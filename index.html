<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Store Performance Dashboard</title>
  <style>
    :root { --bg1:#6a11cb; --bg2:#2575fc; --card:#ffffff; --text:#1f2937; --muted:#6b7280; }
    html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(135deg, var(--bg1), var(--bg2)); }
    .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    .header { color:#fff; text-align:center; margin-bottom: 24px; }
    .header h1 { margin: 0 0 6px; font-size: 32px; }
    .user-info { display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,.15); border-radius:12px; padding:12px 16px; color:#fff; backdrop-filter: blur(6px); }
    .leaderboard-section { margin-top: 20px; }
    .leaderboard-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:18px; }
    .leaderboard-card { background:var(--card); border-radius:16px; box-shadow: 0 12px 24px rgba(0,0,0,.12); padding:16px; }
    .leaderboard-card h2 { margin:4px 0 10px; color:var(--text); }
    .leaderboard-item { display:flex; align-items:center; justify-content:space-between; padding:12px 10px; border-radius:10px; cursor:pointer; transition: transform .05s ease, background .2s; }
    .leaderboard-item:hover { background:#f3f4f6; transform: translateY(-1px); }
    .rank { width:28px; height:28px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#fff; background:#9ca3af; margin-right:10px; }
    .gold { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
    .silver { background: linear-gradient(135deg, #9ca3af, #e5e7eb); color:#111827; }
    .bronze { background: linear-gradient(135deg, #b45309, #f59e0b); }
    .name { flex: 1; margin-left:6px; color:#111827; font-weight:600; }
    .score { color:#6b7280; font-weight:600; }
    .btn { background: linear-gradient(135deg, #2563eb, #7c3aed); color:#fff; border:none; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .admin-btn { background:#10b981; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    .logout-btn { background:#ef4444; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    .login-container { max-width: 420px; margin: 12vh auto; background:#ffffff; border-radius:16px; padding:24px; box-shadow:0 12px 24px rgba(0,0,0,.18); }
    .login-container h2 { margin:0 0 10px; color:#111827; text-align:center; }
    .form-group { margin-top:12px; display:flex; flex-direction:column; gap:6px; }
    .form-group input, .form-group select { padding:12px; border:1px solid #e5e7eb; border-radius:10px; font-size:15px; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); place-items:center; z-index:50; }
    .modal-content { width:min(720px, 92vw); background:#fff; border-radius:16px; padding:18px; box-shadow:0 12px 28px rgba(0,0,0,.25); }
    .modal-header { display:flex; align-items:center; justify-content:space-between; }
    .modal-close { background:transparent; border:none; font-size:24px; cursor:pointer; line-height:1; }
    .user-list .user-item { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; }
    .delete-btn { background:#ef4444; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
    #content { min-height: 280px; }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <!-- User Management Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>User Management</h2>
        <button class="modal-close" onclick="closeUserModal()">&times;</button>
      </div>

      <div class="form-group">
        <h3>Add New User</h3>
        <input type="email" id="newUserEmail" placeholder="Email address">
        <input type="password" id="newUserPassword" placeholder="Password" style="margin-top:10px;">
        <input type="text" id="newUserLinked" placeholder='Linked Sheet Name (e.g., "JASMINE VASQUEZ")' style="margin-top:10px;">
        <select id="newUserRole" style="width:100%;padding:12px;margin-top:10px;border:1px solid #ddd;border-radius:8px;">
          <option value="user">User</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
        <button class="btn" style="margin-top:10px;" onclick="addUser()">Add User</button>
      </div>

      <div class="user-list" id="userList">
        <h3>Existing Users</h3>
        <div id="userListContent"></div>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    /************ Firebase imports ************/
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import {
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
    import {
      getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    /************ Firebase config ************/
    const firebaseConfig = {
      apiKey: "AIzaSyC74YFnCKeO5TjmPa4H4BMm_pFwohOVAX4",
  authDomain: "store-dashboard-2025.firebaseapp.com",
  projectId: "store-dashboard-2025",
  storageBucket: "store-dashboard-2025.firebasestorage.app",
  messagingSenderId: "556566448299",
  appId: "1:556566448299:web:a2cbe4dda5d21fc6c5cfee",
  measurementId: "G-0D5JMNGE4S"
};

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // GAS Web App URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';

    /* ==== CRASH REPORTER (ADD ONCE) ==== */
    window.addEventListener('error', (e) => {
      const app = document.getElementById('app');
      if (!app) return;
      app.innerHTML = `
        <div class="container">
          <div style="padding:50px;text-align:center;color:#dc2626;">
            <h2>Frontend Error</h2>
            <p>${e?.message || 'Unknown error'}</p>
            <pre style="text-align:left;white-space:pre-wrap;background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;">
${(e?.error && e.error.stack) ? e.error.stack : ''}
            </pre>
          </div>
        </div>
      `;
    });

    /* === ACCESS HELPERS & SESSION === */
    const SUPERADMIN_EMAIL = 'albertosilvajr0@gmail.com'; // you are the only superadmin

    function authHeaders() {
      return window.sessionToken ? { Authorization: `Bearer ${window.sessionToken}` } : {};
    }
    function isAdmin()   { return window.userData?.role === 'admin' || window.userData?.role === 'superadmin'; }
    function isManager() { return window.userData?.role === 'manager'; }
    function canViewName(targetName) {
      const n = (targetName || '').toUpperCase();
      const mine = (window.userData?.linkedName || '').toUpperCase();
      if (isAdmin() || isManager()) return true;
      return mine && n === mine;
    }
    function makeSessionToken({ name, role }) {
      const payload = { name, role };
      return btoa(JSON.stringify(payload));
    }

    /************ UI helpers ************/
    function showLoading(on=true) {
      const app = document.getElementById('app');
      if (!app) return;
      if (on) {
        app.innerHTML = `
          <div class="container">
            <div style="background:#fff;border-radius:16px;padding:40px;text-align:center;box-shadow:0 8px 18px rgba(0,0,0,.12)">
              <div style="font-size:18px;color:#111827;">Loading…</div>
            </div>
          </div>
        `;
      }
    }
    function showUserModal() {
      if (!isAdmin()) { alert('Only admins can manage users.'); return; }
      document.getElementById('userModal').style.display = 'grid';
      loadUsers();
    }
    function closeUserModal() {
      document.getElementById('userModal').style.display = 'none';
    }

    /************ Auth ************/
    async function login() {
      const email = document.getElementById('email')?.value?.trim();
      const password = document.getElementById('password')?.value?.trim();
      const errEl = document.getElementById('error-message');
      if (!email || !password) {
        if (errEl) errEl.textContent = 'Enter email and password.';
        return;
      }
      try {
        showLoading(true);
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        if (errEl) errEl.textContent = e.message || 'Login failed';
        showLogin();
      }
    }
    async function logout() {
      await signOut(auth);
      showLogin();
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { showLogin(); return; }

      // Load / create Firestore user doc
      const userRef = doc(db, 'users', user.uid);
      let snap = await getDoc(userRef);
      if (!snap.exists()) {
        await setDoc(userRef, {
          email: user.email,
          role: user.email === SUPERADMIN_EMAIL ? 'superadmin' : 'user',
          linkedName: '',
          createdAt: new Date()
        });
        snap = await getDoc(userRef);
      }
      const data = snap.data() || {};
      let role = data.role || 'user';

      // Ensure the superadmin
      if (user.email === SUPERADMIN_EMAIL && role !== 'superadmin') {
        role = 'superadmin';
        await setDoc(userRef, { ...data, role }, { merge: true });
      }

      window.userData = {
        email: user.email, uid: user.uid, role,
        linkedName: data.linkedName || ''
      };
      const sessionName = window.userData.linkedName || window.userData.email;
      window.sessionToken = makeSessionToken({ name: sessionName, role });

      showDashboard();
    });

  // Show dashboard (NO custom headers; use ?session=)
async function showDashboard() {
  if (!window.userData) { showLogin(); return; }

  try {
    showLoading(true);

    const url = `${SCRIPT_URL}?route=leaderboards&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);            // <-- no headers here
    const raw  = await resp.text();

    let result;
    try { result = JSON.parse(raw); } catch {
      throw new Error(`Non-JSON response from GAS.\nHTTP ${resp.status}\n\n${raw}`);
    }
    if (!result.ok) throw new Error(result.error || 'Backend returned ok:false');

    window.dashboardData = result;
    renderDashboard(result);

  } catch (err) {
    console.error('Dashboard error:', err);
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div style="padding: 50px; text-align: center; color: red; background:#fff; border-radius:16px;">
          <h2>Error Loading Dashboard</h2>
          <p style="white-space:pre-wrap;">${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="max-width:200px;margin:20px auto;">Retry</button>
        </div>
      </div>
    `;
  } finally {
    showLoading(false);
  }
}


    function renderDashboard(data) {
      const salesLB = (data.sales || []).slice(0, 10);
      const bdcLB   = (data.bdc   || []).slice(0, 10);
      const me = window.userData || {};

      function rowHTML(person, index, type) {
        const name = person.name || '';
        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
        const allowed = canViewName(name);
        const clickAttr = allowed ? `onclick="showPersonDetails('${name.replace(/'/g, "\\'")}', '${type}')"` : '';
        const style = allowed ? '' : 'opacity:0.6; cursor:not-allowed;';
        const right = type === 'Sales' ? `${person.sales || 0} Sales` : `${person.shows || 0} Shows`;
        return `
          <div class="leaderboard-item" ${clickAttr} style="${style}">
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="rank ${rankClass}">${index + 1}</div>
              <div class="name">${name}</div>
            </div>
            <div class="score">${right}</div>
          </div>
        `;
      }

      document.getElementById('app').innerHTML = `
        <div class="header"><h1>Store Performance Dashboard</h1></div>

        <div class="user-info">
          <div>
            Welcome, <strong>${me.email || ''}</strong>
            ${isAdmin() ? '<span style="color:#a7f3d0;"> (Admin)</span>' : (isManager() ? '<span style="color:#93c5fd;"> (Manager)</span>' : '')}
            ${me.linkedName ? ` • Linked: <strong>${me.linkedName}</strong>` : ''}
          </div>
          <div>
            ${isAdmin() ? '<button class="admin-btn" onclick="showUserModal()">User Management</button>' : ''}
            <button class="logout-btn" onclick="logout()" style="margin-left:10px;">Logout</button>
          </div>
        </div>

        <div class="leaderboard-section" id="content">
          <div class="leaderboard-grid">
            <div class="leaderboard-card">
              <h2>🏆 Sales Leaderboard</h2>
              ${salesLB.length ? salesLB.map((p, i) => rowHTML(p, i, 'Sales')).join('') : '<p style="text-align:center;color:#999;">No sales data</p>'}
            </div>
            <div class="leaderboard-card">
              <h2>📞 BDC Leaderboard</h2>
              ${bdcLB.length ? bdcLB.map((p, i) => rowHTML(p, i, 'BDC')).join('') : '<p style="text-align:center;color:#999;">No BDC data</p>'}
            </div>
          </div>
        </div>
      `;
    }

    // Person "1on1" page (NO custom headers; use ?session=)
async function showPersonDetails(name, type) {
  try {
    showLoading(true);

    const url = `${SCRIPT_URL}?route=person&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);            // <-- no headers here
    const result = await resp.json();
    if (!result.ok) throw new Error(result.error || 'Failed to load person details');

    const d = result.data || {};
    document.getElementById('content').innerHTML = `
      <div style="max-width: 980px; margin: 0 auto;">
        <button onclick="showDashboard()" class="btn" style="background:#6B7280;margin-bottom:16px;">← Back to Leaderboard</button>
        <div class="leaderboard-card" style="padding:24px;">
          <h2 style="margin-top:0;">${d.name || name}</h2>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:16px; margin-top:10px;">
            <div><div class="muted">Type</div><div style="font-weight:700">${d.type || type || '-'}</div></div>
            <div><div class="muted">Total Calls</div><div style="font-weight:700">${d.calls || 0}</div></div>
            ${d.type === 'Sales' ? `
              <div><div class="muted">Sales MTD</div><div style="font-weight:700">${d.sales || 0}</div></div>
              <div><div class="muted">Sales/Day</div><div style="font-weight:700">${d.salesPerDay ? d.salesPerDay.toFixed(1) : 0}</div></div>
            ` : `
              <div><div class="muted">Appts Shown</div><div style="font-weight:700">${d.apptsShown || 0}</div></div>
              <div><div class="muted">Appts Created</div><div style="font-weight:700">${d.apptsCreated || 0}</div></div>
            `}
            <div><div class="muted">Working Days</div><div style="font-weight:700">${d.workingDays || 0}</div></div>
            <div><div class="muted">Texts</div><div style="font-weight:700">${d.texts || 0}</div></div>
            <div style="grid-column: 1 / -1;"><div class="muted">Avg Talk Time</div><div style="font-size:28px;font-weight:800">${d.avgTalk || '0:00'}</div></div>
          </div>

          <div style="display:flex; gap:12px; margin-top:20px;">
            <button class="btn" onclick="viewCallSheets('${name.replace(/'/g, "\\'")}')">📊 View Call Sheets</button>
            ${isAdmin() ? `<button class="btn" style="background:#10B981">✏️ Edit Performance Data</button>` : ''}
          </div>
        </div>
      </div>
    `;
  } catch (e) {
    document.getElementById('content').innerHTML = `
      <div style="background:#fff;border-radius:16px;padding:40px;color:#dc2626; text-align:center;">
        <h2>Error Loading Details</h2>
        <p>${e.message}</p>
      </div>
    `;
  } finally { showLoading(false); }
}


   // View Call Sheets (NO custom headers; use ?session=)
async function viewCallSheets(name) {
  try {
    showLoading(true);

    const url = `${SCRIPT_URL}?route=calls_for&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);            // <-- no headers here
    const result = await resp.json();
    if (!result.ok) throw new Error(result.error || 'Failed to load call sheets');

    const rows = result.data?.calls || [];
    const trs = rows.map(r => `
      <tr style="border-top:1px solid #e5e7eb;">
        <td style="padding:10px;">${r.date || '-'}</td>
        <td style="padding:10px;">${r.time || '-'}</td>
        <td style="padding:10px;">${r.duration || '-'}</td>
        <td style="padding:10px;">${r.number || '-'}</td>
        <td style="padding:10px;">${r.notes || '-'}</td>
      </tr>
    `).join('');

    document.getElementById('content').innerHTML = `
      <div class="leaderboard-card">
        <button onclick="showPersonDetails('${name.replace(/'/g, "\\'")}')" class="btn" style="background:#6B7280;margin-bottom:12px;">← Back to ${name}</button>
        <h2 style="margin-top:0;">Call Sheets - ${name}</h2>
        <div style="overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f3f4f6;">
                <th style="text-align:left; padding:10px;">Date</th>
                <th style="text-align:left; padding:10px;">Time</th>
                <th style="text-align:left; padding:10px;">Duration</th>
                <th style="text-align:left; padding:10px;">Number</th>
                <th style="text-align:left; padding:10px;">Notes</th>
              </tr>
            </thead>
            <tbody>
              ${rows.length ? trs : `<tr><td colspan="5" style="padding:20px;text-align:center;color:#6b7280;">No call data</td></tr>`}
            </tbody>
          </table>
        </div>
      </div>
    `;
  } catch (e) {
    alert('Failed to load call sheets: ' + e.message);
  } finally { showLoading(false); }
}

    /************ User Management ************/
    async function loadUsers() {
      try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        let html = '';
        usersSnapshot.forEach((docu) => {
          const u = docu.data();
          const email  = u.email || '';
          const role   = u.role || 'user';
          const linked = u.linkedName || '';
          const isSelf = email === window.userData.email;
          const canDelete = isAdmin() && !isSelf && role !== 'admin' && role !== 'superadmin' && email !== SUPERADMIN_EMAIL;

          html += `
            <div class="user-item">
              <div>
                <div>${email}</div>
                <small>Role: <strong>${role}</strong>${role==='superadmin' ? ' 👑' : ''} ${linked ? `• Linked: ${linked}` : ''}</small>
              </div>
              ${canDelete ? `<button class="delete-btn" onclick="deleteUser('${docu.id}', '${role}', '${email}')">Delete</button>`
                          : `<span style="color:#666;">${isSelf ? 'Current User' : (role==='superadmin' || role==='admin' ? 'Protected' : '')}</span>`}
            </div>
          `;
        });
        document.getElementById('userListContent').innerHTML = html || '<p>No users found</p>';
      } catch (e) {
        document.getElementById('userListContent').innerHTML = '<p style="color:red;">Failed to load users.</p>';
      }
    }

    async function addUser() {
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newUserPassword').value.trim();
      const role = document.getElementById('newUserRole').value;
      const linkedName = document.getElementById('newUserLinked').value.trim();

      if (!isAdmin()) { alert('Only admins can add users.'); return; }
      if (!email || !password) { alert('Please enter email and password'); return; }
      if (role === 'superadmin') { alert('Superadmin cannot be created here.'); return; }

      try {
        showLoading(true);
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', cred.user.uid), {
          email, role, linkedName, createdAt: new Date(), createdBy: window.userData.email
        });
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPassword').value = '';
        document.getElementById('newUserLinked').value = '';
        document.getElementById('newUserRole').value = 'user';
        await loadUsers();
        alert('User added successfully!');
      } catch (error) {
        alert('Error adding user: ' + error.message);
      } finally { showLoading(false); }
    }

    async function deleteUser(uid, role, email) {
      if (!isAdmin()) { alert('Only admins can delete users.'); return; }
      if (role === 'admin' || role === 'superadmin' || email === SUPERADMIN_EMAIL) { alert('Cannot delete admins or the superadmin.'); return; }
      if (!confirm('Are you sure you want to delete this user?')) return;

      try {
        showLoading(true);
        await deleteDoc(doc(db, 'users', uid));
        await loadUsers();
        alert('User deleted successfully!');
      } catch (error) {
        alert('Error deleting user: ' + error.message);
      } finally { showLoading(false); }
    }

    /************ Login screen ************/
    function showLogin() {
      const appEl = document.getElementById('app');
      appEl.innerHTML = `
        <div class="login-container">
          <h2>Store Performance Dashboard</h2>
          <div id="error-message" style="color:#dc2626;min-height:20px;margin:10px 0 0;"></div>
          <div class="form-group" style="margin-top:16px;">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@company.com" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input id="password" type="password" placeholder="Your password" autocomplete="current-password" />
          </div>
          <button class="btn" onclick="login()">Log in</button>
        </div>
      `;
    }

    /************ Globals for inline handlers ************/
    window.login = login;
    window.logout = logout;
    window.showUserModal = showUserModal;
    window.closeUserModal = closeUserModal;
    window.addUser = addUser;
    window.deleteUser = deleteUser;
    window.showPersonDetails = showPersonDetails;
    window.viewCallSheets = viewCallSheets;
    window.showDashboard = showDashboard;

    /************ Boot ************/
    if (auth.currentUser) { showDashboard(); } else { showLogin(); }
  </script>
</body>
</html>
