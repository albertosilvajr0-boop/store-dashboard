<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Store Dashboard — Leaderboards & 1on1s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #fafafa; }
      header { background:#111; color:#fff; padding:14px 18px; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      h2 { margin: 18px 0 8px; font-size: 18px; }
      table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid #e8e8e8; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
      th { background:#fcfcfc; font-weight: 600; }
      a { color: #0a66c2; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .two { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
      .card { background:#fff; border:1px solid #e8e8e8; border-radius: 10px; padding: 14px; }
      .muted { color:#666; font-size: 12px; }
      .pill { display:inline-block; background:#eef6ff; color:#145aa6; padding:3px 8px; border-radius:999px; font-size:12px; }
      .kvs { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; margin:10px 0 0; }
      .kv { background:#f9fafb; border:1px solid #eee; border-radius:8px; padding:10px; text-align:center; }
      .kv .n { font-weight:700; font-size:18px; }
      .kv .bar { height:4px; border-radius:9999px; background:#eee; margin-top:6px; overflow:hidden; }
      .kv .bar > span { display:block; height:100%; border-radius:9999px; }
      .kph { display:flex; align-items:center; gap:8px; }
      .topline { display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .linkish { font-size:12px; color:#0a66c2; cursor:pointer; }
      .back { display:inline-block; margin-bottom:12px; }
      @media (max-width: 900px) { .two { grid-template-columns: 1fr; } .kvs { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    </style>
  </head>
  <body>
    <header><div class="wrap">
      <h1>Store Dashboard</h1>
      <div class="muted">Leaderboards & 1on1s</div>
    </div></header>
    <div class="wrap">
      <div id="app">
        <div class="two">
          <div class="card">
            <h2>Sales Leaderboard <span class="pill">Sales (MTD)</span></h2>
            <table>
              <thead><tr><th>#</th><th>Rep</th><th>Sales</th></tr></thead>
              <tbody id="salesBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
            </table>
          </div>
          <div class="card">
            <h2>BDC Leaderboard <span class="pill">Shows (MTD)</span></h2>
            <table>
              <thead><tr><th>#</th><th>Agent</th><th>Shows</th></tr></thead>
              <tbody id="bdcBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* ====== CONFIG ====== */
      var GAS_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';
      function ts(){ return '&t=' + Date.now(); }
      function qs(id){ return document.getElementById(id); }

      /* ====== Benchmarks (editable; persisted in localStorage) ====== */
      var DEFAULT_TARGETS = {
        Sales: {
          mtd:    { sales: 18, calls: 300, created: 20, shown: 15, texts: 300, leads: 60, due: 10 },
          perDay: { sales: 1,  calls: 40,  created: 1.5, shown: 1,  texts: 20,  leads: 3 }
        },
        BDC: {
          mtd:    { sales: 0,  calls: 2000, created: 80, shown: 40, texts: 800, leads: 200, due: 0 },
          perDay: { sales: 0,  calls: 100,  created: 4,  shown: 2.5, texts: 40,  leads: 10 }
        }
      };
      function loadTargets(){
        try { return JSON.parse(localStorage.getItem('targets_v1')||'null') || DEFAULT_TARGETS; }
        catch(e){ return DEFAULT_TARGETS; }
      }
      function saveTargets(t){ localStorage.setItem('targets_v1', JSON.stringify(t)); }
      function editTargets(role){
        var t = loadTargets();
        var group = (role && t[role]) ? role : (confirm('Edit Sales targets? Click "Cancel" for BDC') ? 'Sales' : 'BDC');
        var g = t[group];
        function ask(k, cur){ var x = prompt(group+' target for '+k+' (blank to keep '+cur+')', cur); return x===''||x==null ? cur : (+x||0); }
        // MTD
        g.mtd.sales   = ask('MTD: sales', g.mtd.sales);
        g.mtd.calls   = ask('MTD: calls', g.mtd.calls);
        g.mtd.created = ask('MTD: appts created', g.mtd.created);
        g.mtd.shown   = ask('MTD: appts shown', g.mtd.shown);
        g.mtd.texts   = ask('MTD: texts', g.mtd.texts);
        g.mtd.leads   = ask('MTD: leads in name', g.mtd.leads);
        // Per Day
        g.perDay.sales   = ask('Per-Day: sales', g.perDay.sales);
        g.perDay.calls   = ask('Per-Day: calls', g.perDay.calls);
        g.perDay.created = ask('Per-Day: appts created', g.perDay.created);
        g.perDay.shown   = ask('Per-Day: appts shown', g.perDay.shown);
        g.perDay.texts   = ask('Per-Day: texts', g.perDay.texts);
        g.perDay.leads   = ask('Per-Day: leads in name', g.perDay.leads);
        saveTargets(t);
        alert('Saved targets for '+group+'. Reloading view…');
        if (location.hash.startsWith('#/person/')) location.reload();
      }

      /* ====== API ====== */
      function apiLeaderboards(){ return fetch(GAS_URL+'?route=leaderboards'+ts(), {cache:'no-store'}).then(r=>r.json()); }
      function apiPerson(name, type){
        var p = new URLSearchParams({route:'person', name:name, type:type});
        return fetch(GAS_URL+'?'+p.toString()+ts(), {cache:'no-store'}).then(r=>r.json());
      }

      /* ====== HOME VIEW ====== */
      function navToPerson(name, type){
        location.hash = '#/person/' + encodeURIComponent(String(name||'')) + '/' + encodeURIComponent(String(type||''));
        location.reload();
      }
      function fillHome(){
        apiLeaderboards().then(function(data){
          if(!data || !data.ok) throw new Error((data && data.error) || 'API error');
          // Sales table (rank, name, sales)
          var sBody = qs('salesBody'); sBody.innerHTML='';
          var sales = Array.isArray(data.sales)?data.sales:[];
          if(!sales.length){ var tr=document.createElement('tr'); var td=document.createElement('td'); td.colSpan=3; td.className='muted'; td.textContent='No data'; tr.appendChild(td); sBody.appendChild(tr); }
          else sales.forEach(function(r,i){
            var tr=document.createElement('tr');
            var tdRank=document.createElement('td'); tdRank.textContent=i+1;
            var tdName=document.createElement('td'); var a=document.createElement('a'); a.href='javascript:void(0)'; a.textContent=r.name||''; a.onclick=function(){navToPerson(r.name,'Sales');}; tdName.appendChild(a);
            var tdSales=document.createElement('td'); tdSales.textContent=(r.sales!=null?r.sales:0);
            tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdSales); sBody.appendChild(tr);
          });
          // BDC table (rank, name, shows)
          var bBody = qs('bdcBody'); bBody.innerHTML='';
          var bdc = Array.isArray(data.bdc)?data.bdc:[];
          if(!bdc.length){ var tr2=document.createElement('tr'); var td2=document.createElement('td'); td2.colSpan=3; td2.className='muted'; td2.textContent='No data'; tr2.appendChild(td2); bBody.appendChild(tr2); }
          else bdc.forEach(function(r,i){
            var tr=document.createElement('tr');
            var tdRank=document.createElement('td'); tdRank.textContent=i+1;
            var tdName=document.createElement('td'); var a=document.createElement('a'); a.href='javascript:void(0)'; a.textContent=r.name||''; a.onclick=function(){navToPerson(r.name,'BDC');}; tdName.appendChild(a);
            var tdShows=document.createElement('td'); tdShows.textContent=(r.shows!=null?r.shows:0);
            tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdShows); bBody.appendChild(tr);
          });
        }).catch(function(e){
          ['salesBody','bdcBody'].forEach(function(id){ var tb=qs(id); tb.innerHTML=''; var tr=document.createElement('tr'); var td=document.createElement('td'); td.colSpan=3; td.className='muted'; td.textContent='Error'; tr.appendChild(td); tb.appendChild(tr); });
          console.error(e);
        });
      }

      /* ====== PERSON VIEW ====== */
      function pctColor(p){ return p>=100 ? '#16a34a' : (p>=60 ? '#f59e0b' : '#ef4444'); }
      function addBar(el, value, target){
        if (!target || target<=0) return;
        var wrap=document.createElement('div'); wrap.className='bar';
        var fill=document.createElement('span');
        var pct=Math.min(100, (value/target)*100);
        fill.style.width=pct.toFixed(1)+'%';
        fill.style.background=pctColor(pct);
        wrap.title='Target: '+target+' | '+pct.toFixed(0)+'%';
        wrap.appendChild(fill);
        el.appendChild(wrap);
      }
      function kvTile(num,label, target){
        var d=document.createElement('div'); d.className='kv';
        var n=document.createElement('div'); n.className='n'; n.textContent=num; d.appendChild(n);
        var t=document.createElement('div'); t.className='t'; t.textContent=label; d.appendChild(t);
        addBar(d, parseFloat(num)||0, target);
        return d;
      }
      function fmt(n, decimals){ if (n==null||isNaN(n)) return '0'; var f=+n; return (decimals!=null)?f.toFixed(decimals):String(f); }
      function safeDiv(n,d){ return d>0 ? (n/d) : 0; }

      function fillPerson(name, type){
        var app = document.getElementById('app');
        app.innerHTML = '<a class="back" href="#/">&larr; Back</a><div class="card"><div class="muted">Loading 1on1…</div></div>';
        apiPerson(name, type).then(function(data){
          if(!data || !data.ok) throw new Error((data && data.error) || 'API error');
          var b = data.block || {};
          var picks = data.picks || {};
          var over = picks.over || null;
          var under = picks.under || null;
          var role = (b.type || type || 'Sales').toString();
          var targetsAll = loadTargets();
          var tgt = targetsAll[role] || targetsAll['Sales'];

          // Top card header with edit link
          var container = document.createElement('div');
          var card = document.createElement('div'); card.className='card';
          var top = document.createElement('div'); top.className='topline';
          var h2 = document.createElement('h2'); h2.textContent = (b.name || name) + ' '; var pill=document.createElement('span'); pill.className='pill'; pill.textContent=role; h2.appendChild(pill);
          var edit = document.createElement('span'); edit.className='linkish'; edit.textContent='Edit targets'; edit.onclick=function(){ editTargets(role); };
          top.appendChild(h2); top.appendChild(edit);
          var sub = document.createElement('div'); sub.className='muted'; sub.textContent='Last work day: ' + (data.lastWorkDay || '—');
          card.appendChild(top); card.appendChild(sub);

          /* ---------- MTD KPIs (Sales first) ---------- */
          var mtd = document.createElement('div'); mtd.className='kvs';
          // Order: Sales, Shows, Created, Calls, Texts, Leads, Due, Avg Talk (no bar)
          mtd.appendChild(kvTile(fmt(b.salesMTD,1),'Sales', tgt.mtd.sales));
          mtd.appendChild(kvTile(fmt(b.shownMTD,0),'Appts Shown', tgt.mtd.shown));
          mtd.appendChild(kvTile(fmt(b.createdMTD,0),'Appts Created', tgt.mtd.created));
          mtd.appendChild(kvTile(fmt(b.callsMTD,0),'Calls (MTD)', tgt.mtd.calls));
          mtd.appendChild(kvTile(fmt(b.textsMTD,0),'Texts', tgt.mtd.texts));
          mtd.appendChild(kvTile(fmt(b.leadsInNameMTD,0),'Leads in Name', tgt.mtd.leads));
          mtd.appendChild(kvTile(fmt(b.dueMTD,0),'Appts Due', tgt.mtd.due));
          // Avg talk (no bar, it’s a pace metric)
          var kvAT = document.createElement('div'); kvAT.className='kv';
          var nAT = document.createElement('div'); nAT.className='n'; nAT.textContent = b.avgTalk || '0:00'; kvAT.appendChild(nAT);
          var tAT = document.createElement('div'); tAT.className='t'; tAT.textContent = 'Avg Talk'; kvAT.appendChild(tAT);
          mtd.appendChild(kvAT);

          // Working days tile (no bar)
          var kvWD = document.createElement('div'); kvWD.className='kv';
          var nWD = document.createElement('div'); nWD.className='n'; nWD.textContent = b.workingDays || 0; kvWD.appendChild(nWD);
          var tWD = document.createElement('div'); tWD.className='t'; tWD.textContent = 'Working Days'; kvWD.appendChild(tWD);
          mtd.appendChild(kvWD);

          card.appendChild(mtd);

          /* ---------- Per-Day KPIs ---------- */
          var per = document.createElement('div'); per.className='kvs'; per.style.marginTop='10px';
          var wd = b.workingDays || 0;
          per.appendChild(kvTile(fmt(safeDiv(+b.salesMTD,wd),2),'Sales/Day', tgt.perDay.sales));
          per.appendChild(kvTile(fmt(safeDiv(+b.shownMTD,wd),2),'Shown/Day', tgt.perDay.shown));
          per.appendChild(kvTile(fmt(safeDiv(+b.createdMTD,wd),2),'Created/Day', tgt.perDay.created));
          per.appendChild(kvTile(fmt(safeDiv(+b.callsMTD,wd),1),'Calls/Day', tgt.perDay.calls));
          per.appendChild(kvTile(fmt(safeDiv(+b.textsMTD,wd),1),'Texts/Day', tgt.perDay.texts));
          per.appendChild(kvTile(fmt(safeDiv(+b.leadsInNameMTD,wd),2),'Leads/Day', tgt.perDay.leads));
          // Role tile (label only)
          var kvRole = document.createElement('div'); kvRole.className='kv';
          var nRole = document.createElement('div'); nRole.className='n'; nRole.textContent = role; kvRole.appendChild(nRole);
          var tRole = document.createElement('div'); tRole.className='t'; tRole.textContent = 'Role'; kvRole.appendChild(tRole);
          per.appendChild(kvRole);

          // attach
          card.appendChild(per);
          container.appendChild(card);

          /* ---------- Coaching picks ---------- */
          var callsCard = document.createElement('div'); callsCard.className='card';
          var h2b = document.createElement('h2'); h2b.textContent='Call Coaching Picks'; callsCard.appendChild(h2b);
          var meta = document.createElement('div'); meta.className='muted'; meta.textContent='1 over a minute, 1 under 30 seconds (longest as fallback if none ≥ 60s)'; callsCard.appendChild(meta);

          function callBlock(label, pick){
            var wrap=document.createElement('div'); wrap.className='call';
            var strong=document.createElement('strong'); strong.textContent=label; wrap.appendChild(strong); wrap.appendChild(document.createElement('br'));
            if (pick){
              var span=document.createElement('span'); span.textContent=(pick.dateKey||'')+' — '+(pick.talkMSS||''); wrap.appendChild(span);
              if (pick.url){ wrap.appendChild(document.createElement('br')); var link=document.createElement('a'); link.href=pick.url; link.target='_blank'; link.rel='noopener'; link.textContent='Play recording'; wrap.appendChild(link); }
            } else {
              var none=document.createElement('span'); none.className='muted'; none.textContent='None'; wrap.appendChild(none);
            }
            return wrap;
          }
          callsCard.appendChild(callBlock('Over 1:00', over));
          callsCard.appendChild(callBlock('Under 0:30', under));

          // render
          app.innerHTML = '<a class="back" href="#/">&larr; Back</a>';
          app.appendChild(container);
          app.appendChild(callsCard);
        }).catch(function(e){
          app.innerHTML = '<a class="back" href="#/">&larr; Back</a><div class="card">Error: '+(e&&e.message?e.message:String(e))+'</div>';
        });
      }

      /* ====== Router ====== */
      function route(){
        var hash = location.hash || '#/';
        var parts = hash.slice(2).split('/');
        if (parts[0] === '' || parts[0] === 'home') fillHome();
        else if (parts[0] === 'person') fillPerson(decodeURIComponent(parts[1]||''), parts[2]||'');
        else fillHome();
      }
      window.addEventListener('hashchange', route);
      route();
    </script>
  </body>
</html>

