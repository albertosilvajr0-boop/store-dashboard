<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Store Dashboard — Leaderboards & 1on1s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Speed: preconnect to Apps Script early -->
    <link rel="preconnect" href="https://script.google.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    <link rel="preconnect" href="https://script.googleusercontent.com">
    <link rel="dns-prefetch" href="https://script.googleusercontent.com">

    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #fafafa; }
      header { background:#111; color:#fff; padding:14px 18px; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      h2 { margin: 18px 0 8px; font-size: 18px; }
      table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid #e8e8e8; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
      th { background:#fcfcfc; font-weight: 600; }
      a { color: #0a66c2; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .two { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
      .card { background:#fff; border:1px solid #e8e8e8; border-radius: 10px; padding: 14px; }
      .muted { color:#666; font-size: 12px; }
      .pill { display:inline-block; background:#eef6ff; color:#145aa6; padding:3px 8px; border-radius:999px; font-size:12px; }
      .kvs { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; margin:10px 0 0; }
      .kv { background:#f9fafb; border:1px solid #eee; border-radius:8px; padding:10px; text-align:center; }
      .kv .n { font-weight:700; font-size:18px; }
      .kv .bar { height:4px; border-radius:9999px; background:#eee; margin-top:6px; overflow:hidden; }
      .kv .bar > span { display:block; height:100%; border-radius:9999px; }
      .topline { display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .linkish { font-size:12px; color:#0a66c2; cursor:pointer; }
      .back { display:inline-block; margin-bottom:12px; }
      @media (max-width: 900px) { .two { grid-template-columns: 1fr; } .kvs { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    </style>
  </head>
  <body>
    <header><div class="wrap">
      <h1>Store Dashboard</h1>
      <div class="muted">Leaderboards & 1on1s</div>
    </div></header>
    <div class="wrap">
      <div id="app"><!-- populated by JS --></div>
    </div>

    <script>
      /* ====== CONFIG ====== */
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';
      function ts(){ return '&t=' + Date.now(); }
      function qs(id){ return document.getElementById(id); }

      /* ====== Person cache (sessionStorage) ====== */
      const PERSON_CACHE_TTL_MS = 9 * 60 * 1000; // 9 minutes
      function personKey(name, type){
        return 'person:' + String(name || '').toUpperCase() + ':' + String(type || '');
      }
      function readPersonCache(name, type){
        try {
          const raw = sessionStorage.getItem(personKey(name, type));
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj || !obj.t || (Date.now() - obj.t) > PERSON_CACHE_TTL_MS) {
            sessionStorage.removeItem(personKey(name, type));
            return null;
          }
          return obj.data;
        } catch(e){ return null; }
      }
      function writePersonCache(name, type, data){
        try { sessionStorage.setItem(personKey(name, type), JSON.stringify({ t: Date.now(), data })); } catch(e){}
      }
      async function fetchPerson(name, type, opts){
        const useCache = !opts || opts.useCache !== false;
        if (useCache) {
          const cached = readPersonCache(name, type);
          if (cached) return { data: cached, fromCache: true };
        }
        const params = new URLSearchParams({ route: 'person', name, type });
        const res = await fetch(GAS_URL + '?' + params.toString() + ts(), { cache: 'no-store' });
        const json = await res.json();
        if (json && json.ok) writePersonCache(name, type, json);
        return { data: json, fromCache: false };
      }

      /* ====== Benchmarks (editable; persisted in localStorage) ====== */
      const DEFAULT_TARGETS = {
        Sales: {
          perDay: { sales: 0.5, shown: 0.5, created: 1.0, calls: 40, texts: 20, talkSec: 80 },
          mtd:    { due: 10 }
        },
        BDC: {
          perDay: { sales: 0, shown: 2.5, created: 4, calls: 100, texts: 40, talkSec: 60 },
          mtd:    { due: 0 }
        }
      };
      function loadTargets(){ try { return JSON.parse(localStorage.getItem('targets_v3')||'null') || DEFAULT_TARGETS; } catch(e){ return DEFAULT_TARGETS; } }
      function saveTargets(t){ localStorage.setItem('targets_v3', JSON.stringify(t)); }
      function secsFromAny(x){
        if (x==null) return 0;
        if (typeof x === 'number') return x;
        const s = String(x).trim();
        if (/^\d+:\d{1,2}$/.test(s)){ const p=s.split(':'); return (+p[0])*60 + (+p[1]); }
        const n = parseFloat(s); return isNaN(n) ? 0 : n;
      }
      function mssFromSecs(sec){
        sec = Math.max(0, Math.round(sec));
        const m = Math.floor(sec/60), s=sec%60;
        return m + ':' + String(s).padStart(2,'0');
      }
      function editTargets(role){
        const t = loadTargets();
        const group = (role && t[role]) ? role : (confirm('Edit Sales targets? Click Cancel for BDC') ? 'Sales' : 'BDC');
        const g = t[group];
        function askNum(label, cur){ const x = prompt(label + ' (blank = keep ' + cur + ')', cur); return (x===''||x==null) ? cur : (+x||0); }
        function askTime(label, cur){ const x = prompt(label + ' mm:ss or seconds (blank = keep ' + mssFromSecs(cur) + ')', mssFromSecs(cur)); return (x===''||x==null) ? cur : secsFromAny(x); }
        g.perDay.sales   = askNum(group+' per-day: Sales', g.perDay.sales);
        g.perDay.shown   = askNum(group+' per-day: Appts Shown', g.perDay.shown);
        g.perDay.created = askNum(group+' per-day: Appts Created', g.perDay.created);
        g.perDay.calls   = askNum(group+' per-day: Calls', g.perDay.calls);
        g.perDay.texts   = askNum(group+' per-day: Texts', g.perDay.texts);
        g.perDay.talkSec = askTime(group+' per-day: Avg Talk (target)', g.perDay.talkSec);
        g.mtd.due        = askNum(group+' MTD: Appts Due (fallback)', g.mtd.due || 0);
        saveTargets(t);
        alert('Saved targets for '+group+'. Reloading…');
        if (location.hash.startsWith('#/person/')) location.reload();
      }

      /* ====== API ====== */
      async function apiLeaderboards(){ const r=await fetch(GAS_URL+'?route=leaderboards'+ts(), {cache:'no-store'}); return r.json(); }

      /* ====== HOME VIEW ====== */
      function navToPerson(name, type){
        // Faster nav — no full page reload
        location.hash = '#/person/' + encodeURIComponent(String(name||'')) + '/' + encodeURIComponent(String(type||''));
      }

      function fillHome(){
        // 1) rebuild the Home skeleton so Back always works
        const root = qs('app');
        root.innerHTML = `
          <div class="two">
            <div class="card">
              <h2>Sales Leaderboard <span class="pill">Sales (MTD)</span></h2>
              <table>
                <thead><tr><th>#</th><th>Rep</th><th>Sales</th></tr></thead>
                <tbody id="salesBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
              </table>
            </div>
            <div class="card">
              <h2>BDC Leaderboard <span class="pill">Shows (MTD)</span></h2>
              <table>
                <thead><tr><th>#</th><th>Agent</th><th>Shows</th></tr></thead>
                <tbody id="bdcBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
              </table>
            </div>
          </div>
        `;

        // 2) fetch & populate
        apiLeaderboards().then(function(data){
          if(!data || !data.ok) throw new Error(data && data.error || 'API error');

          // --- Sales ---
          const sBody = qs('salesBody'); sBody.innerHTML='';
          const sales = Array.isArray(data.sales)?data.sales:[];
          if (!sales.length){
            const tr=document.createElement('tr'), td=document.createElement('td');
            td.colSpan=3; td.className='muted'; td.textContent='No data';
            tr.appendChild(td); sBody.appendChild(tr);
          } else {
            sales.forEach(function(r,i){
              const tr=document.createElement('tr');
              const tdRank=document.createElement('td'); tdRank.textContent=i+1;
              const tdName=document.createElement('td'); const a=document.createElement('a');
              a.href = '#/person/' + encodeURIComponent(r.name) + '/Sales';
              a.textContent = r.name || '';
              a.onclick=function(e){ e.preventDefault(); navToPerson(r.name,'Sales'); };
              tdName.appendChild(a);
              const tdSales=document.createElement('td'); tdSales.textContent=(r.sales!=null?r.sales:0);
              tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdSales);
              sBody.appendChild(tr);
            });
          }

          // --- BDC ---
          const bBody = qs('bdcBody'); bBody.innerHTML='';
          const bdc = Array.isArray(data.bdc)?data.bdc:[];
          if (!bdc.length){
            const tr2=document.createElement('tr'), td2=document.createElement('td');
            td2.colSpan=3; td2.className='muted'; td2.textContent='No data';
            tr2.appendChild(td2); bBody.appendChild(tr2);
          } else {
            bdc.forEach(function(r,i){
              const tr=document.createElement('tr');
              const tdRank=document.createElement('td'); tdRank.textContent=i+1;
              const tdName=document.createElement('td'); const a=document.createElement('a');
              a.href = '#/person/' + encodeURIComponent(r.name) + '/BDC';
              a.textContent=r.name||'';
              a.onclick=function(e){ e.preventDefault(); navToPerson(r.name,'BDC'); };
              tdName.appendChild(a);
              const tdShows=document.createElement('td'); tdShows.textContent=(r.shows!=null?r.shows:0);
              tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdShows);
              bBody.appendChild(tr);
            });
          }

          // 3) Prefetch top rows + hover (for instant first clicks)
          try {
            const prefetchList = [];
            (data.sales || []).slice(0, 20).forEach(function(r){ prefetchList.push({name:r.name, type:'Sales'}); });
            (data.bdc   || []).slice(0, 20).forEach(function(r){ prefetchList.push({name:r.name, type:'BDC'}); });
            prefetchList.forEach(function(p, i){
              setTimeout(function(){ fetchPerson(p.name, p.type).catch(function(){}); }, i * 120);
            });
            document.querySelectorAll('a[href^="#/person/"]').forEach(function(a){
              try {
                const parts = decodeURIComponent(a.getAttribute('href').slice(2)).split('/');
                const nm = parts[1] || '', tp = parts[2] || '';
                a.addEventListener('mouseenter', function(){ fetchPerson(nm, tp).catch(function(){}); });
              } catch(e){}
            });
          } catch(e){}
        }).catch(function(e){
          qs('app').innerHTML = '<div class="card">Error: '+(e && e.message ? e.message : String(e))+'</div>';
          console.error(e);
        });
      }

      /* ====== PERSON VIEW (cache-then-network) ====== */
      function pctColor(p){ return p>=100 ? '#16a34a' : (p>=60 ? '#f59e0b' : '#ef4444'); }
      function addBar(el, value, target, isTime){
        if (!target || target<=0) return;
        const wrap=document.createElement('div'); wrap.className='bar';
        const fill=document.createElement('span');
        const pct = Math.min(100, (value/target)*100);
        fill.style.width=pct.toFixed(1)+'%';
        fill.style.background=pctColor(pct);
        wrap.title='Target: '+ (isTime? mssFromSecs(target) : target) +' | '+pct.toFixed(0)+'%';
        wrap.appendChild(fill); el.appendChild(wrap);
      }
      function kvTile(num,label, target, isTime){
        const d=document.createElement('div'); d.className='kv';
        const n=document.createElement('div'); n.className='n'; n.textContent=num; d.appendChild(n);
        const t=document.createElement('div'); t.className='t'; t.textContent=label; d.appendChild(t);
        addBar(d, isTime? secsFromAny(num): parseFloat(num)||0, target, isTime);
        return d;
      }
      function fmt(n, decimals){ if (n==null||isNaN(n)) return '0'; const f=+n; return (decimals!=null)?f.toFixed(decimals):String(f); }
      function safeDiv(n,d){ n=+n||0; d=+d||0; return d>0 ? (n/d) : 0; }
      function deriveTargetMTD(key, roleTargets, workingDays){
        const map = { sales:'sales', shown:'shown', created:'created', calls:'calls', texts:'texts' };
        if (roleTargets.perDay && roleTargets.perDay[map[key]]!=null){
          const per = +roleTargets.perDay[map[key]] || 0;
          const wd  = +workingDays || 0;
          return per * wd;
        }
        if (roleTargets.mtd && roleTargets.mtd[key]!=null) return +roleTargets.mtd[key] || 0;
        return 0;
      }

      async function renderPerson(name, type) {
        const root = qs('app');
        root.innerHTML = '<a class="back" href="#/">&larr; Back</a><div class="card"><div class="muted">Loading 1on1…</div></div>';
        try {
          // 1) render immediately from cache if present
          const cached = readPersonCache(name, type);
          if (cached && cached.ok) {
            renderPersonBody_(cached);
            // background revalidation
            fetchPerson(name, type, { useCache:false })
              .then(function(res){ if (res && res.data && res.data.ok) { writePersonCache(name, type, res.data); renderPersonBody_(res.data); } })
              .catch(function(){});
            return;
          }
          // 2) no cache → fetch once
          const res = await fetchPerson(name, type, { useCache:false });
          if (!res || !res.data || !res.data.ok) throw new Error(res && res.data && res.data.error || 'API error');
          renderPersonBody_(res.data);
        } catch (e) {
          root.innerHTML = '<a class="back" href="#/">&larr; Back</a><div class="card">Error: '+(e && e.message ? e.message : String(e))+'</div>';
        }
      }

      function renderPersonBody_(data){
        const b = data.block || {};
        const picks = data.picks || {};
        const over = picks.over || null;
        const under = picks.under || null;
        const role = (b.type || '').toString();
        const targetsAll = loadTargets();
        const tgt = targetsAll[role] || targetsAll['Sales'];
        const wd = b.workingDays || 0;
        const talkTarget = secsFromAny((tgt.perDay && tgt.perDay.talkSec) ? tgt.perDay.talkSec : 0);

        const app = qs('app');
        const container = document.createElement('div');

        // Header
        const cardHead = document.createElement('div'); cardHead.className='card';
        const top = document.createElement('div'); top.className='topline';
        const h2 = document.createElement('h2'); h2.textContent = (b.name || '') + ' ';
        const pill=document.createElement('span'); pill.className='pill'; pill.textContent=role; h2.appendChild(pill);
        const edit = document.createElement('span'); edit.className='linkish'; edit.textContent='Edit targets'; edit.onclick=function(){ editTargets(role); };
        top.appendChild(h2); top.appendChild(edit);
        const sub = document.createElement('div'); sub.className='muted'; sub.textContent='Last work day: ' + (data.lastWorkDay || '—');
        cardHead.appendChild(top); cardHead.appendChild(sub);
        container.appendChild(cardHead);

        // MTD KPIs
        const cardMTD = document.createElement('div'); cardMTD.className='card';
        const hMTD = document.createElement('h2'); hMTD.textContent = 'MTD KPIs'; cardMTD.appendChild(hMTD);
        const mtd = document.createElement('div'); mtd.className='kvs';

        const tSales   = deriveTargetMTD('sales',  tgt, wd);
        const tShown   = deriveTargetMTD('shown',  tgt, wd);
        const tCreated = deriveTargetMTD('created',tgt, wd);
        const tCalls   = deriveTargetMTD('calls',  tgt, wd);
        const tTexts   = deriveTargetMTD('texts',  tgt, wd);
        const tDue     = deriveTargetMTD('due',    tgt, wd);

        mtd.appendChild(kvTile(fmt(b.salesMTD,1), 'Sales', tSales, false));
        mtd.appendChild(kvTile(fmt(b.shownMTD,0), 'Appts Shown', tShown, false));
        mtd.appendChild(kvTile(fmt(b.createdMTD,0),'Appts Created', tCreated, false));
        mtd.appendChild(kvTile(fmt(b.callsMTD,0),  'Calls (MTD)', tCalls, false));
        mtd.appendChild(kvTile(fmt(b.textsMTD,0),  'Texts', tTexts, false));
        mtd.appendChild(kvTile(fmt(b.dueMTD,0),    'Appts Due', tDue, false));
        mtd.appendChild(kvTile(b.avgTalk||'0:00',  'Avg Talk', talkTarget, true));
        const kvWD = document.createElement('div'); kvWD.className='kv';
        const nWD = document.createElement('div'); nWD.className='n'; nWD.textContent = wd; kvWD.appendChild(nWD);
        const tWD = document.createElement('div'); tWD.className='t'; tWD.textContent = 'Working Days'; kvWD.appendChild(tWD);
        mtd.appendChild(kvWD);
        cardMTD.appendChild(mtd);
        container.appendChild(cardMTD);

        // Per-Day KPIs
        const cardPD = document.createElement('div'); cardPD.className='card';
        const hPD = document.createElement('h2'); hPD.textContent = 'Per-Day KPIs'; cardPD.appendChild(hPD);
        const per = document.createElement('div'); per.className='kvs';
        function perTarget(key){ return (tgt.perDay && tgt.perDay[key]!=null) ? (+tgt.perDay[key]||0) : 0; }
        per.appendChild(kvTile(fmt(safeDiv(+b.salesMTD,wd),2),'Sales/Day', perTarget('sales'), false));
        per.appendChild(kvTile(fmt(safeDiv(+b.shownMTD,wd),2),'Shown/Day', perTarget('shown'), false));
        per.appendChild(kvTile(fmt(safeDiv(+b.createdMTD,wd),2),'Created/Day', perTarget('created'), false));
        per.appendChild(kvTile(fmt(safeDiv(+b.callsMTD,wd),1),'Calls/Day', perTarget('calls'), false));
        per.appendChild(kvTile(fmt(safeDiv(+b.textsMTD,wd),1),'Texts/Day', perTarget('texts'), false));
        per.appendChild(kvTile(b.avgTalk||'0:00','Avg Talk', talkTarget, true));
        cardPD.appendChild(per);
        container.appendChild(cardPD);

        // Last Work Day KPIs
        const lastDay = data.lastDay || null;
        const cardLW = document.createElement('div'); cardLW.className='card';
        const hLW = document.createElement('h2'); hLW.textContent = 'Last Work Day KPIs'; cardLW.appendChild(hLW);
        const subLW = document.createElement('div'); subLW.className='muted'; subLW.textContent = lastDay && lastDay.dateKey ? ('Date: ' + lastDay.dateKey) : 'Date: ' + (data.lastWorkDay || '—');
        cardLW.appendChild(subLW);
        const lw = document.createElement('div'); lw.className='kvs';
        const tgtSales = perTarget('sales'), tgtCalls = perTarget('calls');
        lw.appendChild(kvTile(fmt(lastDay && lastDay.sales != null ? lastDay.sales : 0 ,0), 'Sales (Day)', tgtSales, false));
        lw.appendChild(kvTile(fmt(lastDay && lastDay.calls != null ? lastDay.calls : 0 ,0), 'Calls (Day)', tgtCalls, false));
        lw.appendChild(kvTile((lastDay && lastDay.avgTalkMSS) ? lastDay.avgTalkMSS : '0:00', 'Avg Talk', talkTarget, true));
        cardLW.appendChild(lw);
        container.appendChild(cardLW);

        // PR Wins / Opportunities / Last Sales Day
        const pr = data.prNotes || {};
        if (pr.wins || pr.opportunities || (pr.lastSales && pr.lastSales.date)) {
          const cardPR = document.createElement('div'); cardPR.className='card';
          const hPR = document.createElement('h2'); hPR.textContent = 'Wins & Opportunities'; cardPR.appendChild(hPR);

          if (pr.lastSales && pr.lastSales.date) {
            const info = document.createElement('div'); info.className='muted';
            info.textContent = 'Last Sales Day: ' + pr.lastSales.date + ' — Sales ' + (pr.lastSales.sales != null ? pr.lastSales.sales : '0');
            cardPR.appendChild(info);
          }
          if (pr.wins) {
            const w = document.createElement('div'); w.style.marginTop = '8px'; w.textContent = pr.wins; cardPR.appendChild(w);
          }
          if (pr.opportunities) {
            const o = document.createElement('div'); o.style.marginTop = '6px'; o.textContent = pr.opportunities; cardPR.appendChild(o);
          }
          container.appendChild(cardPR);
        }

        // Coaching picks
        const callsCard = document.createElement('div'); callsCard.className='card';
        const h2b = document.createElement('h2'); h2b.textContent='Call Coaching Picks'; callsCard.appendChild(h2b);
        const lastDayKey = data.lastWorkDay || '';
        const usedDay = (picks && picks.usedDate) ? picks.usedDate : ((over && over.dateKey) || (under && under.dateKey) || '');
        const meta = document.createElement('div'); meta.className='muted';
        meta.textContent = (usedDay && lastDayKey && usedDay !== lastDayKey)
          ? ('Using calls from ' + usedDay + ' (no recordings on last work day).')
          : '1 over a minute, 1 under 30 seconds (longest/shortest as fallback)';
        callsCard.appendChild(meta);

        function callBlock(label, pick){
          const wrap=document.createElement('div'); wrap.className='call';
          const strong=document.createElement('strong'); strong.textContent=label; wrap.appendChild(strong); wrap.appendChild(document.createElement('br'));
          if (pick){
            const span=document.createElement('span'); span.textContent=(pick.dateKey||'')+' — '+(pick.talkMSS||''); wrap.appendChild(span);
            if (pick.url){ wrap.appendChild(document.createElement('br')); const link=document.createElement('a'); link.href=pick.url; link.target='_blank'; link.rel='noopener'; link.textContent='Play recording'; wrap.appendChild(link); }
          } else {
            const none=document.createElement('span'); none.className='muted'; none.textContent='None'; wrap.appendChild(none);
          }
          return wrap;
        }
        callsCard.appendChild(callBlock('Over 1:00', over));
        callsCard.appendChild(callBlock('Under 0:30', under));

        // render
        app.innerHTML = '<a class="back" href="#/">&larr; Back</a>';
        app.appendChild(container);
        app.appendChild(callsCard);
      }

      /* ====== Router ====== */
      function route(){
        const hash = location.hash || '#/';
        const parts = hash.slice(2).split('/');
        if (parts[0] === '' || parts[0] === 'home') fillHome();
        else if (parts[0] === 'person') renderPerson(decodeURIComponent(parts[1]||''), parts[2]||'');
        else fillHome();
      }
      window.addEventListener('hashchange', route);
      // Initial render
      route();
    </script>
  </body>
</html>
