<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Authentication */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-form h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .auth-form input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .auth-form button {
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Dashboard */
        .header {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .leaderboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .leaderboard-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .leaderboard-item.clickable {
            cursor: pointer;
        }
        
        .leaderboard-item.clickable:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }
        
        .rank {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-right: 15px;
            min-width: 40px;
        }
        
        .name {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
        }
        
        .score {
            font-size: 18px;
            color: #764ba2;
            font-weight: bold;
        }
        
        .error-message {
            color: red;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="authSection" class="auth-container">
            <form id="loginForm" class="auth-form">
                <h2>Store Dashboard Login</h2>
                <input type="text" id="loginUsername" placeholder="Username or Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="submit">Login</button>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" style="display: none;">
            <div class="header">
                <h3>Welcome, <span id="userDisplayName"></span>
                    <span id="adminBadge" style="color: #4CAF50; display: none;"> (Admin)</span>
                </h3>
                <div>
                    <button onclick="refreshData()" style="margin-right: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Refresh Data
                    </button>
                    <button onclick="logout()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Logout
                    </button>
                </div>
            </div>

            <div id="mainContent"></div>
        </div>
    </div>

    <script>
        // Configuration
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';
        
        // Global variables
        let currentUser = null;
        let dashboardData = null;

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                // Call Google Apps Script backend for authentication
                const response = await fetch(`${SCRIPT_URL}?route=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                
                if (result.ok) {
                    currentUser = result.user;
                    localStorage.setItem('dashboardUser', JSON.stringify(currentUser));
                    
                    // Show dashboard
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                    document.getElementById('userDisplayName').textContent = currentUser.name || username;
                    
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminBadge').style.display = 'inline';
                    }
                    
                    // Load dashboard data
                    await loadDashboardData();
                } else {
                    errorDiv.textContent = result.error || 'Invalid credentials';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.style.display = 'block';
            }
        });

        // Load dashboard data
        async function loadDashboardData() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading">Loading dashboard data...</div>';
            
            try {
                // Fetch leaderboard data
                const response = await fetch(`${SCRIPT_URL}?route=leaderboards`);
                const result = await response.json();
                
                if (result.ok) {
                    dashboardData = result;
                    renderLeaderboards();
                } else {
                    throw new Error(result.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                mainContent.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3 style="color: red;">Error Loading Dashboard</h3>
                        <p>${error.message}</p>
                        <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Render leaderboards
        function renderLeaderboards() {
            const mainContent = document.getElementById('mainContent');
            
            if (!dashboardData) {
                mainContent.innerHTML = '<div class="loading">No data available</div>';
                return;
            }
            
            const salesData = dashboardData.sales || [];
            const bdcData = dashboardData.bdc || [];
            
            const isAdmin = currentUser && currentUser.role === 'admin';
            const linkedPerson = currentUser ? currentUser.linkedTo : null;
            
            mainContent.innerHTML = `
                <div class="leaderboard-container">
                    <div class="leaderboard-card">
                        <h2 style="margin-bottom: 20px; color: #333;">Sales Representatives</h2>
                        ${salesData.length > 0 ? salesData.map((person, index) => {
                            const canClick = isAdmin || (linkedPerson && normalizeText(person.name) === normalizeText(linkedPerson));
                            return `
                                <div class="leaderboard-item ${canClick ? 'clickable' : ''}"
                                     ${canClick ? `onclick="viewPersonDetails('${person.name}', 'Sales')"` : ''}>
                                    <span class="rank">#${index + 1}</span>
                                    <span class="name">${person.name}</span>
                                    <span class="score">${person.sales || 0} sales</span>
                                </div>
                            `;
                        }).join('') : '<div style="padding: 20px; text-align: center; color: #6b7280;">No sales data available</div>'}
                    </div>
                    
                    <div class="leaderboard-card">
                        <h2 style="margin-bottom: 20px; color: #333;">BDC Agents</h2>
                        ${bdcData.length > 0 ? bdcData.map((person, index) => {
                            const canClick = isAdmin || (linkedPerson && normalizeText(person.name) === normalizeText(linkedPerson));
                            return `
                                <div class="leaderboard-item ${canClick ? 'clickable' : ''}"
                                     ${canClick ? `onclick="viewPersonDetails('${person.name}', 'BDC')"` : ''}>
                                    <span class="rank">#${index + 1}</span>
                                    <span class="name">${person.name}</span>
                                    <span class="score">${person.shows || 0} shows</span>
                                </div>
                            `;
                        }).join('') : '<div style="padding: 20px; text-align: center; color: #6b7280;">No BDC data available</div>'}
                    </div>
                </div>
            `;
        }

        // View person details
        async function viewPersonDetails(name, type) {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading">Loading person details...</div>';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?route=person&name=${encodeURIComponent(name)}`);
                const result = await response.json();
                
                if (result.ok) {
                    renderPersonDetails(result, type);
                } else {
                    throw new Error(result.error || 'Failed to load person data');
                }
            } catch (error) {
                console.error('Error loading person details:', error);
                mainContent.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h3>Error loading details for ${name}</h3>
                        <p>${error.message}</p>
                        <button onclick="loadDashboardData()">Back to Dashboard</button>
                    </div>
                `;
            }
        }

        // Render person details
        function renderPersonDetails(data, type) {
            const mainContent = document.getElementById('mainContent');
            const metrics = data.metrics || {};
            
            mainContent.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px;">
                    <button onclick="loadDashboardData()" style="margin-bottom: 20px; padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        ← Back to Dashboard
                    </button>
                    
                    <h2>${data.name}</h2>
                    <p style="color: #666; margin-bottom: 20px;">${type} • ${data.callCount || 0} assigned calls</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="color: #666;">Total Calls</div>
                            <div style="font-size: 24px; font-weight: bold; color: #333;">${metrics.calls || 0}</div>
                        </div>
                        
                        ${type === 'Sales' ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <div style="color: #666;">Sales</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${metrics.sales || 0}</div>
                            </div>
                        ` : `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <div style="color: #666;">Shows</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${metrics.shown || 0}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <div style="color: #666;">Created</div>
                                <div style="font-size: 24px; font-weight: bold; color: #333;">${metrics.created || 0}</div>
                            </div>
                        `}
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="color: #666;">Working Days</div>
                            <div style="font-size: 24px; font-weight: bold; color: #333;">${metrics.workingDays || 0}</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="color: #666;">Avg Talk Time</div>
                            <div style="font-size: 24px; font-weight: bold; color: #333;">${metrics.avgTalkTime || '0:00'}</div>
                        </div>
                    </div>
                    
                    ${data.callCount > 0 ? `
                        <button onclick="viewCallList('${data.name}')" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            View Call List →
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // View call list
        async function viewCallList(name) {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading">Loading call list...</div>';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?route=calls&name=${encodeURIComponent(name)}`);
                const result = await response.json();
                
                if (result.ok && result.length > 0) {
                    renderCallList(name, result);
                } else {
                    mainContent.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 10px;">
                            <h3>No calls found for ${name}</h3>
                            <button onclick="loadDashboardData()">Back to Dashboard</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading call list:', error);
                mainContent.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h3>Error loading call list</h3>
                        <p>${error.message}</p>
                        <button onclick="loadDashboardData()">Back to Dashboard</button>
                    </div>
                `;
            }
        }

        // Render call list
        function renderCallList(name, calls) {
            const mainContent = document.getElementById('mainContent');
            
            mainContent.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px;">
                    <button onclick="loadDashboardData()" style="margin-bottom: 20px; padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        ← Back to Dashboard
                    </button>
                    
                    <h2>Call List for ${name}</h2>
                    <p style="color: #666; margin-bottom: 20px;">Total: ${calls.length} calls</p>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Customer</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Phone</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Status</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Lead Age</th>
                                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Priority</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${calls.map(call => `
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${call.customerName || ''}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${call.phone || ''}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${call.status || ''}</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${call.leadAge || ''} days</td>
                                        <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${call.bucket || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Helper function to normalize text
        function normalizeText(text) {
            if (!text) return '';
            return text.toString().trim().toUpperCase().replace(/\s+/g, ' ');
        }

        // Refresh data
        async function refreshData() {
            await loadDashboardData();
        }

        // Logout
        function logout() {
            currentUser = null;
            localStorage.removeItem('dashboardUser');
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Check for saved session on load
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('dashboardUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                    document.getElementById('userDisplayName').textContent = currentUser.name;
                    
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminBadge').style.display = 'inline';
                    }
                    
                    loadDashboardData();
                } catch (e) {
                    console.error('Invalid saved session');
                    localStorage.removeItem('dashboardUser');
                }
            }
        });
    </script>
</body>
</html>
