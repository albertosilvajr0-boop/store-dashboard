<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Store Performance Dashboard</title>
  <style>
    :root {
      --bg1:#6a11cb; --bg2:#2575fc;
      --card:#ffffff; --text:#111827; --muted:#6b7280;
      --pill:#0ea5e9; --pill2:#10b981;
    }
    html, body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); }
    .container { max-width:1100px; margin:40px auto; padding:0 20px; }
    .header { color:#fff; text-align:center; margin:10px 0 16px; }
    .header h1 { margin:0; font-size:34px; }
    .user-info { display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,.65); color:#fff; border-radius:12px; padding:10px 16px; }
    .btn { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn:hover { background:#1d4ed8; }
    .logout-btn { background:#ef4444; } .logout-btn:hover { background:#dc2626; }
    .admin-btn { background:#10b981; } .admin-btn:hover { background:#059669; }

    .switcher { display:flex; gap:8px; margin:18px 0 6px; }
    .seg { border:1px solid rgba(255,255,255,.25); color:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; backdrop-filter: blur(8px); }
    .seg.active { background:#fff; color:#111827; border-color:#fff; }
    .hint { color:#e5e7eb; font-size:12px; margin-left:8px; }

    .card { background:var(--card); border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.12); padding:16px; }
    .titleRow { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .titleRow h2 { margin:0; color:var(--text); font-size:18px; display:flex; align-items:center; gap:10px; }

    .list { display:flex; flex-direction:column; gap:4px; }
    .row { display:flex; align-items:center; justify-content:space-between; padding:12px 10px; border-radius:10px; cursor:pointer; transition:transform .06s ease, background .2s; }
    .row:hover { background:#f3f4f6; transform:translateY(-1px); }
    .left { display:flex; align-items:center; gap:10px; }
    .rank { width:28px; height:28px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#fff; background:#9ca3af; }
    .gold { background:linear-gradient(135deg,#f59e0b,#fbbf24); }
    .silver { background:linear-gradient(135deg,#9ca3af,#e5e7eb); color:#111827; }
    .bronze { background:linear-gradient(135deg,#b45309,#f59e0b); }
    .name { color:#111827; font-weight:700; }
    .right { text-align:right; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .pill { font-size:12px; font-weight:700; padding:3px 8px; border-radius:999px; background:#e5f3ff; color:#0b5cab; }
    .pill.sales { background:#fef3c7; color:#92400e; }
    .pill.calls { background:#e0f2fe; color:#075985; }
    .pill.texts { background:#ecfdf5; color:#065f46; }
    .pill.appt { background:#f1f5f9; color:#334155; }
    .muted { color:#6b7280; font-size:13px; }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <script type="module">
    // GAS endpoint (already set by you elsewhere)
    const SCRIPT_URL = window.SCRIPT_URL || '';
    const state = { mode: 'sales', raw: null }; // 'sales' | 'bdc'

    function isAdmin(){ return (window.userData?.role==='admin'||window.userData?.role==='superadmin'); }
    function isManager(){ return (window.userData?.role==='manager'); }
    function canViewName(targetName){
      const mine=(window.userData?.linkedName||'').toUpperCase();
      if(isAdmin()||isManager())return true;
      return mine && (String(targetName||'').toUpperCase()===mine);
    }

    async function fetchLeaderboards(){
      if(!SCRIPT_URL) throw new Error('SCRIPT_URL is not defined on window.');
      const url = `${SCRIPT_URL}?route=leaderboards&session=${encodeURIComponent(window.sessionToken||'')}`;
      const resp = await fetch(url, { cache: 'no-store' });
      const text = await resp.text();
      let data; try{ data=JSON.parse(text);}catch(e){ throw new Error(`Non-JSON from GAS\nHTTP ${resp.status}\n\n${text}`); }
      if(!data?.ok) throw new Error(data?.error||'Backend returned ok:false');
      return data;
    }

    function sortSales(arr){
      // desc by sales, then alpha
      return [...(arr||[])].sort((a,b)=>(b.sales??0)-(a.sales??0)||String(a.name||'').localeCompare(String(b.name||'')));
    }
    function sortBDC(arr){
      // desc by shown/shows/shows_count, then alpha
      const shown = x => x.shown ?? x.shows ?? x.shows_count ?? 0;
      return [...(arr||[])].sort((a,b)=>shown(b)-shown(a)||String(a.name||'').localeCompare(String(b.name||'')));
    }

    function chip(label, value, cls=''){
      return `<span class="pill ${cls}">${label}: <strong>${value}</strong></span>`;
    }

    function rowHTML(person, i, mode){
      const name = person.name || '';
      const rankClass = i===0 ? 'gold' : i===1 ? 'silver' : i===2 ? 'bronze' : '';
      const allowed = canViewName(name);
      const clickAttr = allowed ? `onclick="showPersonDetails('${name.replace(/'/g,"\\'")}', '${mode.toUpperCase()}')"` : '';
      const style = allowed ? '' : 'opacity:.6; cursor:not-allowed;';

      if(mode==='sales'){
        const sales = person.sales ?? 0;
        const calls = person.calls ?? 0;
        const texts = person.texts ?? 0;
        const created = person.created ?? 0;
        const shown = person.shown ?? person.shown_count ?? 0;
        return `
          <div class="row" ${clickAttr} style="${style}">
            <div class="left">
              <div class="rank ${rankClass}">${i+1}</div>
              <div class="name">${name}</div>
            </div>
            <div class="right">
              <div class="chips">
                ${chip('Sales', sales, 'sales')}
                ${chip('Calls', calls, 'calls')}
                ${chip('Texts', texts, 'texts')}
                ${chip('Appts Made', created, 'appt')}
                ${chip('Appts Shown', shown, 'appt')}
              </div>
            </div>
          </div>
        `;
      } else {
        // BDC
        const calls = person.calls ?? 0;    // may be 0 until backend adds it
        const texts = person.texts ?? 0;    // may be 0 until backend adds it
        const created = person.created ?? 0;
        const shown = person.shown ?? person.shows ?? person.shows_count ?? 0;
        return `
          <div class="row" ${clickAttr} style="${style}">
            <div class="left">
              <div class="rank ${rankClass}">${i+1}</div>
              <div class="name">${name}</div>
            </div>
            <div class="right">
              <div class="chips">
                ${chip('Appts Shown', shown, 'appt')}
                ${chip('Appts Made', created, 'appt')}
                ${chip('Calls', calls, 'calls')}
                ${chip('Texts', texts, 'texts')}
              </div>
            </div>
          </div>
        `;
      }
    }

    function render(data){
      const me = window.userData || {};
      // Save raw once
      if(!state.raw) state.raw = data;

      // Derive lists with correct sort
      const salesLB = sortSales(data.sales || []);
      const bdcLB   = sortBDC(data.bdc   || []);

      // Active list
      const activeList = state.mode==='sales' ? salesLB : bdcLB;

      // HTML
      document.getElementById('app').innerHTML = `
        <div class="header"><h1>Store Performance Dashboard</h1></div>

        <div class="user-info">
          <div>
            Welcome, <strong>${me.email || ''}</strong>
            ${isAdmin() ? '<span style="color:#a7f3d0;"> (Admin)</span>' :
              (isManager() ? '<span style="color:#93c5fd;"> (Manager)</span>' : '')}
            ${me.linkedName ? ` ‚Ä¢ Linked: <strong>${me.linkedName}</strong>` : ''}
          </div>
          <div>
            ${isAdmin() ? '<button class="admin-btn" onclick="showUserModal()">User Management</button>' : ''}
            <button class="logout-btn" onclick="logout()" style="margin-left:10px;">Logout</button>
          </div>
        </div>

        <div class="switcher">
          <button class="seg ${state.mode==='sales'?'active':''}" onclick="setMode('sales')">Sales</button>
          <button class="seg ${state.mode==='bdc'?'active':''}" onclick="setMode('bdc')">BDC</button>
          <span class="hint">Tip: Click a name to open their 1:1</span>
        </div>

        <div id="content" class="card">
          <div class="titleRow">
            <h2>${state.mode==='sales' ? 'üèÜ Sales Leaderboard' : 'üìû BDC Leaderboard'}</h2>
            <div class="muted">
              ${state.mode==='sales'
                ? 'Sorted by Sales (MTD)'
                : 'Sorted by Appts Shown (MTD)'}
            </div>
          </div>
          <div class="list">
            ${activeList.length
              ? activeList.map((p,i)=>rowHTML(p,i,state.mode)).join('')
              : `<p class="muted" style="text-align:center;">No ${state.mode.toUpperCase()} data</p>`}
          </div>
        </div>
      `;
    }

    // Person 1:1 (unchanged from your previous build)
    async function showPersonDetails(name, type) {
      const contentEl = document.getElementById('content');
      if (contentEl) contentEl.innerHTML = `<div class="card" style="padding:24px; text-align:center;">Loading ${name}‚Ä¶</div>`;
      try {
        const url = `${SCRIPT_URL}?route=person&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken||'')}`;
        const resp = await fetch(url, { cache:'no-store' });
        const result = await resp.json();
        if (!result?.ok) throw new Error(result?.error || 'Failed to load person details');
        const payload = result.data || {};
        const b = payload.block || {};
        const day = payload.lastDay || {};
        const isSales = (b.type || type) === 'Sales';
        const html = `
          <button onclick="window.showDashboard()" class="btn" style="background:#6B7280;margin-bottom:16px;">‚Üê Back to Leaderboard</button>
          <div class="card" style="padding:24px;">
            <h2 style="margin:0 0 6px;">${b.name || name}</h2>
            <div class="muted" style="margin-bottom:14px;">${b.type || type || '-'} ‚Ä¢ ${b.workingDays || 0} working days (MTD)</div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:16px;">
              <div><div class="muted">Total Calls (MTD)</div><div style="font-weight:700">${b.callsMTD || 0}</div></div>
              ${isSales ? `
                <div><div class="muted">Sales (MTD)</div><div style="font-weight:700">${b.salesMTD || 0}</div></div>
                <div><div class="muted">Texts (MTD)</div><div style="font-weight:700">${b.textsMTD || 0}</div></div>
                <div><div class="muted">Appts Created (MTD)</div><div style="font-weight:700">${b.createdMTD || 0}</div></div>
                <div><div class="muted">Appts Shown (MTD)</div><div style="font-weight:700">${b.shownMTD || 0}</div></div>
              ` : `
                <div><div class="muted">Appts Shown (MTD)</div><div style="font-weight:700">${b.shownMTD || 0}</div></div>
                <div><div class="muted">Appts Created (MTD)</div><div style="font-weight:700">${b.createdMTD || 0}</div></div>
                <div><div class="muted">Texts (MTD)</div><div style="font-weight:700">${b.textsMTD || 0}</div></div>
              `}
              <div><div class="muted">Leads In Name (MTD)</div><div style="font-weight:700">${b.leadsInNameMTD || 0}</div></div>
              <div><div class="muted">Avg Talk</div><div style="font-weight:700">${b.avgTalk || '0:00'}</div></div>
            </div>
            <div style="margin-top:18px; background:#f8fafc; border-radius:10px; padding:14px;">
              <div style="font-weight:600; margin-bottom:6px;">Last Work Day</div>
              <div style="display:flex; gap:18px; flex-wrap:wrap;">
                <div><span class="muted">Date:</span> ${day.dateKey || '-'}</div>
                <div><span class="muted">Calls:</span> ${day.calls || 0}</div>
                <div><span class="muted">Avg Talk:</span> ${day.avgTalkMSS || '0:00'}</div>
                ${isSales ? `<div><span class="muted">Sales:</span> ${day.sales ?? 0}</div>` : ''}
              </div>
            </div>
            <div style="display:flex; gap:12px; margin-top:20px;">
              <button class="btn" onclick="viewCallSheets('${(b.name || name).replace(/'/g, "\\'")}')">üìä View Call Sheets</button>
            </div>
          </div>
        `;
        if (contentEl) contentEl.innerHTML = html;
      } catch (e) {
        if (contentEl) contentEl.innerHTML = `
          <div class="card" style="padding:40px;color:#dc2626; text-align:center;">
            <h2>Error Loading Details</h2>
            <p>${e?.message || e}</p>
            <button class="btn" onclick="window.showDashboard()" style="margin-top:12px;background:#6B7280;">‚Üê Back to Leaderboard</button>
          </div>`;
      }
    }

    async function viewCallSheets(name){
      const contentEl = document.getElementById('content');
      if (contentEl) contentEl.innerHTML = `<div class="card" style="padding:24px; text-align:center;">Loading call sheets for ${name}‚Ä¶</div>`;
      try {
        const url = `${SCRIPT_URL}?route=calls_for&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken || '')}`;
        const resp = await fetch(url, { cache: 'no-store' });
        const result = await resp.json();
        if (!result?.ok) throw new Error(result?.error || 'Failed to load call sheets');
        const rows = result.data?.calls || [];
        const tzDateOnly = v => { if(!v) return '-'; try{ const d=(v instanceof Date)?v:new Date(v); return isNaN(d)?String(v):(d.toLocaleDateString()); }catch{ return String(v); }};
        const trs = rows.map(r=>`
          <tr style="border-top:1px solid #e5e7eb;">
            <td style="padding:10px;">${r.link ? `<a href="${r.link}" target="_blank" rel="noopener">${r.name||'-'}</a>` : (r.name||'-')}</td>
            <td style="padding:10px;">${r.phone||'-'}</td>
            <td style="padding:10px;">${r.email||'-'}</td>
            <td style="padding:10px;">${r.salesPerson||'-'}</td>
            <td style="padding:10px;">${r.bdcAgent||'-'}</td>
            <td style="padding:10px;">${r.source||'-'}</td>
            <td style="padding:10px;">${tzDateOnly(r.dateIn||r.date)}</td>
            <td style="padding:10px;">${r.leadAge??'-'}</td>
            <td style="padding:10px;">${r.daysSince??'-'}</td>
            <td style="padding:10px;">${r.bucket||'-'}</td>
            <td style="padding:10px;">${r.status||'-'}</td>
            <td style="padding:10px;">${r.reason||'-'}</td>
          </tr>`).join('');
        const html = `
          <div class="card" style="padding:24px;">
            <button onclick="window.showPersonDetails('${name.replace(/'/g,"\\'")}')" class="btn" style="background:#6B7280;margin-bottom:12px;">‚Üê Back to ${name}</button>
            <h2 style="margin:0 0 10px;">Call Sheets - ${name}</h2>
            <div style="overflow:auto;">
              <table style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#f3f4f6;">
                    <th style="text-align:left; padding:10px;">Customer</th>
                    <th style="text-align:left; padding:10px;">Phone</th>
                    <th style="text-align:left; padding:10px;">Email</th>
                    <th style="text-align:left; padding:10px;">Sales Person</th>
                    <th style="text-align:left; padding:10px;">BDC Agent</th>
                    <th style="text-align:left; padding:10px;">Source</th>
                    <th style="text-align:left; padding:10px;">Date In</th>
                    <th style="text-align:left; padding:10px;">Lead Age</th>
                    <th style="text-align:left; padding:10px;">Days Since</th>
                    <th style="text-align:left; padding:10px;">Priority Bucket</th>
                    <th style="text-align:left; padding:10px;">Status</th>
                    <th style="text-align:left; padding:10px;">Priority Reason</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows.length ? trs : `<tr><td colspan="12" style="padding:20px;text-align:center;color:#6b7280;">No call data</td></tr>`}
                </tbody>
              </table>
            </div>
          </div>`;
        if (contentEl) contentEl.innerHTML = html;
      } catch (e) {
        if (contentEl) contentEl.innerHTML = `<div class="card" style="padding:40px;color:#dc2626; text-align:center;"><h2>Error Loading Call Sheets</h2><p>${e?.message||e}</p></div>`;
      }
    }

    // switcher handlers + expose for onclick
    function setMode(mode){
      state.mode = mode;
      render(state.raw);
    }
    async function showDashboard(){
      try{ if (typeof showLoading==='function') showLoading(true); }catch(_){}
      try{
        const data = await fetchLeaderboards();
        render(data);
      }catch(err){
        document.getElementById('app').innerHTML = `
          <div class="container">
            <div class="card" style="padding:50px;text-align:center;color:#dc2626;">
              <h2>Error Loading Dashboard</h2>
              <p style="white-space:pre-wrap;">${err?.message||err}</p>
              <button class="btn" onclick="window.showDashboard()" style="max-width:200px;margin:20px auto;">Retry</button>
            </div>
          </div>`;
      }finally{
        try{ if (typeof showLoading==='function') showLoading(false); }catch(_){}
      }
    }

    window.showDashboard = showDashboard;
    window.showPersonDetails = showPersonDetails;
    window.viewCallSheets = viewCallSheets;
    window.setMode = setMode;

    showDashboard();
  </script>
</body>
</html>
