<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Store Dashboard — Leaderboards & 1on1s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Speed: preconnect -->
    <link rel="preconnect" href="https://script.google.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    <link rel="preconnect" href="https://script.googleusercontent.com">
    <link rel="dns-prefetch" href="https://script.googleusercontent.com">

    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #fafafa; }
      header { background:#111; color:#fff; padding:14px 18px; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      h2 { margin: 18px 0 8px; font-size: 18px; }
      table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid #e8e8e8; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
      th { background:#fcfcfc; font-weight: 600; }
      a { color: #0a66c2; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .two { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
      .card { background:#fff; border:1px solid #e8e8e8; border-radius: 10px; padding: 14px; }
      .muted { color:#666; font-size: 12px; }
      .pill { display:inline-block; background:#eef6ff; color:#145aa6; padding:3px 8px; border-radius:999px; font-size:12px; }
      .kvs { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; margin:10px 0 0; }
      .kv { background:#f9fafb; border:1px solid #eee; border-radius:8px; padding:10px; text-align:center; }
      .kv .n { font-weight:700; font-size:18px; }
      .kv .bar { height:4px; border-radius:9999px; background:#eee; margin-top:6px; overflow:hidden; }
      .kv .bar > span { display:block; height:100%; border-radius:9999px; }
      .btn { display:inline-block; padding:8px 12px; border:1px solid #e0e0e0; border-radius:8px; background:#f8f8f8; text-decoration:none; }
      .btn:hover { background:#f0f0f0; }
      .topline { display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .linkish { font-size:12px; color:#0a66c2; cursor:pointer; }
      .back { display:inline-block; margin-bottom:12px; }
      @media (max-width: 900px) { .two { grid-template-columns: 1fr; } .kvs { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>Store Dashboard</h1>
        <div class="muted">Leaderboards & 1on1s</div>
      </div>
    </header>

    <div class="wrap"><div id="nav"></div></div>
    <div class="wrap"><div id="app"></div></div>

    <script>
      /* ====== CONFIG ====== */
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';
      function ts(){ return '&t=' + Date.now(); }
      function qs(id){ return document.getElementById(id); }

      /* ====== (minimal) nav (optional) ====== */
      function renderNav(){ qs('nav').innerHTML = '<div class="muted"><a href="#/">Home</a></div>'; }

      /* ====== person cache (sessionStorage) to keep 1on1 snappy ====== */
      const PERSON_CACHE_TTL_MS = 9 * 60 * 1000;
      function personKey(name, type){ return 'person:' + String(name || '').toUpperCase() + ':' + String(type || ''); }
      function readPersonCache(name, type){
        try{
          const raw = sessionStorage.getItem(personKey(name, type));
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj || !obj.t || (Date.now() - obj.t) > PERSON_CACHE_TTL_MS) { sessionStorage.removeItem(personKey(name, type)); return null; }
          return obj.data;
        }catch(e){ return null; }
      }
      function writePersonCache(name, type, data){ try{ sessionStorage.setItem(personKey(name, type), JSON.stringify({ t:Date.now(), data })); }catch(e){} }

      async function fetchPerson(name, type, opts){
        const useCache = !opts || opts.useCache !== false;
        if (useCache) {
          const cached = readPersonCache(name, type);
          if (cached) return { data: cached, fromCache: true };
        }
        const params = new URLSearchParams({ route:'person', name, type });
        const res = await fetch(GAS_URL + '?' + params.toString() + ts(), { cache:'no-store' });
        const json = await res.json();
        if (json && json.ok) writePersonCache(name, type, json);
        return { data: json, fromCache:false };
      }

      /* ====== API ====== */
      async function apiLeaderboards(){ const r=await fetch(GAS_URL+'?route=leaderboards'+ts(),{cache:'no-store'}); return r.json(); }
      async function apiCallsFor(name){ const u=GAS_URL+'?route=calls_for&name='+encodeURIComponent(name)+ts(); const r=await fetch(u,{cache:'no-store'}); return r.json(); }

      /* ====== HOME ====== */
      function navToPerson(name, type){ location.hash = '#/person/' + encodeURIComponent(String(name||'')) + '/' + encodeURIComponent(String(type||'')); }
      function fillHome(){
        const root=qs('app');
        root.innerHTML = `
          <div class="two">
            <div class="card">
              <h2>Sales Leaderboard <span class="pill">Sales (MTD)</span></h2>
              <table><thead><tr><th>#</th><th>Rep</th><th>Sales</th></tr></thead><tbody id="salesBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody></table>
            </div>
            <div class="card">
              <h2>BDC Leaderboard <span class="pill">Shows (MTD)</span></h2>
              <table><thead><tr><th>#</th><th>Agent</th><th>Shows</th></tr></thead><tbody id="bdcBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody></table>
            </div>
          </div>`;

        apiLeaderboards().then(function(data){
          if(!data || !data.ok) throw new Error(data && data.error || 'API error');

          const sBody=qs('salesBody'); sBody.innerHTML='';
          (data.sales||[]).forEach(function(r,i){
            const tr=document.createElement('tr');
            const tdRank=document.createElement('td'); tdRank.textContent=i+1;
            const tdName=document.createElement('td'); const a=document.createElement('a');
            a.href='#/person/'+encodeURIComponent(r.name)+'/Sales'; a.textContent=r.name||'';
            a.onclick=function(e){ e.preventDefault(); navToPerson(r.name,'Sales'); };
            tdName.appendChild(a);
            const tdSales=document.createElement('td'); tdSales.textContent=(r.sales!=null?r.sales:0);
            tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdSales); sBody.appendChild(tr);
          });

          const bBody=qs('bdcBody'); bBody.innerHTML='';
          (data.bdc||[]).forEach(function(r,i){
            const tr=document.createElement('tr');
            const tdRank=document.createElement('td'); tdRank.textContent=i+1;
            const tdName=document.createElement('td'); const a=document.createElement('a');
            a.href='#/person/'+encodeURIComponent(r.name)+'/BDC'; a.textContent=r.name||'';
            a.onclick=function(e){ e.preventDefault(); navToPerson(r.name,'BDC'); };
            tdName.appendChild(a);
            const tdShows=document.createElement('td'); tdShows.textContent=(r.shows!=null?r.shows:0);
            tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdShows); bBody.appendChild(tr);
          });

          // Prefetch a handful for instant first-clicks
          try{
            const prefetch=[]; (data.sales||[]).slice(0,12).forEach(r=>prefetch.push({name:r.name,type:'Sales'}));
            (data.bdc||[]).slice(0,12).forEach(r=>prefetch.push({name:r.name,type:'BDC'}));
            prefetch.forEach((p,i)=>setTimeout(()=>fetchPerson(p.name,p.type).catch(()=>{}), i*100));
          }catch(e){}
        }).catch(function(e){
          qs('app').innerHTML = '<div class="card">Error: '+(e && e.message ? e.message : String(e))+'</div>';
        });
      }

      /* ====== PERSON (1on1) ====== */
      function pctColor(p){ return p>=100 ? '#16a34a' : (p>=60 ? '#f59e0b' : '#ef4444'); }
      function addBar(el, value, target, isTime){
        if(!target||target<=0) return;
        const wrap=document.createElement('div'); wrap.className='bar';
        const fill=document.createElement('span'); const pct=Math.min(100,(value/target)*100);
        fill.style.width=pct.toFixed(1)+'%'; fill.style.background=pctColor(pct);
        wrap.title='Target: '+(isTime?mssFromSecs(target):target)+' | '+pct.toFixed(0)+'%'; wrap.appendChild(fill); el.appendChild(wrap);
      }
      function kvTile(num,label,target,isTime){ const d=document.createElement('div'); d.className='kv'; const n=document.createElement('div'); n.className='n'; n.textContent=num; d.appendChild(n); const t=document.createElement('div'); t.className='t'; t.textContent=label; d.appendChild(t); addBar(d,isTime?secsFromAny(num):parseFloat(num)||0,target,isTime); return d; }
      function fmt(n,d){ if(n==null||isNaN(n)) return '0'; const f=+n; return (d!=null)?f.toFixed(d):String(f); }
      function safeDiv(n,d){ n=+n||0; d=+d||0; return d>0?(n/d):0; }
      function deriveTargetMTD(key,rt,wd){ const map={sales:'sales',shown:'shown',created:'created',calls:'calls',texts:'texts'}; if(rt.perDay&&rt.perDay[map[key]]!=null){ const per=+rt.perDay[map[key]]||0; return per*(+wd||0);} if(rt.mtd&&rt.mtd[key]!=null) return +rt.mtd[key]||0; return 0; }

      async function renderPerson(name, type){
        const root=qs('app');
        root.innerHTML='<a class="back" href="#/">&larr; Back</a><div class="card"><div class="muted">Loading 1on1…</div></div>';
        try{
          const cached=readPersonCache(name,type);
          if(cached&&cached.ok){ renderPersonBody_(cached); fetchPerson(name,type,{useCache:false}).then(r=>{ if(r&&r.data&&r.data.ok){ writePersonCache(name,type,r.data); renderPersonBody_(r.data);} }).catch(()=>{}); return; }
          const r=await fetchPerson(name,type,{useCache:false}); if(!r||!r.data||!r.data.ok) throw new Error(r&&r.data&&r.data.error||'API error'); renderPersonBody_(r.data);
        }catch(e){ root.innerHTML='<a class="back" href="#/">&larr; Back</a><div class="card">Error: '+(e.message||String(e))+'</div>'; }
      }

      function renderPersonBody_(data){
        const b=data.block||{}, picks=data.picks||{}, over=picks.over||null, under=picks.under||null;
        const role=(b.type||'').toString(), targetsAll=loadTargets(), tgt=targetsAll[role]||targetsAll['Sales'], wd=b.workingDays||0;
        const talkTarget=secsFromAny((tgt.perDay&&tgt.perDay.talkSec)?tgt.perDay.talkSec:0);

        const app=qs('app'); const container=document.createElement('div');

        // Header + "Open Call Sheet" link
        const cardHead=document.createElement('div'); cardHead.className='card';
        const top=document.createElement('div'); top.className='topline';
        const h2=document.createElement('h2'); h2.textContent=(b.name||'')+' '; const pill=document.createElement('span'); pill.className='pill'; pill.textContent=role; h2.appendChild(pill);
        const right=document.createElement('div');
        const linkSheet=document.createElement('a'); linkSheet.className='btn'; linkSheet.href='#/sheet/'+encodeURIComponent(b.name||''); linkSheet.textContent='Open Call Sheet';
        right.appendChild(linkSheet);
        top.appendChild(h2); top.appendChild(right);
        const sub=document.createElement('div'); sub.className='muted'; sub.textContent='Last work day: '+(data.lastWorkDay||'—');
        cardHead.appendChild(top); cardHead.appendChild(sub); container.appendChild(cardHead);

        // MTD
        const cardMTD=document.createElement('div'); cardMTD.className='card';
        const hMTD=document.createElement('h2'); hMTD.textContent='MTD KPIs'; cardMTD.appendChild(hMTD);
        const mtd=document.createElement('div'); mtd.className='kvs';
        const tSales=deriveTargetMTD('sales',tgt,wd), tShown=deriveTargetMTD('shown',tgt,wd), tCreated=deriveTargetMTD('created',tgt,wd),
              tCalls=deriveTargetMTD('calls',tgt,wd), tTexts=deriveTargetMTD('texts',tgt,wd), tDue=deriveTargetMTD('due',tgt,wd);
        mtd.appendChild(kvTile(fmt(b.salesMTD,1),'Sales',tSales,false));
        mtd.appendChild(kvTile(fmt(b.shownMTD,0),'Appts Shown',tShown,false));
        mtd.appendChild(kvTile(fmt(b.createdMTD,0),'Appts Created',tCreated,false));
        mtd.appendChild(kvTile(fmt(b.callsMTD,0),'Calls (MTD)',tCalls,false));
        mtd.appendChild(kvTile(fmt(b.textsMTD,0),'Texts',tTexts,false));
        mtd.appendChild(kvTile(fmt(b.dueMTD,0),'Appts Due',tDue,false));
        mtd.appendChild(kvTile(b.avgTalk||'0:00','Avg Talk',talkTarget,true));
        const kvWD=document.createElement('div'); kvWD.className='kv'; const nWD=document.createElement('div'); nWD.className='n'; nWD.textContent=wd; kvWD.appendChild(nWD);
        const tWD=document.createElement('div'); tWD.className='t'; tWD.textContent='Working Days'; kvWD.appendChild(tWD); mtd.appendChild(kvWD);
        cardMTD.appendChild(mtd); container.appendChild(cardMTD);

        // Per-Day
        const cardPD=document.createElement('div'); cardPD.className='card';
        const hPD=document.createElement('h2'); hPD.textContent='Per-Day KPIs'; cardPD.appendChild(hPD);
        const per=document.createElement('div'); per.className='kvs';
        function perTarget(k){ return (tgt.perDay&&tgt.perDay[k]!=null)?(+tgt.perDay[k]||0):0; }
        per.appendChild(kvTile(fmt(safeDiv(+b.salesMTD,wd),2),'Sales/Day',perTarget('sales'),false));
        per.appendChild(kvTile(fmt(safeDiv(+b.shownMTD,wd),2),'Shown/Day',perTarget('shown'),false));
        per.appendChild(kvTile(fmt(safeDiv(+b.createdMTD,wd),2),'Created/Day',perTarget('created'),false));
        per.appendChild(kvTile(fmt(safeDiv(+b.callsMTD,wd),1),'Calls/Day',perTarget('calls'),false));
        per.appendChild(kvTile(fmt(safeDiv(+b.textsMTD,wd),1),'Texts/Day',perTarget('texts'),false));
        per.appendChild(kvTile(b.avgTalk||'0:00','Avg Talk',talkTarget,true));
        cardPD.appendChild(per); container.appendChild(cardPD);

        // Last Work Day
        const lastDay=data.lastDay||null;
        const cardLW=document.createElement('div'); cardLW.className='card';
        const hLW=document.createElement('h2'); hLW.textContent='Last Work Day KPIs'; cardLW.appendChild(hLW);
        const subLW=document.createElement('div'); subLW.className='muted'; subLW.textContent=lastDay&&lastDay.dateKey?('Date: '+lastDay.dateKey):('Date: '+(data.lastWorkDay||'—')); cardLW.appendChild(subLW);
        const lw=document.createElement('div'); lw.className='kvs';
        const tgtSales=perTarget('sales'), tgtCalls=perTarget('calls');
        lw.appendChild(kvTile(fmt(lastDay&&lastDay.sales!=null?lastDay.sales:0,0),'Sales (Day)',tgtSales,false));
        lw.appendChild(kvTile(fmt(lastDay&&lastDay.calls!=null?lastDay.calls:0,0),'Calls (Day)',tgtCalls,false));
        lw.appendChild(kvTile((lastDay&&lastDay.avgTalkMSS)?lastDay.avgTalkMSS:'0:00','Avg Talk',talkTarget,true));
        cardLW.appendChild(lw); container.appendChild(cardLW);

        // Coaching picks (kept)
        const callsCard=document.createElement('div'); callsCard.className='card';
        const h2b=document.createElement('h2'); h2b.textContent='Call Coaching Picks'; callsCard.appendChild(h2b);
        const lastDayKey=data.lastWorkDay||''; const usedDay=(picks&&picks.usedDate)?picks.usedDate:((over&&over.dateKey)||(under&&under.dateKey)||'');
        const meta=document.createElement('div'); meta.className='muted';
        meta.textContent=(usedDay&&lastDayKey&&usedDay!==lastDayKey)?('Using calls from '+usedDay+' (no recordings on last work day).'):'1 over a minute, 1 under 30 seconds (longest/shortest as fallback)';
        callsCard.appendChild(meta);

        function callBlock(label,pick){ const wrap=document.createElement('div'); wrap.className='call'; const strong=document.createElement('strong'); strong.textContent=label; wrap.appendChild(strong); wrap.appendChild(document.createElement('br')); if(pick){ const span=document.createElement('span'); span.textContent=(pick.dateKey||'')+' — '+(pick.talkMSS||''); wrap.appendChild(span); if(pick.url){ wrap.appendChild(document.createElement('br')); const link=document.createElement('a'); link.href=pick.url; link.target='_blank'; link.rel='noopener'; link.textContent='Play recording'; wrap.appendChild(link);} } else { const none=document.createElement('span'); none.className='muted'; none.textContent='None'; wrap.appendChild(none);} return wrap; }
        callsCard.appendChild(callBlock('Over 1:00', over)); callsCard.appendChild(callBlock('Under 0:30', under));

        app.innerHTML='<a class="back" href="#/">&larr; Back</a>'; app.appendChild(container); app.appendChild(callsCard);
      }

      /* ====== PERSON CALL SHEET (#/sheet/<Name>) ====== */
      async function renderPersonSheet(name){
        const app=qs('app');
        app.innerHTML = `<a class="back" href="#/">&larr; Back</a><div class="card">Loading ${name}'s call sheet…</div>`;
        try{
          const res = await apiCallsFor(name);
          if(!res || !res.ok) throw new Error(res && res.error || 'API error');
          const rows = res.calls || [];
          const wrap = document.createElement('div'); wrap.className='card';
          const h = document.createElement('h2'); h.textContent = `${name} — Call Sheet`; wrap.appendChild(h);

          const tbl = document.createElement('table');
          tbl.innerHTML = `
            <thead>
              <tr>
                <th>Customer</th><th>Phone</th><th>Email</th><th>Source</th><th>Date In</th>
                <th>Lead Age</th><th>Days Since</th><th>Bucket</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="sheetBody"></tbody>`;
          wrap.appendChild(tbl);
          app.innerHTML = `<a class="back" href="#/">&larr; Back</a>`;
          app.appendChild(wrap);

          const tb = qs('sheetBody');
          if (!rows.length){
            const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=9; td.className='muted'; td.textContent='No calls found.'; tr.appendChild(td); tb.appendChild(tr);
          } else {
            rows.forEach(function(r){
              const tr=document.createElement('tr');
              const tdName=document.createElement('td');
              if (r.link) { const a=document.createElement('a'); a.href=r.link; a.target='_blank'; a.rel='noopener'; a.textContent=r.name||''; tdName.appendChild(a); }
              else tdName.textContent = r.name || '';
              tr.appendChild(tdName);

              function tdv(v){ const td=document.createElement('td'); td.textContent = v || ''; return td; }
              tr.appendChild(tdv(r.phone)); tr.appendChild(tdv(r.email));
              tr.appendChild(tdv(r.source)); tr.appendChild(tdv(r.dateIn));
              tr.appendChild(tdv(r.leadAge)); tr.appendChild(tdv(r.daysSince));
              tr.appendChild(tdv(r.bucket));  tr.appendChild(tdv(r.status));
              tb.appendChild(tr);
            });
          }
        } catch(e){
          app.innerHTML = `<a class="back" href="#/">&larr; Back</a><div class="card">Error: ${(e.message || String(e))}</div>`;
        }
      }

      /* ====== Router ====== */
      function route(){
        renderNav();
        const hash=location.hash||'#/';
        const parts=hash.slice(2).split('/');
        if(parts[0]==='' || parts[0]==='home') fillHome();
        else if(parts[0]==='person') renderPerson(decodeURIComponent(parts[1]||''), parts[2]||'');
        else if(parts[0]==='sheet')  renderPersonSheet(decodeURIComponent(parts[1]||''));
        else fillHome();
      }
      window.addEventListener('hashchange', route);
      route();
    </script>
  </body>
</html>
