<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Performance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .leaderboard-section {
            padding: 30px;
        }
        
        .leaderboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .leaderboard-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .leaderboard-card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: #e8eaf6;
            transform: translateX(5px);
        }
        
        .rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background: #9ca3af;
        }
        
        .rank.gold { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .rank.silver { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); }
        .rank.bronze { background: linear-gradient(135deg, #cd7f32, #e4a853); }
        
        .name {
            flex: 1;
            margin-left: 15px;
            font-weight: 500;
            color: #333;
        }
        
        .score {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .login-container h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .admin-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .logout-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .user-list {
            margin-top: 20px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .leaderboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
    </div>
    
    <div id="app"></div>
    
    <!-- User Management Modal (REPLACE ENTIRE BLOCK) -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>User Management</h2>
      <button class="modal-close" onclick="closeUserModal()">&times;</button>
    </div>

    <div class="form-group">
      <h3>Add New User</h3>
      <input type="email" id="newUserEmail" placeholder="Email address">
      <input type="password" id="newUserPassword" placeholder="Password" style="margin-top:10px;">
      <input type="text" id="newUserLinked" placeholder='Linked Sheet Name (e.g., "JASMINE VASQUEZ")' style="margin-top:10px;">
      <select id="newUserRole" style="width:100%;padding:12px;margin-top:10px;border:1px solid #ddd;border-radius:8px;">
        <option value="user">User</option>
        <option value="manager">Manager</option>
        <option value="admin">Admin</option>
      </select>
      <button class="btn" style="margin-top:10px;" onclick="addUser()">Add User</button>
    </div>

    <div class="user-list" id="userList">
      <h3>Existing Users</h3>
      <div id="userListContent"></div>
    </div>
  </div>
</div>


    <!-- Firebase Configuration and Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs,
            collection,
            deleteDoc 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Firebase configuration - store-dashboard-2270e project
        const firebaseConfig = {
            apiKey: "AIzaSyC74YFnCKeO5TjmPa4H4BMm_pFwohOVAX4",
            authDomain: "store-dashboard-2025.firebaseapp.com",
            projectId: "store-dashboard-2025",
            storageBucket: "store-dashboard-2025.firebasestorage.app",
            messagingSenderId: "556566448299",
            appId: "1:556566448299:web:a2cbe4dda5d21fc6c5cfee",
            measurementId: "G-0D5JMNGE4S"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Google Apps Script Web App URL - YOUR ACTUAL URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';
        /* === ACCESS HELPERS & SESSION (ADD THIS ONCE) === */
const SUPERADMIN_EMAIL = 'your@email.com';   // <-- set this to YOU (the only superadmin)

/** Build Authorization header for Apps Script (expects base64-JSON token). */
function authHeaders() {
  return window.sessionToken ? { Authorization: `Bearer ${window.sessionToken}` } : {};
}

/** Role checks */
function isAdmin()   { return window.userData?.role === 'admin' || window.userData?.role === 'superadmin'; }
function isManager() { return window.userData?.role === 'manager'; }

/** Can the current user open this person's detail/call sheet? */
function canViewName(targetName) {
  const n = (targetName || '').toUpperCase();
  const mine = (window.userData?.linkedName || '').toUpperCase();
  if (isAdmin() || isManager()) return true;
  return mine && n === mine;  // users only see themselves
}

/** Create a simple frontend session token the backend already understands */
function makeSessionToken({ name, role }) {
  // Backend uses Utilities.base64Decode on a plain base64 JSON payload:contentReference[oaicite:3]{index=3}
  const payload = { name, role };
  return btoa(JSON.stringify(payload));
}

        // Global variables
        window.userData = null;
        window.dashboardData = null;
        
        // Make functions available globally
        window.login = login;
        window.logout = logout;
        window.showUserModal = showUserModal;
        window.closeUserModal = closeUserModal;
        window.addUser = addUser;
        window.deleteUser = deleteUser;
        window.showPersonDetails = showPersonDetails;
        window.showDashboard = showDashboard;
        window.viewCallSheets = viewCallSheets;
        window.editPersonData = editPersonData;
        
        // Authentication state observer
        // Authentication state observer (REPLACE ENTIRE BLOCK)
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.userData = null;
    showLogin();
    return;
  }

  // Get Firestore user record (role + linkedName)
  const userRef = doc(db, 'users', user.uid);
  let snap = await getDoc(userRef);
  if (!snap.exists()) {
    // First-time login: create a record (default user)
    await setDoc(userRef, {
      email: user.email,
      role: user.email === 'admin@dashboard.com' ? 'admin' : 'user',
      linkedName: '',                 // will be filled by Admin in Manage Users
      createdAt: new Date()
    });
    snap = await getDoc(userRef);
  }

  const data = snap.data() || {};
  let role = data.role || 'user';

  // Auto-ensure YOU are the only superadmin
  if (user.email === SUPERADMIN_EMAIL && role !== 'superadmin') {
    role = 'superadmin';
    await setDoc(userRef, { ...data, role }, { merge: true });
  }

  window.userData = {
    email: user.email,
    uid: user.uid,
    role,
    linkedName: data.linkedName || '',
    isAdmin: role === 'admin' || role === 'superadmin',
    isManager: role === 'manager'
  };

  // Build a frontend session token the Apps Script will accept
  // Important: use linkedName as "name" so backend self-scope matches sheet names:contentReference[oaicite:4]{index=4}
  const sessionName = window.userData.linkedName || window.userData.email;
  window.sessionToken = makeSessionToken({ name: sessionName, role });

  showDashboard();
});

        
        // Login function
async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    console.log('Attempting login with:', email);
    
    try {
        showLoading(true);
        
        // Step 1: Authenticate with Firebase Auth
        console.log('Step 1: Authenticating...');
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log('✅ Authentication successful!', userCredential.user.uid);
        
        // Step 2: Try to get user data from Firestore
        console.log('Step 2: Getting user role from Firestore...');
        const userDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
        
        if (!userDoc.exists()) {
            console.error('❌ User document does not exist in Firestore!');
            console.log('Creating missing Firestore document...');
            
            // CREATE THE MISSING DOCUMENT
            await setDoc(doc(db, 'users', userCredential.user.uid), {
                email: email,
                role: email === 'admin@dashboard.com' ? 'admin' : 'user',
                createdAt: new Date()
            });
            
            console.log('✅ Created Firestore document');
            
            // Now get it again
            const newUserDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
            const userData = newUserDoc.data();
            
            window.userData = {
                email: userCredential.user.email,
                uid: userCredential.user.uid,
                role: userData?.role || 'user',
                isAdmin: userData?.role === 'admin'
            };
        } else {
            console.log('✅ User document found in Firestore');
            const userData = userDoc.data();
            console.log('User data:', userData);
            
            window.userData = {
                email: userCredential.user.email,
                uid: userCredential.user.uid,
                role: userData?.role || 'user',
                isAdmin: userData?.role === 'admin'
            };
        }
        
        console.log('✅ Login complete, showing dashboard...');
        showDashboard();
        
    } catch (error) {
        console.error('❌ Login error:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        
        if (error.code === 'auth/wrong-password') {
            document.getElementById('error-message').textContent = 'Wrong password';
        } else if (error.code === 'auth/user-not-found') {
            document.getElementById('error-message').textContent = 'User not found';
        } else if (error.code === 'auth/invalid-email') {
            document.getElementById('error-message').textContent = 'Invalid email format';
        } else {
            document.getElementById('error-message').textContent = 'Error: ' + error.message;
        }
    } finally {
        showLoading(false);
    }
}
        
        // Logout function
        async function logout() {
            try {
                await signOut(auth);
                window.userData = null;
                showLogin();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Show dashboard (REPLACE ENTIRE FUNCTION)
async function showDashboard() {
  if (!window.userData) { showLogin(); return; }

  try {
    showLoading(true);
    const resp = await fetch(`${SCRIPT_URL}?route=leaderboards`, { headers: authHeaders() });
    const result = await resp.json();

    if (!result.ok) throw new Error(result.error || 'Failed to load leaderboards');

    window.dashboardData = result; // { sales: [...], bdc: [...] }
    renderDashboard(result);

  } catch (err) {
    console.error('Dashboard error:', err);
    document.getElementById('app').innerHTML = `
      <div class="container">
        <div style="padding: 50px; text-align: center; color: red;">
          <h2>Error Loading Dashboard</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="max-width: 200px; margin: 20px auto;">Retry</button>
        </div>
      </div>
    `;
  } finally {
    showLoading(false);
  }
}

        
        // Render dashboard (REPLACE ENTIRE FUNCTION)
function renderDashboard(data) {
  const salesLB = (data.sales || []).slice(0, 10);
  const bdcLB   = (data.bdc   || []).slice(0, 10);

  const me = window.userData || {};

  function rowHTML(person, index, type) {
    const name = person.name || '';
    const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
    const allowed = canViewName(name);

    const clickAttr = allowed ? `onclick="showPersonDetails('${name.replace(/'/g, "\\'")}', '${type}')"` : '';
    const style = allowed ? '' : 'opacity:0.6; cursor:not-allowed;';

    const right = type === 'Sales'
      ? `${person.sales || 0} Sales`
      : `${person.shows || 0} Shows`;

    return `
      <div class="leaderboard-item" ${clickAttr} style="${style}">
        <div class="rank ${rankClass}">${index + 1}</div>
        <div class="name">${name}</div>
        <div class="score">${right}</div>
      </div>
    `;
  }

  document.getElementById('app').innerHTML = `
    <div class="container">
      <div class="header"><h1>Store Performance Dashboard</h1></div>

      <div class="user-info">
        <div>
          Welcome, <strong>${me.email}</strong>
          ${isAdmin() ? '<span style="color: green;">(Admin)</span>' : (isManager() ? '<span style="color: #0ea5e9;">(Manager)</span>' : '')}
          ${me.linkedName ? ` • Linked: <strong>${me.linkedName}</strong>` : ''}
        </div>
        <div>
          ${isAdmin() ? '<button class="admin-btn" onclick="showUserModal()">User Management</button>' : ''}
          <button class="logout-btn" onclick="logout()" style="margin-left: 10px;">Logout</button>
        </div>
      </div>

      <div class="leaderboard-section">
        <div id="content">
          <div class="leaderboard-grid">
            <div class="leaderboard-card">
              <h2>🏆 Sales Leaderboard</h2>
              ${salesLB.length ? salesLB.map((p, i) => rowHTML(p, i, 'Sales')).join('') : '<p style="text-align:center;color:#999;">No sales data</p>'}
            </div>
            <div class="leaderboard-card">
              <h2>📞 BDC Leaderboard</h2>
              ${bdcLB.length ? bdcLB.map((p, i) => rowHTML(p, i, 'BDC')).join('') : '<p style="text-align:center;color:#999;">No BDC data</p>'}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

        
        // Person "1on1" page (REPLACE ENTIRE FUNCTION)
async function showPersonDetails(name, type) {
  try {
    showLoading(true);

    const resp = await fetch(`${SCRIPT_URL}?route=person&name=${encodeURIComponent(name)}`, {
      headers: authHeaders()
    });
    const result = await resp.json();
    if (!result.ok) throw new Error(result.error || 'Failed to load person details');

    const data = result.data;

    // (same pretty UI as before—trimmed for space; you already had this layout)
    // Keep your existing HTML building here; only the fetch/headers changed.
    // For completeness, we’ll reuse your prior HTML with no logic changes:

    let detailsHTML = `
      <div style="max-width: 900px; margin: 0 auto;">
        <button onclick="showDashboard()" style="
          background:#6B7280;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin-bottom:20px;font-size:14px;">
          ← Back to Leaderboard
        </button>

        <h1 style="text-align:center;color:#1F2937;margin-bottom:10px;">${data.name || name}</h1>
        <p style="text-align:center;color:#6B7280;margin-bottom:30px;">${data.type || type} • ${data.workingDays || 0} assigned calls</p>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;">
          <div style="text-align:center;">
            <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Total Calls</div>
            <div style="font-size:36px;font-weight:bold;color:#1F2937;">${data.calls || 0}</div>
          </div>

          ${data.type === 'Sales' ? `
            <div style="text-align:center;">
              <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Sales MTD</div>
              <div style="font-size:36px;font-weight:bold;color:#1F2937;">${data.sales || 0}</div>
            </div>
            <div style="text-align:center;">
              <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Sales/Day</div>
              <div style="font-size:36px;font-weight:bold;color:#1F2937;">${data.salesPerDay ? data.salesPerDay.toFixed(1) : '0'}</div>
            </div>
          ` : `
            <div style="text-align:center;">
              <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Appts Shown</div>
              <div style="font-size:36px;font-weight:bold;color:#1F2937;">${data.apptsShown || 0}</div>
            </div>
            <div style="text-align:center;">
              <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Appts Created</div>
              <div style="font-size:36px;font-weight:bold;color:#1F2937;">${data.apptsCreated || 0}</div>
            </div>
          `}

          <div style="text-align:center;">
            <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Working Days</div>
            <div style="font-size:36px;font-weight:bold;color:#1F2937;">${data.workingDays || 0}</div>
          </div>
          <div style="text-align:center;">
            <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Texts</div>
            <div style="font-size:36px;font-weight:bold;color:#1F2937;">${data.texts || 0}</div>
          </div>
        </div>

        <div style="text-align:center;margin-bottom:30px;">
          <div style="color:#6B7280;font-size:14px;margin-bottom:5px;">Avg Talk Time</div>
          <div style="font-size:48px;font-weight:bold;color:#1F2937;">${data.avgTalk || '0:00'}</div>
        </div>

        <!-- (rest of your Additional Metrics / Performance Notes sections unchanged) -->

        <div style="display:flex;gap:15px;justify-content:center;margin-top:30px;">
          <button onclick="viewCallSheets('${name.replace(/'/g, "\\'")}')" style="
            background:#3B82F6;color:#fff;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:500;
            box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all .2s;" onmouseover="this.style.background='#2563EB'" onmouseout="this.style.background='#3B82F6'">
            📊 View Call Sheets
          </button>

          ${isAdmin() ? `
          <button onclick="editPersonData('${name.replace(/'/g, "\\'")}')" style="
            background:#10B981;color:#fff;border:none;padding:15px 30px;border-radius:8px;cursor:pointer;font-size:16px;font-weight:500;
            box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all .2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10B981'">
            ✏️ Edit Performance Data
          </button>` : ''}
        </div>
      </div>
    `;

    document.getElementById('content').innerHTML = detailsHTML;

  } catch (error) {
    console.error('Error loading person details:', error);
    document.getElementById('content').innerHTML = `
      <div style="text-align:center;padding:50px;color:#DC2626;">
        <h2>Error Loading Details</h2>
        <p>${error.message}</p>
        <button onclick="showDashboard()" style="
          margin-top:20px;background:#6B7280;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Back to Dashboard</button>
      </div>
    `;
  } finally {
    showLoading(false);
  }
}

        
       // View Call Sheets (REPLACE ENTIRE FUNCTION)
async function viewCallSheets(name) {
  try {
    showLoading(true);

    const resp = await fetch(`${SCRIPT_URL}?route=calls_for&name=${encodeURIComponent(name)}`, {
      headers: authHeaders()
    });
    const result = await resp.json();
    if (!result.ok) throw new Error(result.error || 'Failed to load call sheets');

    const data = result.data;

    const callRows = (data.calls || []).map(call => `
      <tr style="border-top:1px solid #E5E7EB;">
        <td style="padding:12px;">${call.date || '-'}</td>
        <td style="padding:12px;">${call.time || '-'}</td>
        <td style="padding:12px;">${call.duration || '-'}</td>
        <td style="padding:12px;">${call.number || '-'}</td>
        <td style="padding:12px;">${call.notes || '-'}</td>
      </tr>
    `).join('');

    document.getElementById('content').innerHTML = `
      <div style="max-width:1200px;margin:0 auto;">
        <button onclick="showPersonDetails('${name.replace(/'/g, "\\'")}')" style="
          background:#6B7280;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin-bottom:20px;">
          ← Back to ${name}
        </button>

        <h1 style="text-align:center;color:#1F2937;margin-bottom:30px;">Call Sheets - ${name}</h1>

        <div style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#F3F4F6;">
                <th style="padding:12px;text-align:left;font-weight:600;">Date</th>
                <th style="padding:12px;text-align:left;font-weight:600;">Time</th>
                <th style="padding:12px;text-align:left;font-weight:600;">Duration</th>
                <th style="padding:12px;text-align:left;font-weight:600;">Number</th>
                <th style="padding:12px;text-align:left;font-weight:600;">Notes</th>
              </tr>
            </thead>
            <tbody>
              ${data.calls && data.calls.length ? callRows : `
                <tr><td colspan="5" style="padding:40px;text-align:center;color:#6B7280;">No call data available</td></tr>
              `}
            </tbody>
          </table>
        </div>
      </div>
    `;

  } catch (error) {
    console.error('Error loading call sheets:', error);
    alert('Failed to load call sheets: ' + error.message);
  } finally {
    showLoading(false);
  }
}

        
        // Helper function for editing (admin only)
        function editPersonData(name) {
            alert('Edit functionality coming soon for: ' + name);
            // Implement edit functionality as needed
        }
        
        // User management functions
        async function showUserModal() {
            if (!window.userData?.isAdmin) return;
            
            document.getElementById('userModal').style.display = 'flex';
            await loadUsers();
        }
        
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }
        
// Show modal already calls loadUsers(); keep showUserModal/closeUserModal as-is.

// Load users (REPLACE)
async function loadUsers() {
  try {
    const usersSnapshot = await getDocs(collection(db, 'users'));
    let html = '';

    usersSnapshot.forEach((docu) => {
      const u = docu.data();
      const email = u.email || '';
      const role = u.role || 'user';
      const linked = u.linkedName || '';
      const isSelf = email === window.userData.email;

      // Deletion rules:
      // - Cannot delete yourself
      // - Cannot delete admin/superadmin
      const canDelete = isAdmin() && !isSelf && role !== 'admin' && role !== 'superadmin' && email !== SUPERADMIN_EMAIL;

      html += `
        <div class="user-item">
          <div>
            <div>${email}</div>
            <small>Role: <strong>${role}</strong>${role==='superadmin' ? ' 👑' : ''} ${linked ? `• Linked: ${linked}` : ''}</small>
          </div>
          ${canDelete
            ? `<button class="delete-btn" onclick="deleteUser('${docu.id}', '${role}', '${email}')">Delete</button>`
            : `<span style="color:#666;">${isSelf ? 'Current User' : (role==='superadmin' || role==='admin' ? 'Protected' : '')}</span>`
          }
        </div>
      `;
    });

    document.getElementById('userListContent').innerHTML = html || '<p>No users found</p>';
  } catch (e) {
    console.error('Error loading users:', e);
    document.getElementById('userListContent').innerHTML = '<p style="color:red;">Failed to load users.</p>';
  }
}

// Add user (REPLACE)
async function addUser() {
  const email = document.getElementById('newUserEmail').value.trim();
  const password = document.getElementById('newUserPassword').value.trim();
  const role = document.getElementById('newUserRole').value;
  const linkedName = document.getElementById('newUserLinked').value.trim();

  if (!isAdmin()) { alert('Only admins can add users.'); return; }
  if (!email || !password) { alert('Please enter email and password'); return; }
  if (role === 'superadmin') { alert('Superadmin cannot be created here.'); return; }

  try {
    showLoading(true);

    const cred = await createUserWithEmailAndPassword(auth, email, password);
    await setDoc(doc(db, 'users', cred.user.uid), {
      email, role, linkedName,
      createdAt: new Date(),
      createdBy: window.userData.email
    });

    // Clear form
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserLinked').value = '';
    document.getElementById('newUserRole').value = 'user';

    await loadUsers();
    alert('User added successfully!');
  } catch (error) {
    console.error('Error adding user:', error);
    alert('Error adding user: ' + error.message);
  } finally {
    showLoading(false);
  }
}

// Delete user (REPLACE)
async function deleteUser(uid, role, email) {
  if (!isAdmin()) { alert('Only admins can delete users.'); return; }
  if (role === 'admin' || role === 'superadmin' || email === SUPERADMIN_EMAIL) {
    alert('You cannot delete admins or the superadmin.'); return;
  }
  if (!confirm('Are you sure you want to delete this user?')) return;

  try {
    showLoading(true);
    await deleteDoc(doc(db, 'users', uid));
    await loadUsers();
    alert('User deleted successfully!');
  } catch (error) {
    console.error('Error deleting user:', error);
    alert('Error deleting user: ' + error.message);
  } finally {
    showLoading(false);
  }
}

        
        // Helper functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
