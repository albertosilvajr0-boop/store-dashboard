<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="theme-color" content="#1c1917"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="SA Dashboard"/>
<link rel="manifest" href="/manifest.json"/>
<link rel="apple-touch-icon" href="/San-Antonio-CDJR-logo-192x192.png"/>
<title>BDC &amp; Sales Leaderboards</title>

<style>
/* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
:root {
  --bg: #fafaf9;
  --card: #ffffff;
  --text: #1a1a1a;
  --muted: #71717a;
  --line: #e4e4e7;
  --green: #16a34a;
  --greenBg: #dcfce7;
  --yellow: #ca8a04;
  --yellowBg: #fef9c3;
  --red: #dc2626;
  --redBg: #fee2e2;
  --gray: #a1a1aa;
  --grayBg: #f4f4f5;
  --chipBg: #f4f4f5;
  --chipOn: #f97316;
  --chipOnText: #fff;
  --header: #1c1917;
  --headerText: #fafaf9;
  --accent: #ea580c;
}

*, *::before, *::after { box-sizing: border-box; }
html, body {
  height: 100%; margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ Scrollbar styling ‚îÄ‚îÄ */
.table-card::-webkit-scrollbar { height: 6px; }
.table-card::-webkit-scrollbar-track { background: var(--line); border-radius: 3px; }
.table-card::-webkit-scrollbar-thumb { background: #a1a1aa; border-radius: 3px; }
.table-card::-webkit-scrollbar-thumb:hover { background: #71717a; }
.detail-card::-webkit-scrollbar { height: 6px; }
.detail-card::-webkit-scrollbar-track { background: var(--line); border-radius: 3px; }
.detail-card::-webkit-scrollbar-thumb { background: #a1a1aa; border-radius: 3px; }

/* ‚îÄ‚îÄ Watermark ‚îÄ‚îÄ */
body::before {
  content: "";
  position: fixed; inset: 0;
  pointer-events: none; z-index: 0;
  background-image: url("sa-watermark.png");
  background-repeat: repeat;
  background-size: 300px auto;
  opacity: .07;
  filter: grayscale(100%) contrast(120%);
}

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.wrap { position: relative; z-index: 1; max-width: 1440px; margin: 0 auto; padding: 16px 20px 40px; }

/* ‚îÄ‚îÄ Top Header Bar ‚îÄ‚îÄ */
.topbar {
  display: flex; align-items: center; gap: 14px;
  background: var(--header); color: var(--headerText);
  border-radius: 14px; padding: 14px 20px;
  margin-bottom: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,.15);
}
.topbar-logo {
  width: 42px; height: 42px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), #fb923c);
  display: grid; place-items: center;
  font-size: 20px; font-weight: 800; color: #fff;
  flex-shrink: 0;
}
.topbar-info { flex: 1; min-width: 0; }
.topbar-title { font-size: 18px; font-weight: 700; letter-spacing: .2px; }
.topbar-sub { font-size: 12px; color: #a8a29e; margin-top: 2px; }
.topbar-actions { display: flex; gap: 8px; flex-shrink: 0; }
.topbar-btn {
  padding: 9px 16px; border-radius: 8px; border: none;
  font-weight: 600; font-size: 13px; cursor: pointer; white-space: nowrap;
  transition: filter .15s;
}
.topbar-btn:hover { filter: brightness(1.1); }
.topbar-btn.manage { background: #3f3f46; color: #fafaf9; }
.topbar-btn.logout  { background: #ef4444; color: #fff; }

/* ‚îÄ‚îÄ Two-Panel Grid ‚îÄ‚îÄ */
.panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  align-items: start;
}
.panels > div {
  min-width: 0; /* prevent grid blowout from wide tables */
}
@media (max-width: 1024px) {
  .panels { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
  .wrap { padding: 10px 12px 30px; }
  .topbar { flex-wrap: wrap; gap: 10px; padding: 12px 14px; border-radius: 10px; }
  .topbar-info { min-width: 0; flex-basis: calc(100% - 56px); }
  .topbar-actions { width: 100%; justify-content: flex-end; }
  .topbar-title { font-size: 16px; }
  .stat-row { gap: 6px; }
  .stat-card { min-width: 80px; padding: 8px 10px; }
  .stat-value { font-size: 18px; }
  .stat-label { font-size: 10px; }
  .panel-title { font-size: 15px; }
}
@media (max-width: 480px) {
  .topbar-btn { padding: 7px 10px; font-size: 12px; }
  .stat-value { font-size: 16px; }
  .stat-value.top-performer { font-size: 13px; }
  .login-container { margin: 8vh 12px; padding: 20px; }
}

/* ‚îÄ‚îÄ Panel ‚îÄ‚îÄ */
.panel-header { margin-bottom: 6px; }
.panel-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
.panel-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }

/* ‚îÄ‚îÄ Stat Cards ‚îÄ‚îÄ */
.stat-row {
  display: flex; gap: 10px; margin: 10px 0 8px;
  flex-wrap: wrap;
}
.stat-card {
  flex: 1; min-width: 100px;
  border: 1px solid var(--line); border-radius: 10px;
  padding: 10px 12px;
  background: var(--card);
}
.stat-label { font-size: 11px; color: var(--muted); font-weight: 500; display: flex; align-items: center; gap: 4px; }
.stat-value { font-size: 22px; font-weight: 800; margin-top: 2px; color: var(--text); }
.stat-value.top-performer { font-size: 15px; font-weight: 700; line-height: 1.3; }

/* ‚îÄ‚îÄ Time Filter Chips ‚îÄ‚îÄ */
.chip-row { display: flex; gap: 6px; margin: 8px 0 6px; align-items: center; }
.chip {
  padding: 5px 12px; border-radius: 999px; font-size: 12px; font-weight: 600;
  cursor: pointer; user-select: none; border: 1px solid var(--line);
  background: var(--chipBg); color: var(--text);
  transition: all .15s;
}
.chip.active { background: var(--chipOn); color: var(--chipOnText); border-color: transparent; }
.chip:hover:not(.active) { background: #e4e4e7; }

/* ‚îÄ‚îÄ KPI Legend (Sales) ‚îÄ‚îÄ */
.kpi-legend { display: flex; gap: 12px; margin: 4px 0 8px; font-size: 11px; color: var(--muted); flex-wrap: wrap; }
.kpi-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 3px; vertical-align: middle; }
.kpi-dot.green  { background: var(--green); }
.kpi-dot.yellow { background: var(--yellow); }
.kpi-dot.gray   { background: var(--gray); }
.kpi-dot.red    { background: var(--red); }

/* ‚îÄ‚îÄ Table Card ‚îÄ‚îÄ */
.table-card {
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 12px;
  overflow-x: auto;
  overflow-y: visible;
  -webkit-overflow-scrolling: touch;
  box-shadow: 0 2px 8px rgba(0,0,0,.04);
}
.table-card table {
  width: 100%; min-width: 620px; border-collapse: collapse;
}
.table-card th {
  padding: 9px 6px; font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .4px; color: var(--muted); background: #fafaf9;
  border-bottom: 2px solid var(--line);
  cursor: pointer; user-select: none; white-space: nowrap;
  position: relative;
}
.table-card th:hover { color: var(--text); }
.table-card th .sort-arrow { font-size: 10px; margin-left: 2px; opacity: .5; }
.table-card th.sorted .sort-arrow { opacity: 1; color: var(--accent); }

.table-card td {
  padding: 8px 6px; font-size: 13px; text-align: center;
  border-bottom: 1px solid #f4f4f5;
}
.table-card tr:last-child td { border-bottom: none; }
.table-card tr.top3 { background: #fffbeb; }
.table-card .rank-cell { width: 32px; text-align: center; }
.table-card .name-cell { text-align: left; font-weight: 600; white-space: nowrap; }
.table-card .trophy { font-size: 14px; margin-right: 4px; }

/* ‚îÄ‚îÄ KPI Cell Colors ‚îÄ‚îÄ */
.kpi-green  { background: var(--greenBg);  color: var(--green);  font-weight: 700; }
.kpi-yellow { background: var(--yellowBg); color: var(--yellow); font-weight: 700; }
.kpi-red    { background: var(--redBg);    color: var(--red);    font-weight: 700; }
.kpi-gray   { background: var(--grayBg);   color: var(--gray);   font-weight: 600; }
.kpi-none   { color: var(--muted); }

/* ‚îÄ‚îÄ Sales primary column highlight ‚îÄ‚îÄ */
.sales-primary { font-weight: 800; font-size: 14px; }

/* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
.login-container {
  max-width: 400px; margin: 14vh auto; background: var(--card);
  border-radius: 16px; padding: 28px; box-shadow: 0 12px 36px rgba(0,0,0,.12);
  position: relative; z-index: 1;
}
.login-container h2 { margin: 0 0 10px; text-align: center; }
.form-group { margin-top: 12px; display: flex; flex-direction: column; gap: 6px; }
.form-group input, .form-group select { padding: 12px; border: 1px solid var(--line); border-radius: 10px; font-size: 15px; }
.btn {
  display: inline-block; padding: 12px 18px; border-radius: 10px; border: none;
  background: var(--header); color: #fff; font-weight: 600; cursor: pointer;
  text-align: center; text-decoration: none; font-size: 14px;
  transition: filter .15s;
}
.btn:hover { filter: brightness(1.15); }
.btn:disabled { opacity: .5; cursor: not-allowed; }

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.45); place-items: center; z-index: 50; }
.modal-content { width: min(720px, 92vw); max-height: 85vh; overflow-y: auto; background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 12px 32px rgba(0,0,0,.25); }
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.modal-close { background: transparent; border: none; font-size: 26px; cursor: pointer; line-height: 1; }
.user-list .user-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
.delete-btn { background: #ef4444; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }

/* ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ */
.activity-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }

/* ‚îÄ‚îÄ Reassignment Page ‚îÄ‚îÄ */
.reassign-stats { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
.reassign-stat { background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 12px 18px; min-width: 120px; }
.reassign-stat .stat-label { font-size: 11px; color: var(--muted); font-weight: 500; }
.reassign-stat .stat-value { font-size: 20px; font-weight: 800; margin-top: 2px; }
.days-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; min-width: 28px; text-align: center; }
.days-3  { background: #fef9c3; color: #854d0e; }
.days-4  { background: #fef3c7; color: #92400e; }
.days-5  { background: #fed7aa; color: #9a3412; }
.days-6  { background: #fecaca; color: #991b1b; }
.days-7  { background: #fca5a5; color: #7f1d1d; }
.days-8  { background: #ef4444; color: #fff; }
.days-9p { background: #dc2626; color: #fff; }
.reassign-link { color: var(--accent); text-decoration: none; font-weight: 600; }
.reassign-link:hover { text-decoration: underline; }
.reassign-sheet-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: #f0f0f0; color: #555; }

/* ‚îÄ‚îÄ News Page ‚îÄ‚îÄ */
.news-card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 16px 18px; margin-bottom: 10px; transition: box-shadow .15s; }

/* ‚îÄ‚îÄ Resources Dropdown ‚îÄ‚îÄ */
.res-link { display:block;padding:9px 16px;color:var(--text);text-decoration:none;font-size:13px;font-weight:500;white-space:nowrap;transition:background .12s; }
.res-link:hover { background:#f4f4f5; }
.custom-link-wrap { display:flex;align-items:center;gap:0; }
.custom-link-wrap .res-link { flex:1;overflow:hidden;text-overflow:ellipsis; }
.custom-link-del { background:none;border:none;color:#dc2626;font-size:14px;cursor:pointer;padding:6px 10px;opacity:0.4;transition:opacity .15s; }
.custom-link-del:hover { opacity:1; }
th[draggable="true"] { cursor:grab; user-select:none; position:relative; }
th[draggable="true"]:active { cursor:grabbing; }
th[draggable="true"]::after { content:'‚†ø'; position:absolute; top:2px; right:2px; font-size:8px; color:var(--muted); opacity:0.4; }
th[draggable="true"]:hover { background:rgba(59,130,246,.08); }
.news-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,.08); }
.news-title { font-size: 15px; font-weight: 700; line-height: 1.4; }
.news-title a { color: var(--text); text-decoration: none; }
.news-title a:hover { color: var(--accent); text-decoration: underline; }
.news-meta { display: flex; gap: 12px; margin-top: 6px; font-size: 12px; color: var(--muted); flex-wrap: wrap; }
.news-source { background: #f0f0f0; padding: 2px 8px; border-radius: 6px; font-weight: 600; font-size: 11px; }
.activity-item:last-child { border-bottom: none; }
.activity-name { font-weight: 600; font-size: 14px; }
.activity-email { color: var(--muted); font-size: 12px; }
.activity-time { text-align: right; white-space: nowrap; }
.activity-time .time-main { font-size: 14px; font-weight: 500; }
.activity-time .time-sub { color: var(--muted); font-size: 11px; }
.activity-status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }
.status-recent { background: #22c55e; }
.status-stale  { background: #f59e0b; }
.status-old    { background: #ef4444; }
.status-never  { background: #d1d5db; }

/* ‚îÄ‚îÄ Person Detail Card ‚îÄ‚îÄ */
.detail-card {
  background: var(--card); border-radius: 14px; padding: 24px;
  border: 1px solid var(--line);
  box-shadow: 0 2px 12px rgba(0,0,0,.06);
  overflow-x: auto;
}

/* ‚îÄ‚îÄ Loading Spinner ‚îÄ‚îÄ */
.loading-wrap {
  display: flex; align-items: center; justify-content: center;
  min-height: 300px;
}
.spinner {
  width: 36px; height: 36px; border: 3px solid var(--line);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ Auto-refresh countdown ‚îÄ‚îÄ */
.refresh-dot {
  width: 6px; height: 6px; border-radius: 50%; background: #22c55e;
  display: inline-block; margin-right: 4px; animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }

/* ‚îÄ‚îÄ Team Chat ‚îÄ‚îÄ */
.chat-fab {
  position: fixed; bottom: 24px; right: 24px; z-index: 9000;
  width: 56px; height: 56px; border-radius: 50%; border: none;
  background: linear-gradient(135deg, var(--accent), #fb923c);
  color: #fff; font-size: 24px; cursor: pointer;
  box-shadow: 0 4px 16px rgba(0,0,0,.25);
  display: flex; align-items: center; justify-content: center;
  transition: transform .15s, box-shadow .15s;
}
.chat-fab:hover { transform: scale(1.08); box-shadow: 0 6px 24px rgba(0,0,0,.3); }
.chat-fab .unread-badge {
  position: absolute; top: -4px; right: -4px;
  background: #dc2626; color: #fff; font-size: 11px; font-weight: 700;
  min-width: 20px; height: 20px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  padding: 0 5px; border: 2px solid var(--bg);
}

.chat-drawer {
  position: fixed; bottom: 90px; right: 24px; z-index: 9001;
  width: 380px; max-height: 520px;
  background: var(--card); border: 1px solid var(--line);
  border-radius: 16px; box-shadow: 0 8px 40px rgba(0,0,0,.18);
  display: none; flex-direction: column;
  overflow: hidden;
}
.chat-drawer.open { display: flex; }

.chat-drawer-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; background: var(--header); color: var(--headerText);
  border-radius: 16px 16px 0 0;
}
.chat-drawer-header h3 { margin: 0; font-size: 15px; font-weight: 700; }
.chat-drawer-close {
  background: none; border: none; color: #a8a29e; font-size: 20px;
  cursor: pointer; padding: 0 4px; line-height: 1;
}
.chat-drawer-close:hover { color: #fff; }

.chat-nav-row {
  display: flex; gap: 4px; padding: 8px 10px;
  border-bottom: 1px solid var(--line); background: #fafaf9;
  align-items: center;
}
.chat-nav-select {
  flex: 1; padding: 6px 8px; border-radius: 8px; font-size: 11px;
  font-weight: 600; font-family: inherit;
  border: 1px solid var(--line); background: var(--card);
  color: var(--text); cursor: pointer; outline: none;
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 6px center;
  padding-right: 22px;
  min-width: 0;
}
.chat-nav-select:focus { border-color: var(--accent); }

.chat-inbox-btn {
  padding: 6px 8px; border-radius: 8px; font-size: 11px;
  font-weight: 700; font-family: inherit;
  border: 1px solid var(--line); background: var(--card);
  color: var(--text); cursor: pointer; white-space: nowrap;
  display: flex; align-items: center; gap: 4px;
  transition: all .15s;
}
.chat-inbox-btn:hover { border-color: var(--accent); background: #fef3c7; }
.chat-inbox-btn.has-unread { border-color: #dc2626; color: #dc2626; background: #fef2f2; }
.chat-inbox-count {
  background: #dc2626; color: #fff; font-size: 10px; font-weight: 700;
  min-width: 16px; height: 16px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  padding: 0 4px;
}

.chat-dm-header {
  display: flex; align-items: center; gap: 6px; padding: 6px 12px;
  background: #f5f3ff; border-bottom: 1px solid #e9e5ff;
  font-size: 12px; font-weight: 600; color: #7c3aed;
}
.chat-dm-header button {
  background: none; border: none; font-size: 14px; cursor: pointer;
  color: #7c3aed; padding: 0 4px;
}
.chat-dm-header button:hover { color: #5b21b6; }

.chat-inbox-view {
  flex: 1; overflow-y: auto; padding: 0; min-height: 200px;
}
.chat-inbox-row {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-bottom: 1px solid var(--line);
  cursor: pointer; transition: background .12s;
}
.chat-inbox-row:hover { background: #f5f3ff; }
.chat-inbox-row .inbox-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: #dc2626; flex-shrink: 0;
}
.chat-inbox-row .inbox-channel {
  font-size: 12px; font-weight: 700; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  max-width: 120px;
}
.chat-inbox-row .inbox-preview {
  flex: 1; font-size: 11px; color: var(--muted);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.chat-inbox-row .inbox-count {
  background: #dc2626; color: #fff; font-size: 10px; font-weight: 700;
  min-width: 18px; height: 18px; border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  padding: 0 5px; flex-shrink: 0;
}
.chat-inbox-row .inbox-time {
  font-size: 10px; color: var(--muted); white-space: nowrap; flex-shrink: 0;
}
.chat-inbox-empty {
  text-align: center; padding: 40px 20px; color: var(--muted); font-size: 13px;
}

/* @mention autocomplete */
.chat-mention-popup {
  position: absolute; bottom: 100%; left: 0; right: 0;
  background: var(--card); border: 1px solid var(--line);
  border-radius: 10px 10px 0 0; max-height: 180px; overflow-y: auto;
  box-shadow: 0 -4px 16px rgba(0,0,0,.12); z-index: 100;
  display: none;
}
.chat-mention-popup.visible { display: block; }
.chat-mention-item {
  padding: 8px 14px; font-size: 12px; font-weight: 600;
  cursor: pointer; display: flex; align-items: center; gap: 8px;
  transition: background .1s;
}
.chat-mention-item:hover, .chat-mention-item.active {
  background: #f5f3ff; color: #7c3aed;
}
.chat-mention-item .mention-dot {
  width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
}
.chat-mention-tag {
  background: #ede9fe; color: #7c3aed; padding: 1px 4px;
  border-radius: 3px; font-weight: 700; font-size: 12px;
}

/* PWA install prompt */
.pwa-install-banner {
  display: none; padding: 10px 16px;
  background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
  color: #fff; font-size: 13px; font-weight: 600;
  align-items: center; justify-content: center; gap: 12px;
  cursor: pointer; text-align: center;
}
.pwa-install-banner:hover { filter: brightness(1.1); }
.pwa-install-banner .pwa-dismiss {
  background: rgba(255,255,255,.2); border: none; color: #fff;
  border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 11px;
}

.chat-messages {
  flex: 1; overflow-y: auto; padding: 12px; min-height: 200px;
  display: flex; flex-direction: column; gap: 6px;
}
.chat-messages::-webkit-scrollbar { width: 5px; }
.chat-messages::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }

.chat-msg {
  max-width: 85%; padding: 8px 12px; border-radius: 12px;
  font-size: 13px; line-height: 1.45; word-break: break-word;
}
.chat-msg.other {
  align-self: flex-start; background: #f4f4f5; color: var(--text);
  border-bottom-left-radius: 4px;
}
.chat-msg.mine {
  align-self: flex-end; background: var(--accent); color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-msg .chat-sender {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .3px; margin-bottom: 2px; opacity: .7;
}
.chat-msg.mine .chat-sender { opacity: .85; }
.chat-msg .chat-time {
  font-size: 10px; opacity: .5; margin-top: 3px; text-align: right;
}

.chat-date-divider {
  text-align: center; font-size: 10px; color: var(--muted);
  font-weight: 600; margin: 8px 0 4px;
  text-transform: uppercase; letter-spacing: .5px;
}

.chat-input-row {
  display: flex; gap: 8px; padding: 10px 12px;
  border-top: 1px solid var(--line); background: #fafaf9;
  border-radius: 0 0 16px 16px;
}
.chat-input {
  flex: 1; border: 1px solid var(--line); border-radius: 8px;
  padding: 8px 12px; font-size: 13px; outline: none;
  font-family: inherit; resize: none;
}
.chat-input:focus { border-color: var(--accent); }
.chat-send-btn {
  background: var(--accent); color: #fff; border: none;
  border-radius: 8px; padding: 8px 14px; font-weight: 700;
  font-size: 13px; cursor: pointer; white-space: nowrap;
  transition: filter .15s;
}
.chat-send-btn:hover { filter: brightness(1.1); }
.chat-send-btn:disabled { opacity: .5; cursor: default; }

/* Emoji & GIF pickers */
.chat-toolbar { display:flex; gap:4px; align-items:center; }
.chat-toolbar-btn {
  background:none; border:none; font-size:18px; cursor:pointer; padding:4px 6px;
  border-radius:6px; transition:background .15s; line-height:1;
}
.chat-toolbar-btn:hover { background:#e7e5e4; }
.chat-toolbar-btn.active { background:#d6d3d1; }
.chat-picker-popup {
  position:absolute; bottom:54px; left:8px; right:8px;
  background:#fff; border:1px solid var(--line); border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,.15); z-index:300; display:none;
  max-height:320px; overflow:hidden; flex-direction:column;
}
.chat-picker-popup.show { display:flex; }
.emoji-tabs {
  display:flex; gap:2px; padding:6px 8px; border-bottom:1px solid var(--line);
  overflow-x:auto; flex-shrink:0;
}
.emoji-tab {
  background:none; border:none; font-size:16px; padding:4px 8px; cursor:pointer;
  border-radius:6px; opacity:.6; transition:all .15s;
}
.emoji-tab:hover, .emoji-tab.active { opacity:1; background:#f5f5f4; }
.emoji-grid {
  display:grid; grid-template-columns:repeat(8,1fr); gap:2px; padding:8px;
  overflow-y:auto; flex:1;
}
.emoji-cell {
  font-size:22px; text-align:center; cursor:pointer; padding:6px 2px;
  border-radius:6px; transition:background .1s; line-height:1.2;
}
.emoji-cell:hover { background:#f5f5f4; }
.gif-search-wrap {
  padding:8px; border-bottom:1px solid var(--line); flex-shrink:0;
}
.gif-search-input {
  width:100%; padding:8px 12px; border:1px solid var(--line); border-radius:8px;
  font-size:13px; outline:none; font-family:inherit; box-sizing:border-box;
}
.gif-search-input:focus { border-color:var(--accent); }
.gif-grid {
  display:grid; grid-template-columns:repeat(2,1fr); gap:6px; padding:8px;
  overflow-y:auto; flex:1; max-height:240px;
}
.gif-cell {
  cursor:pointer; border-radius:8px; overflow:hidden; aspect-ratio:16/10;
  transition:transform .1s;
}
.gif-cell:hover { transform:scale(1.03); }
.gif-cell img { width:100%; height:100%; object-fit:cover; display:block; }
.gif-powered {
  text-align:center; padding:4px; font-size:10px; color:#a8a29e;
  border-top:1px solid var(--line); flex-shrink:0;
}
.chat-gif-msg { max-width:200px; border-radius:10px; margin-top:4px; }


@media (max-width: 480px) {
  .chat-drawer { right: 8px; left: 8px; width: auto; bottom: 82px; max-height: 65vh; }
  .chat-fab { bottom: 16px; right: 16px; width: 50px; height: 50px; font-size: 20px; }
}

/* ‚îÄ‚îÄ Morning Briefing ‚îÄ‚îÄ */
.morning-briefing-overlay {
  position:fixed; inset:0; z-index:9999;
  background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#334155 100%);
  display:flex; align-items:center; justify-content:center;
  animation: briefFadeIn .4s ease-out;
}
@keyframes briefFadeIn { from{opacity:0;transform:scale(1.05)} to{opacity:1;transform:scale(1)} }
.morning-briefing-card {
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
  border-radius:20px; padding:32px 28px; max-width:480px; width:90%;
  color:#f1f5f9; text-align:center;
}
.morning-briefing-card h2 { margin:0 0 4px; font-size:22px; }
.morning-briefing-card .subtitle { color:#94a3b8; font-size:13px; margin-bottom:20px; }
.brief-stats { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:18px; }
.brief-stat {
  background:rgba(255,255,255,.08); border-radius:12px; padding:12px 14px;
  min-width:90px; flex:1;
}
.brief-stat .val { font-size:22px; font-weight:800; }
.brief-stat .lbl { font-size:10px; color:#94a3b8; margin-top:2px; }
.brief-delta { font-size:11px; margin-top:3px; font-weight:600; }
.brief-delta.up { color:#4ade80; }
.brief-delta.down { color:#f87171; }
.brief-delta.flat { color:#94a3b8; }
.brief-movers { text-align:left; margin:16px 0; padding:12px 16px; background:rgba(255,255,255,.05); border-radius:12px; }
.brief-movers h4 { margin:0 0 8px; font-size:13px; color:#94a3b8; font-weight:600; }
.brief-mover { display:flex; align-items:center; gap:8px; padding:4px 0; font-size:13px; }
.brief-mover .rank-change { font-weight:700; color:#4ade80; }
.brief-quote { font-style:italic; color:#94a3b8; font-size:12px; margin:16px 0; padding:0 12px; }
.brief-go-btn {
  background:linear-gradient(135deg,#f97316,#ea580c); color:#fff; border:none;
  padding:12px 40px; border-radius:12px; font-size:15px; font-weight:700;
  cursor:pointer; margin-top:8px; transition:transform .15s;
}
.brief-go-btn:hover { transform:scale(1.04); }

/* ‚îÄ‚îÄ Streaks ‚îÄ‚îÄ */
.streak-badge {
  display:inline-flex; align-items:center; gap:4px;
  background:linear-gradient(135deg,#f97316,#ef4444); color:#fff;
  padding:3px 10px; border-radius:20px; font-size:12px; font-weight:700;
}
.pb-badge {
  display:inline-block; background:#3b82f6; color:#fff;
  font-size:9px; font-weight:700; padding:1px 5px; border-radius:4px;
  margin-left:4px; vertical-align:middle;
}
.pb-alert {
  background:linear-gradient(135deg,#1e40af,#3b82f6); color:#fff;
  padding:10px 16px; border-radius:10px; margin-bottom:10px;
  font-size:13px; font-weight:600; text-align:center;
  animation: briefFadeIn .3s ease-out;
}

/* ‚îÄ‚îÄ Kudos ‚îÄ‚îÄ */
.kudos-section {
  max-width:1400px; margin:0 auto 12px; padding:0 12px;
}
.kudos-card {
  background:var(--card); border:1px solid var(--line); border-radius:14px;
  padding:14px 18px; overflow:hidden;
}
.kudos-card h3 { margin:0 0 10px; font-size:14px; display:flex; align-items:center; gap:6px; }
.kudos-item {
  display:flex; align-items:flex-start; gap:10px; padding:8px 0;
  border-bottom:1px solid var(--line); font-size:13px;
}
.kudos-item:last-child { border-bottom:none; }
.kudos-avatar {
  width:32px; height:32px; border-radius:50%;
  background:var(--accent); color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-weight:700; font-size:13px; flex-shrink:0;
}
.kudos-body { flex:1; }
.kudos-body strong { color:var(--accent); }
.kudos-time { font-size:10px; color:var(--muted); }
.kudos-pinned { background:#fef9c3; border-left:3px solid #eab308; padding-left:10px; }
.kudos-give-btn {
  background:var(--accent); color:#fff; border:none; padding:5px 14px;
  border-radius:8px; font-size:12px; font-weight:600; cursor:pointer;
}
.kudos-modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:10000;
  display:flex; align-items:center; justify-content:center;
}
.kudos-modal {
  background:var(--card); border-radius:14px; padding:20px; width:90%; max-width:400px;
}
.kudos-modal h3 { margin:0 0 12px; font-size:16px; }
.kudos-modal select, .kudos-modal textarea {
  width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px;
  font-size:13px; font-family:inherit; box-sizing:border-box;
}
.kudos-modal textarea { min-height:60px; resize:vertical; margin-top:8px; }
.kudos-modal .actions { display:flex; gap:8px; margin-top:12px; }
.kudos-modal .actions button { flex:1; padding:8px; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:13px; }

/* ‚îÄ‚îÄ Gaining Ticker ‚îÄ‚îÄ */
.gaining-ticker {
  margin-top:10px; padding:8px 12px;
  background:rgba(255,255,255,.08); border-radius:10px; font-size:12px;
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
}
.gaining-ticker .item { display:flex; align-items:center; gap:4px; }
.gaining-ticker .behind-you { color:#f87171; }
.gaining-ticker .ahead { color:#4ade80; }

/* ‚îÄ‚îÄ Milestones / Confetti ‚îÄ‚îÄ */
.milestone-toast {
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  z-index:99999; background:linear-gradient(135deg,#1e293b,#334155);
  color:#fff; padding:30px 40px; border-radius:20px; text-align:center;
  animation: briefFadeIn .4s ease-out;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.milestone-toast h2 { margin:0 0 4px; font-size:28px; }
.milestone-toast p { margin:0; color:#94a3b8; font-size:14px; }
.confetti-piece {
  position:fixed; top:-10px; z-index:99998;
  width:8px; height:8px; border-radius:2px;
  animation: confettiFall linear forwards;
}
@keyframes confettiFall {
  0% { transform:translateY(0) rotate(0deg); opacity:1; }
  100% { transform:translateY(100vh) rotate(720deg); opacity:0; }
}

/* ‚îÄ‚îÄ Sparklines ‚îÄ‚îÄ */
.sparkline-row {
  display:flex; gap:16px; margin-top:10px; flex-wrap:wrap; align-items:center;
}
.sparkline-item { display:flex; align-items:center; gap:6px; }
.sparkline-item .spark-label { font-size:10px; color:#94a3b8; }
.sparkline-item svg { display:block; }
.pace-indicator {
  font-size:11px; font-weight:600; padding:2px 8px; border-radius:6px;
  display:inline-block; margin-top:6px;
}
.pace-up { background:rgba(74,222,128,.15); color:#4ade80; }
.pace-flat { background:rgba(148,163,184,.15); color:#94a3b8; }
.pace-down { background:rgba(248,113,113,.15); color:#f87171; }

/* ‚îÄ‚îÄ Upload Call Data Modal ‚îÄ‚îÄ */
#uploadCallsModal {
  display:none; position:fixed; inset:0; z-index:9999;
  background:rgba(0,0,0,.5); place-items:center;
}
#uploadCallsModal.active { display:grid; }
.upload-modal-content {
  background:var(--card); border-radius:14px; padding:24px;
  max-width:640px; width:90vw; max-height:85vh; overflow-y:auto;
  box-shadow:0 12px 40px rgba(0,0,0,.25);
}
.upload-modal-content h2 { margin:0 0 4px; font-size:18px; }
.upload-modal-content .sub { color:var(--muted); font-size:13px; margin-bottom:16px; }
.upload-drop-zone {
  border:2px dashed var(--line); border-radius:10px; padding:32px 16px;
  text-align:center; cursor:pointer; transition:border-color .2s, background .2s;
  margin-bottom:14px;
}
.upload-drop-zone:hover, .upload-drop-zone.dragover {
  border-color:var(--accent); background:rgba(234,88,12,.04);
}
.upload-drop-zone .icon { font-size:28px; margin-bottom:6px; }
.upload-drop-zone .label { font-size:13px; color:var(--muted); }
.upload-preview-table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
.upload-preview-table th { background:#f4f4f5; padding:6px 8px; text-align:left; font-weight:600; border-bottom:1px solid var(--line); }
.upload-preview-table td { padding:5px 8px; border-bottom:1px solid #f0f0f0; }
.upload-stats { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
.upload-stats .stat { background:#f4f4f5; padding:8px 14px; border-radius:8px; font-size:13px; }
.upload-stats .stat strong { font-weight:700; }
.match-result { padding:10px 14px; border-radius:8px; margin-top:8px; font-size:13px; }
.match-result.success { background:var(--greenBg); color:#15803d; }
.match-result.warning { background:var(--yellowBg); color:#a16207; }
.match-result.error { background:var(--redBg); color:#dc2626; }

/* ‚îÄ‚îÄ Recordings Page ‚îÄ‚îÄ */
.rec-user-grid {
  display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr));
  gap:12px; margin-top:14px;
}
.rec-user-card {
  background:var(--card); border:1px solid var(--line); border-radius:10px;
  padding:14px 16px; cursor:pointer; transition:box-shadow .2s, border-color .2s;
}
.rec-user-card:hover { border-color:var(--accent); box-shadow:0 4px 16px rgba(0,0,0,.08); }
.rec-user-card .name { font-weight:700; font-size:15px; margin-bottom:2px; }
.rec-user-card .role-badge { font-size:11px; padding:1px 8px; border-radius:6px; background:#f4f4f5; color:var(--muted); display:inline-block; }
.rec-user-card .call-count { margin-top:6px; font-size:13px; color:var(--muted); }
.rec-call-row {
  display:grid; grid-template-columns:1fr auto;
  padding:10px 14px; border-bottom:1px solid #f0f0f0; align-items:center;
  transition:background .15s;
}
.rec-call-row:hover { background:#fafafa; }
.rec-call-row .caller { font-weight:600; font-size:14px; }
.rec-call-row .meta { font-size:12px; color:var(--muted); margin-top:2px; }
.rec-call-row .duration { font-size:13px; font-weight:600; color:var(--text); text-align:right; }
.rec-call-row .time { font-size:11px; color:var(--muted); text-align:right; }
</style>
</head>

<body>
<div class="wrap" id="app"></div>

<!-- User Management Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>User Management</h2>
      <button class="modal-close" onclick="closeUserModal()">&times;</button>
    </div>
    <div class="form-group" id="userFormSection">
      <h3 style="margin:0 0 6px;">Add New User</h3>
      <input type="email" id="newUserEmail" placeholder="Email address" autocomplete="off">
      <input type="password" id="newUserPassword" placeholder="Password" style="margin-top:8px;" autocomplete="new-password">
      <input type="text" id="newUserDisplayName" placeholder='Display Name (e.g., "John Smith")' style="margin-top:8px;" autocomplete="off">
      <input type="text" id="newUserLinked" placeholder='Linked Sheet Name (e.g., "JASMINE VASQUEZ")' style="margin-top:8px;" autocomplete="off">
      <input type="tel" id="newUserPhone" placeholder='Phone Number (e.g., "210-555-1234")' style="margin-top:8px;" autocomplete="off">
      <select id="newUserRole" style="width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:8px;">
        <option value="user">User</option>
        <option value="manager">Manager</option>
        <option value="admin">Admin</option>
      </select>
      <select id="newUserManager" style="width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:8px;">
        <option value="">‚Äî No Assigned Manager ‚Äî</option>
      </select>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn" style="flex:1;" onclick="addUser()">Add User</button>
      </div>
    </div>
    <div class="user-list" id="userList">
      <h3>Existing Users</h3>
      <div id="userListContent"></div>
    </div>
  </div>
</div>

<!-- Activity Log Modal -->
<div class="modal" id="activityModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üïê User Activity Log</h2>
      <button class="modal-close" onclick="closeActivityModal()">&times;</button>
    </div>
    <div id="activityContent" style="margin-top:8px;">
      <p style="color:var(--muted);">Loading...</p>
    </div>
  </div>
</div>

<!-- Upload Call Data Modal -->
<div id="uploadCallsModal">
  <div class="upload-modal-content">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h2>Upload Call Data</h2>
        <div class="sub">Upload a CSV or Excel file with call recordings data</div>
      </div>
      <button onclick="closeUploadCallsModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted);padding:4px;">&times;</button>
    </div>
    <div class="upload-drop-zone" id="callDropZone" onclick="document.getElementById('callFileInput').click()">
      <div class="icon">üìÅ</div>
      <div class="label">Click to browse or drag & drop your file here</div>
      <div class="label" style="margin-top:4px;font-size:11px;">Accepts .csv, .xlsx, .xls</div>
    </div>
    <input type="file" id="callFileInput" accept=".csv,.xlsx,.xls" style="display:none;" onchange="callFileSelected(this)">
    <div id="callUploadFileName" style="font-size:13px;font-weight:600;margin-bottom:8px;display:none;"></div>
    <div id="callUploadPreview"></div>
    <div id="callUploadActions" style="display:none;margin-top:14px;">
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="saveCallDataBtn" onclick="saveUploadedCallData()" style="background:var(--green);color:#fff;">Save Call Data</button>
        <button class="btn" id="matchCallsBtn" onclick="matchCallsToLeads()" style="background:#2563eb;color:#fff;">Match Calls to Leads</button>
        <button class="btn" onclick="clearCallUpload()" style="background:var(--line);color:var(--text);">Clear</button>
      </div>
      <div id="callMatchResult"></div>
    </div>
  </div>
</div>

<!-- Team Chat FAB + Drawer -->
<button class="chat-fab" id="chatFab" onclick="toggleChat()" style="display:none;" title="Team Chat">
  üí¨
  <span class="unread-badge" id="chatUnreadBadge" style="display:none;">0</span>
</button>

<div class="chat-drawer" id="chatDrawer">
  <div class="chat-drawer-header">
    <h3>üí¨ Team Chat</h3>
    <div style="display:flex;align-items:center;gap:8px;">
      <span id="chatOnlineCount" style="font-size:11px;color:#a8a29e;"></span>
      <button class="chat-drawer-close" onclick="toggleChat()">‚úï</button>
    </div>
  </div>
  <div class="chat-nav-row" id="chatNavRow">
    <select class="chat-nav-select" id="chatGroupSelect" onchange="switchChatChannel(this.value)">
      <option value="">üë• Group Messages‚Ä¶</option>
    </select>
    <select class="chat-nav-select" id="chatDmSelect" onchange="openDirectMessage(this.value)">
      <option value="">‚úâ Direct Message‚Ä¶</option>
    </select>
    <button class="chat-inbox-btn" id="chatInboxBtn" onclick="toggleChatInbox()">
      üì• Unread <span class="chat-inbox-count" id="chatInboxCount" style="display:none;">0</span>
    </button>
  </div>
  <div class="chat-dm-header" id="chatDmHeader" style="display:none;"></div>
  <div class="chat-inbox-view" id="chatInboxView" style="display:none;"></div>
  <div class="chat-messages" id="chatMessages">
    <p style="color:var(--muted);text-align:center;font-size:13px;margin-top:40px;">Select a conversation to start chatting</p>
  </div>
  <div style="position:relative;">
    <div class="chat-mention-popup" id="chatMentionPopup"></div>
    <div class="chat-picker-popup" id="emojiPicker">
      <div class="emoji-tabs" id="emojiTabs"></div>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>
    <div class="chat-picker-popup" id="gifPicker">
      <div class="gif-search-wrap">
        <input type="text" class="gif-search-input" id="gifSearchInput" placeholder="Search GIFs..." oninput="_debounceGifSearch()">
      </div>
      <div class="gif-grid" id="gifGrid">
        <p style="color:var(--muted);text-align:center;grid-column:1/-1;font-size:12px;margin-top:20px;">Search for a GIF above</p>
      </div>
      <div class="gif-powered">Powered by GIPHY</div>
    </div>
    <div class="chat-input-row" id="chatInputRow">
    <div class="chat-toolbar">
      <button class="chat-toolbar-btn" id="emojiToggleBtn" onclick="toggleEmojiPicker()" title="Emoji">üòä</button>
      <button class="chat-toolbar-btn" id="gifToggleBtn" onclick="toggleGifPicker()" title="GIF">GIF</button>
    </div>
    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..."
      onkeydown="handleChatKeydown(event)">
    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">Send</button>
    </div>
  </div>
</div>

<div class="pwa-install-banner" id="pwaInstallBanner" onclick="installPWA()">
  üì± Install SA Dashboard on your device for push notifications
  <button class="pwa-dismiss" onclick="event.stopPropagation();dismissPwaInstall();">‚úï</button>
</div>

<script type="module">
/************ Firebase imports ************/
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
import {
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  signOut, onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc, updateDoc, increment,
  addDoc, query, where, orderBy, limit, Timestamp, onSnapshot, serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging.js';

/************ Firebase config ************/
const firebaseConfig = {
  apiKey: "AIzaSyC74YFnCKeO5TjmPa4H4BMm_pFwohOVAX4",
  authDomain: "store-dashboard-2025.firebaseapp.com",
  projectId: "store-dashboard-2025",
  storageBucket: "store-dashboard-2025.firebasestorage.app",
  messagingSenderId: "556566448299",
  appId: "1:556566448299:web:a2cbe4dda5d21fc6c5cfee",
  measurementId: "G-0D5JMNGE4S"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const secondaryApp = initializeApp(firebaseConfig, 'secondary');
const secondaryAuth = getAuth(secondaryApp);

// ‚îÄ‚îÄ Firebase Cloud Messaging (Push Notifications) ‚îÄ‚îÄ
let messaging = null;
const FCM_VAPID_KEY = 'BMTYFXgWSxLZESNNeZyaQueSYRd9l9BKI0dsCDdwgL9l0DEX1Cd_2m6eTJdq2wtiWuoxIW11KBSuei55FREPcLU'; // Firebase Console ‚Üí Project Settings ‚Üí Cloud Messaging ‚Üí Web Push certificates
try {
  messaging = getMessaging(app);
} catch (e) {
  console.warn('[FCM] Messaging not supported in this browser:', e.message);
}

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxU-KSYkSuyaamd7ybCZlg1QLClfUbc8Ds_AiPZzVdC7hvYSjrc13Ux_hTQfZU_CTa2/exec';
const SUPERADMIN_EMAIL = 'albertosilvajr0@gmail.com';

/* ‚îÄ‚îÄ Crash reporter ‚îÄ‚îÄ */
window.addEventListener('error', (e) => {
  const appEl = document.getElementById('app');
  if (!appEl) return;
  appEl.innerHTML = `
    <div style="padding:60px 20px;text-align:center;color:#dc2626;">
      <h2>Frontend Error</h2>
      <p>${e?.message || 'Unknown error'}</p>
      <pre style="text-align:left;white-space:pre-wrap;background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;max-width:600px;margin:12px auto;">${(e?.error?.stack) || ''}</pre>
    </div>`;
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ACCESS HELPERS & SESSION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function isAdmin()   { return window.userData?.role === 'admin' || window.userData?.role === 'superadmin'; }
function isManager() { return window.userData?.role === 'manager'; }
function canViewName(targetName) {
  const n = (targetName || '').toUpperCase();
  const mine = (window.userData?.linkedName || '').toUpperCase();
  if (isAdmin() || isManager()) return true;
  return mine && n === mine;
}
function makeSessionToken({ name, role }) {
  return btoa(JSON.stringify({ name, role }));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PAGE VIEW TRACKING
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const _sessionId = Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
let _lastPageView = null;
let _pageViewQueue = [];
let _pvFlushTimer = null;

function logPageView(pageName) {
  const user = auth.currentUser;
  if (!user?.email) return;
  const now = Date.now();
  // Calculate time on previous page
  const dwellMs = _lastPageView ? now - _lastPageView.ts : 0;
  _lastPageView = { page: pageName, ts: now };

  _pageViewQueue.push({
    email: user.email,
    page: pageName,
    ts: Timestamp.fromMillis(now),
    sessionId: _sessionId,
    dwellMs: dwellMs
  });

  // Update daily login lastSeen
  if (user.uid) {
    const loginDocId = user.uid + '_' + todayDateStr();
    setDoc(doc(db, 'dailyLogins', loginDocId), { lastSeen: new Date() }, { merge: true }).catch(() => {});
  }

  // Batch writes ‚Äî flush every 3 seconds or at 5 queued
  if (_pvFlushTimer) clearTimeout(_pvFlushTimer);
  if (_pageViewQueue.length >= 5) {
    _flushPageViews();
  } else {
    _pvFlushTimer = setTimeout(_flushPageViews, 3000);
  }
}

function _flushPageViews() {
  if (_pageViewQueue.length === 0) return;
  const batch = [..._pageViewQueue];
  _pageViewQueue = [];
  batch.forEach(pv => {
    addDoc(collection(db, 'pageViews'), pv).catch(() => {});
  });
}

// Flush on page unload
window.addEventListener('beforeunload', () => {
  if (_lastPageView) {
    // Log final dwell time
    const now = Date.now();
    _pageViewQueue.push({
      email: auth.currentUser?.email || 'unknown',
      page: _lastPageView.page + ' (exit)',
      ts: Timestamp.fromMillis(now),
      sessionId: _sessionId,
      dwellMs: now - _lastPageView.ts
    });
  }
  _flushPageViews();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function safeNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
function shownVal(x) { return x.shown ?? x.shows ?? x.shown_count ?? x.shows_count ?? 0; }
function fmt(n, d=0) { return Number(n).toFixed(d); }

function timeStr() {
  return new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

/* ‚îÄ‚îÄ Motivational Quotes ‚îÄ‚îÄ */
const TOPBAR_QUOTES = [
  "The leaderboard doesn't lie.",
  "You don't get paid for intention. You get paid for execution.",
  "Volume creates luck.",
  "Every call is an opportunity. Every note is a receipt.",
  "Small daily disciplines become big monthly commissions."
];
function setTopbarQuote() {
  const el = document.getElementById('topbarQuote');
  if (el) el.textContent = TOPBAR_QUOTES[Math.floor(Math.random() * TOPBAR_QUOTES.length)];
}

/* ‚îÄ‚îÄ Click Tracking ‚îÄ‚îÄ */
function todayDateStr() {
  const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' }));
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

let _clickBuffer = 0;
let _clickFlushing = false;

async function _flushClicks() {
  if (!window.userData?.uid || _clickBuffer <= 0 || _clickFlushing) return;
  _clickFlushing = true;
  const count = _clickBuffer;
  _clickBuffer = 0;
  try {
    const userRef = doc(db, 'users', window.userData.uid);
    const today = todayDateStr();
    const snap = await getDoc(userRef);
    const data = snap.data() || {};
    if (data.clickDate === today) {
      await updateDoc(userRef, { clicksToday: increment(count) });
    } else {
      await setDoc(userRef, { clicksToday: count, clickDate: today }, { merge: true });
    }
  } catch (e) { _clickBuffer += count; /* retry next flush */ }
  _clickFlushing = false;
}

// Track ALL clicks on the page
document.addEventListener('click', () => {
  if (!window.userData?.uid) return;
  _clickBuffer++;
});

// Flush every 15 seconds
setInterval(_flushClicks, 15000);

// Flush on page unload (tab close, navigation away, refresh)
window.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') _flushClicks();
});
window.addEventListener('beforeunload', () => { _flushClicks(); });

// Legacy wrapper for explicit trackClick() calls
function trackClick() { /* now handled by global listener */ }

/* ‚îÄ‚îÄ Cache ‚îÄ‚îÄ */
const personCache = new Map();
const callListCache = new Map();
function cacheKey(name) { return (name || '').toUpperCase().trim(); }

async function fetchPerson(name) {
  const key = cacheKey(name);
  if (personCache.has(key)) return personCache.get(key);

  // ‚îÄ‚îÄ Firestore only (snapshots update once daily) ‚îÄ‚îÄ
  try {
    const snapDoc = await getDoc(doc(db, 'personSnapshots', name.toUpperCase()));
    if (snapDoc.exists()) {
      const raw = snapDoc.data();
      const payload = JSON.parse(raw.jsonData);
      const result = { ok: true, data: payload, _source: 'firestore' };
      personCache.set(key, result);
      const updatedAt = raw.updatedAt?.toDate?.() || new Date(raw.updatedAt);
      console.log(`[Firestore] ${name} loaded (age: ${Math.round((Date.now() - updatedAt.getTime())/60000)}min)`);
      return result;
    }
  } catch (fsErr) {
    console.warn('[Firestore] Person read failed for', name, ':', fsErr.message);
  }

  return { ok: false, error: 'No snapshot found for ' + name };
}

async function fetchCalls(name) {
  const key = cacheKey(name);
  if (callListCache.has(key)) return callListCache.get(key);

  // ‚îÄ‚îÄ Firestore only (embedded in personSnapshot as callList) ‚îÄ‚îÄ
  try {
    const snapDoc = await getDoc(doc(db, 'personSnapshots', name.toUpperCase()));
    if (snapDoc.exists()) {
      const raw = snapDoc.data();
      const payload = JSON.parse(raw.jsonData);
      // callList = { name, calls: [...] } ‚Äî matches what viewCallSheets expects
      if (payload.callList && payload.callList.calls) {
        const result = { ok: true, data: payload.callList, _source: 'firestore' };
        callListCache.set(key, result);
        return result;
      }
    }
  } catch (fsErr) {
    console.warn('[Firestore] Calls read failed for', name, ':', fsErr.message);
  }

  return { ok: false, error: 'No call data available ‚Äî run the daily snapshot to include call sheets.' };
}

/* ‚îÄ‚îÄ Prefetch helpers ‚îÄ‚îÄ */
const _prefetchingPerson = new Set();

function prefetchPerson(name) {
  if (!name) return;
  const key = cacheKey(name);
  if (personCache.has(key) || _prefetchingPerson.has(key)) return;
  _prefetchingPerson.add(key);
  fetchPerson(name).catch(() => {}).finally(() => _prefetchingPerson.delete(key));
}

// Hover prefetch: triggered on mouseenter of leaderboard rows
function onRowHover(name) {
  prefetchPerson(name);
}

// Staggered prefetch: fetch person snapshots from Firestore (no GAS spam)
function prefetchForDashboard(data) {
  const allNames = new Set();
  (data.sales || []).forEach(x => { if (x.name) allNames.add(x.name); });
  (data.bdc || []).forEach(x => { if (x.name) allNames.add(x.name); });
  if (window.userData?.linkedName) allNames.add(window.userData.linkedName);

  // Priority: own name first
  const mine = window.userData?.linkedName ? [window.userData.linkedName] : [];
  const priority = [...new Set([...mine])];
  priority.forEach(n => prefetchPerson(n));

  // Rest: stagger 200ms apart (Firestore reads are fast, no need for 500ms)
  const rest = [...allNames].filter(n => !priority.includes(n));
  rest.forEach((n, i) => {
    setTimeout(() => prefetchPerson(n), (i + 1) * 200);
  });
}

// Quick-lookup: find a person's row data from dashboard cache
function getDashboardRow(name) {
  const key = (name || '').toUpperCase().trim();
  const all = [...(dashboardData.sales || []), ...(dashboardData.bdc || [])];
  return all.find(r => (r.name || '').toUpperCase().trim() === key) || null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UI HELPERS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showLoading(on = true) {
  const appEl = document.getElementById('app');
  if (!appEl || !on) return;
  appEl.innerHTML = `<div class="loading-wrap"><div class="spinner"></div></div>`;
}

function showUserModal() {
  if (!isAdmin()) { alert('Only admins can manage users.'); return; }
  logPageView('Manage Users');
  document.getElementById('userModal').style.display = 'grid';
  loadUsers();
}
function closeUserModal() {
  document.getElementById('userModal').style.display = 'none';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showLogin() {
  document.getElementById('app').innerHTML = `
    <div class="login-container">
      <h2>BDC &amp; Sales Leaderboards</h2>
      <div id="error-message" style="color:#dc2626;min-height:20px;margin:10px 0 0;"></div>
      <div class="form-group" style="margin-top:16px;">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@company.com" autocomplete="username" />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Your password" autocomplete="current-password" />
      </div>
      <button class="btn" style="width:100%;margin-top:14px;" onclick="login()">Log in</button>
    </div>`;
}

async function login() {
  const email = document.getElementById('email')?.value?.trim();
  const password = document.getElementById('password')?.value?.trim();
  const errEl = document.getElementById('error-message');
  if (!email || !password) { if (errEl) errEl.textContent = 'Enter email and password.'; return; }
  try {
    showLoading(true);
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    if (errEl) errEl.textContent = e.message || 'Login failed';
    showLogin();
  }
}

async function logout() {
  await signOut(auth);
  showLogin();
}

onAuthStateChanged(auth, async (user) => {
  if (!user) { showLogin(); return; }

  const userRef = doc(db, 'users', user.uid);
  let snap = await getDoc(userRef);
  if (!snap.exists()) {
    await setDoc(userRef, {
      email: user.email,
      role: user.email === SUPERADMIN_EMAIL ? 'superadmin' : 'user',
      linkedName: '',
      createdAt: new Date()
    });
    snap = await getDoc(userRef);
  }
  const data = snap.data() || {};

  // Block deleted users from accessing the app
  if (data.deleted) {
    await signOut(auth);
    document.getElementById('app').innerHTML = `
      <div style="max-width:400px;margin:100px auto;text-align:center;padding:40px 20px;">
        <h2 style="margin-bottom:8px;">Account Deactivated</h2>
        <p style="color:var(--muted);">Your account has been deactivated. Contact your manager for assistance.</p>
      </div>`;
    return;
  }

  let role = data.role || 'user';
  if (user.email === SUPERADMIN_EMAIL && role !== 'superadmin') {
    role = 'superadmin';
    await setDoc(userRef, { ...data, role }, { merge: true });
  }

  window.userData = { email: user.email, uid: user.uid, role, linkedName: data.linkedName || '', displayName: data.displayName || '' };
  const sessionName = window.userData.linkedName || window.userData.displayName || window.userData.email;
  window.sessionToken = makeSessionToken({ name: sessionName, role });

  // Record last login timestamp
  setDoc(userRef, { lastLogin: new Date() }, { merge: true }).catch(() => {});

  // Record daily login for historical accuracy
  const loginDate = todayDateStr();
  const loginDocId = user.uid + '_' + loginDate;
  setDoc(doc(db, 'dailyLogins', loginDocId), {
    email: user.email,
    uid: user.uid,
    linkedName: data.linkedName || '',
    role: role,
    date: loginDate,
    lastSeen: new Date()
  }, { merge: true }).catch(() => {});

  trackClick();

  showDashboard();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DASHBOARD (pic2 layout)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let dashboardData = { sales: [], bdc: [] };
let bdcSort = { col: 'shown', dir: 'desc' };
let salesSort = { col: 'sales', dir: 'desc' };

async function showDashboard() {
  if (!window.userData) { showLogin(); return; }
  logPageView('Dashboard');
  try {
    showLoading(true);
    let payload = null;
    try {
      const lbDoc = await getDoc(doc(db, 'dashboardSnapshots', 'leaderboards'));
      if (lbDoc.exists()) {
        const fsRaw = lbDoc.data();
        payload = JSON.parse(fsRaw.jsonData);
        const updatedAt = fsRaw.updatedAt?.toDate?.() || new Date(fsRaw.updatedAt);
        console.log(`[Firestore] Leaderboards loaded (age: ${Math.round((Date.now() - updatedAt.getTime())/60000)}min)`);
      }
    } catch (fsErr) {
      console.warn('[Firestore] Leaderboard read failed:', fsErr.message);
    }
    if (!payload) throw new Error('Leaderboard snapshot not available in Firestore.\nSnapshots update each morning ‚Äî please check that the daily trigger ran.');
    dashboardData.sales = Array.isArray(payload?.sales) ? payload.sales : [];
    dashboardData.bdc   = Array.isArray(payload?.bdc)   ? payload.bdc   : [];
    dashboardData.bdc = dashboardData.bdc.map(x => ({ calls: 0, texts: 0, ...x }));
    // Total Units from "User Act" sheet (col M, "Total" row) ‚Äî sent by backend
    dashboardData.salesTotalUnits = payload.salesTotalUnits ?? null;
    console.log('DEBUG salesTotalUnits from backend:', payload.salesTotalUnits, '| stored:', dashboardData.salesTotalUnits);

    renderDashboard();
    setTopbarQuote();
    prefetchForDashboard(dashboardData);
    checkLeadsAtRisk();
    loadCustomLinks();
    loadLeaderboardUsers();
    initChat();
    initPushNotifications();

    // ‚îÄ‚îÄ New features (non-blocking ‚Äî errors here must not kill the dashboard) ‚îÄ‚îÄ
    try { saveTodaySnapshot(dashboardData.sales, dashboardData.bdc); } catch(e) { console.warn('Snapshot save error:', e); }
    try { saveMetricHistory(dashboardData.sales, dashboardData.bdc); } catch(e) { console.warn('Metric history error:', e); }
    updateLoginStreak().catch(e => console.warn('Streak error:', e));
    checkPersonalBests(dashboardData.sales, dashboardData.bdc).catch(e => console.warn('PB error:', e));
    try { showMorningBriefing(dashboardData.sales, dashboardData.bdc); } catch(e) { console.warn('Briefing error:', e); }
    try { if (isAdmin() || isManager()) showManagerBriefing(dashboardData.sales, dashboardData.bdc); } catch(e) { console.warn('Manager briefing error:', e); }
    try { if (hasDismissedMorningBriefing()) { setTimeout(() => checkMilestones(), 1000); } } catch(e) { console.warn('Milestone error:', e); }
  } catch (err) {
    console.error('Dashboard error:', err);
    document.getElementById('app').innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div class="detail-card" style="max-width:500px;margin:auto;color:#dc2626;">
          <h2>Error Loading Dashboard</h2>
          <p style="white-space:pre-wrap;">${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">Retry</button>
        </div>
      </div>`;
  }
}

/* ‚îÄ‚îÄ Compute Stats ‚îÄ‚îÄ */
function bdcStats(rows) {
  let totalShown = 0, totalCreated = 0, totalDue = 0;
  rows.forEach(r => {
    totalShown   += safeNum(shownVal(r));
    totalCreated += safeNum(r.created ?? r.created_count ?? 0);
    totalDue     += safeNum(r.due ?? r.due_count ?? 0);
  });
  const avgShowRate = totalDue > 0 ? ((totalShown / totalDue) * 100).toFixed(1) : (totalCreated > 0 ? ((totalShown / totalCreated) * 100).toFixed(1) : '‚Äì');
  return { totalShown, totalCreated, avgShowRate };
}

function salesStats(rows) {
  let totalUnits = safeNum(dashboardData.salesTotalUnits ?? 0);
  let topName = '‚Äì', topVal = 0;
  let repSalesSum = 0;
  rows.forEach(r => {
    const s = safeNum(r.sales);
    repSalesSum += s;
    if (s > topVal) { topVal = s; topName = r.name || '‚Äì'; }
  });
  const active = rows.filter(r => safeNum(r.sales) > 0 || safeNum(r.calls) > 0).length || rows.length || 1;
  const avgUnits = active > 0 ? (repSalesSum / active).toFixed(2) : '0';
  return { totalUnits, avgUnits, topName, topVal };
}

/* ‚îÄ‚îÄ Column definitions (draggable order) ‚îÄ‚îÄ */
const BDC_COL_DEFS = {
  shown:    { key: 'shown',    label: 'Appts Shown', primary: true },
  trending: { key: 'trending', label: 'Trending' },
  pctShown: { key: 'pctShown', label: '% Shown' },
  due:      { key: 'due',      label: 'Appts Due' },
  created:  { key: 'created',  label: 'Appts Created' },
  calls:    { key: 'calls',    label: 'Calls' },
  texts:    { key: 'texts',    label: 'Texts' },
};
const SALES_COL_DEFS = {
  sales:     { key: 'sales',     label: 'Sales', primary: true },
  trending:  { key: 'trending',  label: 'Trending' },
  closeRate: { key: 'closeRate', label: 'Close %' },
  pctShown:  { key: 'pctShown',  label: '% Shown' },
  shown:     { key: 'shown',     label: 'Appts Shown' },
  due:       { key: 'due',       label: 'Appts Due' },
  created:   { key: 'created',   label: 'Appts Created' },
  calls:     { key: 'calls',     label: 'Calls' },
  texts:     { key: 'texts',     label: 'Texts' },
};
// Mutable order arrays (user can rearrange via drag)
let bdcColOrder   = ['shown','trending','pctShown','due','created','calls','texts'];
let salesColOrder = ['sales','trending','closeRate','pctShown','shown','due','created','calls','texts'];

let _dragPanel = null, _dragColKey = null;

function onColDragStart(e, panel, colKey) {
  _dragPanel = panel; _dragColKey = colKey;
  e.dataTransfer.effectAllowed = 'move';
  e.target.style.opacity = '0.5';
}
function onColDragEnd(e) { e.target.style.opacity = '1'; _dragPanel = null; _dragColKey = null; }
function onColDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function onColDrop(e, panel, targetKey) {
  e.preventDefault();
  if (_dragPanel !== panel || !_dragColKey || _dragColKey === targetKey) return;
  const arr = panel === 'bdc' ? bdcColOrder : salesColOrder;
  const fromIdx = arr.indexOf(_dragColKey);
  const toIdx = arr.indexOf(targetKey);
  if (fromIdx < 0 || toIdx < 0) return;
  arr.splice(fromIdx, 1);
  arr.splice(toIdx, 0, _dragColKey);
  renderDashboard();
}
window.onColDragStart = onColDragStart;
window.onColDragEnd = onColDragEnd;
window.onColDragOver = onColDragOver;
window.onColDrop = onColDrop;

/* ‚îÄ‚îÄ Leaderboard View Mode (Individual / By Teams) ‚îÄ‚îÄ */
let _lbViewMode = 'individual'; // 'individual' | 'teams'
let _lbUsersCache = null;

async function loadLeaderboardUsers() {
  if (_lbUsersCache) return _lbUsersCache;
  try {
    const snap = await getDocs(collection(db, 'users'));
    const nameMap = {};
    const managers = {};
    snap.forEach(d => {
      const u = { uid: d.id, ...d.data() };
      if (u.deleted) return;
      if (u.linkedName) nameMap[u.linkedName.trim().toUpperCase()] = u;
      if (u.role === 'manager' || u.role === 'admin' || u.role === 'superadmin') {
        managers[d.id] = u;
      }
    });
    _lbUsersCache = { nameMap, managers };
    if (_lbViewMode === 'teams') renderDashboard();
    return _lbUsersCache;
  } catch(e) {
    console.warn('Failed to load users for team view:', e);
    return null;
  }
}

function toggleLeaderboardView() {
  _lbViewMode = _lbViewMode === 'individual' ? 'teams' : 'individual';
  renderDashboard();
}
window.toggleLeaderboardView = toggleLeaderboardView;

function buildManagerSalesRows() {
  if (!_lbUsersCache) return null;
  const { nameMap, managers } = _lbUsersCache;
  const salesData = dashboardData.sales || [];
  const bdcData = dashboardData.bdc || [];
  const salesLookup = {};
  salesData.forEach(r => { salesLookup[(r.name || '').toUpperCase()] = r; });
  const bdcLookup = {};
  bdcData.forEach(r => { bdcLookup[(r.name || '').toUpperCase()] = r; });

  const teamAgg = {};
  Object.entries(nameMap).forEach(([upperName, user]) => {
    const managerId = user.managerId;
    if (!managerId || !managers[managerId]) return;
    const salesRow = salesLookup[upperName];
    const bdcRow = bdcLookup[upperName];
    if (!salesRow && !bdcRow) return;
    if (!teamAgg[managerId]) {
      teamAgg[managerId] = {
        name: managers[managerId].displayName || managers[managerId].email,
        managerId, sales: 0, calls: 0, texts: 0, created: 0, due: 0, shown: 0, visits: 0,
        memberCount: 0
      };
    }
    const r = salesRow || bdcRow;
    teamAgg[managerId].sales += safeNum(salesRow?.sales || 0);
    teamAgg[managerId].calls += safeNum(r.calls);
    teamAgg[managerId].texts += safeNum(r.texts);
    teamAgg[managerId].created += safeNum(r.created ?? r.created_count ?? 0);
    teamAgg[managerId].due += safeNum(r.due ?? r.due_count ?? 0);
    teamAgg[managerId].shown += safeNum(shownVal(r));
    teamAgg[managerId].visits += safeNum(salesRow?.visits || 0);
    teamAgg[managerId].memberCount++;
  });

  return Object.values(teamAgg);
}

/* ‚îÄ‚îÄ Sales Trending Projection (off Sundays only) ‚îÄ‚îÄ */
function trendingSales(currentSales) {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  const today = now.getDate();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // Count non-Sunday days elapsed (1 through today)
  let elapsedWork = 0;
  for (let d = 1; d < today; d++) {
    if (new Date(year, month, d).getDay() !== 0) elapsedWork++;
  }
  // Count total non-Sunday days in the month
  let totalWork = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    if (new Date(year, month, d).getDay() !== 0) totalWork++;
  }

  if (elapsedWork <= 0) return currentSales;
  return Math.round((currentSales / elapsedWork) * totalWork);
}
  
/* ‚îÄ‚îÄ Sort ‚îÄ‚îÄ */
function sortRows(rows, sortState, type) {
  const { col, dir } = sortState;
  const mult = dir === 'desc' ? -1 : 1;
  return [...rows].sort((a, b) => {
    let va, vb;
    if (col === 'name') {
      va = (a.name || '').toLowerCase();
      vb = (b.name || '').toLowerCase();
      return mult * va.localeCompare(vb);
    }
    if (col === 'shown') { va = safeNum(shownVal(a)); vb = safeNum(shownVal(b)); }
    else if (col === 'created') { va = safeNum(a.created ?? a.created_count ?? 0); vb = safeNum(b.created ?? b.created_count ?? 0); }
    else if (col === 'due') { va = safeNum(a.due ?? a.due_count ?? 0); vb = safeNum(b.due ?? b.due_count ?? 0); }
    else if (col === 'closeRate') {
      const visA = safeNum(a.visits) || 1;
      const visB = safeNum(b.visits) || 1;
      va = safeNum(a.sales) / visA;
      vb = safeNum(b.sales) / visB;
    }
    else if (col === 'trending') {
      va = trendingSales(type === 'bdc' ? safeNum(shownVal(a)) : safeNum(a.sales));
      vb = trendingSales(type === 'bdc' ? safeNum(shownVal(b)) : safeNum(b.sales));
    }
    else if (col === 'pctShown') {
      const dueA = safeNum(a.due ?? a.due_count ?? a.created ?? 0) || 1;
      const dueB = safeNum(b.due ?? b.due_count ?? b.created ?? 0) || 1;
      va = safeNum(shownVal(a)) / dueA;
      vb = safeNum(shownVal(b)) / dueB;
    }
    else { va = safeNum(a[col]); vb = safeNum(b[col]); }
    return mult * (va - vb);
  });
}

function toggleSort(panel, col) {
  const s = panel === 'bdc' ? bdcSort : salesSort;
  if (s.col === col) { s.dir = s.dir === 'desc' ? 'asc' : 'desc'; }
  else { s.col = col; s.dir = 'desc'; }
  renderDashboard();
}

/* ‚îÄ‚îÄ KPI Weekly Targets (Sales) ‚îÄ‚îÄ */
const WEEKLY_TARGETS = { calls: 150, texts: 100, created: 5, due: 5, shown: 3 };

function kpiClass(value, target) {
  if (target <= 0) return '';
  if (value <= 0) return 'kpi-gray';
  const pct = value / target;
  if (pct >= 1) return 'kpi-green';
  if (pct >= 0.5) return 'kpi-yellow';
  return 'kpi-red';
}

/* ‚îÄ‚îÄ BDC Column-Relative Gradient ‚îÄ‚îÄ */
/* Computes min/max per metric across all BDC rows, then colors each cell
   on a red ‚Üí yellow ‚Üí green scale based on where it falls in that range. */
function bdcColumnRanges(rows) {
  const metrics = ['calls','texts','created','due','trending'];
  const ranges = {};
  metrics.forEach(m => {
    let min = Infinity, max = -Infinity;
    rows.forEach(r => {
      let v;
      if (m === 'calls') v = safeNum(r.calls);
      else if (m === 'texts') v = safeNum(r.texts);
      else if (m === 'created') v = safeNum(r.created ?? r.created_count ?? 0);
      else if (m === 'due') v = safeNum(r.due ?? r.due_count ?? 0);
      else if (m === 'trending') v = trendingSales(safeNum(shownVal(r)));
      else v = 0;
      if (v < min) min = v;
      if (v > max) max = v;
    });
    ranges[m] = { min, max };
  });
  return ranges;
}

function kpiColumnGradient(value, min, max) {
  if (max === min) {
    // Everyone has the same value
    if (value <= 0) return 'background:#f4f4f5;color:#a1a1aa;font-weight:600;';
    return 'background:#dcfce7;color:#16a34a;font-weight:700;';
  }
  if (value <= 0) return 'background:#f4f4f5;color:#a1a1aa;font-weight:600;';

  const pct = (value - min) / (max - min); // 0 = worst, 1 = best

  let r, g, b, tr, tg, tb;
  if (pct < 0.5) {
    const t = pct / 0.5;
    // red (#fee2e2) ‚Üí amber (#fef3c7)
    r = 254; g = Math.round(226 + t * (243 - 226)); b = Math.round(226 - t * (226 - 199));
    tr = Math.round(220 + t * (180 - 220)); tg = Math.round(38 + t * (83 - 38)); tb = Math.round(38 + t * (9 - 38));
  } else {
    const t = (pct - 0.5) / 0.5;
    // amber (#fef3c7) ‚Üí green (#dcfce7)
    r = Math.round(254 - t * (254 - 220)); g = Math.round(243 + t * (252 - 243)); b = Math.round(199 - t * (199 - 231));
    tr = Math.round(180 - t * (180 - 22)); tg = Math.round(83 + t * (163 - 83)); tb = Math.round(9 + t * (74 - 9));
  }
  return `background:rgb(${r},${g},${b});color:rgb(${tr},${tg},${tb});font-weight:700;`;
}

/* Green (high) ‚Üí Yellow (mid) ‚Üí Light-yellow (low) gradient for BDC Trending */
function trendingGradient(value, min, max) {
  if (max === min) {
    if (value <= 0) return 'background:#f4f4f5;color:#a1a1aa;font-weight:600;';
    return 'background:#dcfce7;color:#166534;font-weight:700;';
  }
  if (value <= 0) return 'background:#f4f4f5;color:#a1a1aa;font-weight:600;';

  const pct = (value - min) / (max - min); // 0 = lowest, 1 = highest

  let r, g, b, tr, tg, tb;
  if (pct < 0.5) {
    const t = pct / 0.5;
    // light yellow (#fefce8) ‚Üí yellow (#fef9c3)
    r = 254; g = Math.round(252 - t * (252 - 249)); b = Math.round(232 - t * (232 - 195));
    tr = Math.round(161 - t * (161 - 161)); tg = Math.round(128 + t * (138 - 128)); tb = Math.round(0 + t * (4 - 0));
  } else {
    const t = (pct - 0.5) / 0.5;
    // yellow (#fef9c3) ‚Üí green (#dcfce7)
    r = Math.round(254 - t * (254 - 220)); g = Math.round(249 + t * (252 - 249)); b = Math.round(195 + t * (231 - 195));
    tr = Math.round(161 - t * (161 - 22)); tg = Math.round(138 + t * (163 - 138)); tb = Math.round(4 + t * (74 - 4));
  }
  return `background:rgb(${r},${g},${b});color:rgb(${tr},${tg},${tb});font-weight:700;`;
}

/* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ Personal Scorecard + Rank + Leads at Risk ‚îÄ‚îÄ */
function buildPersonalSection(sales, bdc) {
  const me = window.userData || {};
  const myName = (me.linkedName || '').trim();
  if (!myName) return ''; // not linked, skip

  // Always rank by primary metric (sales desc, shown desc) regardless of current sort
  const salesByUnits = [...sales].sort((a, b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown   = [...bdc].sort((a, b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));

  const myNameUpper = myName.toUpperCase();
  const salesIdx = salesByUnits.findIndex(r => (r.name || '').toUpperCase() === myNameUpper);
  const bdcIdx   = bdcByShown.findIndex(r => (r.name || '').toUpperCase() === myNameUpper);

  const inSales = salesIdx >= 0;
  const inBDC   = bdcIdx >= 0;
  if (!inSales && !inBDC) return ''; // not on either board

  let cards = '';

  if (inSales) {
    const r = salesByUnits[salesIdx];
    const rank = salesIdx + 1;
    const total = salesByUnits.length;
    const unitsSold = safeNum(r.sales);
    const calls = safeNum(r.calls);
    const texts = safeNum(r.texts);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const shown = safeNum(shownVal(r));
    const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : 'üìä';

    cards = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:80px;text-align:center;">
          <div style="font-size:22px;">${rankEmoji}</div>
          <div style="font-size:20px;font-weight:800;color:var(--accent);">#${rank}</div>
          <div style="font-size:10px;color:var(--muted);">of ${total} reps</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${unitsSold}</div>
          <div style="font-size:10px;color:var(--muted);">Units</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${calls}</div>
          <div style="font-size:10px;color:var(--muted);">Calls</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${texts}</div>
          <div style="font-size:10px;color:var(--muted);">Texts</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${created}</div>
          <div style="font-size:10px;color:var(--muted);">Appts Created</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${shown}</div>
          <div style="font-size:10px;color:var(--muted);">Appts Shown</div>
        </div>
      </div>`;
  }

  if (inBDC) {
    const r = bdcByShown[bdcIdx];
    const rank = bdcIdx + 1;
    const total = bdcByShown.length;
    const shown = safeNum(shownVal(r));
    const calls = safeNum(r.calls);
    const texts = safeNum(r.texts);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const due = safeNum(r.due ?? r.due_count ?? 0);
    const pct = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : '‚Äì';
    const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : 'üìä';

    cards = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:80px;text-align:center;">
          <div style="font-size:22px;">${rankEmoji}</div>
          <div style="font-size:20px;font-weight:800;color:var(--accent);">#${rank}</div>
          <div style="font-size:10px;color:var(--muted);">of ${total} agents</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${shown}</div>
          <div style="font-size:10px;color:var(--muted);">Shown</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${calls}</div>
          <div style="font-size:10px;color:var(--muted);">Calls</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${texts}</div>
          <div style="font-size:10px;color:var(--muted);">Texts</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${created}</div>
          <div style="font-size:10px;color:var(--muted);">Created</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${pct}</div>
          <div style="font-size:10px;color:var(--muted);">Show Rate</div>
        </div>
      </div>`;
  }

  const teamLabel = inSales ? 'Sales' : 'BDC';
  const firstName = myName.split(' ')[0] || myName;
  let streakHtml = '', pbAlertHtml = '', gainingHtml = '', sparklineHtml = '';
  try { streakHtml = getStreakBadgeHtml(); } catch(e) { console.warn('Streak badge error:', e); }
  try { pbAlertHtml = getPBAlertHtml(); } catch(e) { console.warn('PB alert error:', e); }
  try { gainingHtml = buildGainingTicker(sales, bdc); } catch(e) { console.warn('Gaining ticker error:', e); }
  try { sparklineHtml = buildSparklines(); } catch(e) { console.warn('Sparkline error:', e); }

  return `
    <div style="max-width:1400px;margin:0 auto 12px;padding:0 12px;">
      <div id="personalCard" style="background:linear-gradient(135deg,#1e293b,#334155);border-radius:14px;padding:16px 20px;color:#fff;">
        ${pbAlertHtml}
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
          <div style="font-size:15px;font-weight:700;">üëã Hey ${firstName} ‚Äî here's your ${teamLabel} snapshot ${streakHtml}</div>
          <div style="font-size:11px;color:#94a3b8;">MTD Performance</div>
        </div>
        ${cards}
        ${sparklineHtml}
        ${gainingHtml}
        <div id="leadsAtRiskBanner"></div>
      </div>
    </div>`;
}

/* Fetch reassignment data in background and show leads-at-risk banner */
function checkLeadsAtRisk() {
  const me = window.userData || {};
  const myName = (me.linkedName || '').trim();
  if (!myName) return;

  const url = `${SCRIPT_URL}?route=reassignments&session=${encodeURIComponent(window.sessionToken || '')}`;
  fetch(url).then(r => r.text()).then(raw => {
    let result;
    try { result = JSON.parse(raw); } catch { return; }
    if (!result.ok) return;

    const rows = result.rows || [];
    const myNameUpper = myName.toUpperCase();
    const myLeads = rows.filter(r =>
      (r.salesPerson || '').toUpperCase().includes(myNameUpper) ||
      (r.bdcAgent || '').toUpperCase().includes(myNameUpper)
    );

    const banner = document.getElementById('leadsAtRiskBanner');
    if (!banner) return;

    if (myLeads.length > 0) {
      const reviewCount = myLeads.filter(r => r.status === 'Active - Manager Review').length;
      const reviewNote = reviewCount > 0 ? ` ¬∑ <span style="color:#fca5a5;">${reviewCount} in Manager Review</span>` : '';
      banner.innerHTML = `
        <div onclick="${(isAdmin() || isManager()) ? 'showReassignments()' : ''}" style="margin-top:12px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:10px 14px;${(isAdmin() || isManager()) ? 'cursor:pointer;' : ''}display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;">
          <div>
            <span style="font-size:14px;">üö®</span>
            <strong style="color:#fca5a5;">You have ${myLeads.length} lead${myLeads.length !== 1 ? 's' : ''} with 3+ days no contact</strong>${reviewNote}
          </div>
          ${(isAdmin() || isManager()) ? '<span style="font-size:12px;color:#94a3b8;">View Reassignments ‚Üí</span>' : '<span style="font-size:12px;color:#94a3b8;">Follow up today!</span>'}
        </div>`;
    }
  }).catch(() => {});
}

/* ‚îÄ‚îÄ Pearson Correlation for KPI Analysis (all users) ‚îÄ‚îÄ */
function pearsonR(xs, ys) {
  const n = xs.length;
  if (n < 3) return null; // need at least 3 data points
  const mx = xs.reduce((s, v) => s + v, 0) / n;
  const my = ys.reduce((s, v) => s + v, 0) / n;
  let num = 0, dx2 = 0, dy2 = 0;
  for (let i = 0; i < n; i++) {
    const dx = xs[i] - mx, dy = ys[i] - my;
    num += dx * dy;
    dx2 += dx * dx;
    dy2 += dy * dy;
  }
  const denom = Math.sqrt(dx2 * dy2);
  return denom === 0 ? 0 : num / denom;
}

function buildCorrelationBox(rows, targetKey, targetLabel, kpiDefs) {
  if (rows.length < 3) return '';

  const targetVals = rows.map(r => {
    if (targetKey === 'shown') return safeNum(shownVal(r));
    return safeNum(r[targetKey]);
  });

  const results = [];
  kpiDefs.forEach(kpi => {
    const vals = rows.map(r => {
      if (kpi.key === 'shown') return safeNum(shownVal(r));
      if (kpi.key === 'pctShown') {
        const shown = safeNum(shownVal(r));
        const due = safeNum(r.due ?? r.due_count ?? 0);
        const created = safeNum(r.created ?? r.created_count ?? 0);
        return due > 0 ? shown / due : (created > 0 ? shown / created : 0);
      }
      return safeNum(r[kpi.key] ?? r[kpi.alt] ?? 0);
    });
    const r = pearsonR(vals, targetVals);
    if (r !== null) results.push({ label: kpi.label, r });
  });

  results.sort((a, b) => Math.abs(b.r) - Math.abs(a.r));

  let rows_html = results.map(item => {
    const absR = Math.abs(item.r);
    const sign = item.r >= 0 ? '+' : '‚àí';
    const color = absR >= 0.7 ? '#16a34a' : absR >= 0.4 ? '#ca8a04' : '#94a3b8';
    const strength = absR >= 0.7 ? 'Strong' : absR >= 0.4 ? 'Moderate' : 'Weak';
    const barW = Math.round(absR * 100);
    const barColor = item.r >= 0
      ? (absR >= 0.7 ? '#22c55e' : absR >= 0.4 ? '#eab308' : '#d1d5db')
      : (absR >= 0.7 ? '#ef4444' : absR >= 0.4 ? '#f97316' : '#d1d5db');
    return `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--line);">
      <div style="width:110px;font-size:12px;font-weight:600;">${item.label}</div>
      <div style="flex:1;height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
        <div style="width:${barW}%;height:100%;background:${barColor};border-radius:4px;transition:width .3s;"></div>
      </div>
      <div style="min-width:50px;text-align:right;font-size:12px;font-weight:700;color:${color};">${sign}${absR.toFixed(2)}</div>
      <div style="min-width:60px;text-align:right;font-size:10px;color:${color};">${strength}</div>
    </div>`;
  }).join('');

  return `
    <div style="margin-top:12px;padding:14px 16px;background:var(--card);border:1px solid var(--line);border-radius:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div style="font-weight:700;font-size:13px;">üìê KPI Correlation to ${targetLabel}</div>
        <div style="font-size:10px;color:var(--muted);">Pearson r ¬∑ ${rows.length} reps</div>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:8px;">Which metrics most predict ${targetLabel.toLowerCase()}?</div>
      ${rows_html}
      <div style="margin-top:8px;font-size:10px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap;">
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#22c55e;"></span> Strong (‚â•0.70)</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#eab308;"></span> Moderate (0.40‚Äì0.69)</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#d1d5db;"></span> Weak (&lt;0.40)</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#ef4444;"></span> Negative</span>
      </div>
    </div>`;
}

/* ‚îÄ‚îÄ Day-of-Week & Time-of-Day Performance Patterns (admin only) ‚îÄ‚îÄ */
let _callPatternsData = null;
let _callPatternsFilter = 'total'; // 'total', 'inbound', 'outbound'

function setCallPatternsFilter(f) {
  _callPatternsFilter = f;
  renderCallPatternsFromCache();
}
window.setCallPatternsFilter = setCallPatternsFilter;

function loadCallPatterns() {
  if (!isAdmin() && !isManager()) return;
  const container = document.getElementById('callPatternsBox');
  if (!container) return;

  const url = `${SCRIPT_URL}?route=callpatterns&session=${encodeURIComponent(window.sessionToken || '')}`;
  fetch(url).then(r => r.text()).then(raw => {
    let result;
    try { result = JSON.parse(raw); } catch { return; }
    if (!result.ok) return;
    _callPatternsData = result;
    _callPatternsFilter = 'total';
    renderCallPatternsFromCache();
  }).catch(err => {
    console.error('Call patterns load error:', err);
  });
}

function renderCallPatternsFromCache() {
  const container = document.getElementById('callPatternsBox');
  if (!container || !_callPatternsData) return;

  const result = _callPatternsData;
  // Support both old format (flat) and new format (total/inbound/outbound)
  const hasNewFormat = result.total && result.total.heatmap;
  const slice = hasNewFormat
    ? (result[_callPatternsFilter] || result.total)
    : { heatmap: result.heatmap || [], dayTotals: result.dayTotals || [], hourTotals: result.hourTotals || [] };
  const showToggle = hasNewFormat;
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const heatmap = slice.heatmap || [];

  // Filter label
  const filterLabels = { total: 'All Calls', inbound: 'Inbound', outbound: 'Outbound' };
  const filterColors = { total: '#166534', inbound: '#2563eb', outbound: '#f97316' };
  const heatPalettes = {
    total:    { bg: ['var(--card)','#f0fdf4','#bbf7d0','#86efac','#22c55e','#166534'], fg6: '#fff' },
    inbound:  { bg: ['var(--card)','#eff6ff','#bfdbfe','#93c5fd','#3b82f6','#1d4ed8'], fg6: '#fff' },
    outbound: { bg: ['var(--card)','#fff7ed','#fed7aa','#fdba74','#f97316','#c2410c'], fg6: '#fff' },
  };
  const palette = heatPalettes[_callPatternsFilter];

  // Hour range
  let minHour = 23, maxHour = 0;
  heatmap.forEach(c => {
    if (c.hour < minHour) minHour = c.hour;
    if (c.hour > maxHour) maxHour = c.hour;
  });
  if (minHour > maxHour) { minHour = 7; maxHour = 20; }
  minHour = Math.max(0, minHour - 1);
  maxHour = Math.min(23, maxHour + 1);

  // Build grid
  const grid = {};
  let maxCount = 1;
  heatmap.forEach(c => {
    if (!grid[c.day]) grid[c.day] = {};
    grid[c.day][c.hour] = c;
    if (c.count > maxCount) maxCount = c.count;
  });

  function heatColor(count) {
    if (!count) return palette.bg[0];
    const pct = count / maxCount;
    if (pct >= 0.8) return palette.bg[5];
    if (pct >= 0.6) return palette.bg[4];
    if (pct >= 0.4) return palette.bg[3];
    if (pct >= 0.2) return palette.bg[2];
    return palette.bg[1];
  }
  function textColor(count) {
    if (!count) return 'var(--muted)';
    const pct = count / maxCount;
    return pct >= 0.6 ? palette.fg6 : '#1e293b';
  }
  function fmtHour(h) {
    if (h === 0) return '12a';
    if (h < 12) return h + 'a';
    if (h === 12) return '12p';
    return (h - 12) + 'p';
  }

  // Build table
  let gridHTML = '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:11px;">';
  gridHTML += '<thead><tr><th style="padding:4px 6px;text-align:left;font-size:10px;color:var(--muted);">Day</th>';
  for (let h = minHour; h <= maxHour; h++) {
    gridHTML += `<th style="padding:4px 2px;text-align:center;font-size:9px;color:var(--muted);min-width:32px;">${fmtHour(h)}</th>`;
  }
  gridHTML += '<th style="padding:4px 6px;text-align:right;font-size:10px;color:var(--muted);">Total</th></tr></thead><tbody>';

  const dayOrder = [1,2,3,4,5,6,0];
  const dayTotals = slice.dayTotals || [];
  const hourTotals = slice.hourTotals || [];

  dayOrder.forEach(d => {
    const dayTotal = dayTotals[d] || 0;
    const isWeekend = d === 0 || d === 6;
    gridHTML += `<tr><td style="padding:4px 6px;font-weight:700;font-size:11px;${isWeekend ? 'color:var(--muted);' : ''}">${dayNames[d]}</td>`;
    for (let h = minHour; h <= maxHour; h++) {
      const cell = (grid[d] || {})[h];
      const count = cell ? cell.count : 0;
      const talk = cell ? cell.avgTalk : 0;
      const bg = heatColor(count);
      const fg = textColor(count);
      const title = count > 0 ? `${dayNames[d]} ${fmtHour(h)}: ${count} ${filterLabels[_callPatternsFilter].toLowerCase()}, avg ${talk.toFixed(1)}min` : `${dayNames[d]} ${fmtHour(h)}: no calls`;
      gridHTML += `<td style="padding:3px 1px;text-align:center;background:${bg};color:${fg};border-radius:3px;font-weight:${count > 0 ? '600' : '400'};" title="${title}">${count || '¬∑'}</td>`;
    }
    gridHTML += `<td style="padding:4px 6px;text-align:right;font-weight:700;font-size:11px;">${dayTotal}</td></tr>`;
  });

  gridHTML += '<tr><td style="padding:4px 6px;font-size:10px;color:var(--muted);font-weight:600;">Total</td>';
  for (let h = minHour; h <= maxHour; h++) {
    const ht = hourTotals[h] || 0;
    gridHTML += `<td style="padding:3px 1px;text-align:center;font-size:10px;font-weight:600;color:var(--muted);">${ht || '¬∑'}</td>`;
  }
  const grandTotal = dayTotals.reduce((s, v) => s + v, 0);
  gridHTML += `<td style="padding:4px 6px;text-align:right;font-weight:800;font-size:12px;">${grandTotal}</td></tr>`;
  gridHTML += '</tbody></table></div>';

  // Insights
  let peakDay = 0, peakDayVal = 0;
  dayTotals.forEach((v, i) => { if (v > peakDayVal) { peakDayVal = v; peakDay = i; } });
  let peakHour = 0, peakHourVal = 0;
  hourTotals.forEach((v, i) => { if (v > peakHourVal) { peakHourVal = v; peakHour = i; } });
  let deadHour = -1, deadHourVal = Infinity;
  for (let h = 8; h <= 18; h++) {
    const v = hourTotals[h] || 0;
    if (v < deadHourVal) { deadHourVal = v; deadHour = h; }
  }
  const accentClr = filterColors[_callPatternsFilter];
  const insights = `
    <div style="margin-top:10px;font-size:11px;color:var(--muted);line-height:1.7;">
      ‚Ä¢ <strong>${dayNames[peakDay]}</strong> is the busiest day with ${peakDayVal} total calls<br>
      ${deadHour >= 0 ? `‚Ä¢ <strong style="color:#dc2626;">${fmtHour(deadHour)}‚Äì${fmtHour(deadHour+1)}</strong> is the slowest business hour ‚Äî only ${deadHourVal} calls<br>` : ''}
      ‚Ä¢ Peak calling hour overall: <strong>${fmtHour(peakHour)}‚Äì${fmtHour(peakHour+1)}</strong> with ${peakHourVal} calls
    </div>`;

  // Legend with palette colors
  const legend = `<div style="display:flex;gap:6px;align-items:center;margin-top:8px;font-size:10px;color:var(--muted);">
    <span>Low</span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[1]};border:1px solid var(--line);border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[2]};border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[3]};border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[4]};border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[5]};border-radius:2px;"></span>
    <span>High</span>
    <span style="margin-left:8px;">¬∑ Hover cells for details</span>
  </div>`;

  // Toggle buttons
  function tbtn(key, label) {
    const active = _callPatternsFilter === key;
    const clr = filterColors[key];
    return `<button onclick="setCallPatternsFilter('${key}')" style="padding:3px 10px;font-size:11px;font-weight:${active ? '700' : '500'};border:1px solid ${active ? clr : 'var(--line)'};background:${active ? clr : 'transparent'};color:${active ? '#fff' : 'var(--text)'};border-radius:6px;cursor:pointer;transition:all .15s;">${label}</button>`;
  }

  // Totals for each filter for the header
  const totalAll = (hasNewFormat ? result.total?.dayTotals : slice.dayTotals || []).reduce((s, v) => s + v, 0);
  const totalIB  = hasNewFormat ? (result.inbound?.dayTotals || []).reduce((s, v) => s + v, 0) : 0;
  const totalOB  = hasNewFormat ? (result.outbound?.dayTotals || []).reduce((s, v) => s + v, 0) : 0;

  const dateRangeStr = result.dateRange ? `${result.dateRange.from || '?'} ‚Äì ${result.dateRange.to || '?'}` : '';

  container.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-weight:700;font-size:13px;">üïê Call Activity Heatmap</div>
        ${showToggle ? `<div style="display:flex;gap:4px;">
          ${tbtn('total', 'Total')}
          ${tbtn('inbound', 'IB')}
          ${tbtn('outbound', 'OB')}
        </div>` : ''}
      </div>
      <div style="font-size:10px;color:var(--muted);">${result.month || 'MTD'}${dateRangeStr ? ` ¬∑ <span style="color:var(--text);">${dateRangeStr}</span>` : ''} ¬∑ ${grandTotal} ${filterLabels[_callPatternsFilter].toLowerCase()}${showToggle ? ` ¬∑ <span style="color:var(--text);">${totalAll} total</span> (<span style="color:#2563eb;">${totalIB} IB</span> / <span style="color:#f97316;">${totalOB} OB</span>)` : ''}</div>
    </div>
    <div style="font-size:10px;color:var(--muted);margin-bottom:8px;">When are ${_callPatternsFilter === 'total' ? 'calls' : _callPatternsFilter + ' calls'} happening? Darker = more calls in that time slot.</div>
    ${gridHTML}
    ${legend}
    ${insights}`;
}

function renderDashboard() {
  const me = window.userData || {};
  const bdc   = sortRows(dashboardData.bdc, bdcSort, 'bdc');
  const sales = sortRows(dashboardData.sales, salesSort, 'sales');
  const bs = bdcStats(bdc);
  const ss = salesStats(sales);
  const now = timeStr();
  const bdcRanges = bdcColumnRanges(bdc);

  function sortArrow(panel, col) {
    const s = panel === 'bdc' ? bdcSort : salesSort;
    const active = s.col === col;
    const arrow = active ? (s.dir === 'desc' ? '‚ñº' : '‚ñ≤') : '‚Üï';
    return `<span class="sort-arrow">${arrow}</span>`;
  }
  function thAttr(panel, col) {
    return `class="${(panel === 'bdc' ? bdcSort : salesSort).col === col ? 'sorted' : ''}" onclick="toggleSort('${panel}','${col}')"`;
  }
  function thDrag(panel, col) {
    return `draggable="true" ondragstart="onColDragStart(event,'${panel}','${col}')" ondragend="onColDragEnd(event)" ondragover="onColDragOver(event)" ondrop="onColDrop(event,'${panel}','${col}')" style="cursor:grab;"`;
  }

  function trophy(i) {
    if (i === 0) return '<span class="trophy">ü•á</span>';
    if (i === 1) return '<span class="trophy">ü•à</span>';
    if (i === 2) return '<span class="trophy">ü•â</span>';
    return '';
  }

  /* ‚îÄ‚îÄ BDC cell renderer ‚îÄ‚îÄ */
  function bdcCellData(r) {
    const shown   = safeNum(shownVal(r));
    const calls   = safeNum(r.calls);
    const texts   = safeNum(r.texts);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const due     = safeNum(r.due ?? r.due_count ?? 0);
    const pct     = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : (created > 0 ? ((shown / created) * 100).toFixed(1) + '%' : '‚Äì');
    const callsS   = kpiColumnGradient(calls, bdcRanges.calls.min, bdcRanges.calls.max);
    const textsS   = kpiColumnGradient(texts, bdcRanges.texts.min, bdcRanges.texts.max);
    const createdS = kpiColumnGradient(created, bdcRanges.created.min, bdcRanges.created.max);
    const dueS     = kpiColumnGradient(due, bdcRanges.due.min, bdcRanges.due.max);
    const trendShown = trendingSales(shown);
    const trendS = trendingGradient(trendShown, bdcRanges.trending.min, bdcRanges.trending.max);
    return {
      shown:    `<td><strong>${shown}</strong></td>`,
      trending: `<td style="${trendS}">${trendShown}</td>`,
      pctShown: `<td>${pct}</td>`,
      due:      `<td style="${dueS}">${due}</td>`,
      created:  `<td style="${createdS}">${created}</td>`,
      calls:    `<td style="${callsS}">${calls}</td>`,
      texts:    `<td style="${textsS}">${texts}</td>`,
    };
  }

  function bdcRow(r, i) {
    const name = r.name || '‚Äì';
    const top3    = i < 3 ? ' top3' : '';
    const allowed = canViewName(name);
    const click   = allowed ? `onclick="showPersonDetails('${name.replace(/'/g, "\\'")}', 'BDC')" onmouseenter="onRowHover('${name.replace(/'/g, "\\'")}')"` : '';
    const cursor  = allowed ? 'cursor:pointer;' : 'opacity:0.7;';
    const cells = bdcCellData(r);
    return `<tr class="${top3}" ${click} style="${cursor}">
      <td class="rank-cell">${trophy(i)}${i < 3 ? '' : (i + 1)}</td>
      <td class="name-cell">${name}</td>
      ${bdcColOrder.map(k => cells[k]).join('')}
    </tr>`;
  }
  
  /* ‚îÄ‚îÄ Sales cell renderer ‚îÄ‚îÄ */
  function salesCellData(r) {
    const salesV  = safeNum(r.sales);
    const calls   = safeNum(r.calls);
    const texts   = safeNum(r.texts);
    const visits  = safeNum(r.visits);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const due     = safeNum(r.due ?? r.due_count ?? 0);
    const shown   = safeNum(shownVal(r));
    const pct     = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : (created > 0 ? ((shown / created) * 100).toFixed(1) + '%' : '‚Äì');
    const closeRate = visits > 0 ? ((salesV / visits) * 100).toFixed(1) + '%' : '‚Äì';
    const callsK   = kpiClass(calls, WEEKLY_TARGETS.calls);
    const textsK   = kpiClass(texts, WEEKLY_TARGETS.texts);
    const createdK = kpiClass(created, WEEKLY_TARGETS.created);
    const dueK     = kpiClass(due, WEEKLY_TARGETS.due);
    const shownK   = kpiClass(shown, WEEKLY_TARGETS.shown);
    const trend = trendingSales(salesV);
    const trendStyle = trend >= 20 ? 'background:#bbf7d0;color:#166534;font-weight:700;'
                     : trend >= 12 ? 'background:#dcfce7;color:#16a34a;font-weight:700;'
                     : trend >= 10 ? 'background:#fef9c3;color:#ca8a04;font-weight:700;'
                     :               'background:#f4f4f5;color:#a1a1aa;font-weight:600;';
    return {
      sales:     `<td class="sales-primary">${salesV}</td>`,
      trending:  `<td style="${trendStyle}">${trend}</td>`,
      closeRate: `<td style="font-weight:600;">${closeRate}</td>`,
      pctShown:  `<td>${pct}</td>`,
      shown:     `<td class="${shownK}">${shown}</td>`,
      due:       `<td class="${dueK}">${due}</td>`,
      created:   `<td class="${createdK}">${created}</td>`,
      calls:     `<td class="${callsK}">${calls}</td>`,
      texts:     `<td class="${textsK}">${texts}</td>`,
    };
  }

  function salesRow(r, i) {
    const name    = r.name || '‚Äì';
    const top3    = i < 3 ? ' top3' : '';
    const allowed = canViewName(name);
    const click   = allowed ? `onclick="showPersonDetails('${name.replace(/'/g, "\\'")}', 'Sales')" onmouseenter="onRowHover('${name.replace(/'/g, "\\'")}')"` : '';
    const cursor  = allowed ? 'cursor:pointer;' : 'opacity:0.7;';
    const cells = salesCellData(r);
    return `<tr class="${top3}" ${click} style="${cursor}">
      <td class="rank-cell">${trophy(i)}${i < 3 ? '' : (i + 1)}</td>
      <td class="name-cell">${name}</td>
      ${salesColOrder.map(k => cells[k]).join('')}
    </tr>`;
  }

  /* ‚îÄ‚îÄ Manager row renderers (team-aggregated view) ‚îÄ‚îÄ */
  function managerSalesCellData(team) {
    const salesV = team.sales;
    const calls = team.calls;
    const texts = team.texts;
    const visits = team.visits;
    const created = team.created;
    const due = team.due;
    const shown = team.shown;
    const mc = team.memberCount || 1;
    const pct = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : (created > 0 ? ((shown / created) * 100).toFixed(1) + '%' : '‚Äì');
    const closeRate = visits > 0 ? ((salesV / visits) * 100).toFixed(1) + '%' : '‚Äì';
    const trend = trendingSales(salesV);
    const trendPerMember = mc > 0 ? trend / mc : 0;
    const trendStyle = trendPerMember >= 20 ? 'background:#bbf7d0;color:#166534;font-weight:700;'
                     : trendPerMember >= 12 ? 'background:#dcfce7;color:#16a34a;font-weight:700;'
                     : trendPerMember >= 10 ? 'background:#fef9c3;color:#ca8a04;font-weight:700;'
                     :                        'background:#f4f4f5;color:#a1a1aa;font-weight:600;';
    const callsK = kpiClass(calls, WEEKLY_TARGETS.calls * mc);
    const textsK = kpiClass(texts, WEEKLY_TARGETS.texts * mc);
    const createdK = kpiClass(created, WEEKLY_TARGETS.created * mc);
    const dueK = kpiClass(due, WEEKLY_TARGETS.due * mc);
    const shownK = kpiClass(shown, WEEKLY_TARGETS.shown * mc);
    return {
      sales:     `<td class="sales-primary">${salesV}</td>`,
      trending:  `<td style="${trendStyle}">${trend}</td>`,
      closeRate: `<td style="font-weight:600;">${closeRate}</td>`,
      pctShown:  `<td>${pct}</td>`,
      shown:     `<td class="${shownK}">${shown}</td>`,
      due:       `<td class="${dueK}">${due}</td>`,
      created:   `<td class="${createdK}">${created}</td>`,
      calls:     `<td class="${callsK}">${calls}</td>`,
      texts:     `<td class="${textsK}">${texts}</td>`,
    };
  }

  function managerSalesRow(team, i) {
    const name = team.name || '‚Äì';
    const members = team.memberCount || 0;
    const top3 = i < 3 ? ' top3' : '';
    const cells = managerSalesCellData(team);
    return `<tr class="${top3}" onclick="showTeamDashboard('${team.managerId}')" style="cursor:pointer;">
      <td class="rank-cell">${trophy(i)}${i < 3 ? '' : (i + 1)}</td>
      <td class="name-cell">${name} <span style="font-size:10px;color:var(--muted);font-weight:400;">(${members} member${members !== 1 ? 's' : ''})</span></td>
      ${salesColOrder.map(k => cells[k]).join('')}
    </tr>`;
  }

  /* ‚îÄ‚îÄ Compute Sales tbody (individual or team view) ‚îÄ‚îÄ */
  let salesTbodyHtml;
  if (_lbViewMode === 'teams') {
    const mgrRows = buildManagerSalesRows();
    if (!mgrRows) {
      salesTbodyHtml = `<tr><td colspan="${2 + salesColOrder.length}" style="padding:30px;color:var(--muted);">Loading team data‚Ä¶</td></tr>`;
    } else if (!mgrRows.length) {
      salesTbodyHtml = `<tr><td colspan="${2 + salesColOrder.length}" style="padding:30px;color:var(--muted);">No teams found ‚Äî assign managers to users via User Management</td></tr>`;
    } else {
      const sorted = sortRows(mgrRows, salesSort, 'sales');
      salesTbodyHtml = sorted.map((r, i) => managerSalesRow(r, i)).join('');
    }
  } else {
    salesTbodyHtml = sales.length
      ? sales.map((r, i) => salesRow(r, i)).join('')
      : `<tr><td colspan="${2 + salesColOrder.length}" style="padding:30px;color:var(--muted);">No sales data</td></tr>`;
  }

  document.getElementById('app').innerHTML = `
    <!-- Top Bar -->
    <div class="topbar">
      <div class="topbar-logo">SA</div>
      <div class="topbar-info">
        <div class="topbar-title">BDC &amp; Sales Leaderboards</div>
        <div class="topbar-sub"><span class="refresh-dot"></span><span id="topbarQuote"></span></div>
      </div>
      <div class="topbar-actions">
        <div style="position:relative;display:inline-block;" id="resourcesWrap">
          <button class="topbar-btn manage" onclick="toggleResourcesMenu()" style="min-width:110px;">üìÇ Resources ‚ñæ</button>
          <div id="resourcesMenu" style="display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:1000;min-width:220px;padding:6px 0;max-height:70vh;overflow-y:auto;">
            <a href="https://sanantoniododge.com" target="_blank" class="res-link">üåê Website</a>
            <a href="https://www.eleadcrm.com/evo2/fresh/login.asp?logout=1&CID=0&USERID=0&SESSIONID=" target="_blank" class="res-link">üñ•Ô∏è Old CRM</a>
            <a href="https://retail.cdk.com/login/login.htm?fromURI=%2Fapp%2Fmodern-retailing_eleadcrm_2%2Fexk3ds515b8OezABo697%2Fsso%2Fsaml%3FSAMLRequest%3DfZHNbsIwEITvSLxD5DtxYpofLEBKywWJqhK0PfSCnHgpFrGdep2C%252BvRNQ1HLhevMfjua3SkKXbOGF63fmzV8tIA%252BOOnaID87M9I6w61AhdwIDch9xTfF44qzMOKNs95Wtib%252FmduIQATnlTUkWC5mRMkqjuNdFCdsIuVdPk5LEGlaTuKclWkpdxkJXsFhB8xIx3cUYgtLg14Y30kRS0YxG7HsORrzKOOMvZFg0dVQRvie2nvfIKfUgReqDit5CCurqWgaqq0EZ0ZnR5n3LdQgZOX0llE4HcYSkzgp8yf4Ku5tOskooqU%252FJUlQXHo8WIOtBrcB96kqeFmv%252FiKPx2N4WdmHdjyZDwdBMO1Pxfsybn5rfkqvRoeDX%252BH6afNv%26RelayState%3DdFxaLjd1sdMLESVboy1b35lo" target="_blank" class="res-link">üíª New CRM</a>
            <a href="https://auth.automotivemastermind.com/u/login/identifier?state=hKFo2SBqMkxFdnZqYUQzSmI5OFIzVFNXNGtLM2IzcDZrZDVXX6Fur3VuaXZlcnNhbC1sb2dpbqN0aWTZIEhzUjFTRVpIZ2RWeG1HNm1CX0xNM0lnQXJqSXNiVFY0o2NpZNkgQ0pHdUlpQThVZmRiVDRxMU54RTF6dU9NV3d0YTNuOWg" target="_blank" class="res-link">üß† Dealer Mastermind</a>
            <div style="border-top:1px solid var(--line);margin:4px 0;"></div>
            <a href="https://www.ramtrucks.com/vehicle-selector.incentives.html" target="_blank" class="res-link">üêè Ram Incentives</a>
            <a href="https://www.jeep.com/vehicle-selector.incentives.html" target="_blank" class="res-link">üèîÔ∏è Jeep Incentives</a>
            <a href="https://www.jeep.com/vehicle-selector.incentives.html" target="_blank" class="res-link">üîµ Chrysler Incentives</a>
            <a href="https://www.dodge.com/vehicle-selector.incentives.html" target="_blank" class="res-link">üî¥ Dodge Incentives</a>
            <div style="border-top:1px solid var(--line);margin:4px 0;"></div>
            <a href="https://dealerconnect.chrysler.com/login/login.html?TYPE=33554433&REALMOID=06-d5cf97a8-bccd-103a-bcc8-83e513310cb3&GUID=&SMAUTHREASON=0&METHOD=GET&SMAGENTNAME=-SM-go2wTta208Z%2fzUCz5DbrvlEeym4%2faGv4KExpKsILVlca0WM5Is5FVfWQwWKj8l6iqbgVd8ZTMNXhZNBworA80NiZt2yCKScu&TARGET=-SM-https%3a%2f%2fdealerconnect%2echrysler%2ecom%2fportal%2fController%2fPortal" target="_blank" class="res-link">üîó DealerConnect</a>
            <a href="https://gemini.google.com/app" target="_blank" class="res-link">‚ú® Gemini AI</a>
            <a href="#" onclick="event.preventDefault();closeResourcesMenu();showAutoNews();" class="res-link">üì∞ News (Last 48 hrs)</a>
            <a href="#" onclick="event.preventDefault();closeResourcesMenu();showRecallLookup();" class="res-link">üîî Recall & TSB Lookup</a>
            ${(isAdmin() || isManager()) ? '<a href="#" onclick="event.preventDefault();closeResourcesMenu();showCompetitiveAnalysis();" class="res-link">üèÜ Competitive Analysis</a>' : ''}
            <a href="#" onclick="event.preventDefault();closeResourcesMenu();showRoster();" class="res-link">üìã Roster</a>
            <div id="customLinksSection"></div>
            <div style="border-top:1px solid var(--line);margin:4px 0;"></div>
            <div id="addLinkForm" style="padding:6px 12px;">
              <a href="#" onclick="event.preventDefault();event.stopPropagation();showAddLinkForm();" class="res-link" id="addLinkBtn" style="color:var(--accent);font-weight:600;">‚ûï Add My Link</a>
              <div id="addLinkFields" style="display:none;padding:4px 0;">
                <input id="newLinkLabel" type="text" placeholder="Label (e.g. My Tool)" maxlength="40" style="width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-size:12px;margin-bottom:4px;box-sizing:border-box;" onclick="event.stopPropagation();" onkeydown="if(event.key==='Enter'){event.stopPropagation();document.getElementById('newLinkUrl').focus();}" />
                <input id="newLinkUrl" type="url" placeholder="https://..." maxlength="500" style="width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-size:12px;margin-bottom:6px;box-sizing:border-box;" onclick="event.stopPropagation();" onkeydown="if(event.key==='Enter'){event.stopPropagation();saveCustomLink();}" />
                <div style="display:flex;gap:6px;">
                  <button onclick="event.stopPropagation();saveCustomLink();" style="flex:1;padding:5px 0;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">Save</button>
                  <button onclick="event.stopPropagation();hideAddLinkForm();" style="flex:1;padding:5px 0;background:var(--line);color:var(--text);border:none;border-radius:6px;font-size:12px;cursor:pointer;">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        ${(isAdmin() || isManager()) ? `<div style="position:relative;display:inline-block;" id="reportsWrap">
          <button class="topbar-btn manage" onclick="toggleReportsMenu()" style="min-width:110px;">üìä Reports ‚ñæ</button>
          <div id="reportsMenu" style="display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:1000;min-width:200px;padding:6px 0;">
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showReassignments();" class="res-link">üîÑ Reassignments</a>
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showActivityModal();" class="res-link">üïê Activity Log</a>
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showVehicleDemand();" class="res-link">üöó Vehicle Demand</a>
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showManagerLeaderboard();" class="res-link">üèÜ Manager Leaderboard</a>
            ${isAdmin() ? '<div style="border-top:1px solid var(--line);margin:4px 0;"></div><a href="#" onclick="event.preventDefault();closeReportsMenu();showLeadFunnel();" class="res-link">üî¨ Lead Funnel</a>' : ''}
            ${isAdmin() ? '<a href="#" onclick="event.preventDefault();closeReportsMenu();showEngagement();" class="res-link">üìà Engagement</a>' : ''}
            <div style="border-top:1px solid var(--line);margin:4px 0;"></div>
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showRecordings();" class="res-link">üéôÔ∏è Recordings</a>
          </div>
        </div>` : ''}
        ${(isAdmin() || isManager()) ? '<button class="topbar-btn manage" onclick="showTeamDashboard()" style="min-width:90px;">üëî My Team</button>' : ''}
        ${isAdmin() ? '<button class="topbar-btn manage" onclick="openUploadCallsModal()">üì§ Upload Calls</button>' : ''}
        ${isAdmin() ? '<button class="topbar-btn manage" onclick="showUserModal()">üë§ Manage Users</button>' : ''}
        <button class="topbar-btn logout" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Two Panels -->
    ${buildPersonalSection(sales, bdc)}


    <div class="panels">

      <!-- ‚ïê‚ïê‚ïê BDC Panel ‚ïê‚ïê‚ïê -->
      <div>
        <div class="panel-header">
          <div class="panel-title">üìû BDC ‚Äì Appointments Shown</div>
          <div class="panel-subtitle">Top 3 highlighted by appointments shown ¬∑ click headers to sort ¬∑ drag to reorder</div>
        </div>

        <div class="stat-row">
          <div class="stat-card">
            <div class="stat-label">Total Appts Shown üë£</div>
            <div class="stat-value">${bs.totalShown}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Appts Created üìã</div>
            <div class="stat-value">${bs.totalCreated}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Show Rate üéØ</div>
            <div class="stat-value">${bs.avgShowRate}%</div>
          </div>
        </div>

        <div class="chip-row">
          <div class="chip active">MTD</div>
        </div>

        <div class="kpi-legend" style="align-items:center;">
          <span style="display:inline-flex;align-items:center;gap:6px;">
            <span style="display:inline-block;width:120px;height:10px;border-radius:5px;background:linear-gradient(to right,#fee2e2 0%,#fef3c7 50%,#dcfce7 100%);border:1px solid var(--line);"></span>
            <span>lowest ‚Üí highest in column</span>
          </span>
          <span><span class="kpi-dot gray"></span> no activity</span>
        </div>

        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th class="rank-cell" ${thAttr('bdc','rank')}>Rank ${sortArrow('bdc','rank')}</th>
                <th style="text-align:left;" ${thAttr('bdc','name')}>Name ${sortArrow('bdc','name')}</th>
                ${bdcColOrder.map(k => `<th ${thAttr('bdc', BDC_COL_DEFS[k].key)} ${thDrag('bdc', k)}>${BDC_COL_DEFS[k].label} ${sortArrow('bdc', BDC_COL_DEFS[k].key)}</th>`).join('\n                ')}
              </tr>
            </thead>
            <tbody>
              ${bdc.length ? bdc.map((r, i) => bdcRow(r, i)).join('') : '<tr><td colspan="' + (2 + bdcColOrder.length) + '" style="padding:30px;color:var(--muted);">No BDC data</td></tr>'}
            </tbody>
          </table>
        </div>
        ${buildCorrelationBox(bdc, 'shown', 'Appts Shown', [
          { key: 'calls', label: 'Calls' },
          { key: 'texts', label: 'Texts' },
          { key: 'created', alt: 'created_count', label: 'Appts Created' },
          { key: 'due', alt: 'due_count', label: 'Appts Due' },
          { key: 'pctShown', label: '% Show Rate' },
        ])}
        ${buildCorrelationBox(sales, 'sales', 'Units Sold', [
          { key: 'calls', label: 'Calls' },
          { key: 'texts', label: 'Texts' },
          { key: 'created', alt: 'created_count', label: 'Appts Created' },
          { key: 'due', alt: 'due_count', label: 'Appts Due' },
          { key: 'shown', label: 'Appts Shown' },
          { key: 'pctShown', label: '% Show Rate' },
        ])}
        <!-- Call patterns removed -->
      </div>

      <!-- ‚ïê‚ïê‚ïê Sales Panel ‚ïê‚ïê‚ïê -->
      <div>
        <div class="panel-header">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
            <div class="panel-title">${_lbViewMode === 'teams' ? 'üëî Manager Leaderboard' : 'üöó Sales ‚Äì Units Sold'}</div>
            <button onclick="toggleLeaderboardView()" style="padding:5px 14px;font-size:11px;font-weight:600;border:1px solid ${_lbViewMode === 'teams' ? 'var(--accent)' : 'var(--line)'};background:${_lbViewMode === 'teams' ? 'var(--accent)' : 'transparent'};color:${_lbViewMode === 'teams' ? '#fff' : 'var(--text)'};border-radius:6px;cursor:pointer;transition:all .15s;">${_lbViewMode === 'individual' ? 'üë• View by Teams' : 'üë§ Individual View'}</button>
          </div>
          <div class="panel-subtitle">${_lbViewMode === 'teams' ? 'Aggregated team KPIs per manager ¬∑ click row for team details' : 'Ranked by units sold ¬∑ weekly KPI flags ¬∑ click headers to sort ¬∑ drag to reorder'}</div>
        </div>

        ${_lbViewMode === 'teams' ? (() => {
          const mgrRows = buildManagerSalesRows();
          const numTeams = mgrRows ? mgrRows.length : 0;
          const topTeam = mgrRows && mgrRows.length ? [...mgrRows].sort((a,b) => b.sales - a.sales)[0] : null;
          return `<div class="stat-row">
            <div class="stat-card">
              <div class="stat-label">Total Units üöó</div>
              <div class="stat-value">${ss.totalUnits}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Teams üë•</div>
              <div class="stat-value">${numTeams}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Top Team ‚≠ê</div>
              <div class="stat-value top-performer">${topTeam ? topTeam.name + ' (' + topTeam.sales + ')' : '‚Äì'}</div>
            </div>
          </div>`;
        })() : `<div class="stat-row">
          <div class="stat-card">
            <div class="stat-label">Total Units üöó</div>
            <div class="stat-value">${ss.totalUnits}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Units / Rep üìä</div>
            <div class="stat-value">${ss.avgUnits}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Top Performer ‚≠ê</div>
            <div class="stat-value top-performer">${ss.topName} (${ss.topVal})</div>
          </div>
        </div>`}

        <div class="chip-row">
          <div class="chip active">MTD</div>
        </div>

        <div class="kpi-legend">
          <span><span class="kpi-dot green"></span> ‚â• target${_lbViewMode === 'teams' ? ' (scaled by team size)' : ''}</span>
          <span><span class="kpi-dot yellow"></span> some but &lt; target</span>
          <span><span class="kpi-dot gray"></span> no activity yet</span>
          <span><span class="kpi-dot red"></span> ${_lbViewMode === 'teams' ? 'well below team target' : 'sales well below target'}</span>
        </div>

        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th class="rank-cell" ${thAttr('sales','rank')}>Rank ${sortArrow('sales','rank')}</th>
                <th style="text-align:left;" ${thAttr('sales','name')}>Name ${sortArrow('sales','name')}</th>
                ${salesColOrder.map(k => `<th ${thAttr('sales', SALES_COL_DEFS[k].key)} ${thDrag('sales', k)}>${SALES_COL_DEFS[k].label} ${sortArrow('sales', SALES_COL_DEFS[k].key)}</th>`).join('\n                ')}
              </tr>
            </thead>
            <tbody>
              ${salesTbodyHtml}
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /panels -->
  `;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTO-REFRESH (5 min)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
setInterval(() => {
  if (window.userData && document.querySelector('.panels')) {
    showDashboard();
  }
}, 5 * 60 * 1000);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PERSON DETAILS (1-on-1 view)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function showPersonDetails(name, type) {
  trackClick();
  logPageView('Person Detail: ' + name);
  const appEl = document.getElementById('app');

  // Also start fetching calls in background so they're ready when user clicks "View Call Sheets"
  fetchCalls(name).catch(() => {});

  // Instant preview: use dashboard data we already have while full details load
  const preview = getDashboardRow(name);
  const isSalesPreview = type === 'Sales' || (preview && safeNum(preview.sales) > 0);

  if (preview && !personCache.has(cacheKey(name))) {
    // Show instant preview from leaderboard data
    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">${name}</div><div class="topbar-sub">${type || '‚Äì'} ¬∑ Loading full details‚Ä¶</div></div>
        <div class="topbar-actions">
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Back</button>
          <button class="topbar-btn logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="detail-card" style="margin-top:8px;">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:14px; margin-bottom:18px;">
          <div class="stat-card"><div class="stat-label">Calls (MTD)</div><div class="stat-value">${safeNum(preview.calls)}</div></div>
          ${isSalesPreview
            ? `<div class="stat-card"><div class="stat-label">Sales (MTD)</div><div class="stat-value">${safeNum(preview.sales)}</div></div>
               <div class="stat-card"><div class="stat-label">Texts (MTD)</div><div class="stat-value">${safeNum(preview.texts)}</div></div>`
            : `<div class="stat-card"><div class="stat-label">Appts Shown (MTD)</div><div class="stat-value">${safeNum(shownVal(preview))}</div></div>
               <div class="stat-card"><div class="stat-label">Appts Created (MTD)</div><div class="stat-value">${safeNum(preview.created ?? preview.created_count ?? 0)}</div></div>`
          }
        </div>
        <div style="text-align:center;padding:18px;color:var(--muted);font-size:13px;">
          <div class="spinner" style="margin:0 auto 10px;width:24px;height:24px;"></div>
          Loading full details, coaching notes & last work day‚Ä¶
        </div>
      </div>`;
  } else {
    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">Loading ${name}‚Ä¶</div></div>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>`;
  }

  try {
    const result = await fetchPerson(name);
    if (!result?.ok) throw new Error(result?.error || 'Failed to load person details');

    const payload = result.data || {};
    const b = payload.block || {};
    const day = payload.lastDay || {};
    const note = payload.prNotes || {};
    const isSales = (b.type || type) === 'Sales';

    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">${b.name || name}</div><div class="topbar-sub">${b.type || type || '‚Äì'} ¬∑ ${b.workingDays || 0} working days (MTD)</div></div>
        <div class="topbar-actions">
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Back</button>
          <button class="topbar-btn logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="detail-card" style="margin-top:8px;">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:14px; margin-bottom:18px;">
          <div class="stat-card"><div class="stat-label">Calls (MTD)</div><div class="stat-value">${b.callsMTD || 0}</div></div>
          ${isSales
            ? `<div class="stat-card"><div class="stat-label">Sales (MTD)</div><div class="stat-value">${b.salesMTD || 0}</div></div>
               <div class="stat-card"><div class="stat-label">Texts (MTD)</div><div class="stat-value">${b.textsMTD || 0}</div></div>`
            : `<div class="stat-card"><div class="stat-label">Appts Shown (MTD)</div><div class="stat-value">${b.shownMTD || 0}</div></div>
               <div class="stat-card"><div class="stat-label">Appts Created (MTD)</div><div class="stat-value">${b.createdMTD || 0}</div></div>`
          }
          <div class="stat-card"><div class="stat-label">Leads In Name</div><div class="stat-value">${b.leadsInNameMTD || 0}</div></div>
          <div class="stat-card"><div class="stat-label">Avg Talk</div><div class="stat-value">${b.avgTalk || '0:00'}</div></div>
        </div>

        <div style="background:#fafaf9;border-radius:10px;padding:14px;margin-bottom:14px;">
          <div style="font-weight:700;margin-bottom:6px;">Last Work Day</div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:14px;">
            <div><span style="color:var(--muted);">Date:</span> ${day.dateKey || '‚Äì'}</div>
            <div><span style="color:var(--muted);">Calls:</span> ${day.calls || 0}</div>
            <div><span style="color:var(--muted);">Avg Talk:</span> ${day.avgTalkMSS || '0:00'}</div>
            ${isSales ? `<div><span style="color:var(--muted);">Texts:</span> ${day.texts || 0}</div>` : ''}
          </div>
        </div>

        ${note.wins ? `<div style="background:var(--greenBg);padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:14px;"><strong>Wins:</strong> ${note.wins}</div>` : ''}
        ${note.opportunities ? `<div style="background:var(--yellowBg);padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:14px;"><strong>Opportunities:</strong> ${note.opportunities}</div>` : ''}
        ${note.coaching ? `<div style="background:#ede9fe;padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:14px;"><strong>Coaching:</strong> ${note.coaching}</div>` : ''}

        <button class="btn" style="margin-top:10px;" onclick="viewCallSheets('${name.replace(/'/g, "\\'")}')">View Call Sheets</button>
      </div>`;
  } catch (e) {
    appEl.innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div class="detail-card" style="max-width:500px;margin:auto;color:#dc2626;">
          <h2>Error Loading Details</h2>
          <p>${e.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">‚Üê Back</button>
        </div>
      </div>`;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CALL SHEETS VIEW
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function viewCallSheets(name) {
  trackClick();
  logPageView('Call Sheets: ' + name);
  const appEl = document.getElementById('app');
  appEl.innerHTML = `
    <div class="topbar">
      <div class="topbar-logo">SA</div>
      <div class="topbar-info"><div class="topbar-title">Call Sheets ‚Äì ${name}</div></div>
    </div>
    <div class="loading-wrap"><div class="spinner"></div></div>`;

  try {
    const result = await fetchCalls(name);
    if (!result?.ok) throw new Error(result?.error || 'Failed to load call sheets');
    const rows = result.data?.calls || result.calls || [];

    const trs = rows.map(r => {
      const custName = r.name || '‚Äì';
      const custCell = r.link
        ? `<a href="${r.link}" target="_blank" rel="noopener" style="color:#2563eb;text-decoration:underline;font-weight:600;">${custName}</a>`
        : custName;
      return `
      <tr>
        <td style="text-align:left;padding:8px;">${custCell}</td>
        <td style="padding:8px;">${r.phone || '‚Äì'}</td>
        <td style="padding:8px;">${r.email || '‚Äì'}</td>
        <td style="padding:8px;">${r.salesPerson || '‚Äì'}</td>
        <td style="padding:8px;">${r.bdcAgent || '‚Äì'}</td>
        <td style="padding:8px;">${r.source || '‚Äì'}</td>
        <td style="padding:8px;">${r.dateIn || '‚Äì'}</td>
        <td style="padding:8px;">${r.leadAge ?? '‚Äì'}</td>
        <td style="padding:8px;">${r.daysSince ?? '‚Äì'}</td>
        <td style="padding:8px;">${r.bucket || '‚Äì'}</td>
        <td style="padding:8px;">${r.status || '‚Äì'}</td>
        <td style="padding:8px;">${r.reason || '‚Äì'}</td>
      </tr>`;
    }).join('');

    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">Call Sheets ‚Äì ${name}</div><div class="topbar-sub">${rows.length} records</div></div>
        <div class="topbar-actions">
          <button class="topbar-btn manage" onclick="showPersonDetails('${name.replace(/'/g, "\\'")}')">‚Üê Back to ${name}</button>
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <div class="table-card" style="margin-top:12px;overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th style="text-align:left;">Customer</th><th>Phone</th><th>Email</th><th>Sales Person</th>
              <th>BDC Agent</th><th>Source</th><th>Date In</th><th>Lead Age</th>
              <th>Days Since</th><th>Bucket</th><th>Status</th><th>Reason</th>
            </tr>
          </thead>
          <tbody>
            ${rows.length ? trs : '<tr><td colspan="12" style="padding:30px;color:var(--muted);">No call data</td></tr>'}
          </tbody>
        </table>
      </div>`;
  } catch (e) {
    appEl.innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div class="detail-card" style="max-width:500px;margin:auto;color:#dc2626;">
          <h2>Error Loading Call Sheets</h2>
          <p>${e.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">‚Üê Back</button>
        </div>
      </div>`;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   USER MANAGEMENT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const _userCache = {};
async function loadUsers() {
  try {
    const usersSnapshot = await getDocs(collection(db, 'users'));
    let html = '';
    usersSnapshot.forEach((docu) => {
      const u = docu.data();
      if (u.deleted) return;
      const uid = docu.id;
      const email = u.email || '';
      const role = u.role || 'user';
      const linked = u.linkedName || '';
      const displayName = u.displayName || '';
      const phone = u.phone || '';
      const managerId = u.managerId || '';
      _userCache[uid] = { email, role, linked, displayName, phone, managerId };
      const isSelf = email === window.userData.email;
      const canDelete = isAdmin() && !isSelf && role !== 'admin' && role !== 'superadmin' && email !== SUPERADMIN_EMAIL;
      const canEdit = isAdmin();
      const managerLabel = managerId && _userCache[managerId] ? (_userCache[managerId].displayName || _userCache[managerId].email) : '';
      const infoLine = [
        `Role: <strong>${role}</strong>${role === 'superadmin' ? ' üëë' : ''}`,
        displayName ? `Display: ${displayName}` : '',
        linked ? `Linked: ${linked}` : '',
        phone ? `üìû ${phone}` : '',
        managerLabel ? `üëî Manager: ${managerLabel}` : ''
      ].filter(Boolean).join(' ‚Ä¢ ');
      html += `
        <div class="user-item-wrapper" id="userWrapper_${uid}">
          <div class="user-item">
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;">${email}</div>
              <small>${infoLine}</small>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
              ${canEdit ? `<button class="btn" style="padding:4px 10px;font-size:11px;background:#2563eb;" id="editBtn_${uid}" onclick="startEditUser('${uid}')">Edit</button>` : ''}
              ${canDelete ? `<button class="delete-btn" onclick="deleteUser('${uid}','${email.replace(/'/g,"\\'")}','${role}')">Delete</button>` : ''}
            </div>
          </div>
          <div class="inline-edit-form" id="editForm_${uid}" style="display:none;"></div>
        </div>`;
    });
    document.getElementById('userListContent').innerHTML = html || '<p style="color:var(--muted);">No users found.</p>';
    // Populate manager dropdowns (Add User form)
    populateManagerDropdown(document.getElementById('newUserManager'), '');
  } catch (e) {
    document.getElementById('userListContent').innerHTML = `<p style="color:#dc2626;">Error: ${e.message}</p>`;
  }
}

function getManagerOptions() {
  // Return list of users with role manager, admin, or superadmin
  return Object.entries(_userCache)
    .filter(([, u]) => u.role === 'manager' || u.role === 'admin' || u.role === 'superadmin')
    .map(([uid, u]) => ({ uid, label: u.displayName || u.email }))
    .sort((a, b) => a.label.toLowerCase().localeCompare(b.label.toLowerCase()));
}

function populateManagerDropdown(selectEl, currentManagerId) {
  if (!selectEl) return;
  const managers = getManagerOptions();
  let opts = '<option value="">‚Äî No Assigned Manager ‚Äî</option>';
  managers.forEach(m => {
    opts += `<option value="${m.uid}"${m.uid === currentManagerId ? ' selected' : ''}>${m.label}</option>`;
  });
  selectEl.innerHTML = opts;
}

function startEditUser(uid) {
  const u = _userCache[uid];
  if (!u) { alert('User data not found. Please refresh and try again.'); return; }

  // Close any other open inline edit forms
  document.querySelectorAll('.inline-edit-form').forEach(f => { f.style.display = 'none'; f.innerHTML = ''; });

  const formContainer = document.getElementById('editForm_' + uid);
  if (!formContainer) return;

  formContainer.innerHTML = `
    <div style="background:#eff6ff;border-radius:10px;padding:14px;margin-top:6px;">
      <h3 style="margin:0 0 6px;font-size:14px;">Edit User</h3>
      <input type="email" id="inlineEmail_${uid}" value="${u.email}" disabled style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;background:#f3f4f6;color:#6b7280;">
      <input type="password" id="inlinePassword_${uid}" placeholder="Leave blank to keep current" style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;" autocomplete="new-password">
      <input type="text" id="inlineDisplayName_${uid}" value="${(u.displayName || '').replace(/"/g,'&quot;')}" placeholder='Display Name (e.g., "John Smith")' style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;">
      <input type="text" id="inlineLinked_${uid}" value="${(u.linked || '').replace(/"/g,'&quot;')}" placeholder='Linked Sheet Name (e.g., "JASMINE VASQUEZ")' style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;">
      <input type="tel" id="inlinePhone_${uid}" value="${(u.phone || '').replace(/"/g,'&quot;')}" placeholder='Phone Number (e.g., "210-555-1234")' style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;">
      <select id="inlineRole_${uid}" style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;">
        <option value="user"${u.role === 'user' ? ' selected' : ''}>User</option>
        <option value="manager"${u.role === 'manager' ? ' selected' : ''}>Manager</option>
        <option value="admin"${u.role === 'admin' ? ' selected' : ''}>Admin</option>
      </select>
      <select id="inlineManager_${uid}" style="width:100%;padding:10px;margin-top:8px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;">
        <option value="">‚Äî No Assigned Manager ‚Äî</option>
      </select>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn" style="flex:1;" onclick="saveEditUser('${uid}')">Save Changes</button>
        <button class="btn" style="flex:0;background:#78716c;" onclick="cancelEditUser('${uid}')">Cancel</button>
      </div>
    </div>`;
  formContainer.style.display = 'block';
  // Populate manager dropdown with current selection
  populateManagerDropdown(document.getElementById('inlineManager_' + uid), u.managerId || '');
  formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function cancelEditUser(uid) {
  if (uid) {
    const formContainer = document.getElementById('editForm_' + uid);
    if (formContainer) { formContainer.style.display = 'none'; formContainer.innerHTML = ''; }
  } else {
    // Close all inline edit forms
    document.querySelectorAll('.inline-edit-form').forEach(f => { f.style.display = 'none'; f.innerHTML = ''; });
  }
}

async function saveEditUser(uid) {
  const displayName = document.getElementById('inlineDisplayName_' + uid)?.value?.trim() || '';
  const linked = document.getElementById('inlineLinked_' + uid)?.value?.trim() || '';
  const phone = document.getElementById('inlinePhone_' + uid)?.value?.trim() || '';
  const role = document.getElementById('inlineRole_' + uid)?.value || 'user';
  const managerId = document.getElementById('inlineManager_' + uid)?.value || '';

  try {
    const updates = { role, linkedName: linked, displayName, phone, managerId };
    await setDoc(doc(db, 'users', uid), updates, { merge: true });
    alert('User updated!');
    cancelEditUser(uid);
    loadUsers();
  } catch (e) { alert('Error: ' + e.message); }
}

async function addUser() {
  const email = document.getElementById('newUserEmail')?.value?.trim();
  const password = document.getElementById('newUserPassword')?.value?.trim();
  const displayName = document.getElementById('newUserDisplayName')?.value?.trim() || '';
  const linked = document.getElementById('newUserLinked')?.value?.trim() || '';
  const phone = document.getElementById('newUserPhone')?.value?.trim() || '';
  const role = document.getElementById('newUserRole')?.value || 'user';
  const managerId = document.getElementById('newUserManager')?.value || '';

  if (!email || !password) { alert('Enter email and password.'); return; }
  if (password.length < 6) { alert('Password must be at least 6 characters.'); return; }

  try {
    const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
    await setDoc(doc(db, 'users', cred.user.uid), {
      email, role, linkedName: linked, displayName, phone, managerId, createdAt: new Date()
    });
    await secondaryAuth.signOut();
    alert('User created!');
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserDisplayName').value = '';
    document.getElementById('newUserLinked').value = '';
    document.getElementById('newUserPhone').value = '';
    document.getElementById('newUserRole').value = 'user';
    document.getElementById('newUserManager').value = '';
    loadUsers();
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function deleteUser(uid, email, role) {
  if (!isAdmin()) { alert('Only admins.'); return; }
  if (role === 'admin' || role === 'superadmin' || email === SUPERADMIN_EMAIL) { alert('Cannot delete admins.'); return; }
  if (!confirm('Delete this user?')) return;
  try {
    // Mark as deleted (prevents ghost re-creation via onAuthStateChanged)
    await setDoc(doc(db, 'users', uid), { deleted: true, deletedAt: new Date() }, { merge: true });
    loadUsers();
    alert('User deleted.');
  } catch (e) { alert('Error: ' + e.message); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   POTENTIAL REASSIGNMENTS PAGE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let reassignSort = { col: 'daysSince', dir: 'desc' };

async function showReassignments() {
  if (!isAdmin() && !isManager()) { alert('Only admins and managers can view reassignments.'); return; }
  trackClick();
  logPageView('Reassignments');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üîÑ Potential Reassignments</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Leads with a CRM link and 3+ days since last contact</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Back to Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    const url = `${SCRIPT_URL}?route=reassignments&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error(`Non-JSON response.\nHTTP ${resp.status}\n\n${raw}`); }
    if (!result.ok) throw new Error(result.error || 'Backend error');

    const rows = result.rows || [];
    renderReassignments(rows);
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading Reassignments</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">‚Üê Back</button>
        </div>
      </div>`;
  }
}

function renderReassignments(rows) {
  window._reassignRows = rows;  // cache for re-sorting
  // Sort
  const sorted = sortReassignRows(rows, reassignSort);

  // Stats
  const total = sorted.length;
  const critical = sorted.filter(r => r.daysSince >= 5).length;
  const reviewCount = sorted.filter(r => r.status === 'Active - Manager Review').length;
  const bySheet = {};
  sorted.forEach(r => { bySheet[r.sheet] = (bySheet[r.sheet] || 0) + 1; });
  const sheetCount = Object.keys(bySheet).length;

  // Find who has the most
  let worstSheet = '‚Äì', worstCount = 0;
  Object.entries(bySheet).forEach(([k, v]) => { if (v > worstCount) { worstCount = v; worstSheet = k; } });

  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üîÑ Potential Reassignments</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Leads with a CRM link and 3+ days since last contact</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="showReassignments()">‚Üª Refresh</button>
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <div class="reassign-stats">
        <div class="reassign-stat">
          <div class="stat-label">Total Flagged</div>
          <div class="stat-value">${total}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Manager Review ‚ö†Ô∏è</div>
          <div class="stat-value" style="color:#991b1b;">${reviewCount}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Critical (5+ days) üî¥</div>
          <div class="stat-value" style="color:#dc2626;">${critical}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Reps Affected</div>
          <div class="stat-value">${sheetCount}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Most Flagged</div>
          <div class="stat-value" style="font-size:15px;">${worstSheet} (${worstCount})</div>
        </div>
      </div>

      ${total === 0 ? '<div class="detail-card" style="text-align:center;padding:40px;color:var(--muted);font-size:15px;">No leads flagged ‚Äî everyone is within 5 days üéâ</div>' : ''}
      ${total > 0 ? `<div class="table-card" id="reassignTable">${reassignTableHTML(sorted)}</div>` : ''}
    </div>`;
}

function reassignTableHTML(rows) {
  const sc = (col) => reassignSort.col === col ? 'sorted' : '';
  const ar = (col) => reassignSort.col === col ? (reassignSort.dir === 'desc' ? '‚ñº' : '‚ñ≤') : '‚ñΩ';

  const headerRow = `<tr>
    <th class="${sc('leadAge')}" onclick="toggleReassignSort('leadAge')">Lead Age <span class="sort-arrow">${ar('leadAge')}</span></th>
    <th class="${sc('daysSince')}" onclick="toggleReassignSort('daysSince')">Days Since <span class="sort-arrow">${ar('daysSince')}</span></th>
    <th class="${sc('customer')}" onclick="toggleReassignSort('customer')">Customer <span class="sort-arrow">${ar('customer')}</span></th>
    <th>Phone</th>
    <th class="${sc('salesPerson')}" onclick="toggleReassignSort('salesPerson')">Sales Rep <span class="sort-arrow">${ar('salesPerson')}</span></th>
    <th class="${sc('bdcAgent')}" onclick="toggleReassignSort('bdcAgent')">BDC Agent <span class="sort-arrow">${ar('bdcAgent')}</span></th>
    <th class="${sc('source')}" onclick="toggleReassignSort('source')">Source <span class="sort-arrow">${ar('source')}</span></th>
    <th class="${sc('status')}" onclick="toggleReassignSort('status')">Status <span class="sort-arrow">${ar('status')}</span></th>
    <th class="${sc('sheet')}" onclick="toggleReassignSort('sheet')">Assigned To <span class="sort-arrow">${ar('sheet')}</span></th>
  </tr>`;

  // Split into Manager Review and rest
  const reviewRows = rows.filter(r => r.status === 'Active - Manager Review');
  const otherRows = rows.filter(r => r.status !== 'Active - Manager Review');

  let html = '<table><thead>' + headerRow + '</thead><tbody>';

  if (reviewRows.length > 0) {
    html += `<tr><td colspan="9" style="background:#fef2f2;text-align:left;padding:10px 12px;font-weight:700;font-size:13px;color:#991b1b;border-bottom:2px solid #fecaca;">
      ‚ö†Ô∏è Manager Review Required (${reviewRows.length})
    </td></tr>`;
    reviewRows.forEach(r => { html += reassignRowHTML(r); });
  }

  if (otherRows.length > 0) {
    if (reviewRows.length > 0) {
      html += `<tr><td colspan="9" style="background:#f9fafb;text-align:left;padding:10px 12px;font-weight:700;font-size:13px;color:var(--muted);border-bottom:2px solid var(--line);">
        Other Flagged Leads (${otherRows.length})
      </td></tr>`;
    }
    otherRows.forEach(r => { html += reassignRowHTML(r); });
  }

  html += '</tbody></table>';
  return html;
}

function reassignRowHTML(r) {
  const dc = r.daysSince >= 9 ? 'days-9p' : r.daysSince >= 8 ? 'days-8' : r.daysSince >= 7 ? 'days-7' : r.daysSince >= 6 ? 'days-6' : r.daysSince >= 5 ? 'days-5' : r.daysSince >= 4 ? 'days-4' : 'days-3';
  const isReview = r.status === 'Active - Manager Review';
  const rowStyle = isReview ? 'background:#fff5f5;' : '';
  const statusStyle = isReview ? 'color:#991b1b;font-weight:700;' : 'font-size:12px;';
  return `<tr style="${rowStyle}">
    <td style="font-size:12px;">${r.leadAge || '‚Äî'}</td>
    <td><span class="days-badge ${dc}">${r.daysSince}</span></td>
    <td style="text-align:left;"><a class="reassign-link" href="${r.link}" target="_blank">${r.customer || '‚Äî'}</a></td>
    <td style="font-size:12px;">${r.phone || '‚Äî'}</td>
    <td style="font-size:12px;">${r.salesPerson || '‚Äî'}</td>
    <td style="font-size:12px;">${r.bdcAgent || '‚Äî'}</td>
    <td style="font-size:12px;">${r.source || '‚Äî'}</td>
    <td style="${statusStyle}">${r.status || '‚Äî'}</td>
    <td><span class="reassign-sheet-badge">${r.sheet}</span></td>
  </tr>`;
}

function sortReassignRows(rows, sortState) {
  const { col, dir } = sortState;
  const mult = dir === 'desc' ? -1 : 1;
  return [...rows].sort((a, b) => {
    if (col === 'daysSince') return mult * (a.daysSince - b.daysSince);
    if (col === 'leadAge') return mult * ((a.leadAge || 0) - (b.leadAge || 0));
    if (col === 'customer' || col === 'salesPerson' || col === 'bdcAgent' || col === 'source' || col === 'status' || col === 'sheet') {
      return mult * (a[col] || '').localeCompare(b[col] || '');
    }
    return 0;
  });
}

function toggleReassignSort(col) {
  if (reassignSort.col === col) {
    reassignSort.dir = reassignSort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    reassignSort.col = col;
    reassignSort.dir = 'desc';
  }
  // Re-render with current data ‚Äî refetch not needed
  const table = document.getElementById('reassignTable');
  if (table && window._reassignRows) {
    table.innerHTML = reassignTableHTML(sortReassignRows(window._reassignRows, reassignSort));
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTOMOTIVE NEWS PAGE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function showAutoNews() {
  logPageView('Auto News');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:800px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üì∞ Automotive Industry News</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Latest articles from the past week</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    const url = `${SCRIPT_URL}?route=autonews&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error(`Non-JSON response.\nHTTP ${resp.status}\n\n${raw}`); }
    if (!result.ok) throw new Error(result.error || 'Backend error');

    const articles = result.articles || [];
    renderAutoNews(articles);
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading News</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">‚Üê Back</button>
        </div>
      </div>`;
  }
}

function renderAutoNews(articles) {
  const app = document.getElementById('app');

  let cardsHTML = '';
  if (articles.length === 0) {
    cardsHTML = '<div class="detail-card" style="text-align:center;padding:40px;color:var(--muted);font-size:15px;">No recent articles found. Check back later.</div>';
  } else {
    // Group by source
    const groups = new Map();
    articles.forEach(a => {
      const src = a.source || 'Other';
      if (!groups.has(src)) groups.set(src, []);
      groups.get(src).push(a);
    });

    // Sort groups: CDG first, then by article count descending
    const sortedGroups = [...groups.entries()].sort((a, b) => {
      if (a[0] === 'Car Dealership Guy') return -1;
      if (b[0] === 'Car Dealership Guy') return 1;
      return b[1].length - a[1].length;
    });

    let groupIdx = 0;
    sortedGroups.forEach(([source, items]) => {
      const isCDG = source === 'Car Dealership Guy';
      const groupId = 'newsGroup' + groupIdx++;
      const bgColor = isCDG ? '#f0fdf4' : '#f9fafb';
      const badgeBg = isCDG ? '#dcfce7' : '#f4f4f5';
      const badgeColor = isCDG ? '#166534' : '#71717a';

      // Source-specific icons
      const srcLower = source.toLowerCase();
      let icon = 'üì∞';
      if (isCDG) icon = 'üöó';
      else if (srcLower.includes('automotive news')) icon = 'üè≠';
      else if (srcLower.includes('cbt')) icon = 'üéôÔ∏è';
      else if (srcLower.includes('reuters')) icon = 'üåê';
      else if (srcLower.includes('cnbc')) icon = 'üìà';
      else if (srcLower.includes('bloomberg')) icon = 'üíπ';
      else if (srcLower.includes('fox')) icon = 'üì∫';
      else if (srcLower.includes('cnn')) icon = 'üì°';
      else if (srcLower.includes('yahoo')) icon = 'üü£';
      else if (srcLower.includes('ap news') || srcLower.includes('associated press')) icon = 'üîµ';
      else if (srcLower.includes('usa today')) icon = 'üá∫üá∏';
      else if (srcLower.includes('wall street') || srcLower.includes('wsj')) icon = 'üìä';
      else if (srcLower.includes('motor') || srcLower.includes('drive') || srcLower.includes('torque')) icon = 'üèéÔ∏è';
      else if (srcLower.includes('truck') || srcLower.includes('pickup')) icon = 'üõª';
      else if (srcLower.includes('ev') || srcLower.includes('electric') || srcLower.includes('electrek')) icon = '‚ö°';
      else if (srcLower.includes('car') || srcLower.includes('auto')) icon = 'üöô';
      else if (srcLower.includes('dealer')) icon = 'ü§ù';
      else if (srcLower.includes('forbes')) icon = 'üí∞';
      else if (srcLower.includes('nbc')) icon = 'üì∫';
      else if (srcLower.includes('abc')) icon = 'üì∫';

      cardsHTML += `
        <div style="margin-bottom:8px;border:1px solid var(--line);border-radius:10px;overflow:hidden;">
          <div onclick="toggleNewsGroup('${groupId}')" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:${bgColor};cursor:pointer;user-select:none;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:14px;">${icon}</span>
              <span style="font-weight:700;font-size:14px;color:${isCDG ? '#166534' : 'var(--text)'};">${source}</span>
              <span style="background:${badgeBg};color:${badgeColor};padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">${items.length}</span>
            </div>
            <span id="${groupId}Arrow" style="font-size:12px;color:var(--muted);transition:transform .2s;transform:rotate(-90deg);">‚ñº</span>
          </div>
          <div id="${groupId}" style="border-top:1px solid var(--line);display:none;">`;

      items.forEach(a => {
        const timeStr = a.date ? timeAgoNews(new Date(a.date)) : '';
        cardsHTML += `
            <div style="padding:12px 16px;border-bottom:1px solid var(--line);${isCDG ? 'border-left:3px solid #22c55e;' : ''}">
              <div class="news-title"><a href="${a.link}" target="_blank" rel="noopener">${a.title}</a></div>
              <div class="news-meta">
                ${timeStr ? `<span>üïê ${timeStr}</span>` : ''}
              </div>
            </div>`;
      });

      cardsHTML += `
          </div>
        </div>`;
    });
  }

  app.innerHTML = `
    <div style="max-width:800px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üì∞ Automotive Industry News</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Latest articles from the past 48 hours ¬∑ ${articles.length} article${articles.length !== 1 ? 's' : ''}</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="toggleAllNewsGroups()">Expand / Collapse All</button>
          <button class="topbar-btn manage" onclick="showAutoNews()">‚Üª Refresh</button>
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>
      ${cardsHTML}
    </div>`;
}

function toggleNewsGroup(id) {
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + 'Arrow');
  if (!el) return;
  if (el.style.display === 'none') {
    el.style.display = '';
    if (arrow) arrow.style.transform = 'rotate(0deg)';
  } else {
    el.style.display = 'none';
    if (arrow) arrow.style.transform = 'rotate(-90deg)';
  }
}

function toggleAllNewsGroups() {
  const groups = document.querySelectorAll('[id^="newsGroup"]');
  let hiddenCount = 0;
  groups.forEach(g => { if (g.id.indexOf('Arrow') === -1 && g.style.display === 'none') hiddenCount++; });
  const shouldShow = hiddenCount > 0;
  groups.forEach(g => {
    if (g.id.indexOf('Arrow') !== -1) {
      g.style.transform = shouldShow ? 'rotate(0deg)' : 'rotate(-90deg)';
    } else {
      g.style.display = shouldShow ? '' : 'none';
    }
  });
}

function timeAgoNews(date) {
  const diff = Date.now() - date;
  const mins = Math.floor(diff / 60000);
  const hrs  = Math.floor(diff / 3600000);
  if (mins < 60) return `${mins}m ago`;
  if (hrs < 24)  return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SOURCE LEADERBOARD
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let sourceSort = { col: 'total', dir: 'desc' };

async function showSourceLeaderboard() {
  if (!isAdmin()) { alert('Only admins can view the Source Leaderboard.'); return; }
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üìä Source Leaderboard</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Lead source performance across all distribution tabs</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    const url = `${SCRIPT_URL}?route=sourcestats&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error(`Non-JSON response.\nHTTP ${resp.status}\n\n${raw}`); }
    if (!result.ok) throw new Error(result.error || 'Backend error');

    window._sourceRows = result.sources || [];
    renderSourceLeaderboard(window._sourceRows);
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading Sources</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">‚Üê Back</button>
        </div>
      </div>`;
  }
}

function renderSourceLeaderboard(rows) {
  const sorted = sortSourceRows(rows, sourceSort);

  // Summary stats
  const totalLeads = sorted.reduce((s, r) => s + r.total, 0);
  const totalAtRisk = sorted.reduce((s, r) => s + r.atRisk, 0);
  const totalReview = sorted.reduce((s, r) => s + r.managerReview, 0);
  const sourceCount = sorted.length;

  // Best & worst follow-up (by atRiskPct, min 5 leads)
  const qualified = sorted.filter(r => r.total >= 5);
  let bestSource = '‚Äì', worstSource = '‚Äì';
  if (qualified.length) {
    const byRisk = [...qualified].sort((a, b) => a.atRiskPct - b.atRiskPct);
    bestSource = byRisk[0].source + ' (' + byRisk[0].atRiskPct + '%)';
    worstSource = byRisk[byRisk.length - 1].source + ' (' + byRisk[byRisk.length - 1].atRiskPct + '%)';
  }

  const sc = (col) => sourceSort.col === col ? 'sorted' : '';
  const ar = (col) => sourceSort.col === col ? (sourceSort.dir === 'desc' ? '‚ñº' : '‚ñ≤') : '‚ñΩ';

  let tableHTML = `<table><thead><tr>
    <th class="${sc('source')}" onclick="toggleSourceSort('source')">Source <span class="sort-arrow">${ar('source')}</span></th>
    <th class="${sc('total')}" onclick="toggleSourceSort('total')">Total Leads <span class="sort-arrow">${ar('total')}</span></th>
    <th class="${sc('atRisk')}" onclick="toggleSourceSort('atRisk')">At Risk (3+d) <span class="sort-arrow">${ar('atRisk')}</span></th>
    <th class="${sc('atRiskPct')}" onclick="toggleSourceSort('atRiskPct')">% At Risk <span class="sort-arrow">${ar('atRiskPct')}</span></th>
    <th class="${sc('managerReview')}" onclick="toggleSourceSort('managerReview')">Mgr Review <span class="sort-arrow">${ar('managerReview')}</span></th>
    <th class="${sc('avgDaysSince')}" onclick="toggleSourceSort('avgDaysSince')">Avg Days Since <span class="sort-arrow">${ar('avgDaysSince')}</span></th>
    <th class="${sc('avgLeadAge')}" onclick="toggleSourceSort('avgLeadAge')">Avg Lead Age <span class="sort-arrow">${ar('avgLeadAge')}</span></th>
    <th class="${sc('repCount')}" onclick="toggleSourceSort('repCount')">Reps <span class="sort-arrow">${ar('repCount')}</span></th>
  </tr></thead><tbody>`;

  sorted.forEach((r, i) => {
    // Color code % at risk
    const riskColor = r.atRiskPct >= 60 ? '#dc2626' : r.atRiskPct >= 40 ? '#ea580c' : r.atRiskPct >= 20 ? '#ca8a04' : '#16a34a';
    const riskBg = r.atRiskPct >= 60 ? '#fef2f2' : r.atRiskPct >= 40 ? '#fff7ed' : r.atRiskPct >= 20 ? '#fefce8' : '#f0fdf4';
    const topRepsStr = r.topReps.map(t => t.name.split(' ')[0] + ' (' + t.count + ')').join(', ');

    tableHTML += `<tr>
      <td style="text-align:left;font-weight:600;">${r.source}</td>
      <td><strong>${r.total}</strong></td>
      <td>${r.atRisk > 0 ? '<span style="color:#dc2626;font-weight:600;">' + r.atRisk + '</span>' : '0'}</td>
      <td style="background:${riskBg};color:${riskColor};font-weight:700;">${r.atRiskPct}%</td>
      <td>${r.managerReview > 0 ? '<span style="color:#991b1b;font-weight:600;">' + r.managerReview + '</span>' : '0'}</td>
      <td>${r.avgDaysSince}</td>
      <td>${r.avgLeadAge}d</td>
      <td title="${topRepsStr}">${r.repCount}</td>
    </tr>`;
  });

  tableHTML += '</tbody></table>';

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üìä Source Leaderboard</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Lead source performance across all distribution tabs ¬∑ ${sourceCount} sources ¬∑ ${totalLeads} total leads</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="showSourceLeaderboard()">‚Üª Refresh</button>
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <div class="reassign-stats">
        <div class="reassign-stat">
          <div class="stat-label">Total Leads</div>
          <div class="stat-value">${totalLeads}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">At Risk (3+ days) üî¥</div>
          <div class="stat-value" style="color:#dc2626;">${totalAtRisk}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Manager Review ‚ö†Ô∏è</div>
          <div class="stat-value" style="color:#991b1b;">${totalReview}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Best Follow-Up ‚úÖ</div>
          <div class="stat-value" style="font-size:13px;color:#16a34a;">${bestSource}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Worst Follow-Up üö®</div>
          <div class="stat-value" style="font-size:13px;color:#dc2626;">${worstSource}</div>
        </div>
      </div>

      <div class="table-card" id="sourceTable">${tableHTML}</div>

      <div style="margin-top:12px;padding:12px 16px;background:var(--card);border:1px solid var(--line);border-radius:10px;">
        <div style="font-weight:700;font-size:13px;margin-bottom:8px;">üìà Quick Insights</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6;">
          ${qualified.length >= 2 ? `‚Ä¢ <strong style="color:#16a34a;">${[...qualified].sort((a,b)=>a.atRiskPct-b.atRiskPct)[0].source}</strong> has the best follow-up rate ‚Äî only ${[...qualified].sort((a,b)=>a.atRiskPct-b.atRiskPct)[0].atRiskPct}% at risk<br>` : ''}
          ${qualified.length >= 2 ? `‚Ä¢ <strong style="color:#dc2626;">${[...qualified].sort((a,b)=>b.atRiskPct-a.atRiskPct)[0].source}</strong> needs attention ‚Äî ${[...qualified].sort((a,b)=>b.atRiskPct-a.atRiskPct)[0].atRiskPct}% of leads at risk<br>` : ''}
          ${sorted.length > 0 ? `‚Ä¢ <strong>${sorted[0].source}</strong> produces the most volume with ${sorted[0].total} total leads<br>` : ''}
          ${totalReview > 0 ? `‚Ä¢ <strong style="color:#991b1b;">${totalReview} leads</strong> across all sources are in Manager Review status` : '‚Ä¢ No leads currently in Manager Review ‚Äî great job!'}
        </div>
      </div>
    </div>`;
}

function sortSourceRows(rows, sortState) {
  const { col, dir } = sortState;
  const mult = dir === 'desc' ? -1 : 1;
  return [...rows].sort((a, b) => {
    if (col === 'source') return mult * (a.source || '').localeCompare(b.source || '');
    return mult * ((a[col] || 0) - (b[col] || 0));
  });
}

function toggleSourceSort(col) {
  if (sourceSort.col === col) {
    sourceSort.dir = sourceSort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    sourceSort.col = col;
    sourceSort.dir = 'desc';
  }
  if (window._sourceRows) {
    renderSourceLeaderboard(window._sourceRows);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ACTIVITY LOG
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showActivityModal() {
  if (!isAdmin() && !isManager()) { alert('Only admins and managers can view activity.'); return; }
  logPageView('Activity Log');
  document.getElementById('activityModal').style.display = 'grid';
  loadActivity();
}
function closeActivityModal() {
  document.getElementById('activityModal').style.display = 'none';
}

function filterNotSignedIn(filter) {
  const items = document.querySelectorAll('.nsi-item');
  items.forEach(el => {
    if (filter === 'all') { el.style.display = ''; return; }
    el.style.display = el.classList.contains('nsi-' + filter) ? '' : 'none';
  });
  // Update button styles
  ['All','Sales','Mgmt'].forEach(id => {
    const btn = document.getElementById('nsiFilter' + id);
    if (!btn) return;
    const active = id.toLowerCase() === filter || (id === 'All' && filter === 'all');
    btn.style.background = active ? '#991b1b' : '#fff';
    btn.style.color = active ? '#fff' : '#991b1b';
  });
}
window.filterNotSignedIn = filterNotSignedIn;

function timeAgo(date) {
  if (!date) return { text: 'Never', status: 'never' };
  const now = new Date();
  const diff = now - date;
  const mins = Math.floor(diff / 60000);
  const hrs  = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  let text;
  if (mins < 1)       text = 'Just now';
  else if (mins < 60) text = `${mins}m ago`;
  else if (hrs < 24)  text = `${hrs}h ago`;
  else if (days < 7)  text = `${days}d ago`;
  else                text = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

  const status = hrs < 24 ? 'recent' : days < 7 ? 'stale' : 'old';
  return { text, status };
}

async function loadActivity() {
  const el = document.getElementById('activityContent');
  el.innerHTML = '<p style="color:var(--muted);">Loading...</p>';
  try {
    // Fetch users for current data + clicks
    const userSnap = await getDocs(collection(db, 'users'));
    const userMap = {}; // uid ‚Üí user data
    const today = todayDateStr();
    userSnap.forEach(d => {
      const u = d.data();
      if (u.deleted) return; // Skip soft-deleted users
      if (!u.linkedName && !['manager','superadmin'].includes(u.role)) return; // Skip unconfigured/ghost users
      const ll = u.lastLogin?.toDate ? u.lastLogin.toDate() : (u.lastLogin ? new Date(u.lastLogin) : null);
      const clicks = (u.clickDate === today) ? (u.clicksToday || 0) : 0;
      userMap[d.id] = {
        uid: d.id,
        email: u.email || '',
        role: u.role || 'user',
        linkedName: u.linkedName || '',
        lastLogin: ll,
        clicks
      };
    });

    // Fetch dailyLogins (last 14 days)
    let loginSnap = null;
    try {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - 14);
      const cutoffStr = cutoff.getFullYear() + '-' + String(cutoff.getMonth() + 1).padStart(2, '0') + '-' + String(cutoff.getDate()).padStart(2, '0');
      loginSnap = await getDocs(query(
        collection(db, 'dailyLogins'),
        where('date', '>=', cutoffStr),
        orderBy('date', 'desc')
      ));
    } catch (e) { console.warn('dailyLogins query failed, falling back:', e); }

    // Build day ‚Üí users map from dailyLogins
    const dayLogins = new Map(); // date string ‚Üí [{email, linkedName, role, lastSeen}]
    if (loginSnap) {
      loginSnap.forEach(d => {
        const data = d.data();
        const dateStr = data.date;
        if (!dayLogins.has(dateStr)) dayLogins.set(dateStr, []);
        const lastSeen = data.lastSeen?.toDate ? data.lastSeen.toDate() : (data.lastSeen ? new Date(data.lastSeen) : null);
        dayLogins.get(dateStr).push({
          email: data.email || '',
          linkedName: data.linkedName || '',
          role: data.role || 'user',
          uid: data.uid || '',
          lastSeen: lastSeen,
          clicks: (dateStr === today && userMap[data.uid]) ? userMap[data.uid].clicks : 0
        });
      });
    }

    // Also include users from users collection for today if no dailyLogins yet (backward compat)
    const todayLogins = dayLogins.get(today) || [];
    const todayUidSet = new Set(todayLogins.map(u => u.uid));
    Object.values(userMap).forEach(u => {
      if (u.lastLogin && u.lastLogin.toDateString() === new Date().toDateString() && !todayUidSet.has(u.uid)) {
        if (!dayLogins.has(today)) dayLogins.set(today, []);
        dayLogins.get(today).push({
          email: u.email,
          linkedName: u.linkedName,
          role: u.role,
          uid: u.uid,
          lastSeen: u.lastLogin,
          clicks: u.clicks
        });
      }
    });

    // If dailyLogins was empty (first deploy / query failed), fall back to users collection lastLogin
    if (dayLogins.size === 0 || (dayLogins.size === 1 && dayLogins.has(today))) {
      Object.values(userMap).forEach(u => {
        if (!u.lastLogin) return;
        const d = u.lastLogin;
        const dStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        if (dayLogins.has(dStr)) {
          const existing = dayLogins.get(dStr);
          if (existing.some(e => e.uid === u.uid)) return;
        }
        if (!dayLogins.has(dStr)) dayLogins.set(dStr, []);
        dayLogins.get(dStr).push({
          email: u.email, linkedName: u.linkedName, role: u.role,
          uid: u.uid, lastSeen: u.lastLogin, clicks: u.clicks
        });
      });
    }

    // Also add "never logged in" users
    const allLoggedUids = new Set();
    dayLogins.forEach(users => users.forEach(u => allLoggedUids.add(u.uid)));
    const neverGroup = Object.values(userMap).filter(u => !u.lastLogin && !allLoggedUids.has(u.uid));

    // Format day groups
    const now = new Date();
    const todayDateString = now.toDateString();
    const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayDateString = yesterday.toDateString();

    // Sort dates descending
    const sortedDates = [...dayLogins.keys()].sort((a, b) => b.localeCompare(a));

    function dateLabel(dateStr) {
      // dateStr is "2026-02-17"
      const parts = dateStr.split('-');
      const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      if (d.toDateString() === todayDateString) return 'Today';
      if (d.toDateString() === yesterdayDateString) return 'Yesterday';
      return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
    }

    // Summary stats
    const todayGroup = dayLogins.get(today) || [];
    const todayUids = new Set(todayGroup.map(u => u.uid));
    const notSignedIn = Object.values(userMap).filter(u => !todayUids.has(u.uid));
    const notSignedInSales = notSignedIn.filter(u => u.role === 'user');
    const notSignedInMgmt = notSignedIn.filter(u => ['admin','superadmin','manager'].includes(u.role));
    notSignedIn.sort((a, b) => {
      // Most recent login first; never-logged-in users go last
      if (!a.lastLogin && !b.lastLogin) return (a.linkedName || a.email).localeCompare(b.linkedName || b.email);
      if (!a.lastLogin) return 1;
      if (!b.lastLogin) return -1;
      return b.lastLogin - a.lastLogin;
    });

    const salesLoggedIn = todayGroup.filter(u => u.role === 'user').length;
    const mgmtLoggedIn = todayGroup.filter(u => ['admin','superadmin','manager'].includes(u.role)).length;
    const totalClicks = todayGroup.reduce((sum, u) => sum + (u.clicks || 0), 0);

    let html = `
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:4px;">
        <div style="flex:1;min-width:120px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#166534;font-weight:500;">Sales Logged In Today</div>
          <div style="font-size:22px;font-weight:800;color:#166534;">${salesLoggedIn}</div>
        </div>
        <div style="flex:1;min-width:120px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#1e40af;font-weight:500;">Mgmt / Admin Today</div>
          <div style="font-size:22px;font-weight:800;color:#1e40af;">${mgmtLoggedIn}</div>
        </div>
        <div style="flex:1;min-width:120px;background:#faf5ff;border:1px solid #e9d5ff;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#7e22ce;font-weight:500;">Total Clicks Today</div>
          <div style="font-size:22px;font-weight:800;color:#7e22ce;">${totalClicks}</div>
        </div>
        <div style="flex:1;min-width:120px;background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#991b1b;font-weight:500;">Not Signed In Today</div>
          <div style="font-size:22px;font-weight:800;color:#991b1b;">${notSignedIn.length}</div>
        </div>
      </div>
      ${notSignedIn.length > 0 ? `
      <details style="margin-top:8px;margin-bottom:4px;" id="notSignedInDetails">
        <summary style="cursor:pointer;font-weight:700;font-size:12px;color:#991b1b;padding:6px 0;user-select:none;">
          üö´ Not Signed In Today <span style="background:#fecaca;color:#991b1b;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:6px;">${notSignedIn.length}</span>
        </summary>
        <div style="display:flex;gap:6px;margin:8px 0 4px;">
          <button onclick="filterNotSignedIn('all')" id="nsiFilterAll" style="padding:4px 12px;border-radius:6px;border:1px solid #fecaca;background:#991b1b;color:#fff;font-size:11px;font-weight:600;cursor:pointer;">All (${notSignedIn.length})</button>
          <button onclick="filterNotSignedIn('sales')" id="nsiFilterSales" style="padding:4px 12px;border-radius:6px;border:1px solid #fecaca;background:#fff;color:#991b1b;font-size:11px;font-weight:600;cursor:pointer;">Sales Reps (${notSignedInSales.length})</button>
          <button onclick="filterNotSignedIn('mgmt')" id="nsiFilterMgmt" style="padding:4px 12px;border-radius:6px;border:1px solid #fecaca;background:#fff;color:#991b1b;font-size:11px;font-weight:600;cursor:pointer;">Managers / Admin (${notSignedInMgmt.length})</button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;padding:4px 0;" id="nsiList">
          ${notSignedIn.map(u => {
            const name = u.linkedName || u.email;
            const roleBadge = u.role === 'superadmin' ? ' üôè' : u.role === 'admin' ? ' ‚≠ê' : u.role === 'manager' ? ' üìã' : '';
            const lastStr = u.lastLogin ? timeAgo(u.lastLogin).text : 'Never';
            const roleClass = ['admin','superadmin','manager'].includes(u.role) ? 'mgmt' : 'sales';
            return `<div class="nsi-item nsi-${roleClass}" style="background:#fff;border:1px solid #fecaca;border-radius:8px;padding:5px 10px;font-size:11px;" title="Last seen: ${lastStr}">
              <span style="font-weight:600;">${name}</span>${roleBadge} <span style="color:var(--muted);margin-left:4px;">${lastStr}</span>
            </div>`;
          }).join('')}
          }).join('')}
        </div>
      </details>` : ''}`;

    for (const dateStr of sortedDates) {
      const group = dayLogins.get(dateStr);
      // Sort by lastSeen desc within group
      group.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));
      const label = dateLabel(dateStr);
      const isToday = label === 'Today';
      const countBadge = `<span style="background:${isToday ? '#dcfce7' : '#f4f4f5'};color:${isToday ? '#166534' : '#71717a'};padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:8px;">${group.length}</span>`;
      html += `<div style="margin-top:16px;margin-bottom:6px;font-weight:700;font-size:13px;color:${isToday ? '#166534' : 'var(--muted)'};text-transform:uppercase;letter-spacing:.3px;">${label}${countBadge}</div>`;

      group.forEach(u => {
        const ago = u.lastSeen ? timeAgo(u.lastSeen) : { text: '‚Äî', status: 'never' };
        const displayName = u.linkedName || u.email;
        const loginTime = u.lastSeen
          ? u.lastSeen.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
          : '‚Äî';
        const roleBadge = u.role === 'superadmin' ? ' üôè' : u.role === 'admin' ? ' ‚≠ê' : u.role === 'manager' ? ' üìã' : '';
        const clickBadge = u.clicks > 0
          ? `<span style="background:#dbeafe;color:#1d4ed8;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:600;">${u.clicks} click${u.clicks !== 1 ? 's' : ''}</span>`
          : '<span style="color:#d1d5db;font-size:11px;">0 clicks</span>';

        html += `
          <div class="activity-item">
            <div style="min-width:48px;text-align:center;">${isToday ? clickBadge : ''}</div>
            <div style="display:flex;align-items:center;min-width:0;flex:1;">
              <span class="activity-status status-${ago.status}"></span>
              <div style="min-width:0;">
                <div class="activity-name">${displayName}${roleBadge}</div>
                <div class="activity-email">${u.linkedName ? u.email + ' ¬∑ ' : ''}${u.role}</div>
              </div>
            </div>
            <div class="activity-time">
              <div class="time-main">${isToday ? ago.text : loginTime}</div>
              <div class="time-sub">${isToday ? loginTime : ago.text}</div>
            </div>
          </div>`;
      });
    }

    if (neverGroup.length) {
      const countBadge = `<span style="background:#f4f4f5;color:#71717a;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:8px;">${neverGroup.length}</span>`;
      html += `<div style="margin-top:16px;margin-bottom:6px;font-weight:700;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;">Never Logged In${countBadge}</div>`;
      neverGroup.forEach(u => {
        const roleBadge = u.role === 'superadmin' ? ' üôè' : u.role === 'admin' ? ' ‚≠ê' : u.role === 'manager' ? ' üìã' : '';
        html += `
          <div class="activity-item">
            <div style="min-width:48px;"></div>
            <div style="display:flex;align-items:center;min-width:0;flex:1;">
              <span class="activity-status status-never"></span>
              <div style="min-width:0;">
                <div class="activity-name">${u.linkedName || u.email}${roleBadge}</div>
                <div class="activity-email">${u.linkedName ? u.email + ' ¬∑ ' : ''}${u.role}</div>
              </div>
            </div>
            <div class="activity-time"><div class="time-main">Never</div></div>
          </div>`;
      });
    }

    el.innerHTML = html;
  } catch (err) {
    console.error('Activity error:', err);
    el.innerHTML = '<p style="color:#dc2626;">Error loading activity data. Check Firestore rules.</p>';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBAL BINDINGS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.login = login;
window.logout = logout;
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LEAD FUNNEL (Admin + Manager)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _funnelSort = { col: 'total', dir: 'desc' };
let _funnelData = null;
let _funnelExpanded = new Set(); // which source types are open

async function showLeadFunnel() {
  if (!isAdmin()) return;
  logPageView('Lead Funnel');
  showLoading();
  try {
    const url = `${SCRIPT_URL}?route=sourcefunnel&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.ok) { alert('Error loading funnel data'); showDashboard(); return; }
    _funnelData = data;
    _funnelSort = { col: 'total', dir: 'desc' };
    // Start with all expanded
    const sourceTypes = [...new Set((data.byProvider || []).map(p => p.sourceType || '(Unknown)'))];
    _funnelExpanded = new Set(sourceTypes);
    renderLeadFunnel();
  } catch (err) {
    console.error('Lead funnel error:', err);
    showDashboard();
  }
}

function toggleFunnelGroup(st) {
  if (_funnelExpanded.has(st)) _funnelExpanded.delete(st);
  else _funnelExpanded.add(st);
  renderLeadFunnel();
}
window.toggleFunnelGroup = toggleFunnelGroup;

function toggleFunnelSort(col) {
  if (_funnelSort.col === col) {
    _funnelSort.dir = _funnelSort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    _funnelSort = { col, dir: 'desc' };
  }
  renderLeadFunnel();
}

function funnelExpandAll() { 
  const types = [...new Set((_funnelData?.byProvider || []).map(p => p.sourceType || '(Unknown)'))];
  _funnelExpanded = new Set(types);
  renderLeadFunnel();
}
function funnelCollapseAll() { _funnelExpanded = new Set(); renderLeadFunnel(); }
window.funnelExpandAll = funnelExpandAll;
window.funnelCollapseAll = funnelCollapseAll;

function renderLeadFunnel() {
  if (!_funnelData) return;
  const providers = _funnelData.byProvider || [];
  const sourceTypes = _funnelData.bySourceType || [];

  // Group providers by sourceType
  const groups = {};
  providers.forEach(p => {
    const st = p.sourceType || '(Unknown)';
    if (!groups[st]) groups[st] = [];
    groups[st].push(p);
  });

  // Sort providers within each group
  function sortRows(arr) {
    return [...arr].sort((a, b) => {
      let av = a[_funnelSort.col], bv = b[_funnelSort.col];
      if (typeof av === 'string') return _funnelSort.dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
      av = av ?? -1; bv = bv ?? -1;
      return _funnelSort.dir === 'asc' ? av - bv : bv - av;
    });
  }

  // Overall stats
  const allProviders = providers;
  const totLeads = allProviders.reduce((s, r) => s + r.total, 0);
  const totSold = allProviders.reduce((s, r) => s + r.sold, 0);
  const totAppt = allProviders.reduce((s, r) => s + r.apptSet, 0);
  const overallClose = totLeads > 0 ? (totSold / totLeads * 100).toFixed(1) : '0';
  const overallAppt = totLeads > 0 ? (totAppt / totLeads * 100).toFixed(1) : '0';

  // Best/worst (min 5 leads) across all providers
  const qualified = allProviders.filter(r => r.total >= 5);
  const bestClose = qualified.length ? qualified.reduce((a, b) => a.closeRate > b.closeRate ? a : b) : null;
  const worstClose = qualified.length ? qualified.reduce((a, b) => a.closeRate < b.closeRate ? a : b) : null;
  const bestAppt = qualified.length ? qualified.reduce((a, b) => a.apptRate > b.apptRate ? a : b) : null;
  const fastestClose = qualified.filter(r => r.avgDaysToClose !== null).length
    ? qualified.filter(r => r.avgDaysToClose !== null).reduce((a, b) => (a.avgDaysToClose ?? 999) < (b.avgDaysToClose ?? 999) ? a : b) : null;

  function sa(col) {
    const active = _funnelSort.col === col;
    return active ? (_funnelSort.dir === 'desc' ? '‚ñº' : '‚ñ≤') : '‚Üï';
  }
  function thC(col) { return _funnelSort.col === col ? 'sorted' : ''; }
  function closeColor(rate) {
    if (rate >= 15) return '#16a34a';
    if (rate >= 8) return '#ca8a04';
    if (rate >= 3) return '#f97316';
    return '#dc2626';
  }
  function apptColor(rate) {
    if (rate >= 30) return '#16a34a';
    if (rate >= 15) return '#ca8a04';
    return '#94a3b8';
  }

  const sourceIcons = {
    'Internet Up': 'üåê',
    'Phone Up': 'üìû',
    'Showroom Up': 'üè™',
    'Campaign': 'üì£',
  };
  const sourceColors = {
    'Internet Up': '#2563eb',
    'Phone Up': '#16a34a',
    'Showroom Up': '#9333ea',
    'Campaign': '#f97316',
  };

  // Sort source types by total leads desc
  const sortedSourceTypes = [...sourceTypes].sort((a, b) => b.total - a.total);

  // Build accordion HTML
  let accordionHTML = '';
  sortedSourceTypes.forEach(st => {
    const stName = st.name;
    const icon = sourceIcons[stName] || 'üìã';
    const clr = sourceColors[stName] || '#64748b';
    const expanded = _funnelExpanded.has(stName);
    const chevron = expanded ? '‚ñæ' : '‚ñ∏';
    const provs = sortRows(groups[stName] || []);

    // Source type header row
    accordionHTML += `
      <div style="margin-bottom:${expanded ? '0' : '8'}px;">
        <div onclick="toggleFunnelGroup('${stName.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border:1px solid var(--line);border-radius:${expanded ? '10px 10px 0 0' : '10px'};cursor:pointer;user-select:none;transition:all .15s;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:16px;">${icon}</span>
            <span style="font-size:11px;color:var(--muted);">${chevron}</span>
            <span style="font-weight:800;font-size:14px;">${stName}</span>
            <span style="font-size:11px;color:var(--muted);font-weight:500;">${provs.length} provider${provs.length !== 1 ? 's' : ''}</span>
          </div>
          <div style="display:flex;gap:16px;align-items:center;font-size:12px;flex-wrap:wrap;">
            <span><strong>${st.total}</strong> leads</span>
            <span style="color:${apptColor(st.apptRate)};font-weight:700;">${st.apptRate}% appt</span>
            <span style="color:${closeColor(st.closeRate)};font-weight:700;">${st.closeRate}% close</span>
            <span style="font-weight:700;color:#16a34a;">${st.sold} sold</span>
            <span style="color:${st.stalePct > 40 ? '#dc2626' : st.stalePct > 20 ? '#ca8a04' : '#16a34a'};">${st.stalePct}% stale</span>
          </div>
        </div>`;

    if (expanded) {
      accordionHTML += `
        <div style="border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px;overflow:hidden;margin-bottom:8px;">
          <div style="overflow-x:auto;">
          <table style="width:100%;font-size:12px;">
            <thead>
              <tr style="background:rgba(0,0,0,.02);">
                <th style="text-align:left;padding:8px 12px;cursor:pointer;font-size:11px;" class="${thC('name')}" onclick="toggleFunnelSort('name')">Lead Provider <span class="sort-arrow">${sa('name')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('total')}" onclick="toggleFunnelSort('total')">Leads <span class="sort-arrow">${sa('total')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('apptSet')}" onclick="toggleFunnelSort('apptSet')">Appt Set <span class="sort-arrow">${sa('apptSet')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('apptRate')}" onclick="toggleFunnelSort('apptRate')">Appt % <span class="sort-arrow">${sa('apptRate')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('sold')}" onclick="toggleFunnelSort('sold')">Sold <span class="sort-arrow">${sa('sold')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('closeRate')}" onclick="toggleFunnelSort('closeRate')">Close % <span class="sort-arrow">${sa('closeRate')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('avgDaysToClose')}" onclick="toggleFunnelSort('avgDaysToClose')">Days to Close <span class="sort-arrow">${sa('avgDaysToClose')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('active')}" onclick="toggleFunnelSort('active')">Active <span class="sort-arrow">${sa('active')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('stalePct')}" onclick="toggleFunnelSort('stalePct')">Stale 3d+ <span class="sort-arrow">${sa('stalePct')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('badLead')}" onclick="toggleFunnelSort('badLead')">Bad <span class="sort-arrow">${sa('badLead')}</span></th>
                <th style="text-align:left;font-size:11px;">Top Reps</th>
              </tr>
            </thead>
            <tbody>`;

      provs.forEach(r => {
        const daysClose = r.avgDaysToClose !== null ? r.avgDaysToClose + 'd' : '‚Äì';
        const repsStr = (r.topReps || []).join(', ');
        // Bar width proportional to group max
        const groupMax = Math.max(...provs.map(p => p.total), 1);
        const barPct = Math.round((r.total / groupMax) * 100);
        accordionHTML += `<tr>
          <td style="padding:6px 12px;font-weight:600;white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${r.name}">
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;">${r.name}</div>
              <div style="width:40px;height:4px;background:#f1f5f9;border-radius:2px;flex-shrink:0;">
                <div style="width:${barPct}%;height:100%;background:${clr};border-radius:2px;opacity:.5;"></div>
              </div>
            </div>
          </td>
          <td style="text-align:center;font-weight:700;">${r.total}</td>
          <td style="text-align:center;">${r.apptSet}</td>
          <td style="text-align:center;font-weight:700;color:${apptColor(r.apptRate)};">${r.apptRate}%</td>
          <td style="text-align:center;font-weight:700;">${r.sold}</td>
          <td style="text-align:center;font-weight:700;color:${closeColor(r.closeRate)};">${r.closeRate}%</td>
          <td style="text-align:center;">${daysClose}</td>
          <td style="text-align:center;">${r.active}</td>
          <td style="text-align:center;color:${r.stalePct > 40 ? '#dc2626' : r.stalePct > 20 ? '#ca8a04' : '#16a34a'};">${r.stalePct}%</td>
          <td style="text-align:center;">${r.badLead}</td>
          <td style="font-size:10px;color:var(--muted);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${repsStr}">${repsStr || '‚Äì'}</td>
        </tr>`;
      });

      accordionHTML += `</tbody></table></div></div>`;
    }
    accordionHTML += `</div>`;
  });

  // Insights
  let insights = '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;">';
  if (bestClose) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0;font-size:12px;"><div style="font-weight:700;color:#16a34a;">üèÜ Best Close Rate</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${bestClose.name}</div><div>${bestClose.closeRate}% (${bestClose.sold}/${bestClose.total})</div></div>`;
  if (worstClose) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;font-size:12px;"><div style="font-weight:700;color:#dc2626;">üö® Worst Close Rate</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${worstClose.name}</div><div>${worstClose.closeRate}% (${worstClose.sold}/${worstClose.total})</div></div>`;
  if (fastestClose) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#eff6ff;border-radius:8px;border:1px solid #bfdbfe;font-size:12px;"><div style="font-weight:700;color:#2563eb;">‚ö° Fastest to Close</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${fastestClose.name}</div><div>Avg ${fastestClose.avgDaysToClose} days</div></div>`;
  if (bestAppt) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#fefce8;border-radius:8px;border:1px solid #fde68a;font-size:12px;"><div style="font-weight:700;color:#ca8a04;">üìÖ Best Appt Rate</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${bestAppt.name}</div><div>${bestAppt.apptRate}% (${bestAppt.apptSet}/${bestAppt.total})</div></div>`;
  insights += '</div>';

  const funnelDateRange = _funnelData.dateRange ? `${_funnelData.dateRange.from || '?'} ‚Äì ${_funnelData.dateRange.to || '?'}` : '';

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">üî¨ Lead Source Funnel</div>
          <div style="font-size:12px;color:var(--muted);">Lead In ‚Üí Appointment Set ‚Üí Sold ¬∑ grouped by Source Type${funnelDateRange ? ` ¬∑ <strong style="color:var(--text);">${funnelDateRange}</strong>` : ''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="topbar-btn" onclick="funnelExpandAll()" style="font-size:11px;padding:5px 10px;">Expand All</button>
          <button class="topbar-btn" onclick="funnelCollapseAll()" style="font-size:11px;padding:5px 10px;">Collapse All</button>
          <button class="topbar-btn manage" onclick="showLeadFunnel()">‚Üª Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Total Leads</div>
          <div style="font-size:22px;font-weight:800;">${totLeads}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Appts Set üìÖ</div>
          <div style="font-size:22px;font-weight:800;">${totAppt}</div>
          <div style="font-size:11px;color:var(--muted);">${overallAppt}% of leads</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Sold ‚úÖ</div>
          <div style="font-size:22px;font-weight:800;color:#16a34a;">${totSold}</div>
          <div style="font-size:11px;color:var(--muted);">${overallClose}% close rate</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Source Types</div>
          <div style="font-size:22px;font-weight:800;">${sortedSourceTypes.length}</div>
          <div style="font-size:11px;color:var(--muted);">${allProviders.length} providers</div>
        </div>
      </div>

      ${insights}

      <!-- Accordion -->
      <div style="margin-top:16px;">
        ${accordionHTML}
      </div>

      <div style="margin-top:12px;font-size:10px;color:var(--muted);line-height:1.6;">
        <strong>How to read:</strong> Appt % = what % of leads get an appointment. Close % = what % convert to a sale. Stale 3d+ = leads not contacted in 3+ days. Sources with &lt;5 leads excluded from insight cards. Colors: <span style="color:#16a34a;">‚ñ†</span> strong <span style="color:#ca8a04;">‚ñ†</span> moderate <span style="color:#dc2626;">‚ñ†</span> weak
      </div>
    </div>`;
}

window.showDashboard = showDashboard;
window.showPersonDetails = showPersonDetails;
window.onRowHover = onRowHover;
window.viewCallSheets = viewCallSheets;
window.showUserModal = showUserModal;
window.closeUserModal = closeUserModal;
window.startEditUser = startEditUser;
window.cancelEditUser = cancelEditUser;
window.saveEditUser = saveEditUser;
window.addUser = addUser;
window.deleteUser = deleteUser;
window.showActivityModal = showActivityModal;
window.closeActivityModal = closeActivityModal;
window.showReassignments = showReassignments;
window.toggleReassignSort = toggleReassignSort;
window.showSourceLeaderboard = showSourceLeaderboard;
window.toggleSourceSort = toggleSourceSort;
window.showLeadFunnel = showLeadFunnel;
window.toggleFunnelSort = toggleFunnelSort;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BROWSER BACK BUTTON SUPPORT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _skipPush = false;

function navPush(state) {
  if (_skipPush) return;
  history.pushState(state, '', '#' + state.view);
}

// Wrap navigation functions to push history
const _origShowDashboard = showDashboard;
showDashboard = async function() {
  navPush({ view: 'dashboard' });
  return _origShowDashboard();
};
window.showDashboard = showDashboard;

const _origShowPerson = showPersonDetails;
showPersonDetails = async function(name, type) {
  navPush({ view: 'person', name, type });
  return _origShowPerson(name, type);
};
window.showPersonDetails = showPersonDetails;

const _origViewCalls = viewCallSheets;
viewCallSheets = async function(name) {
  navPush({ view: 'calls', name });
  return _origViewCalls(name);
};
window.viewCallSheets = viewCallSheets;

const _origShowReassign = showReassignments;
showReassignments = async function() {
  navPush({ view: 'reassignments' });
  return _origShowReassign();
};
window.showReassignments = showReassignments;

const _origShowSources = showSourceLeaderboard;
showSourceLeaderboard = async function() {
  navPush({ view: 'sources' });
  return _origShowSources();
};
window.showSourceLeaderboard = showSourceLeaderboard;

const _origShowFunnel = showLeadFunnel;
showLeadFunnel = async function() {
  navPush({ view: 'funnel' });
  return _origShowFunnel();
};
window.showLeadFunnel = showLeadFunnel;

if (typeof showVehicleDemand === 'function') {
  const _origShowVeh = showVehicleDemand;
  showVehicleDemand = async function() {
    navPush({ view: 'vehicle' });
    return _origShowVeh();
  };
  window.showVehicleDemand = showVehicleDemand;
}

const _origShowMgrLb = showManagerLeaderboard;
showManagerLeaderboard = async function() {
  navPush({ view: 'mgr-leaderboard' });
  return _origShowMgrLb();
};
window.showManagerLeaderboard = showManagerLeaderboard;

// Handle browser back/forward buttons
window.addEventListener('popstate', (e) => {
  const state = e.state;
  _skipPush = true;
  if (!state || state.view === 'dashboard') {
    _origShowDashboard();
  } else if (state.view === 'person') {
    _origShowPerson(state.name, state.type);
  } else if (state.view === 'calls') {
    _origViewCalls(state.name);
  } else if (state.view === 'reassignments') {
    _origShowReassign();
  } else if (state.view === 'sources') {
    _origShowSources();
  } else if (state.view === 'funnel') {
    _origShowFunnel();
  } else if (state.view === 'vehicle' && typeof _origShowVeh !== 'undefined') {
    _origShowVeh();
  } else if (state.view === 'mgr-leaderboard') {
    _origShowMgrLb();
  } else {
    _origShowDashboard();
  }
  _skipPush = false;
});

// Set initial state
history.replaceState({ view: 'dashboard' }, '', '#dashboard');

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VEHICLE DEMAND DASHBOARD (Admin)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _vehData = null;
let _vehExpanded = new Set();
let _vehSort = { col: 'total', dir: 'desc' };

async function showVehicleDemand() {
  if (!isAdmin() && !isManager()) return;
  logPageView('Vehicle Demand');
  showLoading();
  try {
    let data = null;
    // ‚îÄ‚îÄ Firestore first ‚îÄ‚îÄ
    try {
      const snapDoc = await getDoc(doc(db, 'dashboardSnapshots', 'vehicledemand'));
      if (snapDoc.exists()) {
        const raw = snapDoc.data();
        data = JSON.parse(raw.jsonData);
        data.ok = true;
        const updatedAt = raw.updatedAt?.toDate?.() || new Date(raw.updatedAt);
        console.log(`[Firestore] Vehicle demand loaded (age: ${Math.round((Date.now() - updatedAt.getTime())/60000)}min)`);
      }
    } catch (fsErr) {
      console.warn('[Firestore] Vehicle demand read failed:', fsErr.message);
    }
    // ‚îÄ‚îÄ GAS fallback ‚îÄ‚îÄ
    if (!data) {
      const url = `${SCRIPT_URL}?route=vehicledemand&session=${encodeURIComponent(window.sessionToken || '')}`;
      const resp = await fetch(url);
      data = await resp.json();
    }
    if (!data.ok) { alert('Error loading vehicle data'); showDashboard(); return; }
    _vehData = data;
    _vehSort = { col: 'total', dir: 'desc' };
    _vehExpanded = new Set(data.byMake.slice(0, 5).map(m => m.name));
    renderVehicleDemand();
  } catch (err) {
    console.error('Vehicle demand error:', err);
    showDashboard();
  }
}

function toggleVehGroup(make) {
  if (_vehExpanded.has(make)) _vehExpanded.delete(make);
  else _vehExpanded.add(make);
  renderVehicleDemand();
}

function toggleVehSort(col) {
  if (_vehSort.col === col) _vehSort.dir = _vehSort.dir === 'desc' ? 'asc' : 'desc';
  else _vehSort = { col, dir: 'desc' };
  renderVehicleDemand();
}

function vehExpandAll() {
  _vehExpanded = new Set((_vehData?.byMake || []).map(m => m.name));
  renderVehicleDemand();
}
function vehCollapseAll() { _vehExpanded = new Set(); renderVehicleDemand(); }

function renderVehicleDemand() {
  if (!_vehData) return;
  const { byMake, summary, dateRange } = _vehData;
  const s = summary;
  const dateStr = dateRange ? `${dateRange.from || '?'} ‚Äì ${dateRange.to || '?'}` : '';

  // Sort makes
  const sorted = [...byMake].sort((a, b) => {
    let av = a[_vehSort.col], bv = b[_vehSort.col];
    if (typeof av === 'string') return _vehSort.dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return _vehSort.dir === 'asc' ? (av||0) - (bv||0) : (bv||0) - (av||0);
  });

  function closeClr(r) { return r >= 20 ? '#16a34a' : r >= 10 ? '#ca8a04' : r >= 3 ? '#f97316' : '#dc2626'; }
  function nuBar(nw, used, total) {
    if (!total) return '';
    const pN = Math.round(nw / total * 100);
    const pU = Math.round(used / total * 100);
    return `<div style="display:flex;height:6px;border-radius:3px;overflow:hidden;width:80px;" title="New ${pN}% / Used ${pU}%">
      <div style="width:${pN}%;background:#3b82f6;"></div>
      <div style="width:${pU}%;background:#f97316;"></div>
      <div style="flex:1;background:#e2e8f0;"></div>
    </div>`;
  }
  function statusDots(active, sold, inactive, total) {
    if (!total) return '';
    const pA = Math.round(active / total * 100);
    const pS = Math.round(sold / total * 100);
    return `<div style="display:flex;height:6px;border-radius:3px;overflow:hidden;width:80px;" title="Active ${pA}% / Sold ${pS}%">
      <div style="width:${pA}%;background:#3b82f6;"></div>
      <div style="width:${pS}%;background:#16a34a;"></div>
      <div style="flex:1;background:#fca5a5;"></div>
    </div>`;
  }

  function sa(col) {
    return _vehSort.col === col ? (_vehSort.dir === 'desc' ? '‚ñº' : '‚ñ≤') : '‚Üï';
  }

  // Make brand colors
  const brandColors = {
    'JEEP': '#4d6b3a', 'RAM': '#1a1a1a', 'DODGE': '#d32f2f', 'TOYOTA': '#eb0a1e',
    'FORD': '#003478', 'BMW': '#0066b1', 'CHEVROLET': '#d4a843', 'KIA': '#05141f',
    'NISSAN': '#c3002f', 'HONDA': '#cc0000', 'CHRYSLER': '#004b87',
  };

  // Accordion
  let accHTML = '';
  sorted.forEach(mk => {
    const expanded = _vehExpanded.has(mk.name);
    const chevron = expanded ? '‚ñæ' : '‚ñ∏';
    const clr = brandColors[mk.name] || '#64748b';
    const pctNew = mk.total > 0 ? Math.round(mk.new / mk.total * 100) : 0;
    const pctUsed = mk.total > 0 ? Math.round(mk.used / mk.total * 100) : 0;

    accHTML += `<div style="margin-bottom:${expanded ? '0' : '6'}px;">
      <div onclick="toggleVehGroup('${mk.name.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border:1px solid var(--line);border-radius:${expanded ? '10px 10px 0 0' : '10px'};cursor:pointer;user-select:none;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:11px;color:var(--muted);">${chevron}</span>
          <span style="display:inline-block;width:4px;height:20px;background:${clr};border-radius:2px;"></span>
          <span style="font-weight:800;font-size:14px;">${mk.name}</span>
          <span style="font-size:11px;color:var(--muted);">${mk.models.length} model${mk.models.length !== 1 ? 's' : ''}</span>
        </div>
        <div style="display:flex;gap:14px;align-items:center;font-size:12px;flex-wrap:wrap;">
          <span><strong>${mk.total}</strong> leads</span>
          ${nuBar(mk.new, mk.used, mk.total)}
          <span style="color:#3b82f6;font-size:10px;">${pctNew}% new</span>
          <span style="color:#f97316;font-size:10px;">${pctUsed}% used</span>
          <span style="color:${closeClr(mk.closeRate)};font-weight:700;">${mk.closeRate}% sold</span>
          <span style="font-size:10px;color:var(--muted);">${mk.withTrade} trades</span>
        </div>
      </div>`;

    if (expanded) {
      accHTML += `<div style="border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px;overflow:hidden;margin-bottom:6px;">
        <div style="overflow-x:auto;">
        <table style="width:100%;font-size:12px;">
          <thead><tr style="background:rgba(0,0,0,.02);">
            <th style="text-align:left;padding:8px 12px;font-size:11px;cursor:pointer;" onclick="toggleVehSort('name')">Model <span class="sort-arrow">${sa('name')}</span></th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('total')">Leads <span class="sort-arrow">${sa('total')}</span></th>
            <th style="font-size:11px;">New/Used</th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('active')">Active <span class="sort-arrow">${sa('active')}</span></th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('sold')">Sold <span class="sort-arrow">${sa('sold')}</span></th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('closeRate')">Close % <span class="sort-arrow">${sa('closeRate')}</span></th>
            <th style="font-size:11px;">Pipeline</th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('withTrade')">Trades <span class="sort-arrow">${sa('withTrade')}</span></th>
            <th style="text-align:left;font-size:11px;">Top Trims</th>
          </tr></thead><tbody>`;

      const sortedModels = [...mk.models].sort((a, b) => {
        let av = a[_vehSort.col], bv = b[_vehSort.col];
        if (typeof av === 'string') return _vehSort.dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
        return _vehSort.dir === 'asc' ? (av||0) - (bv||0) : (bv||0) - (av||0);
      });

      const groupMax = Math.max(...mk.models.map(m => m.total), 1);
      sortedModels.forEach(md => {
        const barPct = Math.round((md.total / groupMax) * 100);
        const trimStr = (md.topTrims || []).join(', ');
        const eMake = mk.name.replace(/'/g, "\\'");
        const eModel = md.name.replace(/'/g, "\\'");
        const lnk = (val, filter, color) => val > 0
          ? `<a href="#" onclick="event.preventDefault();showVehLeads('${eMake}','${eModel}','${filter}')" style="color:${color || 'var(--text)'};text-decoration:underline;text-underline-offset:2px;cursor:pointer;font-weight:700;">${val}</a>`
          : `<span style="color:var(--muted);">${val}</span>`;
        accHTML += `<tr>
          <td style="padding:6px 12px;font-weight:600;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${md.name}">${md.name}</div>
              <div style="width:40px;height:4px;background:#f1f5f9;border-radius:2px;flex-shrink:0;">
                <div style="width:${barPct}%;height:100%;background:${clr};border-radius:2px;opacity:.4;"></div>
              </div>
            </div>
          </td>
          <td style="text-align:center;">${lnk(md.total, 'all', 'var(--text)')}</td>
          <td style="text-align:center;">${nuBar(md.new, md.used, md.total)}</td>
          <td style="text-align:center;">${lnk(md.active, 'active', '#3b82f6')}</td>
          <td style="text-align:center;">${lnk(md.sold, 'sold', '#16a34a')}</td>
          <td style="text-align:center;font-weight:700;color:${closeClr(md.closeRate)};">${md.closeRate}%</td>
          <td style="text-align:center;">${statusDots(md.active, md.sold, md.inactive, md.total)}</td>
          <td style="text-align:center;">${lnk(md.withTrade, 'trade', '#f97316')}</td>
          <td style="font-size:10px;color:var(--muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${trimStr}">${trimStr || '‚Äì'}</td>
        </tr>`;
      });

      accHTML += '</tbody></table></div></div>';
    }
    accHTML += '</div>';
  });

  // Top trades sidebar
  const tradesHTML = (s.topTrades || []).map((t, i) =>
    `<div style="display:flex;justify-content:space-between;padding:4px 0;${i > 0 ? 'border-top:1px solid var(--line);' : ''}">
      <span style="font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px;" title="${t.name}">${t.name}</span>
      <span style="font-size:11px;font-weight:700;flex-shrink:0;margin-left:8px;">${t.count}</span>
    </div>`
  ).join('');

  // New vs Used donut (CSS-based)
  const totalNU = s.new + s.used;
  const pctNew = totalNU > 0 ? Math.round(s.new / totalNU * 100) : 50;

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">üöó Vehicle Demand Dashboard</div>
          <div style="font-size:12px;color:var(--muted);">What customers are shopping for ¬∑ grouped by Make${dateStr ? ` ¬∑ <strong style="color:var(--text);">${dateStr}</strong>` : ''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="topbar-btn" onclick="vehExpandAll()" style="font-size:11px;padding:5px 10px;">Expand All</button>
          <button class="topbar-btn" onclick="vehCollapseAll()" style="font-size:11px;padding:5px 10px;">Collapse All</button>
          <button class="topbar-btn manage" onclick="showVehicleDemand()">‚Üª Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Leads w/ Vehicle</div>
          <div style="font-size:22px;font-weight:800;">${s.withVehicle}</div>
          <div style="font-size:10px;color:var(--muted);">of ${s.totalLeads} total</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">New / Used</div>
          <div style="font-size:18px;font-weight:800;"><span style="color:#3b82f6;">${s.new}</span> <span style="color:var(--muted);font-size:12px;">/</span> <span style="color:#f97316;">${s.used}</span></div>
          <div style="display:flex;height:6px;border-radius:3px;overflow:hidden;margin-top:4px;">
            <div style="width:${pctNew}%;background:#3b82f6;"></div>
            <div style="flex:1;background:#f97316;"></div>
          </div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Active üü¢</div>
          <div style="font-size:22px;font-weight:800;">${s.active}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Sold ‚úÖ</div>
          <div style="font-size:22px;font-weight:800;color:#16a34a;">${s.sold}</div>
          <div style="font-size:10px;color:var(--muted);">${s.closeRate}% close</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Makes</div>
          <div style="font-size:22px;font-weight:800;">${byMake.length}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">With Trade-In</div>
          <div style="font-size:22px;font-weight:800;">${s.withTrade}</div>
          <div style="font-size:10px;color:var(--muted);">${s.withVehicle > 0 ? Math.round(s.withTrade / s.withVehicle * 100) : 0}% of leads</div>
        </div>
      </div>

      <!-- Insights row -->
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <!-- Top 5 Models -->
        <div style="flex:1;min-width:250px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:12px;margin-bottom:8px;">üî• Top 5 Most Demanded</div>
          ${(() => {
            const allModels = [];
            byMake.forEach(mk => mk.models.forEach(md => allModels.push({ make: mk.name, ...md })));
            allModels.sort((a, b) => b.total - a.total);
            return allModels.slice(0, 5).map((m, i) =>
              '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;' + (i > 0 ? 'border-top:1px solid var(--line);' : '') + '">' +
                '<span style="font-size:12px;font-weight:600;">' + (i+1) + '. ' + m.make + ' ' + m.name + '</span>' +
                '<span style="font-size:11px;color:var(--muted);"><strong style="color:var(--text);">' + m.total + '</strong> leads ¬∑ <span style="color:' + closeClr(m.closeRate) + ';">' + m.closeRate + '% sold</span></span>' +
              '</div>'
            ).join('');
          })()}
        </div>

        <!-- Top Trades -->
        <div style="flex:1;min-width:250px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:12px;margin-bottom:8px;">üîÑ Top Trade-Ins</div>
          ${tradesHTML || '<div style="color:var(--muted);font-size:12px;">No trade data</div>'}
        </div>
      </div>

      <!-- Accordion -->
      <div>${accHTML}</div>

      <div style="margin-top:12px;font-size:10px;color:var(--muted);line-height:1.6;">
        <strong>How to read:</strong> New/Used bar = <span style="color:#3b82f6;">‚ñ†</span> new <span style="color:#f97316;">‚ñ†</span> used. Pipeline = <span style="color:#3b82f6;">‚ñ†</span> active <span style="color:#16a34a;">‚ñ†</span> sold <span style="color:#fca5a5;">‚ñ†</span> inactive. Close % = sold √∑ total leads for that vehicle.
      </div>
    </div>`;
}

window.showVehicleDemand = showVehicleDemand;
window.toggleVehGroup = toggleVehGroup;
window.toggleVehSort = toggleVehSort;
window.vehExpandAll = vehExpandAll;
window.vehCollapseAll = vehCollapseAll;

function showVehLeads(makeName, modelName, filter) {
  if (!_vehData) return;
  logPageView('Vehicle Leads: ' + makeName + ' ' + modelName);
  const mk = _vehData.byMake.find(m => m.name === makeName);
  if (!mk) return;
  const md = mk.models.find(m => m.name === modelName);
  if (!md || !md.leads) return;

  let leads = md.leads;
  let filterLabel = 'All';
  const filterColors = { all: 'var(--text)', active: '#3b82f6', sold: '#16a34a', inactive: '#dc2626', trade: '#f97316' };
  if (filter === 'active') { leads = leads.filter(l => l.cat === 'active'); filterLabel = 'Active'; }
  else if (filter === 'sold') { leads = leads.filter(l => l.cat === 'sold'); filterLabel = 'Sold'; }
  else if (filter === 'inactive') { leads = leads.filter(l => l.cat === 'inactive'); filterLabel = 'Inactive'; }
  else if (filter === 'trade') { leads = leads.filter(l => l.tv); filterLabel = 'With Trade-In'; }

  const filterBtns = ['all','active','sold','trade'].map(f => {
    const labels = { all: `All (${md.total})`, active: `Active (${md.active})`, sold: `Sold (${md.sold})`, trade: `Trades (${md.withTrade})` };
    const isActive = f === filter;
    return `<button onclick="showVehLeads('${makeName.replace(/'/g, "\\'")}','${modelName.replace(/'/g, "\\'")}','${f}')" style="padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid ${filterColors[f]};background:${isActive ? filterColors[f] : 'transparent'};color:${isActive ? '#fff' : filterColors[f]};cursor:pointer;">${labels[f]}</button>`;
  }).join('');

  const statusClr = (cat) => cat === 'sold' ? '#16a34a' : cat === 'active' ? '#3b82f6' : '#dc2626';

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">${makeName} ${modelName}</div>
          <div style="font-size:12px;color:var(--muted);">
            <span style="color:${filterColors[filter]};font-weight:700;">${filterLabel}</span> ¬∑ ${leads.length} lead${leads.length !== 1 ? 's' : ''}
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          ${filterBtns}
          <button class="topbar-btn manage" onclick="renderVehicleDemand()" style="margin-left:8px;">‚Üê Vehicle Demand</button>
        </div>
      </div>

      <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;overflow:hidden;">
        <div style="overflow-x:auto;">
        <table style="width:100%;font-size:12px;border-collapse:collapse;">
          <thead><tr style="background:rgba(0,0,0,.03);">
            <th style="text-align:left;padding:10px 12px;font-size:11px;">Customer</th>
            <th style="text-align:left;font-size:11px;">Phone</th>
            <th style="text-align:left;font-size:11px;">Email</th>
            <th style="text-align:left;font-size:11px;">Status</th>
            <th style="text-align:left;font-size:11px;">Sales Rep</th>
            <th style="text-align:left;font-size:11px;">Date In</th>
            <th style="text-align:center;font-size:11px;">New/Used</th>
            <th style="text-align:left;font-size:11px;">Trim</th>
            <th style="text-align:left;font-size:11px;">Trade-In</th>
          </tr></thead>
          <tbody>
            ${leads.length === 0 ? '<tr><td colspan="9" style="padding:20px;text-align:center;color:var(--muted);">No leads match this filter.</td></tr>' : ''}
            ${leads.map(l => `<tr style="border-top:1px solid var(--line);">
              <td style="padding:8px 12px;font-weight:600;white-space:nowrap;">${l.n || '‚Äì'}</td>
              <td style="white-space:nowrap;">${l.p ? `<a href="tel:${l.p}" style="color:var(--accent);text-decoration:none;">${l.p}</a>` : '‚Äì'}</td>
              <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.e}">${l.e ? `<a href="mailto:${l.e}" style="color:var(--accent);text-decoration:none;">${l.e}</a>` : '‚Äì'}</td>
              <td style="white-space:nowrap;"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${statusClr(l.cat)};margin-right:4px;"></span>${l.s || '‚Äì'}</td>
              <td style="white-space:nowrap;">${l.r || '‚Äì'}</td>
              <td style="white-space:nowrap;">${l.d || '‚Äì'}</td>
              <td style="text-align:center;"><span style="background:${l.nu === 'New' ? '#dbeafe' : l.nu === 'Used' ? '#ffedd5' : '#f4f4f5'};color:${l.nu === 'New' ? '#1d4ed8' : l.nu === 'Used' ? '#c2410c' : '#71717a'};padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;">${l.nu || '‚Äì'}</span></td>
              <td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.t}">${l.t || '‚Äì'}</td>
              <td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.tv}">${l.tv || '‚Äì'}</td>
            </tr>`).join('')}
          </tbody>
        </table>
        </div>
      </div>
    </div>`;
}

window.showVehLeads = showVehLeads;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SALES MANAGER LEADERBOARD (Managers+)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _mgrLbSort = { col: 'calls', dir: 'desc' };

async function showManagerLeaderboard() {
  if (!isAdmin() && !isManager()) { alert('Only managers and admins can view this report.'); return; }
  trackClick();
  logPageView('Manager Leaderboard');

  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üèÜ Sales Manager Leaderboard</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Individual manager activity ‚Äî Calls, Texts, Emails &amp; Appointments</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Back to Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    // Ensure user data is loaded
    const usersData = _lbUsersCache || await loadLeaderboardUsers();
    if (!usersData) throw new Error('Could not load user data');

    // Ensure dashboard data is loaded
    if (!dashboardData.sales.length && !dashboardData.bdc.length) {
      const lbDoc = await getDoc(doc(db, 'dashboardSnapshots', 'leaderboards'));
      if (lbDoc.exists()) {
        const payload = JSON.parse(lbDoc.data().jsonData);
        dashboardData.sales = Array.isArray(payload?.sales) ? payload.sales : [];
        dashboardData.bdc = Array.isArray(payload?.bdc) ? payload.bdc : [];
        dashboardData.bdc = dashboardData.bdc.map(x => ({ calls: 0, texts: 0, ...x }));
      }
    }

    renderManagerLeaderboard();
  } catch (err) {
    console.error('Manager Leaderboard error:', err);
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading Manager Leaderboard</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">‚Üê Back</button>
        </div>
      </div>`;
  }
}

function getManagerRows() {
  if (!_lbUsersCache) return [];
  const { nameMap, managers } = _lbUsersCache;

  const salesLookup = {};
  (dashboardData.sales || []).forEach(r => { salesLookup[(r.name || '').toUpperCase()] = r; });
  const bdcLookup = {};
  (dashboardData.bdc || []).forEach(r => { bdcLookup[(r.name || '').toUpperCase()] = r; });

  const rows = [];
  // For each manager, find their OWN individual row in sales/BDC data
  Object.values(managers).forEach(mgr => {
    const linked = (mgr.linkedName || '').trim().toUpperCase();
    if (!linked) return;
    const salesRow = salesLookup[linked];
    const bdcRow = bdcLookup[linked];
    if (!salesRow && !bdcRow) return;
    const r = salesRow || bdcRow;
    rows.push({
      name: mgr.displayName || mgr.linkedName || mgr.email,
      calls: safeNum(r.calls),
      texts: safeNum(r.texts),
      emails: 0, // Not currently tracked ‚Äî placeholder
      created: safeNum(r.created ?? r.created_count ?? 0),
      shown: safeNum(shownVal(r)),
      due: safeNum(r.due ?? r.due_count ?? 0),
      sales: safeNum(salesRow?.sales || 0)
    });
  });
  return rows;
}

function toggleMgrLbSort(col) {
  if (_mgrLbSort.col === col) { _mgrLbSort.dir = _mgrLbSort.dir === 'desc' ? 'asc' : 'desc'; }
  else { _mgrLbSort.col = col; _mgrLbSort.dir = 'desc'; }
  renderManagerLeaderboard();
}
window.toggleMgrLbSort = toggleMgrLbSort;

function renderManagerLeaderboard() {
  const rows = getManagerRows();
  const { col, dir } = _mgrLbSort;
  const mult = dir === 'desc' ? -1 : 1;
  const sorted = [...rows].sort((a, b) => {
    if (col === 'name') return mult * (a.name || '').localeCompare(b.name || '');
    return mult * ((a[col] || 0) - (b[col] || 0));
  });

  // Summary stats
  const totalMgrs = sorted.length;
  const totalCalls = sorted.reduce((s, r) => s + r.calls, 0);
  const totalTexts = sorted.reduce((s, r) => s + r.texts, 0);
  const totalAppts = sorted.reduce((s, r) => s + r.created, 0);

  const sortTh = (key, label) => {
    const active = _mgrLbSort.col === key;
    const arrow = active ? (_mgrLbSort.dir === 'desc' ? ' ‚ñº' : ' ‚ñ≤') : '';
    return `<th class="${active ? 'sorted' : ''}" onclick="toggleMgrLbSort('${key}')" style="cursor:pointer;">${label}${arrow}</th>`;
  };

  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üèÜ Sales Manager Leaderboard</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Individual manager activity ‚Äî Calls, Texts, Emails &amp; Appointments</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="showManagerLeaderboard()">‚Üª Refresh</button>
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <div class="reassign-stats">
        <div class="reassign-stat">
          <div class="stat-label">Managers</div>
          <div class="stat-value">${totalMgrs}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Total Calls</div>
          <div class="stat-value">${totalCalls}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Total Texts</div>
          <div class="stat-value">${totalTexts}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Total Appts Created</div>
          <div class="stat-value">${totalAppts}</div>
        </div>
      </div>

      ${sorted.length > 0 ? `<div class="table-card">
        <table>
          <thead>
            <tr>
              <th style="width:32px;text-align:center;">#</th>
              ${sortTh('name', 'Manager')}
              ${sortTh('calls', 'Calls')}
              ${sortTh('texts', 'Texts')}
              ${sortTh('emails', 'Emails')}
              ${sortTh('created', 'Appts Created')}
              ${sortTh('shown', 'Appts Shown')}
              ${sortTh('sales', 'Sales')}
            </tr>
          </thead>
          <tbody>
            ${sorted.map((r, i) => {
              const trophy = i === 0 ? '<span class="trophy">ü•á</span>' : i === 1 ? '<span class="trophy">ü•à</span>' : i === 2 ? '<span class="trophy">ü•â</span>' : '';
              return `<tr class="${i < 3 ? 'top3' : ''}">
                <td class="rank-cell">${i + 1}</td>
                <td class="name-cell">${trophy}${r.name}</td>
                <td>${r.calls}</td>
                <td>${r.texts}</td>
                <td style="color:var(--muted);">${r.emails || '‚Äî'}</td>
                <td>${r.created}</td>
                <td>${r.shown}</td>
                <td><strong>${r.sales}</strong></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>` : `<div class="detail-card" style="text-align:center;padding:40px 20px;color:var(--muted);">
        <p style="font-size:15px;">No manager activity data found.</p>
        <p style="font-size:12px;">Managers need a <strong>linkedName</strong> matching a row in the leaderboard data.</p>
      </div>`}

      <p style="margin-top:12px;font-size:11px;color:var(--muted);text-align:center;">
        Emails column is not yet tracked ‚Äî it will populate once the data source provides email activity counts.
      </p>
    </div>`;
}

window.showManagerLeaderboard = showManagerLeaderboard;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ENGAGEMENT REPORT (Admin)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _engagementData = null;
let _engDays = 7;

async function showEngagement() {
  if (!isAdmin()) return;
  logPageView('Engagement Report');
  showLoading();
  try {
    await loadEngagementData(_engDays);
    renderEngagement();
  } catch (err) {
    console.error('Engagement error:', err);
    showDashboard();
  }
}

async function loadEngagementData(days) {
  _engDays = days;
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);
  const cutoffTs = Timestamp.fromDate(cutoff);

  const q = query(
    collection(db, 'pageViews'),
    where('ts', '>=', cutoffTs),
    orderBy('ts', 'desc'),
    limit(10000)
  );

  const snap = await getDocs(q);
  const rows = [];
  snap.forEach(d => {
    const data = d.data();
    rows.push({
      email: data.email || 'unknown',
      page: data.page || '',
      ts: data.ts?.toDate ? data.ts.toDate() : new Date(data.ts),
      sessionId: data.sessionId || '',
      dwellMs: data.dwellMs || 0
    });
  });
  _engagementData = rows;
}

function setEngDays(d) {
  showLoading();
  loadEngagementData(d).then(() => renderEngagement()).catch(() => showDashboard());
}

function renderEngagement() {
  if (!_engagementData) return;
  const rows = _engagementData.filter(r => !r.page.endsWith('(exit)'));
  const exitRows = _engagementData.filter(r => r.page.endsWith('(exit)'));

  if (rows.length === 0) {
    document.getElementById('app').innerHTML = `
      <div style="max-width:1000px;margin:0 auto;padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <div style="font-size:20px;font-weight:800;">üìà Engagement Report</div>
            <div style="font-size:12px;color:var(--muted);">No data yet ‚Äî tracking just started. Check back after users navigate the dashboard.</div>
          </div>
          <button class="topbar-btn logout" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>`;
    return;
  }

  // ‚îÄ‚îÄ 1. Page Popularity ‚îÄ‚îÄ
  const pageCounts = {};
  const pageDwell = {};
  rows.forEach(r => {
    const p = r.page.startsWith('Person Detail:') ? 'Person Detail' : r.page.startsWith('Call Sheets:') ? 'Call Sheets' : r.page;
    pageCounts[p] = (pageCounts[p] || 0) + 1;
    if (!pageDwell[p]) pageDwell[p] = [];
    if (r.dwellMs > 0 && r.dwellMs < 3600000) pageDwell[p].push(r.dwellMs);
  });
  const pagePopularity = Object.entries(pageCounts)
    .map(([page, count]) => ({
      page,
      count,
      avgDwell: pageDwell[page]?.length ? Math.round(pageDwell[page].reduce((a, b) => a + b, 0) / pageDwell[page].length / 1000) : null
    }))
    .sort((a, b) => b.count - a.count);
  const maxPageCount = pagePopularity.length ? pagePopularity[0].count : 1;

  // ‚îÄ‚îÄ 2. Drop-off (last page per session) ‚îÄ‚îÄ
  const sessionPages = {};
  rows.forEach(r => {
    if (!sessionPages[r.sessionId]) sessionPages[r.sessionId] = [];
    sessionPages[r.sessionId].push(r);
  });
  const dropOffs = {};
  Object.values(sessionPages).forEach(pages => {
    pages.sort((a, b) => b.ts - a.ts);
    let last = pages[0].page;
    last = last.startsWith('Person Detail:') ? 'Person Detail' : last.startsWith('Call Sheets:') ? 'Call Sheets' : last;
    dropOffs[last] = (dropOffs[last] || 0) + 1;
  });
  const dropOffArr = Object.entries(dropOffs).sort((a, b) => b[1] - a[1]);
  const totalSessions = Object.keys(sessionPages).length;

  // ‚îÄ‚îÄ 3. Session Depth ‚îÄ‚îÄ
  const sessionDepths = Object.values(sessionPages).map(p => p.length);
  const avgDepth = sessionDepths.length ? (sessionDepths.reduce((a, b) => a + b, 0) / sessionDepths.length).toFixed(1) : 0;
  const maxDepth = Math.max(...sessionDepths, 0);

  // ‚îÄ‚îÄ 4. Per-User Engagement ‚îÄ‚îÄ
  const userStats = {};
  rows.forEach(r => {
    if (!userStats[r.email]) userStats[r.email] = { views: 0, sessions: new Set(), pages: new Set() };
    userStats[r.email].views++;
    userStats[r.email].sessions.add(r.sessionId);
    const p = r.page.startsWith('Person Detail:') ? 'Person Detail' : r.page.startsWith('Call Sheets:') ? 'Call Sheets' : r.page;
    userStats[r.email].pages.add(p);
  });
  const userArr = Object.entries(userStats).map(([email, s]) => ({
    email,
    views: s.views,
    sessions: s.sessions.size,
    uniquePages: s.pages.size
  })).sort((a, b) => b.views - a.views);

  // ‚îÄ‚îÄ 5. Time Patterns (hour of day) ‚îÄ‚îÄ
  const hourCounts = new Array(24).fill(0);
  const dayCounts = new Array(7).fill(0);
  rows.forEach(r => {
    hourCounts[r.ts.getHours()]++;
    dayCounts[r.ts.getDay()]++;
  });
  const maxHour = Math.max(...hourCounts, 1);
  const maxDay = Math.max(...dayCounts, 1);
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  function fmtDwell(sec) {
    if (sec === null) return '‚Äì';
    if (sec < 60) return sec + 's';
    return Math.floor(sec / 60) + 'm ' + (sec % 60) + 's';
  }

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
  document.getElementById('app').innerHTML = `
    <div style="max-width:1100px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">üìà Engagement Report</div>
          <div style="font-size:12px;color:var(--muted);">Page views, drop-offs & user activity ¬∑ last ${_engDays} days ¬∑ ${rows.length} views tracked</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          ${[7, 14, 30].map(d =>
            `<button class="topbar-btn${_engDays === d ? ' active' : ''}" onclick="setEngDays(${d})" style="font-size:11px;padding:5px 10px;${_engDays === d ? 'background:var(--accent);color:#fff;' : ''}">${d}d</button>`
          ).join('')}
          <button class="topbar-btn manage" onclick="showEngagement()">‚Üª Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Page Views</div>
          <div style="font-size:22px;font-weight:800;">${rows.length}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Sessions</div>
          <div style="font-size:22px;font-weight:800;">${totalSessions}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Unique Users</div>
          <div style="font-size:22px;font-weight:800;">${userArr.length}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Avg Depth</div>
          <div style="font-size:22px;font-weight:800;">${avgDepth}</div>
          <div style="font-size:10px;color:var(--muted);">pages/session</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Deepest Session</div>
          <div style="font-size:22px;font-weight:800;">${maxDepth}</div>
          <div style="font-size:10px;color:var(--muted);">pages</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
        <!-- Page Popularity -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;grid-column:${pagePopularity.length > 6 ? '1 / -1' : '1'};">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">üî• Page Popularity</div>
          ${pagePopularity.map(p => `
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
              <div style="width:130px;font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0;" title="${p.page}">${p.page}</div>
              <div style="flex:1;height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
                <div style="width:${Math.round(p.count / maxPageCount * 100)}%;height:100%;background:linear-gradient(90deg,#3b82f6,#8b5cf6);border-radius:4px;"></div>
              </div>
              <div style="font-size:11px;font-weight:700;min-width:32px;text-align:right;">${p.count}</div>
              <div style="font-size:10px;color:var(--muted);min-width:40px;text-align:right;">${fmtDwell(p.avgDwell)}</div>
            </div>
          `).join('')}
          <div style="font-size:9px;color:var(--muted);margin-top:6px;text-align:right;">Right column = avg time on page</div>
        </div>

        <!-- Drop-off Points -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">üö™ Session Exit Points</div>
          <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">Where users leave the dashboard</div>
          ${dropOffArr.slice(0, 8).map(([page, count]) => {
            const pct = Math.round(count / totalSessions * 100);
            return `
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
              <div style="width:120px;font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0;">${page}</div>
              <div style="flex:1;height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
                <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#f97316,#dc2626);border-radius:4px;"></div>
              </div>
              <div style="font-size:11px;font-weight:700;min-width:32px;text-align:right;">${count}</div>
              <div style="font-size:10px;color:var(--muted);min-width:32px;text-align:right;">${pct}%</div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
        <!-- Hourly Pattern -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">üïê Activity by Hour</div>
          <div style="display:flex;align-items:flex-end;gap:2px;height:80px;">
            ${hourCounts.map((c, h) => {
              const pct = Math.round(c / maxHour * 100);
              const isWork = h >= 8 && h <= 18;
              return `<div title="${h > 12 ? (h-12) : h}${h >= 12 ? 'pm' : 'am'}: ${c} views" style="flex:1;height:${Math.max(pct, 2)}%;background:${isWork ? '#3b82f6' : '#cbd5e1'};border-radius:2px 2px 0 0;transition:all .15s;"></div>`;
            }).join('')}
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:9px;color:var(--muted);">
            <span>12a</span><span>6a</span><span>12p</span><span>6p</span><span>11p</span>
          </div>
        </div>

        <!-- Daily Pattern -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">üìÖ Activity by Day</div>
          ${dayNames.map((name, i) => {
            const pct = Math.round(dayCounts[i] / maxDay * 100);
            return `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <div style="width:32px;font-size:11px;font-weight:600;">${name}</div>
              <div style="flex:1;height:10px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
                <div style="width:${pct}%;height:100%;background:${i === 0 || i === 6 ? '#f97316' : '#3b82f6'};border-radius:4px;"></div>
              </div>
              <div style="font-size:11px;font-weight:700;min-width:32px;text-align:right;">${dayCounts[i]}</div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- User Engagement Table -->
      <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px;">üë§ Per-User Engagement</div>
        <div style="overflow-x:auto;">
        <table style="width:100%;font-size:12px;">
          <thead><tr style="background:rgba(0,0,0,.02);">
            <th style="text-align:left;padding:8px 12px;">User</th>
            <th>Page Views</th>
            <th>Sessions</th>
            <th>Unique Pages</th>
            <th>Views/Session</th>
          </tr></thead>
          <tbody>
            ${userArr.map(u => {
              const vps = u.sessions > 0 ? (u.views / u.sessions).toFixed(1) : '0';
              const maxViews = userArr[0]?.views || 1;
              const barPct = Math.round(u.views / maxViews * 100);
              return `<tr>
                <td style="padding:6px 12px;font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="${u.email}">${u.email}</td>
                <td style="text-align:center;">
                  <div style="display:flex;align-items:center;gap:6px;justify-content:center;">
                    <div style="width:50px;height:5px;background:#f1f5f9;border-radius:3px;overflow:hidden;">
                      <div style="width:${barPct}%;height:100%;background:#3b82f6;border-radius:3px;"></div>
                    </div>
                    <span style="font-weight:700;">${u.views}</span>
                  </div>
                </td>
                <td style="text-align:center;">${u.sessions}</td>
                <td style="text-align:center;">${u.uniquePages}</td>
                <td style="text-align:center;font-weight:700;">${vps}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
        </div>
      </div>

      <div style="margin-top:12px;font-size:10px;color:var(--muted);line-height:1.6;">
        <strong>How to read:</strong> Page Views = total navigations. Sessions = distinct login sessions. Depth = pages visited per session. Exit Points = last page viewed before leaving. Avg time = average seconds spent on that page before navigating away. Tracking began when this feature was deployed.
      </div>
    </div>`;
}

window.showEngagement = showEngagement;
window.setEngDays = setEngDays;
window.showAutoNews = showAutoNews;
window.toggleNewsGroup = toggleNewsGroup;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COMPETITIVE ANALYSIS (Admin)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _compData = null;
let _compFilter = 'all';
let _compExpanded = new Set();

async function showCompetitiveAnalysis() {
  if (!isAdmin()) return;
  logPageView('Competitive Analysis');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1300px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üèÜ Competitive Analysis</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Live pricing from CarGurus ‚Äî SA CDJR vs. 7 area competitors</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    let result = null;
    // ‚îÄ‚îÄ Firestore first ‚îÄ‚îÄ
    try {
      const snapDoc = await getDoc(doc(db, 'dashboardSnapshots', 'comp_analysis'));
      if (snapDoc.exists()) {
        const raw = snapDoc.data();
        result = JSON.parse(raw.jsonData);
        result.ok = true;
        const updatedAt = raw.updatedAt?.toDate?.() || new Date(raw.updatedAt);
        console.log(`[Firestore] Comp analysis loaded (age: ${Math.round((Date.now() - updatedAt.getTime())/60000)}min)`);
      }
    } catch (fsErr) {
      console.warn('[Firestore] Comp analysis read failed:', fsErr.message);
    }
    // ‚îÄ‚îÄ GAS fallback ‚îÄ‚îÄ
    if (!result) {
      const url = `${SCRIPT_URL}?route=comp_analysis&session=${encodeURIComponent(window.sessionToken || '')}`;
      const resp = await fetch(url);
      const raw = await resp.text();
      try { result = JSON.parse(raw); } catch { throw new Error('Non-JSON response from backend'); }
    }
    if (!result.ok) throw new Error(result.error || 'Backend error');
    _compData = result;
    _compFilter = 'all';
    _compExpanded = new Set();
    renderCompAnalysis();
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading Competitive Analysis</h2>
          <p>${err.message}</p>
          <p style="color:var(--muted);font-size:13px;margin-top:8px;">Make sure the <code>comp_analysis</code> route is added to your Apps Script backend and the <strong>CompAnalysis</strong> sheet tab exists.</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">‚Üê Back</button>
        </div>
      </div>`;
  }
}

function setCompFilter(make) { _compFilter = make; _compModelFilter = 'all'; _compStoreFilter = 'all'; renderCompAnalysis(); }
function setCompModelFilter(model) { _compModelFilter = model; renderCompAnalysis(); }
function toggleCompGroup(key) {
  if (_compExpanded.has(key)) _compExpanded.delete(key); else _compExpanded.add(key);
  renderCompAnalysis();
}
function compExpandAll() { _compExpanded = new Set(_compGroupKeys || []); renderCompAnalysis(); }
function compCollapseAll() { _compExpanded = new Set(); renderCompAnalysis(); }

let _compGroupKeys = [];
let _compModelFilter = 'all';
let _compStoreFilter = 'all';
let _compSortCol = 'salePrice'; // default sort
let _compSortDir = 'asc';
function compSort(col) {
  if (_compSortCol === col) _compSortDir = _compSortDir === 'asc' ? 'desc' : 'asc';
  else { _compSortCol = col; _compSortDir = 'asc'; }
  renderCompAnalysis();
}
function setCompStoreFilter(store) { _compStoreFilter = store; renderCompAnalysis(); }

function renderCompAnalysis() {
  if (!_compData) return;
  const { competitors, ourPricing, lastUpdated } = _compData;

  // ‚îÄ‚îÄ Dealer color map ‚îÄ‚îÄ
  const STORE_COLORS = {
    'SA CDJR':         '#2563eb',
    'Ancira CJD':      '#dc2626',
    'Bluebonnet CDR':  '#7c3aed',
    'Bluebonnet Jeep': '#9333ea',
    'Boerne DCJR':     '#ea580c',
    'Steele North Star':'#0d9488',
    "Benson's IPAC":   '#b45309',
    'Gunn CDJR':       '#4f46e5'
  };
  const STORE_SHORT = {
    'SA CDJR':         'SA CDJR',
    'Ancira CJD':      'Ancira',
    'Bluebonnet CDR':  'BB CDR',
    'Bluebonnet Jeep': 'BB Jeep',
    'Boerne DCJR':     'Boerne',
    'Steele North Star':'Steele NS',
    "Benson's IPAC":   "Benson's",
    'Gunn CDJR':       'Gunn'
  };

  // ‚îÄ‚îÄ Merge ALL vehicles into one unified list with a store label ‚îÄ‚îÄ
  const allVehicles = [];
  competitors.forEach(v => {
    const storeName = v.dealer || 'Unknown';
    allVehicles.push({ ...v, store: storeName, storeColor: STORE_COLORS[storeName] || '#6b7280' });
  });
  ourPricing.forEach(v => allVehicles.push({ ...v, store: 'SA CDJR', storeColor: '#2563eb' }));

  // ‚îÄ‚îÄ Collect all makes and models for filtering ‚îÄ‚îÄ
  const makeModelMap = {};
  allVehicles.forEach(v => {
    if (!makeModelMap[v.make]) makeModelMap[v.make] = new Set();
    makeModelMap[v.make].add(v.model);
  });
  const allMakes = Object.keys(makeModelMap).sort();

  // ‚îÄ‚îÄ Apply make + model + store filters ‚îÄ‚îÄ
  const filtered = allVehicles.filter(v => {
    if (_compFilter !== 'all' && v.make.toLowerCase() !== _compFilter.toLowerCase()) return false;
    if (_compModelFilter !== 'all' && v.model.toLowerCase() !== _compModelFilter.toLowerCase()) return false;
    if (_compStoreFilter !== 'all' && v.store !== _compStoreFilter) return false;
    return true;
  });

  // ‚îÄ‚îÄ Collect all stores ‚îÄ‚îÄ
  const allStores = [...new Set(allVehicles.map(v => v.store))].sort((a, b) => a === 'SA CDJR' ? -1 : b === 'SA CDJR' ? 1 : a.localeCompare(b));

  // ‚îÄ‚îÄ Group by Make > Model > Trim ‚îÄ‚îÄ
  const trimGroups = {};
  filtered.forEach(v => {
    const gKey = `${v.make} ${v.model} ‚Äì ${v.trim || 'Base'}`;
    if (!trimGroups[gKey]) trimGroups[gKey] = { make: v.make, model: v.model, trim: v.trim || 'Base', items: [] };
    trimGroups[gKey].items.push(v);
  });

  // Sort each group's items by selected column
  const getSortVal = (v) => {
    if (_compSortCol === 'msrp') return v.msrp || 0;
    if (_compSortCol === 'salePrice') return v.salePrice || 0;
    if (_compSortCol === 'discount') return (v.msrp && v.salePrice) ? v.msrp - v.salePrice : 0;
    if (_compSortCol === 'pctMsrp') return (v.msrp && v.salePrice) ? v.salePrice / v.msrp : 2;
    return v.salePrice || 0;
  };
  Object.values(trimGroups).forEach(g => {
    g.items.sort((a, b) => {
      const va = getSortVal(a), vb = getSortVal(b);
      return _compSortDir === 'asc' ? va - vb : vb - va;
    });
  });

  // Sort group keys alphabetically
  const sortedKeys = Object.keys(trimGroups).sort();
  _compGroupKeys = sortedKeys;

  // All groups start collapsed (user clicks to expand)

  // ‚îÄ‚îÄ Summary stats ‚îÄ‚îÄ
  let totalOurs = filtered.filter(v => v.store === 'SA CDJR').length;
  let totalComp = filtered.filter(v => v.store !== 'SA CDJR').length;

  // Compare: for each trim group that has SA CDJR + competitor, count wins
  let totalWeBeat = 0, totalTheyBeat = 0, totalNoCompare = 0;
  Object.values(trimGroups).forEach(g => {
    const compItems = g.items.filter(v => v.store !== 'SA CDJR');
    const ourItems = g.items.filter(v => v.store === 'SA CDJR');
    if (compItems.length > 0 && ourItems.length > 0) {
      const bestComp = Math.min(...compItems.filter(v => v.salePrice > 0).map(v => v.salePrice));
      const bestOurs = Math.min(...ourItems.filter(v => v.salePrice > 0).map(v => v.salePrice));
      if (bestOurs < Infinity && bestComp < Infinity) {
        if (bestOurs <= bestComp) totalWeBeat++;
        else totalTheyBeat++;
      } else { totalNoCompare++; }
    } else { totalNoCompare++; }
  });

  // Format helpers
  const fmt = (n) => n ? '$' + n.toLocaleString('en-US') : '‚Äì';
  const fmtDelta = (d) => {
    if (!d) return '‚Äì';
    const abs = Math.abs(d);
    const str = '$' + abs.toLocaleString('en-US');
    return d > 0 ? '+' + str : '-' + str;
  };

  // ‚îÄ‚îÄ Build accordion HTML ‚îÄ‚îÄ
  let accHTML = '';
  sortedKeys.forEach(gKey => {
    const g = trimGroups[gKey];
    const open = _compExpanded.has(gKey);
    const count = g.items.length;

    // Best prices per store for the header
    const ourPricesArr = g.items.filter(v => v.store === 'SA CDJR' && v.salePrice > 0).map(v => v.salePrice);
    const compPricesArr = g.items.filter(v => v.store !== 'SA CDJR' && v.salePrice > 0);
    const bestOur = ourPricesArr.length > 0 ? Math.min(...ourPricesArr) : null;

    // Find best competitor and their name
    let bestCompPrice = null, bestCompStore = '';
    compPricesArr.forEach(v => {
      if (!bestCompPrice || v.salePrice < bestCompPrice) { bestCompPrice = v.salePrice; bestCompStore = STORE_SHORT[v.store] || v.store; }
    });

    // Winner badge
    let winBadge = '';
    if (bestCompPrice && bestOur) {
      if (bestOur < bestCompPrice) winBadge = '<span style="color:#16a34a;font-weight:700;font-size:11px;">‚úì Us</span>';
      else if (bestCompPrice < bestOur) winBadge = `<span style="color:#dc2626;font-weight:700;font-size:11px;">‚úó ${bestCompStore}</span>`;
      else winBadge = '<span style="color:#ca8a04;font-weight:700;font-size:11px;">= Even</span>';
    }

    accHTML += `
      <div style="margin-bottom:6px;border:1px solid var(--line);border-radius:10px;overflow:hidden;">
        <div onclick="toggleCompGroup('${gKey.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);cursor:pointer;user-select:none;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:13px;">${open ? '‚ñº' : '‚ñ∂'}</span>
            <div>
              <span style="font-weight:700;font-size:13px;">${g.make} ${g.model}</span>
              <span style="margin-left:6px;font-weight:400;font-size:12px;color:var(--muted);">‚Äî ${g.trim}</span>
              <span style="margin-left:8px;font-size:10px;color:var(--muted);">(${count})</span>
            </div>
          </div>
          <div style="display:flex;gap:14px;font-size:12px;align-items:center;">
            ${bestCompPrice ? `<span style="color:#dc2626;">Best Comp: <strong>${fmt(bestCompPrice)}</strong> <span style="font-size:10px;color:var(--muted);">(${bestCompStore})</span></span>` : ''}
            ${bestOur ? `<span style="color:#2563eb;">Us: <strong>${fmt(bestOur)}</strong></span>` : ''}
            ${winBadge}
          </div>
        </div>`;

    if (open) {
      accHTML += `<div style="padding:0;overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Store</th>
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Year</th>
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Details</th>
              <th onclick="compSort('msrp')" style="padding:8px 12px;text-align:right;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">MSRP ${_compSortCol === 'msrp' ? (_compSortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '<span style="color:#ccc;">‚áÖ</span>'}</th>
              <th onclick="compSort('salePrice')" style="padding:8px 12px;text-align:right;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">Sale Price ${_compSortCol === 'salePrice' ? (_compSortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '<span style="color:#ccc;">‚áÖ</span>'}</th>
              <th onclick="compSort('discount')" style="padding:8px 12px;text-align:right;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">Discount ${_compSortCol === 'discount' ? (_compSortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '<span style="color:#ccc;">‚áÖ</span>'}</th>
              <th onclick="compSort('pctMsrp')" style="padding:8px 12px;text-align:center;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">% MSRP ${_compSortCol === 'pctMsrp' ? (_compSortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '<span style="color:#ccc;">‚áÖ</span>'}</th>
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Stock / VIN</th>
            </tr>
          </thead>
          <tbody>`;

      g.items.forEach((v, idx) => {
        const discount = (v.msrp && v.salePrice) ? v.msrp - v.salePrice : 0;
        const details = [v.color, v.drivetrain].filter(Boolean).join(' ¬∑ ') || '‚Äì';

        // Store badge
        const isUs = v.store === 'SA CDJR';
        const shortName = STORE_SHORT[v.store] || v.store;
        const storeBadge = `<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;color:#fff;background:${v.storeColor || '#6b7280'};white-space:nowrap;">${shortName}</span>`;

        // % of MSRP
        const pctMsrp = (v.msrp > 0 && v.salePrice > 0) ? ((v.salePrice / v.msrp) * 100) : 0;
        let pctColor = 'var(--muted)';
        let pctLabel = '‚Äì';
        if (pctMsrp > 0) {
          pctLabel = pctMsrp.toFixed(1) + '%';
          if (pctMsrp <= 80) pctColor = '#16a34a';
          else if (pctMsrp <= 87) pctColor = '#059669';
          else if (pctMsrp <= 92) pctColor = '#ca8a04';
          else pctColor = '#dc2626';
        }

        // Hyperlinked price
        const priceHTML = v.salePrice > 0
          ? (v.url ? `<a href="${v.url}" target="_blank" rel="noopener" style="color:${v.storeColor};font-weight:700;text-decoration:underline;text-underline-offset:2px;" title="Search VIN on Google">${fmt(v.salePrice)}</a>` : `<span style="font-weight:700;color:${v.storeColor};">${fmt(v.salePrice)}</span>`)
          : '‚Äì';

        // Stock/VIN
        const stockVin = [];
        if (v.stock) stockVin.push('#' + v.stock);
        const vinShort = v.vin ? v.vin.slice(-6) : '';
        if (vinShort) stockVin.push(vinShort);

        // Lowest price highlight
        const isLowest = idx === 0 && v.salePrice > 0;
        const rowBg = isLowest ? (isUs ? 'background:#eff6ff;' : 'background:#fef2f2;') : '';

        accHTML += `
            <tr style="border-bottom:1px solid var(--line);${rowBg}">
              <td style="padding:8px 12px;">${storeBadge}</td>
              <td style="padding:8px 12px;">${v.year}</td>
              <td style="padding:8px 12px;color:var(--muted);font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${details}">${details}</td>
              <td style="padding:8px 12px;text-align:right;">${v.msrp > 0 ? fmt(v.msrp) : '‚Äì'}</td>
              <td style="padding:8px 12px;text-align:right;">${priceHTML}</td>
              <td style="padding:8px 12px;text-align:right;color:#16a34a;font-weight:600;">${discount > 0 ? fmt(discount) : '‚Äì'}</td>
              <td style="padding:8px 12px;text-align:center;font-weight:600;color:${pctColor};">${pctLabel}</td>
              <td style="padding:8px 12px;font-size:11px;color:var(--muted);white-space:nowrap;" title="${v.vin || ''}">${stockVin.join(' ¬∑ ') || '‚Äì'}</td>
            </tr>`;
      });

      accHTML += `</tbody></table></div>`;
    }
    accHTML += `</div>`;
  });

  if (sortedKeys.length === 0) {
    accHTML = `<div class="detail-card" style="text-align:center;padding:40px;color:var(--muted);">
      No data found${_compFilter !== 'all' ? ' for ' + _compFilter : ''}${_compModelFilter !== 'all' ? ' ' + _compModelFilter : ''}. Make sure <code>refreshCompetitorPricing_()</code> has been run.
    </div>`;
  }

  // ‚îÄ‚îÄ Styles ‚îÄ‚îÄ
  const tabStyle = (f, active) => `padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid ${active ? 'var(--accent)' : 'var(--line)'};background:${active ? 'var(--accent)' : 'var(--card)'};color:${active ? '#fff' : 'var(--text)'};`;
  const modelTabStyle = (f, active) => `padding:4px 12px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid ${active ? '#7c3aed' : 'var(--line)'};background:${active ? '#7c3aed' : 'var(--card)'};color:${active ? '#fff' : 'var(--text)'};`;

  // Models for the selected make
  const modelsForMake = _compFilter !== 'all' && makeModelMap[_compFilter]
    ? [...makeModelMap[_compFilter]].sort()
    : [];

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px 12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">üèÜ Competitive Analysis</div>
          <div style="font-size:12px;color:var(--muted);">
            Competitor pricing across <strong>7 SA-area dealers</strong>
            ${lastUpdated ? ` ¬∑ Updated <strong>${lastUpdated}</strong>` : ''}
            ¬∑ <span style="font-size:11px;">Click any <u>underlined price</u> to search VIN on Google</span>
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <button class="topbar-btn" onclick="compExpandAll()" style="font-size:11px;padding:5px 10px;">Expand All</button>
          <button class="topbar-btn" onclick="compCollapseAll()" style="font-size:11px;padding:5px 10px;">Collapse All</button>
          <button class="topbar-btn manage" onclick="showCompetitiveAnalysis()">‚Üª Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:14px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#2563eb;font-weight:600;">Our Listings</div>
          <div style="font-size:22px;font-weight:800;">${totalOurs}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#dc2626;font-weight:600;">Competitor Listings</div>
          <div style="font-size:22px;font-weight:800;">${totalComp}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Trim Matchups</div>
          <div style="font-size:22px;font-weight:800;">${sortedKeys.length}</div>
        </div>
        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#16a34a;font-weight:600;">We're Lowest</div>
          <div style="font-size:22px;font-weight:800;color:#16a34a;">${totalWeBeat}</div>
        </div>
        <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#dc2626;font-weight:600;">Competitor Lowest</div>
          <div style="font-size:22px;font-weight:800;color:#dc2626;">${totalTheyBeat}</div>
        </div>
      </div>

      <!-- Make filter tabs -->
      <div style="display:flex;gap:6px;margin-bottom:${modelsForMake.length > 0 ? '8' : '14'}px;flex-wrap:wrap;">
        <button onclick="setCompFilter('all')" style="${tabStyle('all', _compFilter === 'all')}">All Makes</button>
        ${allMakes.map(m => `<button onclick="setCompFilter('${m}')" style="${tabStyle(m, _compFilter === m)}">${m}</button>`).join('')}
      </div>

      <!-- Model sub-filter tabs (only shown when a make is selected) -->
      ${modelsForMake.length > 0 ? `
      <div style="display:flex;gap:5px;margin-bottom:14px;flex-wrap:wrap;padding-left:4px;">
        <span style="font-size:11px;color:var(--muted);align-self:center;margin-right:4px;">Model:</span>
        <button onclick="setCompModelFilter('all')" style="${modelTabStyle('all', _compModelFilter === 'all')}">All ${_compFilter}</button>
        ${modelsForMake.map(m => `<button onclick="setCompModelFilter('${m}')" style="${modelTabStyle(m, _compModelFilter === m)}">${m}</button>`).join('')}
      </div>` : ''}

      <!-- Store filter tabs -->
      <div style="display:flex;gap:5px;margin-bottom:14px;flex-wrap:wrap;padding-left:4px;">
        <span style="font-size:11px;color:var(--muted);align-self:center;margin-right:4px;">Store:</span>
        <button onclick="setCompStoreFilter('all')" style="${modelTabStyle('all', _compStoreFilter === 'all')}">All Stores</button>
        ${allStores.map(s => {
          const sc = STORE_COLORS[s] || '#6b7280';
          const active = _compStoreFilter === s;
          return `<button onclick="setCompStoreFilter('${s.replace(/'/g, "\\'")}')" style="padding:4px 12px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid ${active ? sc : 'var(--line)'};background:${active ? sc : 'var(--card)'};color:${active ? '#fff' : 'var(--text)'};">${STORE_SHORT[s] || s}</button>`;
        }).join('')}
      </div>

      <!-- Trim-level Accordions -->
      ${accHTML}

      <div style="margin-top:14px;padding:14px;background:var(--card);border:1px solid var(--line);border-radius:10px;font-size:11px;color:var(--muted);line-height:1.7;">
        <strong>üì° Live data from CarGurus</strong> ‚Äî Both dealerships' pricing scraped automatically.<br>
        ‚Ä¢ Each dropdown = one <strong>trim level</strong>. Rows are sorted by price <strong>lowest ‚Üí highest</strong> across both stores.<br>
        ‚Ä¢ <span style="background:#2563eb;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">SA CDJR</span> = Us ¬∑ Competitors: <span style="background:#dc2626;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">Ancira</span> <span style="background:#7c3aed;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">BB CDR</span> <span style="background:#9333ea;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">BB Jeep</span> <span style="background:#ea580c;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">Boerne</span> <span style="background:#0d9488;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">Steele NS</span> <span style="background:#b45309;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">Benson's</span> <span style="background:#4f46e5;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">Gunn</span> ¬∑ The lowest-priced row is highlighted.<br>
        ‚Ä¢ <u style="color:#dc2626;">Underlined prices</u> are clickable ‚Äî searches the VIN on Google to find the vehicle across dealer sites &amp; marketplaces<br>
        ‚Ä¢ <strong>% MSRP</strong> = Sale Price √∑ MSRP. Lower is better: <span style="color:#16a34a;font-weight:700;">‚â§80%</span> great ¬∑ <span style="color:#059669;font-weight:700;">‚â§87%</span> good ¬∑ <span style="color:#ca8a04;font-weight:700;">‚â§92%</span> fair ¬∑ <span style="color:#dc2626;font-weight:700;">&gt;92%</span> low discount<br>
        ‚Ä¢ Click <strong>MSRP</strong>, <strong>Sale Price</strong>, <strong>Discount</strong>, or <strong>% MSRP</strong> column headers to sort ‚ñ≤‚ñº<br>
        ‚Ä¢ Data: <a href="https://www.cargurus.com/Cars/m-Ancira-Chrysler-Dodge-Jeep-RAM-sp243011" target="_blank" style="color:var(--accent);">Ancira</a> ¬∑ <a href="https://www.cargurus.com/Cars/m-San-Antonio-Dodge-Chrysler-Jeep-Ram-sp302392" target="_blank" style="color:var(--accent);">SA CDJR</a> ¬∑ <a href="https://www.cargurus.com/Cars/m-Bluebonnet-Chrysler-Dodge-Ram-sp63224" target="_blank" style="color:var(--accent);">BB CDR</a> ¬∑ <a href="https://www.cargurus.com/Cars/m-Bluebonnet-Jeep-sp278262" target="_blank" style="color:var(--accent);">BB Jeep</a> ¬∑ <a href="https://www.cargurus.com/Cars/m-Boerne-Dodge-Chrysler-Jeep-Ram-sp63219" target="_blank" style="color:var(--accent);">Boerne</a> ¬∑ <a href="https://www.cargurus.com/Cars/m-Steele-North-Star-Chrysler-Dodge-Jeep-Ram-sp315995" target="_blank" style="color:var(--accent);">Steele NS</a> ¬∑ <a href="https://www.cargurus.com/Cars/m-Bensons-Ingram-Park-Chrysler-Dodge-Jeep-Ram-sp63252" target="_blank" style="color:var(--accent);">Benson's</a> ¬∑ <a href="https://www.cargurus.com/Cars/m-Gunn-Chrysler-Dodge-Jeep-Ram-sp63225" target="_blank" style="color:var(--accent);">Gunn</a><br>
        ‚Ä¢ Filtered to: New CDJR vehicles only (2025+ model year, under 1,000 miles)<br>
        ‚Ä¢ To auto-refresh: Set a daily trigger on <code>refreshCompetitorPricing_()</code> in Apps Script
      </div>
    </div>`;
}

window.showCompetitiveAnalysis = showCompetitiveAnalysis;
window.setCompFilter = setCompFilter;
window.setCompModelFilter = setCompModelFilter;
window.toggleCompGroup = toggleCompGroup;
window.setCompStoreFilter = setCompStoreFilter;
window.compSort = compSort;
window.compExpandAll = compExpandAll;
window.compCollapseAll = compCollapseAll;
window.toggleAllNewsGroups = toggleAllNewsGroups;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üìã ROSTER PAGE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _rosterViewMode = 'all'; // 'all' or 'teams'

async function showRoster() {
  trackClick();
  logPageView('Roster');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:900px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üìã Roster</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Team directory with phone numbers</p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="topbar-btn manage" id="rosterToggleBtn" onclick="toggleRosterView()" style="font-size:12px;padding:6px 14px;">üë• View by Teams</button>
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Back</button>
        </div>
      </div>
      <div id="rosterContent"><div class="loading-wrap"><div class="spinner"></div></div></div>
    </div>`;

  try {
    const usersSnapshot = await getDocs(collection(db, 'users'));
    const users = [];
    window._rosterUsers = []; // cache for toggling views
    usersSnapshot.forEach((docu) => {
      const u = docu.data();
      if (u.deleted) return;
      users.push({
        uid: docu.id,
        displayName: u.displayName || '',
        email: u.email || '',
        phone: u.phone || '',
        role: u.role || 'user',
        linkedName: u.linkedName || '',
        managerId: u.managerId || ''
      });
    });

    // Sort alphabetically by display name, then email
    users.sort((a, b) => {
      const nameA = (a.displayName || a.email).toLowerCase();
      const nameB = (b.displayName || b.email).toLowerCase();
      return nameA.localeCompare(nameB);
    });

    window._rosterUsers = users;

    if (users.length === 0) {
      document.getElementById('rosterContent').innerHTML = '<p style="color:var(--muted);">No users found.</p>';
      return;
    }

    renderRosterView();
  } catch (e) {
    document.getElementById('rosterContent').innerHTML = `<p style="color:#dc2626;">Error loading roster: ${e.message}</p>`;
  }
}

function toggleRosterView() {
  _rosterViewMode = _rosterViewMode === 'all' ? 'teams' : 'all';
  const btn = document.getElementById('rosterToggleBtn');
  if (btn) btn.textContent = _rosterViewMode === 'all' ? 'üë• View by Teams' : 'üìã View All';
  renderRosterView();
}
window.toggleRosterView = toggleRosterView;

function renderRosterCard(u) {
  const name = u.displayName || u.email;
  const roleBadge = u.role === 'superadmin' ? ' üëë' : '';
  const roleColor = u.role === 'admin' || u.role === 'superadmin' ? '#dc2626' : u.role === 'manager' ? '#2563eb' : '#78716c';
  return `
    <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
      <div style="min-width:0;">
        <div style="font-weight:700;font-size:15px;">${name}${roleBadge}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px;">
          <span style="color:${roleColor};font-weight:600;text-transform:uppercase;font-size:11px;">${u.role}</span>
          ${u.linkedName ? ` ¬∑ ${u.linkedName}` : ''}
          ${u.email && u.displayName ? ` ¬∑ ${u.email}` : ''}
        </div>
      </div>
      <div style="font-size:15px;font-weight:600;white-space:nowrap;">
        ${u.phone ? `<a href="tel:${u.phone.replace(/[^+0-9]/g, '')}" style="color:var(--accent);text-decoration:none;">üìû ${u.phone}</a>` : '<span style="color:var(--muted);font-size:12px;font-weight:400;">No phone</span>'}
      </div>
    </div>`;
}

function renderRosterView() {
  const users = window._rosterUsers || [];
  const container = document.getElementById('rosterContent');
  if (!container) return;

  if (_rosterViewMode === 'all') {
    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    users.forEach(u => { html += renderRosterCard(u); });
    html += '</div>';
    container.innerHTML = html;
    return;
  }

  // Team view ‚Äî group by assigned manager
  const teams = {}; // managerId -> { manager, members }
  const unassigned = [];
  const managerMap = {};
  users.forEach(u => { managerMap[u.uid] = u; });

  users.forEach(u => {
    if (u.role === 'manager' || u.role === 'admin' || u.role === 'superadmin') return; // managers shown as headers
    if (u.managerId && managerMap[u.managerId]) {
      if (!teams[u.managerId]) teams[u.managerId] = { manager: managerMap[u.managerId], members: [] };
      teams[u.managerId].members.push(u);
    } else {
      unassigned.push(u);
    }
  });

  let html = '';

  // Sort teams by manager name
  const sortedTeams = Object.values(teams).sort((a, b) => {
    const nameA = (a.manager.displayName || a.manager.email).toLowerCase();
    const nameB = (b.manager.displayName || b.manager.email).toLowerCase();
    return nameA.localeCompare(nameB);
  });

  sortedTeams.forEach(team => {
    const mgrName = team.manager.displayName || team.manager.email;
    const memberCount = team.members.length;
    html += `
      <div style="margin-bottom:20px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:10px 14px;background:linear-gradient(135deg,#1e293b,#334155);border-radius:10px;color:#fff;">
          <span style="font-size:18px;">üëî</span>
          <div>
            <div style="font-weight:700;font-size:15px;">${mgrName}'s Team</div>
            <div style="font-size:11px;color:#94a3b8;">${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
          </div>
          ${(isAdmin() || isManager()) ? `<button class="topbar-btn manage" style="margin-left:auto;font-size:11px;padding:4px 12px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);" onclick="showTeamDashboard('${team.manager.uid}')">üìä Team Dashboard</button>` : ''}
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;padding-left:12px;border-left:3px solid var(--line);">
          ${team.members.map(m => renderRosterCard(m)).join('')}
        </div>
      </div>`;
  });

  // Show managers/admins who have no team members assigned to them
  const managersWithoutTeams = users.filter(u =>
    (u.role === 'manager' || u.role === 'admin' || u.role === 'superadmin') && !teams[u.uid]
  );
  if (managersWithoutTeams.length > 0) {
    html += `
      <div style="margin-bottom:20px;">
        <div style="font-weight:700;font-size:14px;color:var(--muted);margin-bottom:8px;padding:6px 0;">Managers / Admins</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          ${managersWithoutTeams.map(u => renderRosterCard(u)).join('')}
        </div>
      </div>`;
  }

  if (unassigned.length > 0) {
    html += `
      <div style="margin-bottom:20px;">
        <div style="font-weight:700;font-size:14px;color:var(--muted);margin-bottom:8px;padding:6px 0;">Unassigned</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          ${unassigned.map(u => renderRosterCard(u)).join('')}
        </div>
      </div>`;
  }

  if (!html) html = '<p style="color:var(--muted);">No teams found. Assign managers to users via User Management.</p>';
  container.innerHTML = html;
}

window.showRoster = showRoster;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üëî MANAGER TEAM DASHBOARD
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function showTeamDashboard(managerUid) {
  trackClick();
  logPageView('Team Dashboard');

  // If no uid passed, use current user's uid (for "My Team" shortcut)
  if (!managerUid) managerUid = auth.currentUser?.uid || '';

  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1100px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;" id="teamDashTitle">üëî Team Dashboard</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Team performance at a glance</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Back</button>
      </div>
      <div id="teamDashContent"><div class="loading-wrap"><div class="spinner"></div></div></div>
    </div>`;

  try {
    // Fetch all users to find team members
    const usersSnapshot = await getDocs(collection(db, 'users'));
    const allUsers = {};
    let managerData = null;
    usersSnapshot.forEach((docu) => {
      const u = docu.data();
      if (u.deleted) return;
      allUsers[docu.id] = { uid: docu.id, ...u };
      if (docu.id === managerUid) managerData = { uid: docu.id, ...u };
    });

    if (!managerData) {
      document.getElementById('teamDashContent').innerHTML = '<p style="color:#dc2626;">Manager not found.</p>';
      return;
    }

    const mgrName = managerData.displayName || managerData.email;
    document.getElementById('teamDashTitle').textContent = `üëî ${mgrName}'s Team`;

    // Find team members assigned to this manager
    const teamMembers = Object.values(allUsers).filter(u => u.managerId === managerUid);

    if (teamMembers.length === 0) {
      document.getElementById('teamDashContent').innerHTML = '<p style="color:var(--muted);">No team members assigned yet. Assign team members via User Management.</p>';
      return;
    }

    // Get dashboard leaderboard data
    const sales = dashboardData.sales || [];
    const bdc = dashboardData.bdc || [];
    const salesByUnits = [...sales].sort((a, b) => safeNum(b.sales) - safeNum(a.sales));
    const bdcByShown = [...bdc].sort((a, b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));

    // Build team summary cards
    let teamHtml = '';
    let totalUnits = 0, totalCalls = 0, totalTexts = 0, totalShown = 0, totalCreated = 0;
    let memberCards = [];

    teamMembers.sort((a, b) => (a.displayName || a.email).toLowerCase().localeCompare((b.displayName || b.email).toLowerCase()));

    teamMembers.forEach(member => {
      const memberName = (member.linkedName || '').trim().toUpperCase();
      const displayName = member.displayName || member.email;
      if (!memberName) {
        memberCards.push({ displayName, html: buildTeamMemberCardNoData(displayName) });
        return;
      }

      // Check Sales leaderboard
      const salesIdx = salesByUnits.findIndex(r => (r.name || '').toUpperCase() === memberName);
      // Check BDC leaderboard
      const bdcIdx = bdcByShown.findIndex(r => (r.name || '').toUpperCase() === memberName);

      if (salesIdx >= 0) {
        const r = salesByUnits[salesIdx];
        const rank = salesIdx + 1;
        const units = safeNum(r.sales);
        const calls = safeNum(r.calls);
        const texts = safeNum(r.texts);
        const shown = safeNum(shownVal(r));
        const created = safeNum(r.created ?? r.created_count ?? 0);
        const trend = trendingSales(units);
        totalUnits += units;
        totalCalls += calls;
        totalTexts += texts;
        totalShown += shown;
        totalCreated += created;

        const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '#' + rank;
        const callsK = kpiClass(calls, WEEKLY_TARGETS.calls);
        const textsK = kpiClass(texts, WEEKLY_TARGETS.texts);
        const shownK = kpiClass(shown, WEEKLY_TARGETS.shown);
        const createdK = kpiClass(created, WEEKLY_TARGETS.created);

        memberCards.push({ displayName, rank, html: `
          <div style="background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;cursor:pointer;" onclick="showPersonDetails('${(r.name || '').replace(/'/g, "\\'")}', 'Sales')">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
              <div style="font-weight:700;font-size:15px;">${displayName}</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <span style="background:#f0fdf4;color:#16a34a;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;">Sales</span>
                <span style="font-weight:800;color:var(--accent);font-size:14px;">${rankEmoji}</span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(70px,1fr));gap:8px;text-align:center;">
              <div><div style="font-size:20px;font-weight:800;">${units}</div><div style="font-size:10px;color:var(--muted);">Units</div></div>
              <div><div style="font-size:20px;font-weight:800;">${trend}</div><div style="font-size:10px;color:var(--muted);">Trending</div></div>
              <div class="${callsK}"><div style="font-size:16px;font-weight:700;">${calls}</div><div style="font-size:10px;color:var(--muted);">Calls</div></div>
              <div class="${textsK}"><div style="font-size:16px;font-weight:700;">${texts}</div><div style="font-size:10px;color:var(--muted);">Texts</div></div>
              <div class="${createdK}"><div style="font-size:16px;font-weight:700;">${created}</div><div style="font-size:10px;color:var(--muted);">Created</div></div>
              <div class="${shownK}"><div style="font-size:16px;font-weight:700;">${shown}</div><div style="font-size:10px;color:var(--muted);">Shown</div></div>
            </div>
          </div>` });
      } else if (bdcIdx >= 0) {
        const r = bdcByShown[bdcIdx];
        const rank = bdcIdx + 1;
        const shown = safeNum(shownVal(r));
        const calls = safeNum(r.calls);
        const texts = safeNum(r.texts);
        const created = safeNum(r.created ?? r.created_count ?? 0);
        const due = safeNum(r.due ?? r.due_count ?? 0);
        const pct = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : (created > 0 ? ((shown / created) * 100).toFixed(1) + '%' : '‚Äì');
        const trend = trendingSales(shown);
        totalCalls += calls;
        totalTexts += texts;
        totalShown += shown;
        totalCreated += created;

        const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '#' + rank;
        const callsK = kpiClass(calls, WEEKLY_TARGETS.calls);
        const textsK = kpiClass(texts, WEEKLY_TARGETS.texts);
        const shownK = kpiClass(shown, WEEKLY_TARGETS.shown);
        const createdK = kpiClass(created, WEEKLY_TARGETS.created);

        memberCards.push({ displayName, rank, html: `
          <div style="background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;cursor:pointer;" onclick="showPersonDetails('${(r.name || '').replace(/'/g, "\\'")}', 'BDC')">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
              <div style="font-weight:700;font-size:15px;">${displayName}</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <span style="background:#eff6ff;color:#2563eb;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;">BDC</span>
                <span style="font-weight:800;color:var(--accent);font-size:14px;">${rankEmoji}</span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(70px,1fr));gap:8px;text-align:center;">
              <div><div style="font-size:20px;font-weight:800;">${shown}</div><div style="font-size:10px;color:var(--muted);">Shown</div></div>
              <div><div style="font-size:20px;font-weight:800;">${trend}</div><div style="font-size:10px;color:var(--muted);">Trending</div></div>
              <div><div style="font-size:16px;font-weight:700;">${pct}</div><div style="font-size:10px;color:var(--muted);">Show Rate</div></div>
              <div class="${callsK}"><div style="font-size:16px;font-weight:700;">${calls}</div><div style="font-size:10px;color:var(--muted);">Calls</div></div>
              <div class="${textsK}"><div style="font-size:16px;font-weight:700;">${texts}</div><div style="font-size:10px;color:var(--muted);">Texts</div></div>
              <div class="${createdK}"><div style="font-size:16px;font-weight:700;">${created}</div><div style="font-size:10px;color:var(--muted);">Created</div></div>
            </div>
          </div>` });
      } else {
        memberCards.push({ displayName, html: buildTeamMemberCardNoData(displayName) });
      }
    });

    // Team summary banner
    const memberCount = teamMembers.length;
    teamHtml += `
      <div style="background:linear-gradient(135deg,#1e293b,#334155);border-radius:14px;padding:18px 22px;color:#fff;margin-bottom:16px;">
        <div style="font-size:14px;font-weight:600;margin-bottom:12px;">${mgrName}'s Team ‚Äî ${memberCount} member${memberCount !== 1 ? 's' : ''}</div>
        <div style="display:flex;gap:16px;flex-wrap:wrap;text-align:center;">
          ${totalUnits > 0 ? `<div style="flex:1;min-width:80px;"><div style="font-size:24px;font-weight:800;">${totalUnits}</div><div style="font-size:11px;color:#94a3b8;">Total Units</div></div>` : ''}
          <div style="flex:1;min-width:80px;"><div style="font-size:24px;font-weight:800;">${totalCalls}</div><div style="font-size:11px;color:#94a3b8;">Total Calls</div></div>
          <div style="flex:1;min-width:80px;"><div style="font-size:24px;font-weight:800;">${totalTexts}</div><div style="font-size:11px;color:#94a3b8;">Total Texts</div></div>
          <div style="flex:1;min-width:80px;"><div style="font-size:24px;font-weight:800;">${totalCreated}</div><div style="font-size:11px;color:#94a3b8;">Total Created</div></div>
          <div style="flex:1;min-width:80px;"><div style="font-size:24px;font-weight:800;">${totalShown}</div><div style="font-size:11px;color:#94a3b8;">Total Shown</div></div>
        </div>
      </div>`;

    // Individual member cards
    teamHtml += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;">';
    memberCards.forEach(mc => { teamHtml += mc.html; });
    teamHtml += '</div>';

    document.getElementById('teamDashContent').innerHTML = teamHtml;

  } catch (e) {
    document.getElementById('teamDashContent').innerHTML = `<p style="color:#dc2626;">Error loading team dashboard: ${e.message}</p>`;
  }
}

function buildTeamMemberCardNoData(displayName) {
  return `
    <div style="background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;opacity:0.7;">
      <div style="font-weight:700;font-size:15px;margin-bottom:6px;">${displayName}</div>
      <div style="color:var(--muted);font-size:13px;">No leaderboard data ‚Äî check Linked Sheet Name in User Management</div>
    </div>`;
}

window.showTeamDashboard = showTeamDashboard;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üîî RECALL & TSB LOOKUP (NHTSA)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showRecallLookup() {
  logPageView('Recall Lookup');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:900px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üîî Recall & TSB Lookup</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">NHTSA vehicle safety data ‚Äî recalls, complaints & manufacturer communications</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Back</button>
      </div>

      <div style="background:var(--card);border:1px solid var(--line);border-radius:12px;padding:20px;margin-bottom:16px;">
        <div style="font-weight:700;font-size:15px;margin-bottom:12px;">Enter a VIN</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <input type="text" id="recallVinInput" placeholder="e.g. 1C4RJFBG5LC123456" maxlength="17"
            style="flex:1;min-width:220px;padding:12px 14px;border:1px solid var(--line);border-radius:8px;font-size:15px;font-family:monospace;text-transform:uppercase;"
            onkeydown="if(event.key==='Enter')runRecallLookup()">
          <button class="btn" onclick="runRecallLookup()" id="recallSearchBtn" style="padding:12px 24px;font-size:14px;">üîç Look Up</button>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:12px;">Works with any US-market vehicle. Data provided free by NHTSA.</div>
      </div>

      <div id="recallResults"></div>

      <div style="background:var(--card);border:1px solid var(--line);border-radius:12px;padding:20px;margin-top:16px;">
        <div style="font-weight:700;font-size:15px;margin-bottom:4px;">üìÇ Bulk VIN Recall Check</div>
        <div style="color:var(--muted);font-size:12px;margin-bottom:12px;">Upload a spreadsheet (.csv or .xlsx) with VINs. We'll check each one for recalls and produce a downloadable report.</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <label style="flex:1;min-width:220px;padding:14px;border:2px dashed var(--line);border-radius:8px;text-align:center;cursor:pointer;transition:border-color .2s;" 
            onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--line)'">
            <input type="file" id="bulkVinFile" accept=".csv,.xlsx,.xls,.txt" style="display:none;" onchange="bulkVinFileSelected(this)">
            <div id="bulkVinFileName" style="font-size:14px;font-weight:500;color:var(--muted);">Click to choose file or drag & drop</div>
          </label>
          <button class="btn" onclick="runBulkRecallCheck()" id="bulkRecallBtn" style="padding:12px 24px;font-size:14px;" disabled>üöÄ Run Check</button>
        </div>
        <div id="bulkProgress" style="margin-top:12px;display:none;"></div>
        <div id="bulkResults" style="margin-top:12px;"></div>
      </div>
    </div>`;
}

async function runRecallLookup() {
  const input = document.getElementById('recallVinInput');
  const vin = (input?.value || '').trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
  if (vin.length !== 17) { alert('Please enter a valid 17-character VIN.'); return; }
  input.value = vin;

  const el = document.getElementById('recallResults');
  const btn = document.getElementById('recallSearchBtn');
  btn.disabled = true; btn.textContent = '‚è≥ Searching...';
  el.innerHTML = '<div class="loading-wrap"><div class="spinner"></div></div>';

  try {
    // Step 1: Decode VIN
    const decodeResp = await fetch('https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/' + vin + '?format=json');
    const decodeData = await decodeResp.json();
    const v = decodeData.Results?.[0] || {};
    const make = v.Make || '';
    const model = v.Model || '';
    const year = v.ModelYear || '';
    const trim = v.Trim || '';
    const engine = [v.DisplacementL ? v.DisplacementL + 'L' : '', v.EngineCylinders ? v.EngineCylinders + '-cyl' : '', v.FuelTypePrimary || ''].filter(Boolean).join(' ');
    const drivetrain = v.DriveType || '';
    const bodyClass = v.BodyClass || '';
    const plant = v.PlantCity ? (v.PlantCity + (v.PlantState ? ', ' + v.PlantState : '') + (v.PlantCountry ? ', ' + v.PlantCountry : '')) : '';
    const errorCode = v.ErrorCode || '';

    if (!make || !model || !year || (errorCode && !errorCode.startsWith('0'))) {
      el.innerHTML = `
        <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:20px;text-align:center;">
          <div style="font-size:18px;font-weight:700;color:#dc2626;">VIN Not Recognized</div>
          <p style="color:#991b1b;margin:8px 0 0;">NHTSA could not decode this VIN. Double-check it and try again.</p>
        </div>`;
      btn.disabled = false; btn.textContent = 'üîç Look Up';
      return;
    }

    // Step 2: Fetch recalls + complaints in parallel
    const [recallResp, complaintResp] = await Promise.all([
      fetch('https://api.nhtsa.gov/recalls/recallsByVehicle?make=' + encodeURIComponent(make) + '&model=' + encodeURIComponent(model) + '&modelYear=' + year),
      fetch('https://api.nhtsa.gov/complaints/complaintsByVehicle?make=' + encodeURIComponent(make) + '&model=' + encodeURIComponent(model) + '&modelYear=' + year)
    ]);
    const recallData = await recallResp.json();
    const complaintData = await complaintResp.json();

    const recalls = recallData.results || [];
    const complaints = complaintData.results || [];

    // Build vehicle info card
    let html = `
      <div style="background:linear-gradient(135deg,#1e40af,#3b82f6);border-radius:12px;padding:20px;margin-bottom:16px;color:#fff;">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="font-size:36px;">üöó</div>
          <div>
            <div style="font-size:22px;font-weight:800;">${year} ${make} ${model}${trim ? ' ' + trim : ''}</div>
            <div style="font-size:13px;opacity:.85;margin-top:2px;">${[engine, drivetrain, bodyClass].filter(Boolean).join(' ¬∑ ')}</div>
            ${plant ? '<div style="font-size:12px;opacity:.7;margin-top:2px;">Built: ' + plant + '</div>' : ''}
            <div style="font-size:11px;opacity:.6;margin-top:4px;font-family:monospace;">VIN: ${vin}</div>
          </div>
        </div>
      </div>`;

    // Summary cards
    const recallCount = recalls.length;
    const complaintCount = complaints.length;
    html += `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px;">
        <div style="background:${recallCount > 0 ? '#fef2f2' : '#f0fdf4'};border:1px solid ${recallCount > 0 ? '#fecaca' : '#bbf7d0'};border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:11px;font-weight:600;color:${recallCount > 0 ? '#991b1b' : '#166534'};text-transform:uppercase;">Recalls</div>
          <div style="font-size:28px;font-weight:800;color:${recallCount > 0 ? '#dc2626' : '#16a34a'};">${recallCount}</div>
        </div>
        <div style="background:${complaintCount > 0 ? '#fffbeb' : '#f0fdf4'};border:1px solid ${complaintCount > 0 ? '#fde68a' : '#bbf7d0'};border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:11px;font-weight:600;color:${complaintCount > 0 ? '#92400e' : '#166534'};text-transform:uppercase;">Complaints</div>
          <div style="font-size:28px;font-weight:800;color:${complaintCount > 0 ? '#d97706' : '#16a34a'};">${complaintCount}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;text-align:center;cursor:pointer;" onclick="window.open('https://www.nhtsa.gov/vehicle/' + ${year} + '/' + encodeURIComponent('${make}') + '/' + encodeURIComponent('${model}') + '#702','_blank')">
          <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;">TSBs / Bulletins</div>
          <div style="font-size:14px;font-weight:700;color:var(--accent);margin-top:6px;">View on NHTSA ‚Üí</div>
        </div>
      </div>`;

    // Recalls section
    if (recallCount > 0) {
      html += '<div style="margin-bottom:20px;">';
      html += '<div style="font-weight:700;font-size:16px;margin-bottom:10px;color:#dc2626;">‚ö†Ô∏è Recalls (' + recallCount + ')</div>';
      recalls.forEach((r, i) => {
        const component = r.Component || 'Unknown Component';
        const summary = r.Summary || 'No summary available.';
        const consequence = r.Consequence || '';
        const remedy = r.Remedy || '';
        const campaignNum = r.NHTSACampaignNumber || '';
        const reportDate = r.ReportReceivedDate || '';
        html += `
          <div style="background:var(--card);border:1px solid #fecaca;border-radius:10px;margin-bottom:8px;overflow:hidden;">
            <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none';this.querySelector('.rc-arrow').textContent=this.nextElementSibling.style.display==='none'?'‚ñ∏':'‚ñæ'"
              style="padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;">
              <span class="rc-arrow" style="color:var(--muted);font-size:12px;">‚ñ∏</span>
              <div style="flex:1;min-width:0;">
                <div style="font-weight:600;font-size:14px;">${component}</div>
                <div style="font-size:12px;color:var(--muted);margin-top:2px;">${campaignNum}${reportDate ? ' ¬∑ ' + reportDate : ''}</div>
              </div>
              <span style="background:#fef2f2;color:#dc2626;font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;white-space:nowrap;">RECALL</span>
            </div>
            <div style="display:none;padding:0 16px 14px;border-top:1px solid #fee2e2;">
              <div style="margin-top:12px;">
                <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px;">Summary</div>
                <div style="font-size:13px;line-height:1.5;">${summary}</div>
              </div>
              ${consequence ? '<div style="margin-top:10px;"><div style="font-size:11px;font-weight:600;color:#dc2626;text-transform:uppercase;margin-bottom:4px;">Risk</div><div style="font-size:13px;line-height:1.5;">' + consequence + '</div></div>' : ''}
              ${remedy ? '<div style="margin-top:10px;"><div style="font-size:11px;font-weight:600;color:#16a34a;text-transform:uppercase;margin-bottom:4px;">Remedy</div><div style="font-size:13px;line-height:1.5;">' + remedy + '</div></div>' : ''}
            </div>
          </div>`;
      });
      html += '</div>';
    } else {
      html += `
        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:16px;margin-bottom:16px;text-align:center;">
          <span style="font-size:18px;">‚úÖ</span>
          <span style="font-weight:600;color:#166534;margin-left:6px;">No recalls found for this vehicle</span>
        </div>`;
    }

    // Complaints section
    if (complaintCount > 0) {
      // Group complaints by component
      const compGroups = {};
      complaints.forEach(c => {
        const comp = c.components || 'OTHER';
        if (!compGroups[comp]) compGroups[comp] = [];
        compGroups[comp].push(c);
      });
      const sortedComponents = Object.keys(compGroups).sort((a, b) => compGroups[b].length - compGroups[a].length);

      html += '<div style="margin-bottom:20px;">';
      html += '<div style="font-weight:700;font-size:16px;margin-bottom:10px;color:#d97706;">üìã Consumer Complaints (' + complaintCount + ')</div>';

      sortedComponents.forEach(comp => {
        const items = compGroups[comp];
        html += `
          <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;margin-bottom:8px;overflow:hidden;">
            <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none';this.querySelector('.rc-arrow').textContent=this.nextElementSibling.style.display==='none'?'‚ñ∏':'‚ñæ'"
              style="padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;">
              <span class="rc-arrow" style="color:var(--muted);font-size:12px;">‚ñ∏</span>
              <div style="flex:1;font-weight:600;font-size:14px;">${comp}</div>
              <span style="background:#fffbeb;color:#92400e;font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;">${items.length}</span>
            </div>
            <div style="display:none;padding:0 16px 12px;border-top:1px solid var(--line);max-height:400px;overflow-y:auto;">
              ${items.map(c => {
                const date = c.dateOfIncident || c.dateComplaintFiled || '';
                const crash = c.crash === 'Yes';
                const fire = c.fire === 'Yes';
                const injuries = parseInt(c.numberOfInjuries) || 0;
                const flags = [crash ? 'üí• Crash' : '', fire ? 'üî• Fire' : '', injuries > 0 ? 'ü§ï ' + injuries + ' injured' : ''].filter(Boolean).join(' ¬∑ ');
                return '<div style="padding:10px 0;border-bottom:1px solid var(--line);font-size:13px;line-height:1.5;">' +
                  (date ? '<div style="font-size:11px;color:var(--muted);margin-bottom:3px;">' + date + (flags ? ' ¬∑ <span style="color:#dc2626;">' + flags + '</span>' : '') + '</div>' : '') +
                  (c.summary || 'No details provided.') +
                '</div>';
              }).join('')}
            </div>
          </div>`;
      });
      html += '</div>';
    }

    // Helpful links
    html += `
      <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:16px;margin-bottom:16px;">
        <div style="font-weight:600;font-size:14px;margin-bottom:10px;">üîó More Resources</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
          <a href="https://www.nhtsa.gov/vehicle/${year}/${encodeURIComponent(make)}/${encodeURIComponent(model)}" target="_blank"
            style="background:#eff6ff;color:#1d4ed8;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:500;text-decoration:none;">NHTSA Full Report ‚Üí</a>
          <a href="https://www.google.com/search?q=${encodeURIComponent(year + ' ' + make + ' ' + model + ' problems common issues')}" target="_blank"
            style="background:#f5f3ff;color:#6d28d9;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:500;text-decoration:none;">Google: Common Issues ‚Üí</a>
          <a href="https://www.google.com/search?q=${encodeURIComponent(vin)}" target="_blank"
            style="background:#fefce8;color:#854d0e;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:500;text-decoration:none;">Google VIN ‚Üí</a>
        </div>
      </div>`;

    el.innerHTML = html;

  } catch (err) {
    console.error('Recall lookup error:', err);
    el.innerHTML = `
      <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:20px;text-align:center;">
        <div style="font-size:18px;font-weight:700;color:#dc2626;">Lookup Failed</div>
        <p style="color:#991b1b;margin:8px 0 0;">Could not reach NHTSA servers. Check your internet connection and try again.</p>
        <pre style="text-align:left;font-size:11px;color:var(--muted);margin-top:12px;max-width:600px;overflow-x:auto;">${err.message}</pre>
      </div>`;
  }
  btn.disabled = false; btn.textContent = 'üîç Look Up';
}

/* ‚îÄ‚îÄ Bulk VIN Recall Check ‚îÄ‚îÄ */
let _bulkVins = [];

function bulkVinFileSelected(input) {
  const file = input.files?.[0];
  if (!file) return;
  document.getElementById('bulkVinFileName').textContent = file.name;
  document.getElementById('bulkResults').innerHTML = '';
  document.getElementById('bulkProgress').style.display = 'none';

  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'csv' || ext === 'txt') {
    const reader = new FileReader();
    reader.onload = (e) => {
      _bulkVins = extractVinsFromText(e.target.result);
      finishBulkParse();
    };
    reader.readAsText(file);
  } else if (ext === 'xlsx' || ext === 'xls') {
    // Load SheetJS if not present
    if (!window.XLSX) {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      s.onload = () => readXlsxFile(file);
      s.onerror = () => { alert('Could not load spreadsheet library. Try a .csv file instead.'); };
      document.head.appendChild(s);
    } else {
      readXlsxFile(file);
    }
  } else {
    alert('Please upload a .csv, .xlsx, or .txt file.');
  }
}

function readXlsxFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      let allText = '';
      wb.SheetNames.forEach(name => {
        const ws = wb.Sheets[name];
        allText += XLSX.utils.sheet_to_csv(ws) + '\n';
      });
      _bulkVins = extractVinsFromText(allText);
      finishBulkParse();
    } catch (err) {
      alert('Error reading spreadsheet: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function extractVinsFromText(text) {
  // Find all 17-char alphanumeric strings (excluding I, O, Q per VIN spec)
  const matches = text.match(/\b[A-HJ-NPR-Z0-9]{17}\b/gi) || [];
  // Deduplicate and uppercase
  const seen = new Set();
  return matches.map(v => v.toUpperCase()).filter(v => {
    if (seen.has(v)) return false;
    seen.add(v);
    return true;
  });
}

function finishBulkParse() {
  const btn = document.getElementById('bulkRecallBtn');
  const results = document.getElementById('bulkResults');
  if (_bulkVins.length === 0) {
    btn.disabled = true;
    results.innerHTML = '<div style="color:#dc2626;font-size:13px;">No valid 17-character VINs found in this file.</div>';
  } else {
    btn.disabled = false;
    results.innerHTML = '<div style="color:#16a34a;font-size:13px;font-weight:500;">‚úì Found <strong>' + _bulkVins.length + '</strong> unique VINs. Ready to check.</div>';
  }
}

async function runBulkRecallCheck() {
  if (_bulkVins.length === 0) return;
  const btn = document.getElementById('bulkRecallBtn');
  const prog = document.getElementById('bulkProgress');
  const results = document.getElementById('bulkResults');
  btn.disabled = true;
  prog.style.display = 'block';

  const total = _bulkVins.length;
  const rows = []; // {vin, year, make, model, trim, recallCount, recallComponents, recallSummaries, status}
  let processed = 0;
  let withRecalls = 0;

  function updateProgress() {
    const pct = Math.round((processed / total) * 100);
    prog.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
        <div style="flex:1;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;">
          <div style="width:${pct}%;height:100%;background:${pct < 100 ? '#3b82f6' : '#16a34a'};border-radius:4px;transition:width .3s;"></div>
        </div>
        <span style="font-size:13px;font-weight:600;min-width:60px;text-align:right;">${processed}/${total}</span>
      </div>
      <div style="font-size:12px;color:var(--muted);">
        ${pct < 100 ? '‚è≥ Checking VINs with NHTSA... please keep this page open.' : ''}
        ${withRecalls > 0 ? '<span style="color:#dc2626;font-weight:500;">' + withRecalls + ' VINs with recalls found so far</span>' : ''}
      </div>`;
  }

  updateProgress();

  // Process VINs in batches with small delay to avoid rate limits
  for (let i = 0; i < total; i++) {
    const vin = _bulkVins[i];
    try {
      // Decode VIN
      const decResp = await fetch('https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/' + vin + '?format=json');
      const decData = await decResp.json();
      const v = decData.Results?.[0] || {};
      const make = v.Make || '';
      const model = v.Model || '';
      const year = v.ModelYear || '';
      const trim = v.Trim || '';

      if (!make || !model || !year) {
        rows.push({ vin, year: '', make: '', model: '', trim: '', recallCount: 0, recallComponents: '', recallSummaries: '', status: 'VIN NOT RECOGNIZED' });
        processed++;
        updateProgress();
        continue;
      }

      // Check recalls
      const recResp = await fetch('https://api.nhtsa.gov/recalls/recallsByVehicle?make=' + encodeURIComponent(make) + '&model=' + encodeURIComponent(model) + '&modelYear=' + year);
      const recData = await recResp.json();
      const recalls = recData.results || [];

      const components = recalls.map(r => r.Component || '').filter(Boolean).join('; ');
      const summaries = recalls.map(r => (r.NHTSACampaignNumber || '') + ': ' + (r.Summary || '').slice(0, 150)).join(' | ');

      if (recalls.length > 0) withRecalls++;

      rows.push({
        vin, year, make, model, trim,
        recallCount: recalls.length,
        recallComponents: components,
        recallSummaries: summaries,
        status: recalls.length > 0 ? 'HAS RECALLS' : 'CLEAR'
      });
    } catch (err) {
      rows.push({ vin, year: '', make: '', model: '', trim: '', recallCount: 0, recallComponents: '', recallSummaries: '', status: 'API ERROR' });
    }
    processed++;
    updateProgress();

    // Small delay to be nice to NHTSA servers
    if (i < total - 1) await new Promise(r => setTimeout(r, 200));
  }

  // Generate CSV
  const csvHeader = 'VIN,Year,Make,Model,Trim,Status,Recall Count,Recall Components,Recall Details';
  const csvRows = rows.map(r => {
    const esc = (s) => '"' + String(s || '').replace(/"/g, '""') + '"';
    return [esc(r.vin), r.year, esc(r.make), esc(r.model), esc(r.trim), r.status, r.recallCount, esc(r.recallComponents), esc(r.recallSummaries)].join(',');
  });
  const csv = csvHeader + '\n' + csvRows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const dateStr = new Date().toISOString().slice(0, 10);

  // Show summary + download
  results.innerHTML = `
    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:16px;margin-top:8px;">
      <div style="font-weight:700;font-size:15px;color:#166534;margin-bottom:8px;">‚úÖ Bulk Check Complete</div>
      <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;">
        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:10px 16px;text-align:center;">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;">Total VINs</div>
          <div style="font-size:22px;font-weight:800;">${total}</div>
        </div>
        <div style="background:${withRecalls > 0 ? '#fef2f2' : '#fff'};border:1px solid ${withRecalls > 0 ? '#fecaca' : '#e5e7eb'};border-radius:8px;padding:10px 16px;text-align:center;">
          <div style="font-size:11px;color:${withRecalls > 0 ? '#991b1b' : 'var(--muted)'};text-transform:uppercase;">With Recalls</div>
          <div style="font-size:22px;font-weight:800;color:${withRecalls > 0 ? '#dc2626' : '#16a34a'};">${withRecalls}</div>
        </div>
        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 16px;text-align:center;">
          <div style="font-size:11px;color:#166534;text-transform:uppercase;">Clear</div>
          <div style="font-size:22px;font-weight:800;color:#16a34a;">${total - withRecalls - rows.filter(r => r.status === 'VIN NOT RECOGNIZED' || r.status === 'API ERROR').length}</div>
        </div>
      </div>
      <a href="${url}" download="Recall_Check_${dateStr}.csv"
        style="display:inline-block;background:#16a34a;color:#fff;padding:10px 24px;border-radius:8px;font-weight:600;font-size:14px;text-decoration:none;cursor:pointer;">
        ‚¨á Download Report (.csv)
      </a>
      <span style="font-size:12px;color:var(--muted);margin-left:8px;">Opens in Excel / Google Sheets</span>
    </div>`;

  // Also show a quick preview table
  if (rows.length > 0) {
    let tableHtml = `
      <div style="margin-top:12px;border:1px solid var(--line);border-radius:10px;overflow:hidden;max-height:400px;overflow-y:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <thead><tr style="background:#f8fafc;position:sticky;top:0;">
            <th style="padding:8px 10px;text-align:left;font-weight:600;border-bottom:1px solid var(--line);">VIN</th>
            <th style="padding:8px 10px;text-align:left;font-weight:600;border-bottom:1px solid var(--line);">Vehicle</th>
            <th style="padding:8px 10px;text-align:center;font-weight:600;border-bottom:1px solid var(--line);">Status</th>
            <th style="padding:8px 10px;text-align:center;font-weight:600;border-bottom:1px solid var(--line);">Recalls</th>
          </tr></thead><tbody>`;
    rows.forEach(r => {
      const statusColor = r.status === 'CLEAR' ? '#16a34a' : r.status === 'HAS RECALLS' ? '#dc2626' : '#6b7280';
      const statusBg = r.status === 'CLEAR' ? '#f0fdf4' : r.status === 'HAS RECALLS' ? '#fef2f2' : '#f9fafb';
      tableHtml += `<tr style="border-bottom:1px solid var(--line);">
        <td style="padding:8px 10px;font-family:monospace;font-size:11px;">${r.vin}</td>
        <td style="padding:8px 10px;">${r.year ? r.year + ' ' + r.make + ' ' + r.model : '‚Äî'}</td>
        <td style="padding:8px 10px;text-align:center;">
          <span style="background:${statusBg};color:${statusColor};padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;">${r.status}</span>
        </td>
        <td style="padding:8px 10px;text-align:center;font-weight:600;color:${r.recallCount > 0 ? '#dc2626' : 'var(--muted)'};">${r.recallCount}</td>
      </tr>`;
    });
    tableHtml += '</tbody></table></div>';
    results.innerHTML += tableHtml;
  }

  btn.disabled = false;
}

window.showRecallLookup = showRecallLookup;
window.runRecallLookup = runRecallLookup;
window.bulkVinFileSelected = bulkVinFileSelected;
window.runBulkRecallCheck = runBulkRecallCheck;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CUSTOM USER LINKS (Resources)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window._customLinks = [];

async function loadCustomLinks() {
  if (!window.userData?.uid) return;
  try {
    const snap = await getDoc(doc(db, 'users', window.userData.uid));
    window._customLinks = snap.exists() ? (snap.data().customLinks || []) : [];
  } catch { window._customLinks = []; }
  renderCustomLinks();
}

function renderCustomLinks() {
  const container = document.getElementById('customLinksSection');
  if (!container) return;
  if (!window._customLinks.length) { container.innerHTML = ''; return; }

  let html = '<div style="border-top:1px solid var(--line);margin:4px 0;"></div>';
  html += '<div style="padding:2px 14px 0;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;">My Links</div>';
  window._customLinks.forEach((lnk, i) => {
    const safeLabel = (lnk.label || 'Link').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const safeUrl = (lnk.url || '#').replace(/"/g, '&quot;');
    html += `<div class="custom-link-wrap">
      <a href="${safeUrl}" target="_blank" class="res-link" style="flex:1;">üîñ ${safeLabel}</a>
      <button class="custom-link-del" onclick="event.stopPropagation();removeCustomLink(${i});" title="Remove">‚úï</button>
    </div>`;
  });
  container.innerHTML = html;
}

function showAddLinkForm() {
  document.getElementById('addLinkBtn').style.display = 'none';
  document.getElementById('addLinkFields').style.display = 'block';
  document.getElementById('newLinkLabel').focus();
}
function hideAddLinkForm() {
  document.getElementById('addLinkBtn').style.display = 'block';
  document.getElementById('addLinkFields').style.display = 'none';
  document.getElementById('newLinkLabel').value = '';
  document.getElementById('newLinkUrl').value = '';
}

async function saveCustomLink() {
  const label = (document.getElementById('newLinkLabel').value || '').trim();
  let url = (document.getElementById('newLinkUrl').value || '').trim();
  if (!label || !url) { alert('Please enter both a label and URL.'); return; }
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

  window._customLinks.push({ label, url });
  try {
    await setDoc(doc(db, 'users', window.userData.uid), { customLinks: window._customLinks }, { merge: true });
  } catch (err) {
    console.error('Save custom link error:', err);
    window._customLinks.pop();
    alert('Failed to save link.');
    return;
  }
  hideAddLinkForm();
  renderCustomLinks();
}

async function removeCustomLink(idx) {
  if (idx < 0 || idx >= window._customLinks.length) return;
  const removed = window._customLinks.splice(idx, 1);
  try {
    await setDoc(doc(db, 'users', window.userData.uid), { customLinks: window._customLinks }, { merge: true });
  } catch (err) {
    console.error('Remove custom link error:', err);
    window._customLinks.splice(idx, 0, ...removed);
    alert('Failed to remove link.');
    return;
  }
  renderCustomLinks();
}

function toggleResourcesMenu() {
  const menu = document.getElementById('resourcesMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  const rMenu = document.getElementById('reportsMenu');
  if (rMenu) rMenu.style.display = 'none';
}
function closeResourcesMenu() {
  document.getElementById('resourcesMenu').style.display = 'none';
}
function toggleReportsMenu() {
  const menu = document.getElementById('reportsMenu');
  if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  document.getElementById('resourcesMenu').style.display = 'none';
}
function closeReportsMenu() {
  const menu = document.getElementById('reportsMenu');
  if (menu) menu.style.display = 'none';
}
// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('resourcesWrap');
  if (wrap && !wrap.contains(e.target)) closeResourcesMenu();
  const rWrap = document.getElementById('reportsWrap');
  if (rWrap && !rWrap.contains(e.target)) closeReportsMenu();
});
window.toggleResourcesMenu = toggleResourcesMenu;
window.closeResourcesMenu = closeResourcesMenu;
window.toggleReportsMenu = toggleReportsMenu;
window.closeReportsMenu = closeReportsMenu;
window.showAddLinkForm = showAddLinkForm;
window.hideAddLinkForm = hideAddLinkForm;
window.saveCustomLink = saveCustomLink;
window.removeCustomLink = removeCustomLink;
window.startEditUser = startEditUser;
window.cancelEditUser = cancelEditUser;
window.saveEditUser = saveEditUser;
window.addUser = addUser;
window.deleteUser = deleteUser;
window.toggleSort = toggleSort;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TEAM CHAT (Firestore real-time)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CHAT_CHANNELS = [
  { id: 'general',      label: 'üí¨ General' },
  { id: 'sales',        label: 'üöó Sales' },
  { id: 'bdc',          label: 'üìû BDC' },
  { id: 'managers',     label: 'üìã Managers' }
];

let _chatChannel = 'general';
let _chatOpen = false;
let _chatUnsub = null;       // Firestore onSnapshot unsubscribe
let _chatDmUnsub = null;     // Persistent DM inbox listener
let _chatLastSeen = {};      // channel -> timestamp of last seen message
let _chatInitialized = false;
let _chatUsers = [];         // all users for DM dropdown
let _chatDmTarget = null;    // { uid, name } of current DM recipient
let _chatMode = 'channel';   // 'channel' or 'dm'

function initChat() {
  if (_chatInitialized) return;
  if (!window.userData?.uid) return;
  _chatInitialized = true;

  // Show FAB
  const fab = document.getElementById('chatFab');
  if (fab) fab.style.display = 'flex';

  // Start presence heartbeat (writes lastSeen every 2 min)
  _chatPresenceHeartbeat();
  _chatPresenceTimer = setInterval(_chatPresenceHeartbeat, 120000);

  // Load last-seen timestamps from Firestore (triggers initial unread scan)
  _loadChatLastSeen();

  // Rescan unread counts every 60s for channels we're not listening to
  setInterval(() => _scanAllUnread(), 60000);

  // Load all users for DM dropdown (refresh every 60s for presence dots)
  _loadChatUsers();
  setInterval(_loadChatUsers, 60000);

  // Render channel buttons
  _renderChatChannels();

  // Subscribe to default channel
  _subscribeChatChannel(_chatChannel);

  // Subscribe to incoming DMs (real-time, persists across channel switches)
  _subscribeDmInbox();
}

let _chatPresenceTimer = null;
const CHAT_ACTIVE_MS = 5 * 60 * 1000;   // green: seen within 5 min
const CHAT_IDLE_MS   = 30 * 60 * 1000;  // orange: seen within 30 min

function _chatPresenceHeartbeat() {
  if (!window.userData?.uid) return;
  setDoc(doc(db, 'users', window.userData.uid), {
    chatLastSeen: new Date()
  }, { merge: true }).catch(() => {});
}

function toggleChat() {
  _chatOpen = !_chatOpen;
  const drawer = document.getElementById('chatDrawer');
  if (drawer) drawer.classList.toggle('open', _chatOpen);

  if (_chatOpen) {
    // Mark current channel as read
    _markChannelRead(_chatChannel);
    _updateUnreadBadge();
    // Focus input
    setTimeout(() => {
      const inp = document.getElementById('chatInput');
      if (inp) inp.focus();
    }, 100);
  }
}
window.toggleChat = toggleChat;

let _chatInboxOpen = false;
let _chatInboxMessages = {};  // channel -> { lastMsg, lastMsgTime, senderName }

function _renderChatChannels() {
  const groupSelect = document.getElementById('chatGroupSelect');
  if (!groupSelect) return;

  const channels = CHAT_CHANNELS.filter(ch => {
    if (ch.id === 'managers' && !isAdmin() && !isManager()) return false;
    return true;
  });

  let html = '<option value="">üë• Group Messages‚Ä¶</option>';
  channels.forEach(ch => {
    const unread = _chatUnreadMap[ch.id] || 0;
    const badge = unread > 0 ? ` (${unread})` : '';
    const selected = (_chatMode === 'channel' && ch.id === _chatChannel) ? 'selected' : '';
    html += `<option value="${ch.id}" ${selected}>${ch.label}${badge}</option>`;
  });
  groupSelect.innerHTML = html;

  // Update DM select highlight
  const dmSelect = document.getElementById('chatDmSelect');
  if (dmSelect && _chatMode !== 'dm') dmSelect.value = '';
  if (groupSelect && _chatMode !== 'channel') groupSelect.value = '';

  // Show/hide DM header bar
  _renderDmHeader();

  // Update inbox button state
  _updateInboxBtn();
}

function _renderDmHeader() {
  const header = document.getElementById('chatDmHeader');
  if (!header) return;

  if (_chatMode !== 'dm' || !_chatDmTarget) {
    header.style.display = 'none';
    return;
  }

  header.style.display = 'flex';
  header.innerHTML = `
    <button onclick="exitDm()" title="Back">‚Üê</button>
    <span>‚úâ ${_formatChatName(_chatDmTarget.name)}</span>
  `;
}

function _updateInboxBtn() {
  const btn = document.getElementById('chatInboxBtn');
  const countEl = document.getElementById('chatInboxCount');
  if (!btn || !countEl) return;

  const total = _getTotalUnread();
  if (total > 0) {
    countEl.textContent = total > 99 ? '99+' : total;
    countEl.style.display = 'flex';
    btn.classList.add('has-unread');
  } else {
    countEl.style.display = 'none';
    btn.classList.remove('has-unread');
  }
}

function toggleChatInbox() {
  _chatInboxOpen = !_chatInboxOpen;
  const inboxView = document.getElementById('chatInboxView');
  const msgView = document.getElementById('chatMessages');
  const inputRow = document.getElementById('chatInputRow');

  if (_chatInboxOpen) {
    _renderChatInbox();
    if (inboxView) inboxView.style.display = 'block';
    if (msgView) msgView.style.display = 'none';
    if (inputRow) inputRow.style.display = 'none';
  } else {
    if (inboxView) inboxView.style.display = 'none';
    if (msgView) msgView.style.display = 'flex';
    if (inputRow) inputRow.style.display = 'flex';
  }
}
window.toggleChatInbox = toggleChatInbox;

function _closeChatInbox() {
  _chatInboxOpen = false;
  const inboxView = document.getElementById('chatInboxView');
  const msgView = document.getElementById('chatMessages');
  const inputRow = document.getElementById('chatInputRow');
  if (inboxView) inboxView.style.display = 'none';
  if (msgView) msgView.style.display = 'flex';
  if (inputRow) inputRow.style.display = 'flex';
}

function _renderChatInbox() {
  const container = document.getElementById('chatInboxView');
  if (!container) return;

  // Build list of channels with unread messages
  const unreadChannels = Object.entries(_chatUnreadMap)
    .filter(([ch, count]) => count > 0)
    .sort((a, b) => b[1] - a[1]); // most unread first

  if (unreadChannels.length === 0) {
    container.innerHTML = '<div class="chat-inbox-empty">‚úÖ All caught up! No unread messages.</div>';
    return;
  }

  let html = '';
  unreadChannels.forEach(([channelId, count]) => {
    // Determine display name
    let channelLabel = channelId;
    let icon = 'üí¨';

    if (channelId.startsWith('dm_')) {
      // DM: find the other person's name
      icon = '‚úâ';
      const parts = channelId.replace('dm_', '').split('_');
      const otherUid = parts.find(p => p !== window.userData?.uid) || parts[0];
      const user = _chatUsers.find(u => u.uid === otherUid);
      channelLabel = user ? _formatChatName(user.name) : 'Direct Message';
    } else {
      const ch = CHAT_CHANNELS.find(c => c.id === channelId);
      if (ch) { channelLabel = ch.label; }
    }

    // Get cached preview if we have it
    const preview = _chatInboxMessages[channelId];
    const previewContent = preview ? (preview.gifUrl ? 'üé¨ GIF' : preview.text) : '';
    const previewText = preview ? `${_formatChatName(preview.senderName)}: ${previewContent}` : 'New messages';
    const timeStr = preview?.time || '';

    html += `
      <div class="chat-inbox-row" onclick="openInboxChannel('${channelId}')">
        <div class="inbox-dot"></div>
        <div class="inbox-channel">${icon} ${channelLabel}</div>
        <div class="inbox-preview">${_escapeHtml(previewText)}</div>
        ${timeStr ? `<div class="inbox-time">${timeStr}</div>` : ''}
        <div class="inbox-count">${count}</div>
      </div>`;
  });

  container.innerHTML = html;
}

function _escapeHtml(text) {
  return (text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function openInboxChannel(channelId) {
  _closeChatInbox();

  if (channelId.startsWith('dm_')) {
    // Figure out the other user and open DM
    const parts = channelId.replace('dm_', '').split('_');
    const otherUid = parts.find(p => p !== window.userData?.uid) || parts[0];
    openDirectMessage(otherUid);
  } else {
    switchChatChannel(channelId);
  }
}
window.openInboxChannel = openInboxChannel;

async function _loadChatUsers() {
  try {
    const snap = await getDocs(collection(db, 'users'));
    _chatUsers = [];
    const now = Date.now();

    snap.forEach(d => {
      const data = d.data();
      if (data.deleted) return;
      const name = data.linkedName || data.presenceName || data.displayName || data.email || '';
      if (!name) return;
      if (d.id === window.userData?.uid) return;

      // Determine presence from chatLastSeen field
      let status = 'offline';
      let lastSeen = null;
      if (data.chatLastSeen?.toDate) lastSeen = data.chatLastSeen.toDate();
      else if (data.chatLastSeen) lastSeen = new Date(data.chatLastSeen);

      if (lastSeen) {
        const age = now - lastSeen.getTime();
        if (age <= CHAT_ACTIVE_MS) status = 'active';
        else if (age <= CHAT_IDLE_MS) status = 'idle';
      }

      _chatUsers.push({ uid: d.id, name, email: data.email || '', role: data.role || 'user', status });
    });

    // Sort: active first, then idle, then offline ‚Äî alphabetical within each group
    const statusOrder = { active: 0, idle: 1, offline: 2 };
    _chatUsers.sort((a, b) => {
      const s = statusOrder[a.status] - statusOrder[b.status];
      if (s !== 0) return s;
      return a.name.localeCompare(b.name);
    });

    _renderDmSelect();

    // Update online count in chat header
    const activeCount = _chatUsers.filter(u => u.status === 'active').length;
    const idleCount = _chatUsers.filter(u => u.status === 'idle').length;
    const countEl = document.getElementById('chatOnlineCount');
    if (countEl) {
      const parts = [];
      if (activeCount > 0) parts.push(`${activeCount} active`);
      if (idleCount > 0) parts.push(`${idleCount} away`);
      countEl.innerHTML = parts.length > 0
        ? `<span style="color:#22c55e;">‚óè</span> ${parts.join(', ')}`
        : '';
    }
  } catch (e) {
    console.warn('[Chat] Failed to load users for DM:', e);
  }
}

function _renderDmSelect() {
  const select = document.getElementById('chatDmSelect');
  if (!select) return;

  const activeCount = _chatUsers.filter(u => u.status === 'active').length;
  const idleCount = _chatUsers.filter(u => u.status === 'idle').length;

  let html = `<option value="">‚úâ Direct Message‚Ä¶</option>`;
  _chatUsers.forEach(u => {
    const display = _formatChatName(u.name);
    let dot = '‚ö´';
    if (u.status === 'active') dot = 'üü¢';
    else if (u.status === 'idle') dot = 'üü†';
    html += `<option value="${u.uid}">${dot} ${display}</option>`;
  });
  select.innerHTML = html;
}

function _getDmChannelId(uid1, uid2) {
  // Consistent channel ID regardless of who initiates
  return uid1 < uid2 ? `dm_${uid1}_${uid2}` : `dm_${uid2}_${uid1}`;
}

function openDirectMessage(targetUid) {
  if (!targetUid) return;
  const target = _chatUsers.find(u => u.uid === targetUid);
  if (!target) return;

  _closeChatInbox();
  _chatDmTarget = target;
  _chatMode = 'dm';
  _chatChannel = _getDmChannelId(window.userData.uid, targetUid);

  _renderChatChannels();
  _subscribeChatChannel(_chatChannel);
  _markChannelRead(_chatChannel);
  _updateUnreadBadge();

  // Focus input
  setTimeout(() => {
    const inp = document.getElementById('chatInput');
    if (inp) { inp.placeholder = `Message ${_formatChatName(target.name)}...`; inp.focus(); }
  }, 100);
}
window.openDirectMessage = openDirectMessage;

function exitDm() {
  _chatDmTarget = null;
  _chatMode = 'channel';
  _chatChannel = 'general';

  const inp = document.getElementById('chatInput');
  if (inp) inp.placeholder = 'Type a message...';

  const dmSelect = document.getElementById('chatDmSelect');
  if (dmSelect) dmSelect.value = '';

  _renderChatChannels();
  _subscribeChatChannel(_chatChannel);
}
window.exitDm = exitDm;

function switchChatChannel(channelId) {
  if (!channelId) return; // ignore placeholder selection
  _closeChatInbox();
  _chatMode = 'channel';
  _chatDmTarget = null;
  _chatChannel = channelId;

  const inp = document.getElementById('chatInput');
  if (inp) inp.placeholder = 'Type a message...';

  const dmSelect = document.getElementById('chatDmSelect');
  if (dmSelect) dmSelect.value = '';

  _renderChatChannels();
  _subscribeChatChannel(channelId);
  _markChannelRead(channelId);
  _updateUnreadBadge();
}
window.switchChatChannel = switchChatChannel;

function _subscribeChatChannel(channelId) {
  // Unsubscribe from previous listener
  if (_chatUnsub) { _chatUnsub(); _chatUnsub = null; }

  const msgBox = document.getElementById('chatMessages');
  if (msgBox) msgBox.innerHTML = '<p style="color:var(--muted);text-align:center;font-size:12px;margin-top:40px;">Loading messages...</p>';

  // Query: last 80 messages in this channel, ordered by time
  const q = query(
    collection(db, 'chatMessages'),
    where('channel', '==', channelId),
    orderBy('createdAt', 'desc'),
    limit(80)
  );

  _chatUnsub = onSnapshot(q, (snapshot) => {
    const messages = [];
    snapshot.forEach(d => {
      const data = d.data();
      messages.push({ id: d.id, ...data });
    });

    // Reverse so oldest is first (we queried desc for the limit)
    messages.reverse();
    _renderChatMessages(messages);

    // Cache last message for inbox preview
    if (messages.length > 0) {
      const last = messages[messages.length - 1];
      const ts = last.createdAt?.toDate?.() || (last.createdAt?.seconds ? new Date(last.createdAt.seconds * 1000) : new Date());
      _chatInboxMessages[channelId] = {
        senderName: last.senderName || 'Unknown',
        text: (last.text || '').substring(0, 60),
        gifUrl: last.gifUrl || '',
        time: ts.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
      };
    }

    // Update unread count for THIS channel if chat is closed or viewing a different channel
    if (!_chatOpen || _chatChannel !== channelId) {
      const lastSeen = _chatLastSeen[channelId] || 0;
      let count = 0;
      messages.forEach(msg => {
        if (msg.senderUid === window.userData?.uid) return;
        const msgTime = msg.createdAt?.toMillis?.() || (msg.createdAt?.seconds ? msg.createdAt.seconds * 1000 : 0);
        if (msgTime > lastSeen) count++;
      });
      _chatUnreadMap[channelId] = count;
      _updateUnreadBadge();
    }

    // Auto-scroll to bottom
    if (msgBox) {
      setTimeout(() => { msgBox.scrollTop = msgBox.scrollHeight; }, 50);
    }

    // If chat is open on this channel, mark as read
    if (_chatOpen && _chatChannel === channelId) {
      _markChannelRead(channelId);
    }
  }, (err) => {
    console.error('[Chat] Listener error:', err);
    const msgBox = document.getElementById('chatMessages');
    if (msgBox) msgBox.innerHTML = '<p style="color:#dc2626;text-align:center;font-size:12px;margin-top:40px;">Error loading messages</p>';
  });
}

// ‚îÄ‚îÄ Persistent DM inbox listener (always-on, separate from channel listener) ‚îÄ‚îÄ
function _subscribeDmInbox() {
  if (_chatDmUnsub) { _chatDmUnsub(); _chatDmUnsub = null; }
  if (!window.userData?.uid) return;

  const q = query(
    collection(db, 'chatMessages'),
    where('recipientUid', '==', window.userData.uid),
    orderBy('createdAt', 'desc'),
    limit(50)
  );

  _chatDmUnsub = onSnapshot(q, (snapshot) => {
    // Group by DM channel and count unread
    const dmCounts = {};
    snapshot.forEach(d => {
      const data = d.data();
      const ch = data.channel || '';
      if (!ch.startsWith('dm_')) return;
      const lastSeen = _chatLastSeen[ch] || 0;
      const msgTime = data.createdAt?.toMillis?.() || (data.createdAt?.seconds ? data.createdAt.seconds * 1000 : 0);
      if (msgTime > lastSeen) {
        dmCounts[ch] = (dmCounts[ch] || 0) + 1;
      }
    });

    // If currently viewing a DM channel, don't count it as unread
    if (_chatOpen && _chatMode === 'dm' && _chatChannel) {
      delete dmCounts[_chatChannel];
    }

    // Clear old DM counts, set new ones
    Object.keys(_chatUnreadMap).forEach(k => {
      if (k.startsWith('dm_')) delete _chatUnreadMap[k];
    });
    Object.entries(dmCounts).forEach(([ch, count]) => {
      _chatUnreadMap[ch] = count;
    });
    _updateUnreadBadge();
  }, (err) => {
    console.warn('[Chat] DM inbox listener error (index may need creating):', err.message);
  });
}

function _renderChatMessages(messages) {
  const msgBox = document.getElementById('chatMessages');
  if (!msgBox) return;
  const myUid = window.userData?.uid || '';

  if (!messages.length) {
    msgBox.innerHTML = '<p style="color:var(--muted);text-align:center;font-size:13px;margin-top:40px;">No messages yet ‚Äî say hello! üëã</p>';
    return;
  }

  let html = '';
  let lastDateStr = '';

  messages.forEach(msg => {
    const isMine = msg.senderUid === myUid;
    const ts = msg.createdAt?.toDate?.() || (msg.createdAt?.seconds ? new Date(msg.createdAt.seconds * 1000) : new Date());

    // Date divider
    const dateStr = ts.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    if (dateStr !== lastDateStr) {
      // Check if it's today
      const today = new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      const label = dateStr === today ? 'Today' : dateStr;
      html += `<div class="chat-date-divider">${label}</div>`;
      lastDateStr = dateStr;
    }

    const timeStr = ts.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const senderDisplay = _formatChatName(msg.senderName || 'Unknown');
    const isGif = msg.gifUrl && msg.gifUrl.startsWith('http');
    let contentHtml;
    if (isGif) {
      contentHtml = `<img src="${msg.gifUrl}" alt="GIF" class="chat-gif-msg" loading="lazy">`;
    } else {
      const escapedText = (msg.text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')
        .replace(/@(\w+\s\w\.)/g, '<span class="chat-mention-tag">@$1</span>');
      contentHtml = escapedText;
    }

    html += `
      <div class="chat-msg ${isMine ? 'mine' : 'other'}">
        ${!isMine ? `<div class="chat-sender">${senderDisplay}</div>` : ''}
        <div>${contentHtml}</div>
        <div class="chat-time">${timeStr}</div>
      </div>`;
  });

  msgBox.innerHTML = html;
}

function _formatChatName(name) {
  // "FIRST LAST" -> "First L."
  if (!name) return '?';
  const parts = name.trim().split(/\s+/);
  if (parts.length < 2) return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  const first = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
  const lastInit = parts[parts.length - 1].charAt(0).toUpperCase() + '.';
  return first + ' ' + lastInit;
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('chatSendBtn');
  if (!input || !btn) return;

  const text = input.value.trim();
  if (!text) return;
  if (!window.userData?.uid) return;

  // Capture mentions before clearing
  const mentions = _chatMentions.map(m => m.uid);

  btn.disabled = true;
  input.value = '';
  _chatMentions = [];
  _closeMentionPopup();

  try {
    const msgData = {
      text: text,
      senderUid: window.userData.uid,
      senderName: window.userData.linkedName || window.userData.displayName || window.userData.email || 'Unknown',
      channel: _chatChannel,
      createdAt: serverTimestamp()
    };

    // Add @mention UIDs
    if (mentions.length > 0) {
      msgData.mentions = mentions;
    }

    // Add DM-specific fields
    if (_chatMode === 'dm' && _chatDmTarget) {
      msgData.isDm = true;
      msgData.recipientUid = _chatDmTarget.uid;
      msgData.recipientName = _chatDmTarget.name;
      msgData.participants = [window.userData.uid, _chatDmTarget.uid].sort();
    }

    await addDoc(collection(db, 'chatMessages'), msgData);
  } catch (err) {
    console.error('[Chat] Send error:', err);
    input.value = text;
    alert('Failed to send message. Please try again.');
  }

  btn.disabled = false;
  input.focus();
}
window.sendChatMessage = sendChatMessage;

/* ‚îÄ‚îÄ Emoji Picker ‚îÄ‚îÄ */
const EMOJI_DATA = {
  'üòä': ['üòä','üòÇ','ü§£','üòç','ü•∞','üòò','üòé','ü§©','ü•≥','ü§ó','üòá','üôÉ','üòú','ü§î','ü´°','üò§','üò≠','ü•∫','üò±','ü§Ø','ü´†','üíÄ','üëª','üî•','‚ù§Ô∏è','üíØ','üëè','üôè','üí™','üëç','üëé','‚úÖ','‚ùå','‚≠ê','üéâ','üèÜ','üöÄ','üí∞','üìà','üìâ','üéØ','üíé','üõéÔ∏è','üìû','üì±','üíª'],
  'üöó': ['üöó','üöô','üöï','üèéÔ∏è','üöò','üèÅ','‚õΩ','üîë','üÖøÔ∏è','üõû','üí®','üîß','ü™õ','üìã','üìä','üíº','ü§ù','üìù','üóìÔ∏è','‚è∞','üïê','üìå','üéØ','üí°','üì¢','üè∑Ô∏è','üõí'],
  'üë§': ['üë§','üë•','üßë‚Äçüíº','üë®‚Äçüíº','üë©‚Äçüíº','ü§µ','üíÅ','üôã','ü§∑','üôÖ','üíÉ','üï∫','üëã','‚úåÔ∏è','ü§û','ü´∂','üëä','ü§ú','ü§õ','üëÜ','üëá','üëà','üëâ'],
  'üé≠': ['üòà','ü§°','üí©','üêê','ü¶Å','üêª','ü¶Ö','üêç','ü¶à','üêò','ü¶Ñ','üåü','üåà','‚òÄÔ∏è','üåô','‚ö°','üåä','üçï','üçî','üç∫','ü•Ç','üéµ','üé∂','üé§','üé¨','üéÆ']
};
const EMOJI_TAB_LABELS = {'üòä':'Smileys','üöó':'Auto','üë§':'People','üé≠':'Fun'};

function _initEmojiPicker() {
  const tabs = document.getElementById('emojiTabs');
  const grid = document.getElementById('emojiGrid');
  if (!tabs || !grid) return;
  const cats = Object.keys(EMOJI_DATA);
  tabs.innerHTML = cats.map((k,i) => `<button class="emoji-tab${i===0?' active':''}" onclick="_switchEmojiTab('${k}')" title="${EMOJI_TAB_LABELS[k]||''}">${k}</button>`).join('');
  _switchEmojiTab(cats[0]);
}

function _switchEmojiTab(cat) {
  const grid = document.getElementById('emojiGrid');
  const tabs = document.querySelectorAll('.emoji-tab');
  tabs.forEach(t => t.classList.toggle('active', t.textContent.trim() === cat));
  grid.innerHTML = (EMOJI_DATA[cat]||[]).map(e => `<div class="emoji-cell" onclick="_insertEmoji('${e}')">${e}</div>`).join('');
}

function _insertEmoji(emoji) {
  const inp = document.getElementById('chatInput');
  if (!inp) return;
  const start = inp.selectionStart || inp.value.length;
  inp.value = inp.value.slice(0, start) + emoji + inp.value.slice(start);
  inp.focus();
  inp.setSelectionRange(start + emoji.length, start + emoji.length);
}

function toggleEmojiPicker() {
  const picker = document.getElementById('emojiPicker');
  const gifPicker = document.getElementById('gifPicker');
  const btn = document.getElementById('emojiToggleBtn');
  if (gifPicker?.classList.contains('show')) { gifPicker.classList.remove('show'); document.getElementById('gifToggleBtn')?.classList.remove('active'); }
  picker.classList.toggle('show');
  btn.classList.toggle('active');
  if (picker.classList.contains('show') && !picker.dataset.init) { _initEmojiPicker(); picker.dataset.init = '1'; }
}
window.toggleEmojiPicker = toggleEmojiPicker;
window._switchEmojiTab = _switchEmojiTab;
window._insertEmoji = _insertEmoji;

/* ‚îÄ‚îÄ GIF Search (GIPHY) ‚îÄ‚îÄ */
const GIPHY_API_KEY = 'CdRKiCMbTnt9CkZTZ0lGukSczk6iT4Z6'; // Free GIPHY API key
let _gifSearchTimer = null;

function toggleGifPicker() {
  const picker = document.getElementById('gifPicker');
  const emojiPicker = document.getElementById('emojiPicker');
  const btn = document.getElementById('gifToggleBtn');
  if (emojiPicker?.classList.contains('show')) { emojiPicker.classList.remove('show'); document.getElementById('emojiToggleBtn')?.classList.remove('active'); }
  picker.classList.toggle('show');
  btn.classList.toggle('active');
  if (picker.classList.contains('show')) { document.getElementById('gifSearchInput')?.focus(); _loadTrendingGifs(); }
}
window.toggleGifPicker = toggleGifPicker;

function _debounceGifSearch() {
  clearTimeout(_gifSearchTimer);
  _gifSearchTimer = setTimeout(() => {
    const q = document.getElementById('gifSearchInput')?.value?.trim();
    if (q) _searchGifs(q); else _loadTrendingGifs();
  }, 400);
}
window._debounceGifSearch = _debounceGifSearch;

async function _loadTrendingGifs() {
  const grid = document.getElementById('gifGrid');
  if (!grid) return;
  grid.innerHTML = '<p style="color:var(--muted);text-align:center;grid-column:1/-1;font-size:12px;">Loading trending...</p>';
  try {
    const res = await fetch(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20&rating=pg`);
    const data = await res.json();
    _renderGifs(data.data || []);
  } catch (e) { grid.innerHTML = '<p style="color:#dc2626;text-align:center;grid-column:1/-1;font-size:12px;">Failed to load GIFs</p>'; }
}

async function _searchGifs(query) {
  const grid = document.getElementById('gifGrid');
  if (!grid) return;
  grid.innerHTML = '<p style="color:var(--muted);text-align:center;grid-column:1/-1;font-size:12px;">Searching...</p>';
  try {
    const res = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20&rating=pg`);
    const data = await res.json();
    _renderGifs(data.data || []);
  } catch (e) { grid.innerHTML = '<p style="color:#dc2626;text-align:center;grid-column:1/-1;font-size:12px;">Search failed</p>'; }
}

function _renderGifs(gifs) {
  const grid = document.getElementById('gifGrid');
  if (!gifs.length) { grid.innerHTML = '<p style="color:var(--muted);text-align:center;grid-column:1/-1;font-size:12px;">No GIFs found</p>'; return; }
  grid.innerHTML = gifs.map(g => {
    const url = g.images?.fixed_width?.url || g.images?.original?.url || '';
    const fullUrl = g.images?.original?.url || url;
    return url ? `<div class="gif-cell" onclick="_sendGif('${fullUrl.replace(/'/g,"\\'")}')"><img src="${url}" alt="GIF" loading="lazy"></div>` : '';
  }).join('');
}

async function _sendGif(gifUrl) {
  if (!window.userData?.uid || !_chatChannel) return;
  // Close picker
  document.getElementById('gifPicker')?.classList.remove('show');
  document.getElementById('gifToggleBtn')?.classList.remove('active');

  try {
    const msgData = {
      text: '',
      gifUrl: gifUrl,
      senderUid: window.userData.uid,
      senderName: window.userData.linkedName || window.userData.displayName || window.userData.email || 'Unknown',
      channel: _chatChannel,
      createdAt: serverTimestamp()
    };
    if (_chatMode === 'dm' && _chatDmTarget) {
      msgData.isDm = true;
      msgData.recipientUid = _chatDmTarget.uid;
      msgData.recipientName = _chatDmTarget.name;
      msgData.participants = [window.userData.uid, _chatDmTarget.uid].sort();
    }
    await addDoc(collection(db, 'chatMessages'), msgData);
  } catch (err) { console.error('[Chat] GIF send error:', err); }
}
window._sendGif = _sendGif;

// Close pickers when clicking outside
document.addEventListener('click', function(e) {
  const emojiPicker = document.getElementById('emojiPicker');
  const gifPicker = document.getElementById('gifPicker');
  const emojiBtn = document.getElementById('emojiToggleBtn');
  const gifBtn = document.getElementById('gifToggleBtn');
  if (emojiPicker?.classList.contains('show') && !emojiPicker.contains(e.target) && e.target !== emojiBtn) {
    emojiPicker.classList.remove('show'); emojiBtn?.classList.remove('active');
  }
  if (gifPicker?.classList.contains('show') && !gifPicker.contains(e.target) && e.target !== gifBtn) {
    gifPicker.classList.remove('show'); gifBtn?.classList.remove('active');
  }
});

// ‚îÄ‚îÄ Unread tracking (per-channel) ‚îÄ‚îÄ
let _chatUnreadMap = {};  // channel -> unread count

async function _loadChatLastSeen() {
  if (!window.userData?.uid) return;
  try {
    const snap = await getDoc(doc(db, 'chatLastSeen', window.userData.uid));
    if (snap.exists()) {
      _chatLastSeen = snap.data() || {};
    }
  } catch (e) { /* ignore */ }

  // Initial unread scan after loading lastSeen
  await _scanAllUnread();
}

async function _markChannelRead(channelId) {
  _chatLastSeen[channelId] = Date.now();
  _chatUnreadMap[channelId] = 0;
  _updateUnreadBadge();

  if (!window.userData?.uid) return;
  try {
    await setDoc(doc(db, 'chatLastSeen', window.userData.uid), _chatLastSeen, { merge: true });
  } catch (e) { /* ignore */ }
}

function _getTotalUnread() {
  return Object.values(_chatUnreadMap).reduce((sum, n) => sum + n, 0);
}

function _updateUnreadBadge() {
  const badge = document.getElementById('chatUnreadBadge');
  if (!badge) return;
  const total = _getTotalUnread();
  if (total > 0) {
    badge.textContent = total > 99 ? '99+' : total;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
  // Also update inbox button and group dropdown counts
  _updateInboxBtn();
  _refreshGroupDropdownCounts();
}

function _refreshGroupDropdownCounts() {
  const groupSelect = document.getElementById('chatGroupSelect');
  if (!groupSelect) return;
  const channels = CHAT_CHANNELS.filter(ch => {
    if (ch.id === 'managers' && !isAdmin() && !isManager()) return false;
    return true;
  });
  let html = '<option value="">üë• Group Messages‚Ä¶</option>';
  channels.forEach(ch => {
    const unread = _chatUnreadMap[ch.id] || 0;
    const badge = unread > 0 ? ` (${unread})` : '';
    const selected = (_chatMode === 'channel' && ch.id === _chatChannel) ? 'selected' : '';
    html += `<option value="${ch.id}" ${selected}>${ch.label}${badge}</option>`;
  });
  groupSelect.innerHTML = html;
}

// Scan all group channels + DMs for unread messages
async function _scanAllUnread() {
  if (!window.userData?.uid) return;

  // 1) Check group channels
  const channelIds = CHAT_CHANNELS
    .filter(ch => ch.id !== 'managers' || isAdmin() || isManager())
    .map(ch => ch.id);

  for (const chId of channelIds) {
    try {
      const q = query(
        collection(db, 'chatMessages'),
        where('channel', '==', chId),
        orderBy('createdAt', 'desc'),
        limit(20)
      );
      const snap = await getDocs(q);
      const lastSeen = _chatLastSeen[chId] || 0;
      let count = 0;
      snap.forEach(d => {
        const data = d.data();
        if (data.senderUid === window.userData.uid) return;
        const msgTime = data.createdAt?.toMillis?.() || (data.createdAt?.seconds ? data.createdAt.seconds * 1000 : 0);
        if (msgTime > lastSeen) count++;
      });
      _chatUnreadMap[chId] = count;
    } catch (e) { /* index might not exist yet, ignore */ }
  }

  _updateUnreadBadge();
}

// Clean up listeners and presence on page unload
window.addEventListener('beforeunload', () => {
  if (_chatUnsub) _chatUnsub();
  if (_chatDmUnsub) _chatDmUnsub();
  if (_chatPresenceTimer) clearInterval(_chatPresenceTimer);
});

window.initChat = initChat;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PWA + PUSH NOTIFICATIONS + @MENTIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ Service Worker Registration ‚îÄ‚îÄ
async function registerServiceWorker() {
  if (!('serviceWorker' in navigator)) return null;
  try {
    const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
    console.log('[SW] Registered:', reg.scope);
    return reg;
  } catch (e) {
    console.warn('[SW] Registration failed:', e.message);
    return null;
  }
}

// ‚îÄ‚îÄ FCM Token Management ‚îÄ‚îÄ
async function requestNotificationPermission() {
  if (!messaging) return;
  if (!('Notification' in window)) return;

  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.log('[FCM] Notification permission denied');
      return;
    }

    const swReg = await navigator.serviceWorker.ready;
    const token = await getToken(messaging, {
      vapidKey: FCM_VAPID_KEY,
      serviceWorkerRegistration: swReg
    });

    if (token && window.userData?.uid) {
      // Store token in user's Firestore doc (array of tokens for multi-device)
      const userRef = doc(db, 'users', window.userData.uid);
      const userDoc = await getDoc(userRef);
      const existing = userDoc.exists() ? (userDoc.data().fcmTokens || []) : [];

      if (!existing.includes(token)) {
        existing.push(token);
        await setDoc(userRef, { fcmTokens: existing }, { merge: true });
        console.log('[FCM] Token saved to Firestore');
      } else {
        console.log('[FCM] Token already registered');
      }
    }
  } catch (e) {
    console.warn('[FCM] Token registration failed:', e.message);
  }
}

// ‚îÄ‚îÄ Foreground Message Handler ‚îÄ‚îÄ
function setupForegroundMessages() {
  if (!messaging) return;
  onMessage(messaging, (payload) => {
    console.log('[FCM] Foreground message:', payload);
    const { title, body } = payload.notification || {};
    const data = payload.data || {};

    // Don't show notification if user is actively viewing that channel
    if (_chatOpen && _chatChannel === data.channel) return;

    // Show a toast-style notification
    showChatToast(title || 'New Message', body || '', data.channel);
  });
}

function showChatToast(title, body, channel) {
  // Remove existing toast
  const old = document.getElementById('chatToast');
  if (old) old.remove();

  const toast = document.createElement('div');
  toast.id = 'chatToast';
  toast.style.cssText = 'position:fixed;top:16px;right:16px;background:#1c1917;color:#fff;padding:12px 18px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:10001;max-width:320px;cursor:pointer;animation:slideIn .3s ease;font-size:13px;';
  toast.innerHTML = `<div style="font-weight:700;margin-bottom:2px;">${title}</div><div style="opacity:.8;font-size:12px;">${body}</div>`;
  toast.onclick = () => {
    toast.remove();
    if (!_chatOpen) toggleChat();
    if (channel && !channel.startsWith('dm_')) switchChatChannel(channel);
  };
  document.body.appendChild(toast);
  setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
}

// ‚îÄ‚îÄ @Mention Autocomplete ‚îÄ‚îÄ
let _chatMentions = []; // Array of {uid, name} for current message
let _mentionActive = false;
let _mentionQuery = '';
let _mentionStartIdx = -1;
let _mentionSelectedIdx = 0;

function handleChatKeydown(event) {
  if (_mentionActive) {
    const popup = document.getElementById('chatMentionPopup');
    const items = popup ? popup.querySelectorAll('.chat-mention-item') : [];

    if (event.key === 'ArrowDown') {
      event.preventDefault();
      _mentionSelectedIdx = Math.min(_mentionSelectedIdx + 1, items.length - 1);
      _highlightMentionItem(items);
      return;
    }
    if (event.key === 'ArrowUp') {
      event.preventDefault();
      _mentionSelectedIdx = Math.max(_mentionSelectedIdx - 1, 0);
      _highlightMentionItem(items);
      return;
    }
    if (event.key === 'Enter' || event.key === 'Tab') {
      event.preventDefault();
      if (items[_mentionSelectedIdx]) {
        const uid = items[_mentionSelectedIdx].dataset.uid;
        const name = items[_mentionSelectedIdx].dataset.name;
        _insertMention(uid, name);
      }
      return;
    }
    if (event.key === 'Escape') {
      _closeMentionPopup();
      return;
    }
  }

  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendChatMessage();
  }
}
window.handleChatKeydown = handleChatKeydown;

function _onChatInputChange() {
  const input = document.getElementById('chatInput');
  if (!input) return;

  const val = input.value;
  const cursorPos = input.selectionStart;

  // Look backwards from cursor for an @ that starts a mention
  let atIdx = -1;
  for (let i = cursorPos - 1; i >= 0; i--) {
    if (val[i] === '@') { atIdx = i; break; }
    if (val[i] === ' ' && i < cursorPos - 1) break; // stop at space before query
  }

  if (atIdx >= 0 && (atIdx === 0 || val[atIdx - 1] === ' ')) {
    const queryStr = val.substring(atIdx + 1, cursorPos).toLowerCase();
    _mentionActive = true;
    _mentionQuery = queryStr;
    _mentionStartIdx = atIdx;
    _mentionSelectedIdx = 0;
    _renderMentionPopup(queryStr);
  } else {
    _closeMentionPopup();
  }
}

function _renderMentionPopup(q) {
  const popup = document.getElementById('chatMentionPopup');
  if (!popup) return;

  const filtered = _chatUsers.filter(u =>
    u.name.toLowerCase().includes(q) ||
    _formatChatName(u.name).toLowerCase().includes(q)
  ).slice(0, 8);

  if (!filtered.length) {
    popup.classList.remove('visible');
    return;
  }

  const statusColors = { active: '#22c55e', idle: '#f97316', offline: '#a1a1aa' };

  popup.innerHTML = filtered.map((u, i) => `
    <div class="chat-mention-item ${i === _mentionSelectedIdx ? 'active' : ''}"
         data-uid="${u.uid}" data-name="${u.name}"
         onclick="selectMention('${u.uid}','${u.name.replace(/'/g,"\\'")}')">
      <span class="mention-dot" style="background:${statusColors[u.status] || '#a1a1aa'};"></span>
      ${_formatChatName(u.name)}
    </div>
  `).join('');
  popup.classList.add('visible');
}

function _highlightMentionItem(items) {
  items.forEach((el, i) => {
    el.classList.toggle('active', i === _mentionSelectedIdx);
  });
}

function selectMention(uid, name) {
  _insertMention(uid, name);
}
window.selectMention = selectMention;

function _insertMention(uid, name) {
  const input = document.getElementById('chatInput');
  if (!input) return;

  const displayName = _formatChatName(name);
  const before = input.value.substring(0, _mentionStartIdx);
  const after = input.value.substring(input.selectionStart);
  input.value = before + '@' + displayName + ' ' + after;

  // Track this mention
  if (!_chatMentions.find(m => m.uid === uid)) {
    _chatMentions.push({ uid, name });
  }

  _closeMentionPopup();
  input.focus();
  const newPos = _mentionStartIdx + displayName.length + 2; // @name + space
  input.setSelectionRange(newPos, newPos);
}

function _closeMentionPopup() {
  _mentionActive = false;
  _mentionQuery = '';
  _mentionStartIdx = -1;
  const popup = document.getElementById('chatMentionPopup');
  if (popup) popup.classList.remove('visible');
}

// Attach input listener for @mention detection
setTimeout(() => {
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.addEventListener('input', _onChatInputChange);
  }
}, 500);

// ‚îÄ‚îÄ PWA Install Prompt ‚îÄ‚îÄ
let _deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  _deferredInstallPrompt = e;
  // Show install banner if not dismissed before
  if (!localStorage.getItem('pwa-install-dismissed')) {
    const banner = document.getElementById('pwaInstallBanner');
    if (banner) banner.style.display = 'flex';
  }
});

function installPWA() {
  if (!_deferredInstallPrompt) {
    // Already installed or not supported ‚Äî guide user
    alert('To install: tap your browser menu (‚ãÆ or Share) ‚Üí "Add to Home Screen" or "Install App"');
    return;
  }
  _deferredInstallPrompt.prompt();
  _deferredInstallPrompt.userChoice.then((result) => {
    console.log('[PWA] Install choice:', result.outcome);
    _deferredInstallPrompt = null;
    const banner = document.getElementById('pwaInstallBanner');
    if (banner) banner.style.display = 'none';
  });
}
window.installPWA = installPWA;

function dismissPwaInstall() {
  localStorage.setItem('pwa-install-dismissed', '1');
  const banner = document.getElementById('pwaInstallBanner');
  if (banner) banner.style.display = 'none';
}
window.dismissPwaInstall = dismissPwaInstall;

// ‚îÄ‚îÄ Initialize Push on Login ‚îÄ‚îÄ
async function initPushNotifications() {
  await registerServiceWorker();
  await requestNotificationPermission();
  setupForegroundMessages();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FEATURE 1: Morning Briefing / "The Drop"
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const BRIEF_QUOTES = [
  "The difference between ordinary and extraordinary is that little extra.",
  "Success is the sum of small efforts repeated day in and day out.",
  "Every sale begins with a conversation.",
  "Hustle beats talent when talent doesn't hustle.",
  "Be so good they can't ignore you.",
  "The best time to plant a tree was 20 years ago. The second best time is now.",
  "Winners are not people who never fail, but people who never quit.",
  "Your only limit is you.",
  "Don't watch the clock ‚Äî do what it does. Keep going.",
  "Champions keep playing until they get it right."
];

function getTodayKey() { return new Date().toISOString().slice(0,10); }

function hasDismissedMorningBriefing() {
  return localStorage.getItem('briefDismissed') === getTodayKey();
}

function getYesterdaySnapshot() {
  try { return JSON.parse(localStorage.getItem('briefSnapshot_prev') || 'null'); } catch(e) { return null; }
}

function saveTodaySnapshot(sales, bdc) {
  const today = getTodayKey();
  const prev = localStorage.getItem('briefSnapshot_today_date');
  if (prev && prev !== today) {
    const todayData = localStorage.getItem('briefSnapshot_today');
    if (todayData) localStorage.setItem('briefSnapshot_prev', todayData);
    localStorage.setItem('briefSnapshot_prev_date', prev);
  }
  const salesByUnits = [...sales].sort((a,b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown = [...bdc].sort((a,b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));
  const snapshot = {
    date: today,
    sales: salesByUnits.map((r,i) => ({ name:(r.name||'').toUpperCase(), rank:i+1, units:safeNum(r.sales), calls:safeNum(r.calls), shown:safeNum(shownVal(r)) })),
    bdc: bdcByShown.map((r,i) => ({ name:(r.name||'').toUpperCase(), rank:i+1, shown:safeNum(shownVal(r)), calls:safeNum(r.calls) }))
  };
  localStorage.setItem('briefSnapshot_today', JSON.stringify(snapshot));
  localStorage.setItem('briefSnapshot_today_date', today);
}

function showMorningBriefing(sales, bdc) {
  if (hasDismissedMorningBriefing()) return;
  const me = (window.userData?.linkedName || '').trim().toUpperCase();
  if (!me) return;

  const salesByUnits = [...sales].sort((a,b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown = [...bdc].sort((a,b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));
  const salesIdx = salesByUnits.findIndex(r => (r.name||'').toUpperCase() === me);
  const bdcIdx = bdcByShown.findIndex(r => (r.name||'').toUpperCase() === me);
  const inSales = salesIdx >= 0;
  const inBDC = bdcIdx >= 0;
  if (!inSales && !inBDC) return;

  const yesterday = getYesterdaySnapshot();
  let statsHtml = '';
  let moversHtml = '';

  if (inSales) {
    const r = salesByUnits[salesIdx];
    const rank = salesIdx + 1;
    const units = safeNum(r.sales);
    const calls = safeNum(r.calls);
    const shown = safeNum(shownVal(r));
    let rankDelta = '', unitsDelta = '', callsDelta = '';
    if (yesterday?.sales) {
      const yMe = yesterday.sales.find(x => x.name === me);
      if (yMe) {
        const rd = yMe.rank - rank;
        rankDelta = rd > 0 ? `<div class="brief-delta up">+${rd} rank</div>` : rd < 0 ? `<div class="brief-delta down">${rd} rank</div>` : `<div class="brief-delta flat">same</div>`;
        const ud = units - yMe.units;
        unitsDelta = ud > 0 ? `<div class="brief-delta up">+${ud}</div>` : `<div class="brief-delta flat">‚Äî</div>`;
        const cd = calls - yMe.calls;
        callsDelta = cd > 0 ? `<div class="brief-delta up">+${cd}</div>` : `<div class="brief-delta flat">‚Äî</div>`;
      }
    }
    statsHtml = `
      <div class="brief-stat"><div class="val">#${rank}</div><div class="lbl">Rank</div>${rankDelta}</div>
      <div class="brief-stat"><div class="val">${units}</div><div class="lbl">Units</div>${unitsDelta}</div>
      <div class="brief-stat"><div class="val">${calls}</div><div class="lbl">Calls</div>${callsDelta}</div>
      <div class="brief-stat"><div class="val">${shown}</div><div class="lbl">Shown</div></div>`;
    // Biggest movers
    if (yesterday?.sales) {
      const movers = salesByUnits.map((r2,i2) => {
        const yR = yesterday.sales.find(x => x.name === (r2.name||'').toUpperCase());
        return yR ? { name: r2.name, change: yR.rank - (i2+1) } : null;
      }).filter(x => x && x.change > 0).sort((a,b) => b.change - a.change).slice(0,3);
      if (movers.length) {
        moversHtml = `<div class="brief-movers"><h4>Biggest Movers</h4>${movers.map(m => `<div class="brief-mover"><span class="rank-change">+${m.change}</span> ${m.name}</div>`).join('')}</div>`;
      }
    }
  } else if (inBDC) {
    const r = bdcByShown[bdcIdx];
    const rank = bdcIdx + 1;
    const shown = safeNum(shownVal(r));
    const calls = safeNum(r.calls);
    let rankDelta = '', shownDelta = '';
    if (yesterday?.bdc) {
      const yMe = yesterday.bdc.find(x => x.name === me);
      if (yMe) {
        const rd = yMe.rank - rank;
        rankDelta = rd > 0 ? `<div class="brief-delta up">+${rd} rank</div>` : rd < 0 ? `<div class="brief-delta down">${rd} rank</div>` : `<div class="brief-delta flat">same</div>`;
        const sd = shown - yMe.shown;
        shownDelta = sd > 0 ? `<div class="brief-delta up">+${sd}</div>` : `<div class="brief-delta flat">‚Äî</div>`;
      }
    }
    statsHtml = `
      <div class="brief-stat"><div class="val">#${rank}</div><div class="lbl">Rank</div>${rankDelta}</div>
      <div class="brief-stat"><div class="val">${shown}</div><div class="lbl">Shown</div>${shownDelta}</div>
      <div class="brief-stat"><div class="val">${calls}</div><div class="lbl">Calls</div></div>`;
    if (yesterday?.bdc) {
      const movers = bdcByShown.map((r2,i2) => {
        const yR = yesterday.bdc.find(x => x.name === (r2.name||'').toUpperCase());
        return yR ? { name: r2.name, change: yR.rank - (i2+1) } : null;
      }).filter(x => x && x.change > 0).sort((a,b) => b.change - a.change).slice(0,3);
      if (movers.length) {
        moversHtml = `<div class="brief-movers"><h4>Biggest Movers</h4>${movers.map(m => `<div class="brief-mover"><span class="rank-change">+${m.change}</span> ${m.name}</div>`).join('')}</div>`;
      }
    }
  }

  const quote = BRIEF_QUOTES[Math.floor(Math.random() * BRIEF_QUOTES.length)];
  const firstName = (window.userData?.displayName || window.userData?.linkedName || 'there').split(' ')[0];
  const curHour = new Date().getHours();
  const greeting = curHour < 12 ? 'Good Morning' : curHour < 17 ? 'Good Afternoon' : 'Good Evening';
  const overlay = document.createElement('div');
  overlay.className = 'morning-briefing-overlay';
  overlay.id = 'morningBriefing';
  overlay.innerHTML = `
    <div class="morning-briefing-card">
      <h2>${greeting}, ${firstName}!</h2>
      <div class="subtitle">Your numbers are in ‚Äî here's today's snapshot</div>
      <div class="brief-stats">${statsHtml}</div>
      ${moversHtml}
      <div class="brief-quote">"${quote}"</div>
      <button class="brief-go-btn" onclick="dismissMorningBriefing()">Let's Go</button>
    </div>`;
  document.body.appendChild(overlay);
  // Safety net: click anywhere on overlay to dismiss (in case button doesn't render)
  overlay.addEventListener('click', function(e) { if (e.target === overlay) dismissMorningBriefing(); });
  // Safety net: auto-dismiss after 30 seconds in case user can't interact
  setTimeout(function() { if (document.getElementById('morningBriefing')) dismissMorningBriefing(); }, 30000);
}

function dismissMorningBriefing() {
  try { localStorage.setItem('briefDismissed', getTodayKey()); } catch(e) {}
  const el = document.getElementById('morningBriefing');
  if (el) { el.style.opacity = '0'; el.style.transition = 'opacity .3s'; setTimeout(function() { try { el.remove(); } catch(e) {} }, 300); }
  // Trigger milestone check after briefing dismissed
  try { setTimeout(function() { checkMilestones(); }, 500); } catch(e) {}
}
window.dismissMorningBriefing = dismissMorningBriefing;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MANAGER MORNING BRIEFING ‚Äî Team snapshot overlay
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function showManagerBriefing(sales, bdc) {
  const mgrBriefKey = 'mgrBriefDismissed';
  try { if (localStorage.getItem(mgrBriefKey) === getTodayKey()) return; } catch(e) {}

  const myUid = auth.currentUser?.uid;
  if (!myUid) return;

  // Fetch team members
  let teamMembers;
  try {
    const usersSnapshot = await getDocs(collection(db, 'users'));
    teamMembers = [];
    usersSnapshot.forEach(docu => {
      const u = docu.data();
      if (!u.deleted && u.managerId === myUid) teamMembers.push(u);
    });
  } catch(e) { return; }

  if (teamMembers.length === 0) return;

  const salesByUnits = [...sales].sort((a,b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown = [...bdc].sort((a,b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));

  let memberRows = '';
  let totalUnits = 0, totalCalls = 0, totalShown = 0;

  teamMembers.forEach(member => {
    const memberName = (member.linkedName || '').trim().toUpperCase();
    const display = member.displayName || member.email || memberName || '?';
    if (!memberName) {
      memberRows += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08);"><span style="flex:1;font-size:13px;opacity:.6;">${display}</span><span style="font-size:11px;color:#94a3b8;">Not linked</span></div>`;
      return;
    }

    const sIdx = salesByUnits.findIndex(r => (r.name||'').toUpperCase() === memberName);
    const bIdx = bdcByShown.findIndex(r => (r.name||'').toUpperCase() === memberName);

    if (sIdx >= 0) {
      const r = salesByUnits[sIdx];
      const rank = sIdx + 1;
      const units = safeNum(r.sales);
      const calls = safeNum(r.calls);
      totalUnits += units;
      totalCalls += calls;
      const emoji = rank <= 3 ? ['ü•á','ü•à','ü•â'][rank-1] : '#' + rank;
      memberRows += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;">
        <span style="min-width:30px;font-weight:700;">${emoji}</span>
        <span style="flex:1;font-weight:600;">${display}</span>
        <span style="min-width:50px;text-align:right;font-weight:800;">${units} units</span>
        <span style="min-width:50px;text-align:right;color:#94a3b8;">${calls} calls</span>
      </div>`;
    } else if (bIdx >= 0) {
      const r = bdcByShown[bIdx];
      const rank = bIdx + 1;
      const shown = safeNum(shownVal(r));
      const calls = safeNum(r.calls);
      totalShown += shown;
      totalCalls += calls;
      const emoji = rank <= 3 ? ['ü•á','ü•à','ü•â'][rank-1] : '#' + rank;
      memberRows += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;">
        <span style="min-width:30px;font-weight:700;">${emoji}</span>
        <span style="flex:1;font-weight:600;">${display}</span>
        <span style="min-width:50px;text-align:right;font-weight:800;">${shown} shown</span>
        <span style="min-width:50px;text-align:right;color:#94a3b8;">${calls} calls</span>
      </div>`;
    } else {
      memberRows += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;"><span style="min-width:30px;"></span><span style="flex:1;opacity:.6;">${display}</span><span style="color:#94a3b8;font-size:11px;">No data yet</span></div>`;
    }
  });

  const firstName = (window.userData?.displayName || window.userData?.email || 'Coach').split(' ')[0];
  const curHour = new Date().getHours();
  const greeting = curHour < 12 ? 'Good Morning' : curHour < 17 ? 'Good Afternoon' : 'Good Evening';

  // Wait for personal briefing to be dismissed first (or not shown)
  const waitForPersonalBriefing = () => new Promise(resolve => {
    const check = () => {
      if (!document.getElementById('morningBriefing')) resolve();
      else setTimeout(check, 500);
    };
    check();
  });
  await waitForPersonalBriefing();

  const overlay = document.createElement('div');
  overlay.className = 'morning-briefing-overlay';
  overlay.id = 'managerBriefing';
  overlay.innerHTML = `
    <div class="morning-briefing-card" style="max-width:520px;">
      <h2>${greeting}, ${firstName}!</h2>
      <div class="subtitle">Here's how your team is doing today</div>
      <div style="display:flex;gap:16px;justify-content:center;margin:14px 0;flex-wrap:wrap;">
        ${totalUnits > 0 ? `<div style="text-align:center;"><div style="font-size:24px;font-weight:800;">${totalUnits}</div><div style="font-size:11px;color:#94a3b8;">Team Units</div></div>` : ''}
        ${totalShown > 0 ? `<div style="text-align:center;"><div style="font-size:24px;font-weight:800;">${totalShown}</div><div style="font-size:11px;color:#94a3b8;">Team Shown</div></div>` : ''}
        <div style="text-align:center;"><div style="font-size:24px;font-weight:800;">${totalCalls}</div><div style="font-size:11px;color:#94a3b8;">Team Calls</div></div>
        <div style="text-align:center;"><div style="font-size:24px;font-weight:800;">${teamMembers.length}</div><div style="font-size:11px;color:#94a3b8;">Members</div></div>
      </div>
      <div style="text-align:left;max-height:220px;overflow-y:auto;margin:8px 0;">${memberRows}</div>
      <button class="brief-go-btn" onclick="dismissManagerBriefing()">Let's Go</button>
    </div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click', function(e) { if (e.target === overlay) dismissManagerBriefing(); });
  setTimeout(function() { if (document.getElementById('managerBriefing')) dismissManagerBriefing(); }, 45000);
}

function dismissManagerBriefing() {
  try { localStorage.setItem('mgrBriefDismissed', getTodayKey()); } catch(e) {}
  const el = document.getElementById('managerBriefing');
  if (el) { el.style.opacity = '0'; el.style.transition = 'opacity .3s'; setTimeout(function() { try { el.remove(); } catch(e) {} }, 300); }
}
window.dismissManagerBriefing = dismissManagerBriefing;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FEATURE 2: Streaks + Personal Bests
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function updateLoginStreak() {
  const uid = auth.currentUser?.uid;
  if (!uid) return;
  const ref = doc(db, 'users', uid);
  try {
    const snap = await getDoc(ref);
    if (!snap.exists()) return;
    const data = snap.data();
    const today = getTodayKey();
    const lastDate = data.streakLastDate || '';
    let streak = data.loginStreak || 0;
    if (lastDate === today) return; // already counted today
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yKey = yesterday.toISOString().slice(0,10);
    if (lastDate === yKey) {
      streak += 1;
    } else {
      streak = 1; // reset
    }
    await updateDoc(ref, { loginStreak: streak, streakLastDate: today });
    window._loginStreak = streak;
  } catch(e) { console.warn('Streak update failed:', e.message); }
}

function getStreakBadgeHtml() {
  const streak = window._loginStreak || 0;
  if (streak < 2) return '';
  let flames = 'üî•';
  if (streak >= 30) flames = 'üî•üî•üî•';
  else if (streak >= 14) flames = 'üî•üî•';
  return `<span class="streak-badge">${flames} ${streak}-day streak</span>`;
}

async function checkPersonalBests(sales, bdc) {
  const uid = auth.currentUser?.uid;
  if (!uid) return;
  const me = (window.userData?.linkedName || '').trim().toUpperCase();
  if (!me) return;

  const salesByUnits = [...sales].sort((a,b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown = [...bdc].sort((a,b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));
  const sIdx = salesByUnits.findIndex(r => (r.name||'').toUpperCase() === me);
  const bIdx = bdcByShown.findIndex(r => (r.name||'').toUpperCase() === me);

  let metrics = {};
  if (sIdx >= 0) {
    const r = salesByUnits[sIdx];
    metrics = { units: safeNum(r.sales), calls: safeNum(r.calls), shown: safeNum(shownVal(r)) };
  } else if (bIdx >= 0) {
    const r = bdcByShown[bIdx];
    metrics = { shown: safeNum(shownVal(r)), calls: safeNum(r.calls) };
  } else return;

  try {
    const ref = doc(db, 'users', uid);
    const snap = await getDoc(ref);
    const pbs = snap.data()?.personalBests || {};
    let newPBs = {};
    let anyNew = false;
    for (const [key, val] of Object.entries(metrics)) {
      if (val > (pbs[key] || 0)) {
        newPBs[key] = val;
        anyNew = true;
      }
    }
    if (anyNew) {
      const merged = { ...pbs, ...newPBs };
      await updateDoc(ref, { personalBests: merged });
      window._personalBests = merged;
      window._newPBs = newPBs;
    } else {
      window._personalBests = pbs;
      window._newPBs = {};
    }
  } catch(e) { console.warn('PB check failed:', e.message); }
}

function getPBBadge(metricKey) {
  if (window._newPBs && window._newPBs[metricKey]) {
    return '<span class="pb-badge">NEW PB!</span>';
  }
  return '';
}

function getPBAlertHtml() {
  if (!window._newPBs || Object.keys(window._newPBs).length === 0) return '';
  const names = Object.entries(window._newPBs).map(([k,v]) => `${k}: ${v}`).join(', ');
  return `<div class="pb-alert">New Personal Best! ${names}</div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FEATURE 3: Peer Kudos / Shoutouts
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _kudosUnsub = null;
let _kudosItems = [];

function initKudos() {
  if (_kudosUnsub) return;
  try {
    const q = query(collection(db, 'kudos'), orderBy('createdAt', 'desc'), limit(20));
    _kudosUnsub = onSnapshot(q, snap => {
      _kudosItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderKudosFeed();
    }, err => {
      console.warn('Kudos listener failed (index may not exist yet):', err.message);
    });
  } catch(e) { console.warn('Kudos init failed:', e.message); }
}

function renderKudosFeed() {
  const el = document.getElementById('kudosFeed');
  if (!el) return;
  if (_kudosItems.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:12px;font-size:13px;">No shoutouts yet ‚Äî be the first!</div>';
    return;
  }
  el.innerHTML = _kudosItems.slice(0, 5).map(k => {
    const initials = (k.fromName || '?').split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
    const time = k.createdAt?.toDate ? timeAgo(k.createdAt.toDate()) : '';
    const pinned = k.pinned ? ' kudos-pinned' : '';
    return `<div class="kudos-item${pinned}">
      <div class="kudos-avatar">${initials}</div>
      <div class="kudos-body">
        <strong>${k.fromName || 'Someone'}</strong> ‚Üí ${k.toName || 'Team'}
        <div>${k.message || ''}</div>
        <div class="kudos-time">${time}${k.pinned ? ' ¬∑ ‚≠ê Pinned' : ''}</div>
      </div>
    </div>`;
  }).join('');
}

function openKudosModal() {
  // Build user list from dashboard data
  const names = new Set();
  (dashboardData.sales || []).forEach(r => { if (r.name) names.add(r.name); });
  (dashboardData.bdc || []).forEach(r => { if (r.name) names.add(r.name); });
  const sorted = [...names].sort();
  const options = sorted.map(n => `<option value="${n}">${n}</option>`).join('');

  const modal = document.createElement('div');
  modal.className = 'kudos-modal-overlay';
  modal.id = 'kudosModal';
  modal.innerHTML = `
    <div class="kudos-modal">
      <h3>Give a Shoutout</h3>
      <select id="kudosRecipient"><option value="">Choose teammate...</option>${options}</select>
      <textarea id="kudosMessage" placeholder="Nice work on..."></textarea>
      <div class="actions">
        <button onclick="sendKudos()" style="background:var(--accent);color:#fff;">Send</button>
        <button onclick="closeKudosModal()" style="background:var(--line);color:var(--text);">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

async function sendKudos() {
  const to = document.getElementById('kudosRecipient')?.value;
  const msg = document.getElementById('kudosMessage')?.value?.trim();
  if (!to) { alert('Please select a teammate'); return; }
  if (!msg) { alert('Please write a message'); return; }
  const me = window.userData;
  try {
    await addDoc(collection(db, 'kudos'), {
      fromUid: auth.currentUser.uid,
      fromName: me?.displayName || me?.email || 'Someone',
      toName: to,
      message: msg,
      pinned: false,
      createdAt: serverTimestamp()
    });
    closeKudosModal();
  } catch(e) { alert('Failed to send: ' + e.message); }
}

function closeKudosModal() {
  document.getElementById('kudosModal')?.remove();
}

async function toggleKudosPin(kudosId) {
  if (!isAdmin() && !isManager()) return;
  const item = _kudosItems.find(k => k.id === kudosId);
  if (!item) return;
  try {
    await updateDoc(doc(db, 'kudos', kudosId), { pinned: !item.pinned });
  } catch(e) { console.warn('Pin toggle failed:', e.message); }
}

window.openKudosModal = openKudosModal;
window.sendKudos = sendKudos;
window.closeKudosModal = closeKudosModal;
window.toggleKudosPin = toggleKudosPin;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FEATURE 4: "Who's Gaining on You" Ticker
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildGainingTicker(sales, bdc) {
  const me = (window.userData?.linkedName || '').trim().toUpperCase();
  if (!me) return '';

  const salesByUnits = [...sales].sort((a,b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown = [...bdc].sort((a,b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));

  let html = '';

  const sIdx = salesByUnits.findIndex(r => (r.name||'').toUpperCase() === me);
  if (sIdx >= 0) {
    const myVal = safeNum(salesByUnits[sIdx].sales);
    // Who's behind
    if (sIdx < salesByUnits.length - 1) {
      const behind = salesByUnits[sIdx + 1];
      const gap = myVal - safeNum(behind.sales);
      if (gap <= 3) {
        html += `<span class="item behind-you">‚ö†Ô∏è ${behind.name} is ${gap} unit${gap !== 1 ? 's' : ''} behind you</span>`;
      }
    }
    // Who's ahead
    if (sIdx > 0) {
      const ahead = salesByUnits[sIdx - 1];
      const gap = safeNum(ahead.sales) - myVal;
      if (gap <= 3) {
        html += `<span class="item ahead">üéØ You're ${gap} unit${gap !== 1 ? 's' : ''} behind ${ahead.name} for #${sIdx}</span>`;
      }
    }
  }

  const bIdx = bdcByShown.findIndex(r => (r.name||'').toUpperCase() === me);
  if (bIdx >= 0) {
    const myVal = safeNum(shownVal(bdcByShown[bIdx]));
    if (bIdx < bdcByShown.length - 1) {
      const behind = bdcByShown[bIdx + 1];
      const gap = myVal - safeNum(shownVal(behind));
      if (gap <= 3) {
        html += `<span class="item behind-you">‚ö†Ô∏è ${behind.name} is ${gap} shown behind you</span>`;
      }
    }
    if (bIdx > 0) {
      const ahead = bdcByShown[bIdx - 1];
      const gap = safeNum(shownVal(ahead)) - myVal;
      if (gap <= 3) {
        html += `<span class="item ahead">üéØ You're ${gap} shown behind ${ahead.name} for #${bIdx}</span>`;
      }
    }
  }

  if (!html) return '';
  return `<div class="gaining-ticker"><span style="font-size:14px;">üèÉ</span>${html}</div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FEATURE 5: Morning Milestone Celebrations
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MILESTONE_THRESHOLDS = [5, 10, 15, 20, 25, 30, 40, 50];

function checkMilestones() {
  const today = getTodayKey();
  if (localStorage.getItem('milestoneChecked') === today) return;
  localStorage.setItem('milestoneChecked', today);

  const me = (window.userData?.linkedName || '').trim().toUpperCase();
  if (!me) return;

  const sales = dashboardData.sales || [];
  const bdc = dashboardData.bdc || [];
  const salesByUnits = [...sales].sort((a,b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown = [...bdc].sort((a,b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));
  const yesterday = getYesterdaySnapshot();

  const sIdx = salesByUnits.findIndex(r => (r.name||'').toUpperCase() === me);
  if (sIdx >= 0) {
    const units = safeNum(salesByUnits[sIdx].sales);
    const yUnits = yesterday?.sales?.find(x => x.name === me)?.units || 0;
    for (const t of MILESTONE_THRESHOLDS) {
      if (units >= t && yUnits < t) {
        fireMilestone(`${t} Units!`, `You just crossed ${t} units this month`);
        return;
      }
    }
    if (sIdx === 0) {
      const yRank = yesterday?.sales?.find(x => x.name === me)?.rank;
      if (yRank && yRank > 1) {
        fireMilestone('#1 Sales!', 'You just took the top spot');
        return;
      }
    }
  }

  const bIdx = bdcByShown.findIndex(r => (r.name||'').toUpperCase() === me);
  if (bIdx >= 0) {
    const shown = safeNum(shownVal(bdcByShown[bIdx]));
    const yShown = yesterday?.bdc?.find(x => x.name === me)?.shown || 0;
    for (const t of MILESTONE_THRESHOLDS) {
      if (shown >= t && yShown < t) {
        fireMilestone(`${t} Shown!`, `You just hit ${t} shown appointments`);
        return;
      }
    }
    if (bIdx === 0) {
      const yRank = yesterday?.bdc?.find(x => x.name === me)?.rank;
      if (yRank && yRank > 1) {
        fireMilestone('#1 BDC!', 'You just took the top spot');
        return;
      }
    }
  }
}

function fireMilestone(title, subtitle) {
  // Confetti
  const colors = ['#f97316','#ef4444','#eab308','#22c55e','#3b82f6','#a855f7','#ec4899'];
  for (let i = 0; i < 80; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = Math.random() * 100 + 'vw';
    piece.style.background = colors[Math.floor(Math.random() * colors.length)];
    piece.style.animationDuration = (2 + Math.random() * 2) + 's';
    piece.style.animationDelay = Math.random() * 0.5 + 's';
    piece.style.width = (6 + Math.random() * 6) + 'px';
    piece.style.height = (6 + Math.random() * 6) + 'px';
    document.body.appendChild(piece);
    setTimeout(() => piece.remove(), 4500);
  }
  // Toast
  const toast = document.createElement('div');
  toast.className = 'milestone-toast';
  toast.innerHTML = `<div style="font-size:40px;margin-bottom:8px;">üéâ</div><h2>${title}</h2><p>${subtitle}</p>`;
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity .5s'; setTimeout(() => toast.remove(), 500); }, 3500);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FEATURE 6: Trend Lines / Sparklines
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveMetricHistory(sales, bdc) {
  const me = (window.userData?.linkedName || '').trim().toUpperCase();
  if (!me) return;
  const today = getTodayKey();
  let history = {};
  try { history = JSON.parse(localStorage.getItem('metricHistory') || '{}'); } catch(e) {}

  const salesByUnits = [...sales].sort((a,b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown = [...bdc].sort((a,b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));
  const sIdx = salesByUnits.findIndex(r => (r.name||'').toUpperCase() === me);
  const bIdx = bdcByShown.findIndex(r => (r.name||'').toUpperCase() === me);

  let entry = { date: today };
  if (sIdx >= 0) {
    entry.primary = safeNum(salesByUnits[sIdx].sales);
    entry.calls = safeNum(salesByUnits[sIdx].calls);
    entry.type = 'sales';
  } else if (bIdx >= 0) {
    entry.primary = safeNum(shownVal(bdcByShown[bIdx]));
    entry.calls = safeNum(bdcByShown[bIdx].calls);
    entry.type = 'bdc';
  } else return;

  history[today] = entry;
  // Keep only last 31 days
  const keys = Object.keys(history).sort().slice(-31);
  const trimmed = {};
  keys.forEach(k => trimmed[k] = history[k]);
  localStorage.setItem('metricHistory', JSON.stringify(trimmed));
}

function buildSparklines() {
  let history = {};
  try { history = JSON.parse(localStorage.getItem('metricHistory') || '{}'); } catch(e) {}
  const keys = Object.keys(history).sort();
  if (keys.length < 2) return '';

  const primaryVals = keys.map(k => history[k].primary || 0);
  const callsVals = keys.map(k => history[k].calls || 0);
  const type = history[keys[keys.length - 1]]?.type === 'bdc' ? 'Shown' : 'Units';

  function makeSvg(vals, color) {
    const w = 120, h = 30;
    const max = Math.max(...vals, 1);
    const min = Math.min(...vals);
    const range = max - min || 1;
    const points = vals.map((v, i) => {
      const x = (i / (vals.length - 1)) * w;
      const y = h - ((v - min) / range) * (h - 4) - 2;
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    });
    const areaPoints = points.join(' ') + ` ${w},${h} 0,${h}`;
    return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
      <polygon points="${areaPoints}" fill="${color}" opacity="0.15"/>
      <polyline points="${points.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
  }

  // Pace: compare last 3 days trend
  let pace = 'flat';
  if (primaryVals.length >= 3) {
    const last3 = primaryVals.slice(-3);
    if (last3[2] > last3[1] && last3[1] > last3[0]) pace = 'up';
    else if (last3[2] < last3[1] && last3[1] < last3[0]) pace = 'down';
  }
  const paceLabel = pace === 'up' ? 'Accelerating' : pace === 'down' ? 'Slowing down' : 'Steady pace';
  const paceClass = pace === 'up' ? 'pace-up' : pace === 'down' ? 'pace-down' : 'pace-flat';

  return `
    <div class="sparkline-row">
      <div class="sparkline-item">
        <span class="spark-label">${type}</span>
        ${makeSvg(primaryVals, '#f97316')}
      </div>
      <div class="sparkline-item">
        <span class="spark-label">Calls</span>
        ${makeSvg(callsVals, '#3b82f6')}
      </div>
      <span class="pace-indicator ${paceClass}">${paceLabel}</span>
    </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üì§ UPLOAD CALL DATA & üéôÔ∏è RECORDINGS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ State for uploaded call data ‚îÄ‚îÄ
let _uploadedCallRows = [];
let _uploadedFileName = '';

function openUploadCallsModal() {
  if (!isAdmin()) { alert('Only admins can upload call data.'); return; }
  logPageView('Upload Call Data');
  const modal = document.getElementById('uploadCallsModal');
  modal.classList.add('active');

  // Wire up drag-and-drop
  const dz = document.getElementById('callDropZone');
  dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('dragover'); };
  dz.ondragleave = () => { dz.classList.remove('dragover'); };
  dz.ondrop = (e) => {
    e.preventDefault();
    dz.classList.remove('dragover');
    const file = e.dataTransfer.files?.[0];
    if (file) handleCallFile(file);
  };
}

function closeUploadCallsModal() {
  document.getElementById('uploadCallsModal').classList.remove('active');
}

function clearCallUpload() {
  _uploadedCallRows = [];
  _uploadedFileName = '';
  document.getElementById('callFileInput').value = '';
  document.getElementById('callUploadFileName').style.display = 'none';
  document.getElementById('callUploadPreview').innerHTML = '';
  document.getElementById('callUploadActions').style.display = 'none';
  document.getElementById('callMatchResult').innerHTML = '';
}

function callFileSelected(input) {
  const file = input.files?.[0];
  if (file) handleCallFile(file);
}

function handleCallFile(file) {
  _uploadedFileName = file.name;
  document.getElementById('callUploadFileName').textContent = file.name;
  document.getElementById('callUploadFileName').style.display = 'block';
  document.getElementById('callUploadPreview').innerHTML = '<div style="color:var(--muted);font-size:13px;">Parsing file...</div>';

  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'csv') {
    const reader = new FileReader();
    reader.onload = (e) => parseCallCsv(e.target.result);
    reader.readAsText(file);
  } else if (ext === 'xlsx' || ext === 'xls') {
    if (!window.XLSX) {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      s.onload = () => readCallXlsx(file);
      s.onerror = () => { alert('Could not load spreadsheet library. Try a .csv file instead.'); };
      document.head.appendChild(s);
    } else {
      readCallXlsx(file);
    }
  } else {
    alert('Please upload a .csv, .xlsx, or .xls file.');
  }
}

function readCallXlsx(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const jsonRows = XLSX.utils.sheet_to_json(ws, { defval: '' });
      processCallRows(jsonRows);
    } catch (err) {
      document.getElementById('callUploadPreview').innerHTML = `<div style="color:#dc2626;">Error reading file: ${err.message}</div>`;
    }
  };
  reader.readAsArrayBuffer(file);
}

function parseCallCsv(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) {
    document.getElementById('callUploadPreview').innerHTML = '<div style="color:#dc2626;">File appears empty or has no data rows.</div>';
    return;
  }
  // Parse header
  const headers = parseCsvLine(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCsvLine(lines[i]);
    if (vals.length === 0 || vals.every(v => !v.trim())) continue;
    const row = {};
    headers.forEach((h, idx) => { row[h.trim()] = (vals[idx] || '').trim(); });
    rows.push(row);
  }
  processCallRows(rows);
}

function parseCsvLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (inQuotes) {
      if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; }
      else if (ch === '"') { inQuotes = false; }
      else { current += ch; }
    } else {
      if (ch === '"') { inQuotes = true; }
      else if (ch === ',') { result.push(current); current = ''; }
      else { current += ch; }
    }
  }
  result.push(current);
  return result;
}

function normalizeCallHeaders(row) {
  // Map common header names to standard fields
  const mapped = {};
  const keyMap = {
    'phone': ['phone', 'phone number', 'phonenumber', 'phone_number', 'caller', 'caller_number', 'from', 'ani'],
    'name': ['name', 'customer', 'customer name', 'customername', 'customer_name', 'caller_name', 'callername', 'contact', 'contact_name'],
    'date': ['date', 'call date', 'calldate', 'call_date', 'datetime', 'date_time', 'timestamp', 'time', 'call_time', 'calltime'],
    'duration': ['duration', 'call duration', 'callduration', 'call_duration', 'length', 'call_length', 'talk_time', 'talktime'],
    'direction': ['direction', 'call direction', 'type', 'call_type', 'calltype', 'call type', 'inbound_outbound'],
    'agent': ['agent', 'rep', 'representative', 'salesperson', 'sales_person', 'user', 'employee', 'bdc_agent', 'bdcagent', 'assigned', 'answered_by'],
    'status': ['status', 'disposition', 'result', 'call_result', 'outcome', 'call_status'],
    'recording': ['recording', 'recording_url', 'recordingurl', 'recording url', 'audio', 'audio_url', 'link', 'url', 'call_recording'],
    'source': ['source', 'call_source', 'campaign', 'tracking_number', 'tracking'],
    'notes': ['notes', 'note', 'comments', 'comment', 'memo']
  };
  for (const [rawKey, rawVal] of Object.entries(row)) {
    const lower = rawKey.toLowerCase().trim().replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
    const lowerOrig = rawKey.toLowerCase().trim();
    let matched = false;
    for (const [stdKey, aliases] of Object.entries(keyMap)) {
      if (aliases.includes(lowerOrig) || aliases.includes(lower)) {
        mapped[stdKey] = rawVal;
        matched = true;
        break;
      }
    }
    if (!matched) mapped[rawKey] = rawVal;
  }
  return mapped;
}

function processCallRows(rawRows) {
  _uploadedCallRows = rawRows.map(r => normalizeCallHeaders(r));

  // Show preview stats
  const total = _uploadedCallRows.length;
  const withPhone = _uploadedCallRows.filter(r => r.phone).length;
  const withAgent = _uploadedCallRows.filter(r => r.agent).length;
  const withRecording = _uploadedCallRows.filter(r => r.recording).length;

  let html = `
    <div class="upload-stats">
      <div class="stat"><strong>${total}</strong> call records</div>
      <div class="stat"><strong>${withPhone}</strong> with phone #</div>
      <div class="stat"><strong>${withAgent}</strong> with agent</div>
      <div class="stat"><strong>${withRecording}</strong> with recording</div>
    </div>`;

  // Show first 5 rows as preview
  if (_uploadedCallRows.length > 0) {
    const previewCols = ['name', 'phone', 'date', 'duration', 'agent', 'direction', 'status'];
    const hasCols = previewCols.filter(c => _uploadedCallRows.some(r => r[c]));
    html += `<div style="overflow-x:auto;"><table class="upload-preview-table"><thead><tr>`;
    hasCols.forEach(c => { html += `<th>${c.charAt(0).toUpperCase() + c.slice(1)}</th>`; });
    html += `</tr></thead><tbody>`;
    _uploadedCallRows.slice(0, 5).forEach(r => {
      html += '<tr>';
      hasCols.forEach(c => { html += `<td>${r[c] || '‚Äì'}</td>`; });
      html += '</tr>';
    });
    if (_uploadedCallRows.length > 5) {
      html += `<tr><td colspan="${hasCols.length}" style="color:var(--muted);font-style:italic;">...and ${_uploadedCallRows.length - 5} more rows</td></tr>`;
    }
    html += `</tbody></table></div>`;
  }

  document.getElementById('callUploadPreview').innerHTML = html;
  document.getElementById('callUploadActions').style.display = 'block';
}

// ‚îÄ‚îÄ Save uploaded call data to Firestore ‚îÄ‚îÄ
async function saveUploadedCallData() {
  if (!isAdmin()) { alert('Only admins.'); return; }
  if (_uploadedCallRows.length === 0) { alert('No call data to save.'); return; }

  const btn = document.getElementById('saveCallDataBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    const now = new Date();
    const uploadId = 'upload_' + now.getTime();

    // Save the full upload as a document in callUploads collection
    await setDoc(doc(db, 'callUploads', uploadId), {
      fileName: _uploadedFileName,
      uploadedBy: window.userData.email,
      uploadedAt: now,
      rowCount: _uploadedCallRows.length,
      rows: JSON.stringify(_uploadedCallRows)
    });

    // Also write per-agent call records to callRecordings/{AGENT_NAME} for the Recordings page
    const byAgent = {};
    _uploadedCallRows.forEach(r => {
      const agent = (r.agent || 'UNASSIGNED').toUpperCase().trim();
      if (!byAgent[agent]) byAgent[agent] = [];
      byAgent[agent].push({
        name: r.name || '',
        phone: r.phone || '',
        date: r.date || '',
        duration: r.duration || '',
        direction: r.direction || '',
        status: r.status || '',
        recording: r.recording || '',
        source: r.source || '',
        notes: r.notes || '',
        uploadId: uploadId
      });
    });

    const writePromises = Object.entries(byAgent).map(([agent, calls]) => {
      return setDoc(doc(db, 'callRecordings', agent), {
        agent: agent,
        calls: JSON.stringify(calls),
        lastUpdated: now,
        updatedBy: window.userData.email
      }, { merge: true });
    });
    await Promise.all(writePromises);

    btn.textContent = 'Saved!';
    btn.style.background = '#16a34a';
    document.getElementById('callMatchResult').innerHTML = `
      <div class="match-result success">
        Saved ${_uploadedCallRows.length} call records across ${Object.keys(byAgent).length} agents to Firestore.
      </div>`;
    setTimeout(() => { btn.disabled = false; btn.textContent = 'Save Call Data'; btn.style.background = 'var(--green)'; }, 2000);
  } catch (e) {
    btn.disabled = false;
    btn.textContent = 'Save Call Data';
    document.getElementById('callMatchResult').innerHTML = `<div class="match-result error">Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ Match uploaded calls to leads in call sheets ‚îÄ‚îÄ
async function matchCallsToLeads() {
  if (!isAdmin()) { alert('Only admins.'); return; }
  if (_uploadedCallRows.length === 0) { alert('No call data to match.'); return; }

  const btn = document.getElementById('matchCallsBtn');
  btn.disabled = true;
  btn.textContent = 'Matching...';

  try {
    // Gather all person snapshots that have callList data
    const snapshotsRef = collection(db, 'personSnapshots');
    const snapDocs = await getDocs(snapshotsRef);

    // Build a lookup of leads by phone number and by name
    const leadsByPhone = {};  // phone ‚Üí [{ personName, lead }]
    const leadsByName = {};   // name.upper ‚Üí [{ personName, lead }]
    let totalLeads = 0;

    snapDocs.forEach(d => {
      try {
        const raw = d.data();
        const payload = JSON.parse(raw.jsonData || '{}');
        const calls = payload.callList?.calls || [];
        const personName = d.id;
        calls.forEach(lead => {
          totalLeads++;
          if (lead.phone) {
            const ph = lead.phone.replace(/\D/g, '').slice(-10);
            if (ph.length === 10) {
              if (!leadsByPhone[ph]) leadsByPhone[ph] = [];
              leadsByPhone[ph].push({ personName, lead });
            }
          }
          if (lead.name) {
            const nm = lead.name.toUpperCase().trim();
            if (!leadsByName[nm]) leadsByName[nm] = [];
            leadsByName[nm].push({ personName, lead });
          }
        });
      } catch (_) {}
    });

    // Match uploaded calls to leads
    let matched = 0;
    let unmatched = 0;
    const matchResults = [];

    _uploadedCallRows.forEach(call => {
      let matchedLead = null;

      // Try phone match first (most reliable)
      if (call.phone) {
        const ph = call.phone.replace(/\D/g, '').slice(-10);
        if (ph.length === 10 && leadsByPhone[ph]) {
          matchedLead = leadsByPhone[ph][0];
        }
      }

      // Fallback: try name match
      if (!matchedLead && call.name) {
        const nm = call.name.toUpperCase().trim();
        if (leadsByName[nm]) {
          matchedLead = leadsByName[nm][0];
        }
      }

      if (matchedLead) {
        matched++;
        matchResults.push({
          call,
          matchedTo: matchedLead.personName,
          matchedLead: matchedLead.lead
        });
      } else {
        unmatched++;
      }
    });

    // Save match results to Firestore for each person
    const matchesByPerson = {};
    matchResults.forEach(m => {
      const person = m.matchedTo;
      if (!matchesByPerson[person]) matchesByPerson[person] = [];
      matchesByPerson[person].push({
        callPhone: m.call.phone || '',
        callName: m.call.name || '',
        callDate: m.call.date || '',
        callDuration: m.call.duration || '',
        callDirection: m.call.direction || '',
        callRecording: m.call.recording || '',
        callAgent: m.call.agent || '',
        leadName: m.matchedLead.name || '',
        leadLink: m.matchedLead.link || '',
        leadPhone: m.matchedLead.phone || ''
      });
    });

    const now = new Date();
    const matchWrites = Object.entries(matchesByPerson).map(([person, matches]) => {
      return setDoc(doc(db, 'callMatches', person), {
        matches: JSON.stringify(matches),
        lastUpdated: now,
        updatedBy: window.userData.email,
        matchCount: matches.length
      }, { merge: true });
    });
    await Promise.all(matchWrites);

    const pct = _uploadedCallRows.length > 0 ? Math.round((matched / _uploadedCallRows.length) * 100) : 0;
    const resultClass = pct >= 60 ? 'success' : pct >= 30 ? 'warning' : 'error';
    document.getElementById('callMatchResult').innerHTML = `
      <div class="match-result ${resultClass}">
        <strong>Match Results:</strong> ${matched} of ${_uploadedCallRows.length} calls matched (${pct}%)<br>
        <span style="font-size:12px;">Matched across ${Object.keys(matchesByPerson).length} people out of ${totalLeads} total leads in call sheets. ${unmatched} calls could not be matched.</span>
      </div>`;

    btn.textContent = 'Matched!';
    setTimeout(() => { btn.disabled = false; btn.textContent = 'Match Calls to Leads'; }, 2000);
  } catch (e) {
    btn.disabled = false;
    btn.textContent = 'Match Calls to Leads';
    document.getElementById('callMatchResult').innerHTML = `<div class="match-result error">Error: ${e.message}</div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//   üéôÔ∏è RECORDINGS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function showRecordings() {
  if (!isAdmin() && !isManager()) { alert('Only admins and managers can view recordings.'); return; }
  trackClick();
  logPageView('Recordings');

  const appEl = document.getElementById('app');
  appEl.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üéôÔ∏è Recordings</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Click on a team member to view their latest call recordings</p>
        </div>
        <div style="display:flex;gap:8px;">
          ${isAdmin() ? '<button class="topbar-btn manage" onclick="openUploadCallsModal()">üì§ Upload Calls</button>' : ''}
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>
      <div id="recordingsContent"><div class="loading-wrap"><div class="spinner"></div></div></div>
    </div>`;

  try {
    // Fetch all users to build user cards
    const usersSnapshot = await getDocs(collection(db, 'users'));
    const users = [];
    usersSnapshot.forEach(d => {
      const u = d.data();
      if (u.deleted) return;
      const linked = (u.linkedName || '').toUpperCase().trim();
      if (!linked) return;
      users.push({
        uid: d.id,
        email: u.email || '',
        displayName: u.displayName || u.email || '',
        linkedName: linked,
        role: u.role || 'user',
        managerId: u.managerId || ''
      });
    });

    // If manager (not admin), only show their team members
    let visibleUsers = users;
    if (isManager() && !isAdmin()) {
      const myUid = auth.currentUser?.uid;
      visibleUsers = users.filter(u => u.managerId === myUid || u.uid === myUid);
    }

    // Fetch call recording counts from Firestore
    const recSnap = await getDocs(collection(db, 'callRecordings'));
    const recCounts = {};
    recSnap.forEach(d => {
      try {
        const data = d.data();
        const calls = JSON.parse(data.calls || '[]');
        recCounts[d.id] = calls.length;
      } catch (_) { recCounts[d.id] = 0; }
    });

    visibleUsers.sort((a, b) => a.displayName.toLowerCase().localeCompare(b.displayName.toLowerCase()));

    if (visibleUsers.length === 0) {
      document.getElementById('recordingsContent').innerHTML = '<p style="color:var(--muted);text-align:center;padding:40px;">No team members found with linked names.</p>';
      return;
    }

    let html = '<div class="rec-user-grid">';
    visibleUsers.forEach(u => {
      const count = recCounts[u.linkedName] || 0;
      const roleBadge = u.role === 'admin' || u.role === 'superadmin' ? 'Admin' : u.role === 'manager' ? 'Manager' : 'Rep';
      html += `
        <div class="rec-user-card" onclick="showUserRecordings('${u.linkedName.replace(/'/g, "\\'")}', '${u.displayName.replace(/'/g, "\\'")}')">
          <div class="name">${u.displayName}</div>
          <span class="role-badge">${roleBadge}</span>
          <div class="call-count">${count > 0 ? count + ' call recording' + (count !== 1 ? 's' : '') : 'No recordings yet'}</div>
        </div>`;
    });
    html += '</div>';

    document.getElementById('recordingsContent').innerHTML = html;
  } catch (e) {
    document.getElementById('recordingsContent').innerHTML = `<p style="color:#dc2626;text-align:center;padding:40px;">Error: ${e.message}</p>`;
  }
}

async function showUserRecordings(linkedName, displayName) {
  if (!isAdmin() && !isManager()) { alert('Only admins and managers.'); return; }
  trackClick();
  logPageView('Recordings: ' + displayName);

  const appEl = document.getElementById('app');
  appEl.innerHTML = `
    <div style="max-width:1000px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">üéôÔ∏è ${displayName}'s Recordings</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Sorted by most recent</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="showRecordings()">‚Üê All Users</button>
          <button class="topbar-btn manage" onclick="showDashboard()">‚Üê Dashboard</button>
        </div>
      </div>
      <div id="userRecContent"><div class="loading-wrap"><div class="spinner"></div></div></div>
    </div>`;

  try {
    const recDoc = await getDoc(doc(db, 'callRecordings', linkedName));
    let calls = [];
    if (recDoc.exists()) {
      calls = JSON.parse(recDoc.data().calls || '[]');
    }

    // Also check callMatches for matched recording data
    const matchDoc = await getDoc(doc(db, 'callMatches', linkedName));
    let matches = [];
    if (matchDoc.exists()) {
      matches = JSON.parse(matchDoc.data().matches || '[]');
    }

    // Merge matched call data: enrich call records with lead info
    const matchByPhone = {};
    matches.forEach(m => {
      if (m.callPhone) {
        const ph = m.callPhone.replace(/\D/g, '').slice(-10);
        if (ph.length === 10) matchByPhone[ph] = m;
      }
    });

    calls.forEach(c => {
      if (c.phone) {
        const ph = c.phone.replace(/\D/g, '').slice(-10);
        if (ph.length === 10 && matchByPhone[ph]) {
          c._matchedLead = matchByPhone[ph];
        }
      }
    });

    // Sort by date descending (most recent first)
    calls.sort((a, b) => {
      const da = parseCallDate(a.date);
      const db2 = parseCallDate(b.date);
      return db2 - da;
    });

    if (calls.length === 0) {
      document.getElementById('userRecContent').innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--muted);">
          <div style="font-size:36px;margin-bottom:8px;">üéôÔ∏è</div>
          <p>No call recordings found for ${displayName}.</p>
          ${isAdmin() ? '<p style="font-size:13px;">Use <strong>Upload Calls</strong> to add call data.</p>' : ''}
        </div>`;
      return;
    }

    let html = `
      <div style="margin-bottom:12px;font-size:13px;color:var(--muted);">${calls.length} recording${calls.length !== 1 ? 's' : ''} found</div>
      <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;overflow:hidden;">`;

    calls.forEach((c, i) => {
      const customerName = c.name || c._matchedLead?.leadName || 'Unknown';
      const phone = c.phone || '‚Äì';
      const date = c.date || '‚Äì';
      const duration = formatCallDuration(c.duration);
      const direction = c.direction || '';
      const dirIcon = direction.toLowerCase().includes('inbound') || direction.toLowerCase().includes('in') ? 'üì•' : direction.toLowerCase().includes('outbound') || direction.toLowerCase().includes('out') ? 'üì§' : 'üìû';
      const status = c.status || '';
      const recording = c.recording || c._matchedLead?.callRecording || '';
      const leadLink = c._matchedLead?.leadLink || '';
      const source = c.source || '';

      const statusBadge = status ? `<span style="display:inline-block;font-size:10px;padding:1px 6px;border-radius:4px;background:${status.toLowerCase().includes('answer') || status.toLowerCase().includes('connect') ? 'var(--greenBg);color:#15803d' : status.toLowerCase().includes('miss') || status.toLowerCase().includes('abandon') ? 'var(--redBg);color:#dc2626' : '#f4f4f5;color:var(--muted)'};">${status}</span>` : '';

      html += `
        <div class="rec-call-row" style="${i > 0 ? '' : 'border-top:none;'}">
          <div>
            <div class="caller">
              ${dirIcon} ${leadLink ? `<a href="${leadLink}" target="_blank" rel="noopener" style="color:#2563eb;text-decoration:underline;">${customerName}</a>` : customerName}
              ${statusBadge}
            </div>
            <div class="meta">
              ${phone !== '‚Äì' ? phone + ' ¬∑ ' : ''}${source ? source + ' ¬∑ ' : ''}${date}
              ${recording ? ` ¬∑ <a href="${recording}" target="_blank" rel="noopener" style="color:#2563eb;font-size:11px;">Play Recording</a>` : ''}
            </div>
          </div>
          <div>
            <div class="duration">${duration}</div>
            <div class="time">${direction || '‚Äì'}</div>
          </div>
        </div>`;
    });

    html += '</div>';
    document.getElementById('userRecContent').innerHTML = html;
  } catch (e) {
    document.getElementById('userRecContent').innerHTML = `<p style="color:#dc2626;text-align:center;padding:40px;">Error: ${e.message}</p>`;
  }
}

function parseCallDate(dateStr) {
  if (!dateStr) return 0;
  const d = new Date(dateStr);
  return isNaN(d.getTime()) ? 0 : d.getTime();
}

function formatCallDuration(dur) {
  if (!dur) return '‚Äì';
  // If it's already formatted like "2:30" or "02:30:00", return as-is
  if (typeof dur === 'string' && dur.includes(':')) return dur;
  // If numeric (seconds), format
  const secs = parseInt(dur, 10);
  if (isNaN(secs)) return dur;
  if (secs < 60) return secs + 's';
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return m + ':' + String(s).padStart(2, '0');
}

// ‚îÄ‚îÄ Window exports for new features ‚îÄ‚îÄ
window.openUploadCallsModal = openUploadCallsModal;
window.closeUploadCallsModal = closeUploadCallsModal;
window.callFileSelected = callFileSelected;
window.clearCallUpload = clearCallUpload;
window.saveUploadedCallData = saveUploadedCallData;
window.matchCallsToLeads = matchCallsToLeads;
window.showRecordings = showRecordings;
window.showUserRecordings = showUserRecordings;

/* Boot */
if (auth.currentUser) { showDashboard(); } else { showLogin(); }
</script>
</body>
</html>

