<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Store Dashboard — Leaderboards & 1on1s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #fafafa; }
      header { background:#111; color:#fff; padding:14px 18px; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      h2 { margin: 18px 0 8px; font-size: 18px; }
      table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid #e8e8e8; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
      th { background:#fcfcfc; font-weight: 600; }
      a { color: #0a66c2; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .two { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
      .card { background:#fff; border:1px solid #e8e8e8; border-radius: 10px; padding: 14px; }
      .muted { color:#666; font-size: 12px; }
      .pill { display:inline-block; background:#eef6ff; color:#145aa6; padding:3px 8px; border-radius:999px; font-size:12px; }
      .kvs { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; margin:10px 0 0; }
      .kv { background:#f9fafb; border:1px solid #eee; border-radius:8px; padding:8px; text-align:center; }
      .kv .n { font-weight:700; font-size:18px; }
      .call { background:#fff; border:1px solid #e8e8e8; border-radius:8px; padding:10px; margin:8px 0; }
      .call a { display:inline-block; margin-top:4px; }
      .back { display:inline-block; margin-bottom:12px; }
      @media (max-width: 900px) { .two { grid-template-columns: 1fr; } .kvs { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    </style>
  </head>
  <body>
    <header><div class="wrap">
      <h1>Store Dashboard</h1>
      <div class="muted">Leaderboards & 1on1s</div>
    </div></header>
    <div class="wrap">
      <div id="app">
        <div class="two">
          <div class="card">
            <h2>Sales Leaderboard <span class="pill">Sales (MTD)</span></h2>
            <table>
              <thead><tr><th>#</th><th>Rep</th><th>Sales</th><th colspan="2">Extras</th></tr></thead>
              <tbody id="salesBody"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
            </table>
          </div>
          <div class="card">
            <h2>BDC Leaderboard <span class="pill">Shows (MTD)</span></h2>
            <table>
              <thead><tr><th>#</th><th>Agent</th><th>Shows</th><th>Created</th></tr></thead>
              <tbody id="bdcBody"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // CONFIG: Your Apps Script Web App URL (must end with /exec)
      var GAS_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';

      function qs(id){ return document.getElementById(id); }
      function navToPerson(name, type){
        location.hash = '#/person/' + encodeURIComponent(String(name||'')) + '/' + encodeURIComponent(String(type||''));
        location.reload();
      }
      function clearBody(tbodyId, cols){
        var tb = qs(tbodyId);
        while (tb.firstChild) tb.removeChild(tb.firstChild);
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.colSpan = cols;
        td.className = 'muted';
        td.textContent = 'No data';
        tr.appendChild(td);
        tb.appendChild(tr);
      }
      function fillHome(){
        fetch(GAS_URL + '?route=leaderboards&t=' + Date.now(), { cache: 'no-store' })
          .then(function(r){ return r.json(); })
          .then(function(data){
            if(!data || !data.ok){ throw new Error((data && data.error) || 'API error'); }
            var sales = Array.isArray(data.sales) ? data.sales : [];
            var bdc   = Array.isArray(data.bdc)   ? data.bdc   : [];

            // Fill Sales
            var sBody = qs('salesBody');
            sBody.innerHTML = '';
            if (!sales.length){
              var tr = document.createElement('tr'); var td=document.createElement('td');
              td.colSpan = 5; td.className='muted'; td.textContent='No data'; tr.appendChild(td); sBody.appendChild(tr);
            } else {
              sales.forEach(function(r, i){
                var tr = document.createElement('tr');
                var tdRank = document.createElement('td'); tdRank.textContent = (i+1);
                var tdName = document.createElement('td'); var a = document.createElement('a');
                a.href = 'javascript:void(0)'; a.textContent = r.name || '';
                a.onclick = function(){ navToPerson(r.name, 'Sales'); };
                tdName.appendChild(a);
                var tdSales = document.createElement('td'); tdSales.textContent = (r.sales!=null?r.sales:0);
                var tdCalls = document.createElement('td'); tdCalls.className='muted'; tdCalls.textContent = (r.calls!=null?r.calls:0) + ' calls';
                var tdTexts = document.createElement('td'); tdTexts.className='muted'; tdTexts.textContent = (r.texts!=null?r.texts:0) + ' texts';
                tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdSales); tr.appendChild(tdCalls); tr.appendChild(tdTexts);
                sBody.appendChild(tr);
              });
            }

            // Fill BDC
            var bBody = qs('bdcBody');
            bBody.innerHTML = '';
            if (!bdc.length){
              var tr2 = document.createElement('tr'); var td2=document.createElement('td');
              td2.colSpan = 4; td2.className='muted'; td2.textContent='No data'; tr2.appendChild(td2); bBody.appendChild(tr2);
            } else {
              bdc.forEach(function(r, i){
                var tr = document.createElement('tr');
                var tdRank = document.createElement('td'); tdRank.textContent = (i+1);
                var tdName = document.createElement('td'); var a2 = document.createElement('a');
                a2.href = 'javascript:void(0)'; a2.textContent = r.name || '';
                a2.onclick = function(){ navToPerson(r.name, 'BDC'); };
                tdName.appendChild(a2);
                var tdShows = document.createElement('td'); tdShows.textContent = (r.shows!=null?r.shows:0);
                var tdCreated = document.createElement('td'); tdCreated.textContent = (r.created!=null?r.created:0);
                tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdShows); tr.appendChild(tdCreated);
                bBody.appendChild(tr);
              });
            }
          })
          .catch(function(e){
            clearBody('salesBody', 5);
            clearBody('bdcBody', 4);
            console.error(e);
          });
      }

      function fillPerson(name, type){
        var app = document.getElementById('app');
        app.innerHTML = '<a class="back" href="#/">&larr; Back</a><div class="card"><div class="muted">Loading 1on1…</div></div>';
        var params = new URLSearchParams({ route:'person', name:name, type:type });
        fetch(GAS_URL + '?' + params.toString() + '&t=' + Date.now(), { cache:'no-store' })
          .then(function(r){ return r.json(); })
          .then(function(data){
            if(!data || !data.ok){ throw new Error((data && data.error) || 'API error'); }
            var b = data.block || {};
            var picks = data.picks || {};
            var over = picks.over || null;
            var under = picks.under || null;

            var container = document.createElement('div');
            container.innerHTML = '';
            // Card: summary
            var card = document.createElement('div'); card.className='card';
            var h2 = document.createElement('h2'); h2.textContent = (b.name || name) + ' ';
            var pill = document.createElement('span'); pill.className='pill'; pill.textContent = (b.type || type || ''); h2.appendChild(pill);
            var sub = document.createElement('div'); sub.className='muted'; sub.textContent = 'Last work day: ' + (data.lastWorkDay || '—');
            card.appendChild(h2); card.appendChild(sub);

            function kv(n,t){ var d=document.createElement('div'); d.className='kv'; var a=document.createElement('div'); a.className='n'; a.textContent=n; var b=document.createElement('div'); b.className='t'; b.textContent=t; d.appendChild(a); d.appendChild(b); return d; }
            var kvs1 = document.createElement('div'); kvs1.className='kvs';
            kvs1.appendChild(kv(b.workingDays||0,'Working Days'));
            kvs1.appendChild(kv(b.callsMTD||0,'Calls (MTD)'));
            kvs1.appendChild(kv(b.avgTalk||'0:00','Avg Talk'));
            kvs1.appendChild(kv(b.createdMTD||0,'Appts Created'));
            kvs1.appendChild(kv(b.shownMTD||0,'Appts Shown'));
            var kvs2 = document.createElement('div'); kvs2.className='kvs'; kvs2.style.marginTop='10px';
            kvs2.appendChild(kv(b.dueMTD||0,'Appts Due'));
            kvs2.appendChild(kv(b.leadsInNameMTD||0,'Leads in Name'));
            kvs2.appendChild(kv(b.textsMTD||0,'Texts'));
            kvs2.appendChild(kv(b.salesMTD||0,'Sales'));
            kvs2.appendChild(kv(b.type||type||'','Role'));
            card.appendChild(kvs1); card.appendChild(kvs2);

            var callsCard = document.createElement('div'); callsCard.className='card';
            var h2b = document.createElement('h2'); h2b.textContent='Call Coaching Picks'; callsCard.appendChild(h2b);
            var meta = document.createElement('div'); meta.className='muted'; meta.textContent='1 over a minute, 1 under 30 seconds (longest as fallback if none ≥ 60s)'; callsCard.appendChild(meta);

            function callBlock(label, pick){
              var wrap = document.createElement('div'); wrap.className='call';
              var strong = document.createElement('strong'); strong.textContent = label; wrap.appendChild(strong); wrap.appendChild(document.createElement('br'));
              if (pick){
                var span = document.createElement('span'); span.textContent = (pick.dateKey || '') + ' — ' + (pick.talkMSS || ''); wrap.appendChild(span);
                if (pick.url){
                  wrap.appendChild(document.createElement('br'));
                  var link = document.createElement('a'); link.href = pick.url; link.target='_blank'; link.rel='noopener'; link.textContent='Play recording'; wrap.appendChild(link);
                }
              } else {
                var none = document.createElement('span'); none.className='muted'; none.textContent='None'; wrap.appendChild(none);
              }
              return wrap;
            }
            callsCard.appendChild(callBlock('Over 1:00', over));
            callsCard.appendChild(callBlock('Under 0:30', under));

            app.innerHTML = '<a class="back" href="#/">&larr; Back</a>';
            app.appendChild(card);
            app.appendChild(callsCard);
          })
          .catch(function(e){
            app.innerHTML = '<a class="back" href="#/">&larr; Back</a><div class="card">Error: ' + (e && e.message ? e.message : String(e)) + '</div>';
          });
      }

      function init(){
        var hash = location.hash || '#/';
        var parts = hash.slice(2).split('/');
        if (parts[0] === '' || parts[0] === 'home') fillHome();
        else if (parts[0] === 'person') {
          var name = decodeURIComponent(parts[1] || '');
          var type = parts[2] || '';
          fillPerson(name, type);
        } else fillHome();
      }
      init();
    </script>
  </body>
</html>
