<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Store Dashboard — Leaderboards & 1on1s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://script.google.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    <link rel="preconnect" href="https://script.googleusercontent.com">
    <link rel="dns-prefetch" href="https://script.googleusercontent.com">
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #fafafa; }
      header { background:#111; color:#fff; padding:14px 18px; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      h2 { margin: 18px 0 8px; font-size: 18px; }
      table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid #e8e8e8; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
      th { background:#fcfcfc; font-weight: 600; }
      a { color: #0a66c2; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .two { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
      .card { background:#fff; border:1px solid #e8e8e8; border-radius: 10px; padding: 14px; }
      .muted { color:#666; font-size: 12px; }
      .pill { display:inline-block; background:#eef6ff; color:#145aa6; padding:3px 8px; border-radius:999px; font-size:12px; }
      .kvs { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:10px; margin-top:10px; }
      .kv { background:#f9fafb; border:1px solid #eee; border-radius:8px; padding:10px; text-align:center; }
      .kv .n { font-weight:700; font-size:18px; }
      .kv .bar { height:4px; border-radius:9999px; background:#eee; margin-top:6px; overflow:hidden; }
      .kv .bar > span { display:block; height:100%; border-radius:9999px; }
      .btn { display:inline-block; padding:8px 12px; border:1px solid #e0e0e0; border-radius:8px; background:#f8f8f8; text-decoration:none; }
      .btn:hover { background:#f0f0f0; }
      input[type="email"], input[type="password"] { width:260px; padding:8px; margin-bottom:6px; }
      button { padding:8px 12px; cursor:pointer; }
      @media (max-width: 900px) { .two { grid-template-columns: 1fr; } .kvs { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    </style>
  </head>
  <body>
    <header>
      <div class="wrap">
        <h1>Store Dashboard</h1>
        <div class="muted">Leaderboards & 1on1s</div>
      </div>
    </header>

    <div class="wrap"><div id="nav"></div></div>
    <div class="wrap"><div id="app"></div></div>

    <script>
      /* ====== CONFIG ====== */
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwunFBZDwIOTDwplB9wvFR4wmhbG5rASIG4nj1fUbJgbzBuEZ_5-x2euwpPiDsL0i9X/exec';
      const qs = id => document.getElementById(id);
      const ts = () => '&t=' + Date.now();

      /* ====== Session ====== */
      function setSession(tok, prof){ try { localStorage.setItem('session', tok); localStorage.setItem('profile', JSON.stringify(prof||{})); } catch(e){} }
      function getSession(){ try { return localStorage.getItem('session')||''; } catch(e){ return ''; } }
      function getProfile(){ try { return JSON.parse(localStorage.getItem('profile')||'{}'); } catch(e){ return {}; } }
      function clearSession(){ try { localStorage.removeItem('session'); localStorage.removeItem('profile'); } catch(e){} }

      function isAdmin(){ const p=getProfile(); return p && String(p.name||'').toUpperCase()==='ALBERTO'; }

      function renderNav(){
        const nav = qs('nav'); if (!nav) return;
        const prof = getProfile(); const tok = getSession();
        if (tok) {
          nav.innerHTML = `<div class="muted">Logged in as <strong>${prof.name||''}</strong> — <a href="#/">Home</a> · <a href="#/login" id="logout">Logout</a></div>`;
          const a = document.getElementById('logout');
          if (a) a.onclick = e => { e.preventDefault(); clearSession(); location.hash = '#/login'; };
        } else {
          nav.innerHTML = `<div class="muted"><a href="#/login">Login</a></div>`;
        }
      }

      /* ====== KPI targets ====== */
      const DEFAULT_TARGETS = {
        Sales: { perDay: { sales:0.5, shown:0.5, created:1.0, calls:40, texts:20, talkSec:80 }, mtd:{ due:10 } },
        BDC:   { perDay: { sales:0,   shown:2.5, created:4,   calls:100, texts:40, talkSec:60 }, mtd:{ due:0 } }
      };
      function loadTargets(){ try { return JSON.parse(localStorage.getItem('targets_v3')||'null') || DEFAULT_TARGETS; } catch(e){ return DEFAULT_TARGETS; } }
      function secsFromAny(x){ if(x==null)return 0; if(typeof x==='number')return x; const s=String(x).trim(); if(/^\d+:\d{1,2}$/.test(s)){const p=s.split(':'); return (+p[0])*60+(+p[1]);} const n=parseFloat(s); return isNaN(n)?0:n; }
      function mssFromSecs(sec){ sec=Math.max(0,Math.round(sec)); const m=Math.floor(sec/60), s=sec%60; return m+':'+String(s).padStart(2,'0'); }

      /* ====== API ====== */
      async function apiLeaderboards(){ const r=await fetch(GAS_URL+'?route=leaderboards'+ts(),{cache:'no-store'}); return r.json(); }
      async function apiCallsFor(name){
        const tok=getSession();
        const url=GAS_URL+'?route=calls_for&name='+encodeURIComponent(name)+'&session='+encodeURIComponent(tok)+ts();
        const r=await fetch(url,{cache:'no-store'}); return r.json();
      }
      async function fetchPerson(name,type,opts){
        const tok=getSession();
        const params=new URLSearchParams({route:'person',name:name,type:type,session:tok});
        const res=await fetch(GAS_URL+'?'+params.toString()+ts(),{cache:'no-store'});
        return { data: await res.json() };
      }

      /* ====== HOME ====== */
      function navToPerson(name, type){ location.hash = '#/person/'+encodeURIComponent(String(name||''))+'/'+encodeURIComponent(String(type||'')); }
      function fillHome(){
        const app=qs('app'), p=getProfile(), tok=getSession(), admin=isAdmin();
        if (!tok) { location.hash = '#/login'; return; }

        app.innerHTML=`
          <div class="two">
            <div class="card">
              <h2>Sales Leaderboard <span class="pill">Sales (MTD)</span></h2>
              <table><thead><tr><th>#</th><th>Rep</th><th>Sales</th></tr></thead><tbody id="salesBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody></table>
            </div>
            <div class="card">
              <h2>BDC Leaderboard <span class="pill">Shows (MTD)</span></h2>
              <table><thead><tr><th>#</th><th>Agent</th><th>Shows</th></tr></thead><tbody id="bdcBody"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody></table>
            </div>
          </div>`;

        apiLeaderboards().then(data=>{
          if(!data||!data.ok) throw new Error(data&&data.error||'API error');

          const sBody=qs('salesBody'); sBody.innerHTML='';
          (data.sales||[]).forEach((r,i)=>{
            const tr=document.createElement('tr');
            const tdRank=document.createElement('td'); tdRank.textContent=i+1;
            const tdName=document.createElement('td');
            const isSelf = p.name && p.name.toUpperCase()===String(r.name||'').toUpperCase();
            if (admin || isSelf) {
              const a=document.createElement('a'); a.href='#/person/'+encodeURIComponent(r.name)+'/'+'Sales';
              a.textContent=r.name||''; a.onclick=e=>{e.preventDefault(); navToPerson(r.name,'Sales');}; tdName.appendChild(a);
            } else {
              const span=document.createElement('span'); span.textContent=r.name||''; span.className='muted'; tdName.appendChild(span);
            }
            const tdSales=document.createElement('td'); tdSales.textContent=(r.sales!=null?r.sales:0);
            tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdSales); sBody.appendChild(tr);
          });

          const bBody=qs('bdcBody'); bBody.innerHTML='';
          (data.bdc||[]).forEach((r,i)=>{
            const tr=document.createElement('tr');
            const tdRank=document.createElement('td'); tdRank.textContent=i+1;
            const tdName=document.createElement('td');
            const isSelf = p.name && p.name.toUpperCase()===String(r.name||'').toUpperCase();
            if (admin || isSelf) {
              const a=document.createElement('a'); a.href='#/person/'+encodeURIComponent(r.name)+'/'+'BDC';
              a.textContent=r.name||''; a.onclick=e=>{e.preventDefault(); navToPerson(r.name,'BDC');}; tdName.appendChild(a);
            } else {
              const span=document.createElement('span'); span.textContent=r.name||''; span.className='muted'; tdName.appendChild(span);
            }
            const tdShows=document.createElement('td'); tdShows.textContent=(r.shows!=null?r.shows:0);
            tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdShows); bBody.appendChild(tr);
          });
        }).catch(e=>{
          qs('app').innerHTML = `<div class="card">Error: ${e && e.message ? e.message : String(e)}</div>`;
        });
      }

      /* ====== PERSON (1on1) ====== */
      function deriveTargetMTD(key, rt, wd){
        const map={sales:'sales', shown:'shown', created:'created', calls:'calls', texts:'texts'};
        if(rt.perDay&&rt.perDay[map[key]]!=null){ const per=+rt.perDay[map[key]]||0; return per*(+wd||0); }
        if(rt.mtd&&rt.mtd[key]!=null) return +rt.mtd[key]||0;
        return 0;
      }
      const pctColor = p => p>=100 ? '#16a34a' : (p>=60 ? '#f59e0b' : '#ef4444');
      function addBar(el, value, target, isTime){
        if(!target||target<=0) return;
        const wrap=document.createElement('div'); wrap.className='bar';
        const fill=document.createElement('span'); const pct=Math.min(100,(value/target)*100);
        fill.style.width=pct.toFixed(1)+'%'; fill.style.background=pctColor(pct);
        wrap.title=`Target: ${isTime?mssFromSecs(target):target} | ${pct.toFixed(0)}%`; wrap.appendChild(fill); el.appendChild(wrap);
      }
      function kvTile(num,label,target,isTime){ const d=document.createElement('div'); d.className='kv';
        const n=document.createElement('div'); n.className='n'; n.textContent=num; d.appendChild(n);
        const t=document.createElement('div'); t.className='t'; t.textContent=label; d.appendChild(t);
        addBar(d,isTime?secsFromAny(num):parseFloat(num)||0,target,isTime); return d; }
      function fmt(n,d){ if(n==null||isNaN(n)) return '0'; const f=+n; return (d!=null)?f.toFixed(d):String(f); }
      function safeDiv(n,d){ n=+n||0; d=+d||0; return d>0?(n/d):0; }

      async function renderPerson(name, type){
        const app=qs('app'), p=getProfile(), admin=isAdmin();
        if (!getSession()) { location.hash = '#/login'; return; }
        if (!admin && p.name && p.name.toUpperCase()!==String(name||'').toUpperCase()){
          app.innerHTML='<div class="card">Access denied: you can only view your own page.</div>'; return;
        }
        app.innerHTML='<a class="back" href="#/">&larr; Back</a><div class="card"><div class="muted">Loading 1on1…</div></div>';
        try{
          const r=await fetchPerson(name,type,{useCache:false});
          if(!r||!r.data||!r.data.ok) throw new Error(r&&r.data&&r.data.error||'API error');
          const data=r.data; const b=data.block||{};
          const targets=loadTargets()[b.type]||loadTargets()['Sales']; const wd=b.workingDays||0; const talkTarget=secsFromAny((targets.perDay&&targets.perDay.talkSec)?targets.perDay.talkSec:0);
          const picks=data.picks||{}; const over=picks.over||null; const under=picks.under||null;

          const container=document.createElement('div');

          const head=document.createElement('div'); head.className='card';
          const top=document.createElement('div'); top.className='topline';
          const h2=document.createElement('h2'); h2.textContent=(b.name||'')+' '; const pill=document.createElement('span'); pill.className='pill'; pill.textContent=b.type||''; h2.appendChild(pill);
          const rhs=document.createElement('div'); const btn=document.createElement('a'); btn.className='btn'; btn.href='#/sheet/'+encodeURIComponent(b.name||''); btn.textContent='Open Call Sheet'; rhs.appendChild(btn);
          top.appendChild(h2); top.appendChild(rhs);
          const sub=document.createElement('div'); sub.className='muted'; sub.textContent='Last work day: '+(data.lastWorkDay||'—');
          head.appendChild(top); head.appendChild(sub); container.appendChild(head);

          const cardMTD=document.createElement('div'); cardMTD.className='card';
          const hMTD=document.createElement('h2'); hMTD.textContent='MTD KPIs'; cardMTD.appendChild(hMTD);
          const mtd=document.createElement('div'); mtd.className='kvs';
          mtd.appendChild(kvTile(fmt(b.salesMTD,1),'Sales',deriveTargetMTD('sales',targets,wd),false));
          mtd.appendChild(kvTile(fmt(b.shownMTD,0),'Appts Shown',deriveTargetMTD('shown',targets,wd),false));
          mtd.appendChild(kvTile(fmt(b.createdMTD,0),'Appts Created',deriveTargetMTD('created',targets,wd),false));
          mtd.appendChild(kvTile(fmt(b.callsMTD,0),'Calls (MTD)',deriveTargetMTD('calls',targets,wd),false));
          mtd.appendChild(kvTile(fmt(b.textsMTD,0),'Texts',deriveTargetMTD('texts',targets,wd),false));
          mtd.appendChild(kvTile(b.avgTalk||'0:00','Avg Talk',talkTarget,true));
          cardMTD.appendChild(mtd); container.appendChild(cardMTD);

          const cardPD=document.createElement('div'); cardPD.className='card';
          const hPD=document.createElement('h2'); hPD.textContent='Per-Day KPIs'; cardPD.appendChild(hPD);
          const per=document.createElement('div'); per.className='kvs';
          const perTarget=k=> (targets.perDay&&targets.perDay[k]!=null)?(+targets.perDay[k]||0):0;
          per.appendChild(kvTile(fmt(safeDiv(+b.salesMTD,wd),2),'Sales/Day',perTarget('sales'),false));
          per.appendChild(kvTile(fmt(safeDiv(+b.shownMTD,wd),2),'Shown/Day',perTarget('shown'),false));
          per.appendChild(kvTile(fmt(safeDiv(+b.createdMTD,wd),2),'Created/Day',perTarget('created'),false));
          per.appendChild(kvTile(fmt(safeDiv(+b.callsMTD,wd),1),'Calls/Day',perTarget('calls'),false));
          per.appendChild(kvTile(fmt(safeDiv(+b.textsMTD,wd),1),'Texts/Day',perTarget('texts'),false));
          per.appendChild(kvTile(b.avgTalk||'0:00','Avg Talk',talkTarget,true));
          cardPD.appendChild(per); container.appendChild(cardPD);

          const lastDay=data.lastDay||null;
          const cardLW=document.createElement('div'); cardLW.className='card';
          const hLW=document.createElement('h2'); hLW.textContent='Last Work Day KPIs'; cardLW.appendChild(hLW);
          const subLW=document.createElement('div'); subLW.className='muted'; subLW.textContent=lastDay&&lastDay.dateKey?('Date: '+lastDay.dateKey):('Date: '+(data.lastWorkDay||'—')); cardLW.appendChild(subLW);
          const lw=document.createElement('div'); lw.className='kvs';
          lw.appendChild(kvTile(fmt(lastDay&&lastDay.sales!=null?lastDay.sales:0,0),'Sales (Day)', perTarget('sales'), false));
          lw.appendChild(kvTile(fmt(lastDay&&lastDay.calls!=null?lastDay.calls:0,0),'Calls (Day)', perTarget('calls'), false));
          lw.appendChild(kvTile((lastDay&&lastDay.avgTalkMSS)?lastDay.avgTalkMSS:'0:00','Avg Talk', talkTarget, true));
          cardLW.appendChild(lw); container.appendChild(cardLW);

          const callsCard=document.createElement('div'); callsCard.className='card';
          const h2b=document.createElement('h2'); h2b.textContent='Call Coaching Picks'; callsCard.appendChild(h2b);
          const usedDay=(picks&&picks.usedDate)?picks.usedDate:''; const meta=document.createElement('div'); meta.className='muted';
          meta.textContent = (usedDay && data.lastWorkDay && usedDay!==data.lastWorkDay)
            ? ('Using calls from '+usedDay+' (no recordings on last work day).')
            : '1 over a minute, 1 under 30 seconds (longest/shortest as fallback)';
          callsCard.appendChild(meta);
          function block(label,pick){ const wrap=document.createElement('div'); wrap.className='call'; const strong=document.createElement('strong'); strong.textContent=label; wrap.appendChild(strong); wrap.appendChild(document.createElement('br'));
            if(pick){ const span=document.createElement('span'); span.textContent=(pick.dateKey||'')+' — '+(pick.talkMSS||''); wrap.appendChild(span); if(pick.url){ wrap.appendChild(document.createElement('br')); const a=document.createElement('a'); a.href=pick.url; a.target='_blank'; a.rel='noopener'; a.textContent='Play recording'; wrap.appendChild(a);} }
            else { const none=document.createElement('span'); none.className='muted'; none.textContent='None'; wrap.appendChild(none); } return wrap; }
          callsCard.appendChild(block('Over 1:00', over)); callsCard.appendChild(block('Under 0:30', under));

          qs('app').innerHTML='<a class="back" href="#/">&larr; Back</a>'; qs('app').appendChild(container); qs('app').appendChild(callsCard);
        }catch(e){ qs('app').innerHTML='<a class="back" href="#/">&larr; Back</a><div class="card">Error: '+(e.message||String(e))+'</div>'; }
      }

      /* ====== CALL SHEET ====== */
      async function renderPersonSheet(name){
        const app=qs('app'), p=getProfile(), admin=isAdmin();
        if (!getSession()) { location.hash = '#/login'; return; }
        if (!admin && p.name && p.name.toUpperCase()!==String(name||'').toUpperCase()){
          app.innerHTML='<div class="card">Access denied: you can only view your own call sheet.</div>'; return;
        }
        app.innerHTML=`<a class="back" href="#/">&larr; Back</a><div class="card">Loading ${name}'s call sheet…</div>`;
        try{
          const res=await apiCallsFor(name); if(!res||!res.ok) throw new Error(res&&res.error||'API error');
          const rows=res.calls||[];
          const wrap=document.createElement('div'); wrap.className='card';
          const h=document.createElement('h2'); h.textContent=`${name} — Call Sheet`; wrap.appendChild(h);
          const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>Customer</th><th>Phone</th><th>Email</th><th>Source</th><th>Date In</th><th>Lead Age</th><th>Days Since</th><th>Bucket</th><th>Status</th></tr></thead><tbody id="sheetBody"></tbody>';
          wrap.appendChild(tbl); app.innerHTML='<a class="back" href="#/">&larr; Back</a>'; app.appendChild(wrap);
          const tb=qs('sheetBody');
          if(!rows.length){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=9; td.className='muted'; td.textContent='No calls found.'; tr.appendChild(td); tb.appendChild(tr); }
          else rows.forEach(r=>{ const tr=document.createElement('tr'); const tdName=document.createElement('td'); if(r.link){ const a=document.createElement('a'); a.href=r.link; a.target='_blank'; a.rel='noopener'; a.textContent=r.name||''; tdName.appendChild(a);} else tdName.textContent=r.name||''; tr.appendChild(tdName);
            function td(v){ const x=document.createElement('td'); x.textContent=v||''; return x; }
            tr.appendChild(td(r.phone)); tr.appendChild(td(r.email)); tr.appendChild(td(r.source)); tr.appendChild(td(r.dateIn)); tr.appendChild(td(r.leadAge)); tr.appendChild(td(r.daysSince)); tr.appendChild(td(r.bucket)); tr.appendChild(td(r.status)); tb.appendChild(tr); });
        }catch(e){ app.innerHTML=`<a class="back" href="#/">&larr; Back</a><div class="card">Error: ${(e.message||String(e))}</div>`; }
      }

      /* ====== LOGIN ====== */
      async function renderLogin() {
  renderNav();
  const app = qs('app');

  app.innerHTML = `
    <div class="card">
      <h2>Login</h2>
      <div>
        <input id="loginUser" type="email" placeholder="Email or Username (e.g. Alberto)" />
        <br/>
        <input id="loginPass" type="password" placeholder="Password" />
        <br/>
        <button id="loginBtn" style="margin-top:10px;">Login</button>
      </div>
      <div class="muted" id="loginMsg" style="margin-top:8px;"></div>
    </div>
  `;

  const $u   = document.getElementById('loginUser');
  const $p   = document.getElementById('loginPass');
  const $btn = document.getElementById('loginBtn');
  const $msg = document.getElementById('loginMsg');

  async function submitLogin() {
    const user = ($u.value || '').trim();
    const pass = ($p.value || '');
    if (!user || !pass) { $msg.textContent = 'Enter email/username and password.'; return; }

    $btn.disabled = true;
    $msg.textContent = 'Authenticating…';

    try {
      // Use form-encoded body to avoid CORS preflight
      const form = new URLSearchParams();
      form.append('route', 'auth_login');
      form.append('email', user);      // backend accepts username "Alberto" or email
      form.append('password', pass);

      const res = await fetch(GAS_URL, { method: 'POST', body: form });
      const json = await res.json();

      if (!json || !json.ok) {
        throw new Error((json && json.error) || 'Invalid credentials');
      }

      setSession(json.session, json.profile);
      renderNav();
      location.hash = '#/';            // go to Home
    } catch (e) {
      $msg.textContent = 'Error: ' + (e.message || 'Failed to login');
      $btn.disabled = false;
    }
  }

  $btn.onclick = submitLogin;
  $u.addEventListener('keydown', e => { if (e.key === 'Enter') submitLogin(); });
  $p.addEventListener('keydown', e => { if (e.key === 'Enter') submitLogin(); });
}


      /* ====== Router ====== */
      function route(){
        renderNav();
        const tok=getSession();
        const hash=location.hash||'#/';
        const parts=hash.slice(2).split('/');
        // Force login if not authenticated
        if (!tok && parts[0] !== 'login') { location.hash = '#/login'; return; }

        if (parts[0]===''||parts[0]==='home') fillHome();
        else if (parts[0]==='person') renderPerson(decodeURIComponent(parts[1]||''), parts[2]||'');
        else if (parts[0]==='sheet')  renderPersonSheet(decodeURIComponent(parts[1]||''));
        else if (parts[0]==='login')  renderLogin();
        else fillHome();
      }
      window.addEventListener('hashchange', route);
      route();
    </script>
  </body>
</html>
