<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Store Performance Dashboard</title>
  <!-- prevent favicon 404 -->
  <link rel="icon" href="data:;base64,=">
  <style>
    :root {
      --bg1:#6a11cb; --bg2:#2575fc;
      --card:#ffffff; --text:#111827; --muted:#6b7280;
    }
    html, body {
      height:100%;
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    .container { max-width:1100px; margin:40px auto; padding:0 20px; }
    .header { color:#fff; text-align:center; margin:10px 0 16px; }
    .header h1 { margin:0; font-size:34px; }
    .user-info {
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(0,0,0,.65); color:#fff; border-radius:12px; padding:10px 16px;
    }
    .btn {
      background:#2563eb; color:#fff; border:none; padding:10px 14px;
      border-radius:8px; cursor:pointer; font-weight:600;
    }
    .btn:hover { background:#1d4ed8; }
    .logout-btn { background:#ef4444; }
    .logout-btn:hover { background:#dc2626; }
    .admin-btn { background:#10b981; }
    .admin-btn:hover { background:#059669; }

    .switcher { display:flex; gap:8px; margin:18px 0 6px; }
    .seg {
      border:1px solid rgba(255,255,255,.25); color:#fff; padding:8px 12px;
      border-radius:999px; cursor:pointer; font-weight:700; backdrop-filter: blur(8px);
    }
    .seg.active { background:#fff; color:#111827; border-color:#fff; }
    .hint { color:#e5e7eb; font-size:12px; margin-left:8px; }

    .card {
      background:var(--card); border-radius:16px;
      box-shadow:0 12px 24px rgba(0,0,0,.12); padding:16px;
    }
    .titleRow { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .titleRow h2 { margin:0; color:var(--text); font-size:18px; display:flex; align-items:center; gap:10px; }

    .list { display:flex; flex-direction:column; gap:4px; }
    .row {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 10px; border-radius:10px; cursor:pointer;
      transition:transform .06s ease, background .2s;
    }
    .row:hover { background:#f3f4f6; transform:translateY(-1px); }
    .left { display:flex; align-items:center; gap:10px; }
    .rank { width:28px; height:28px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#fff; background:#9ca3af; }
    .gold { background:linear-gradient(135deg,#f59e0b,#fbbf24); }
    .silver { background:linear-gradient(135deg,#9ca3af,#e5e7eb); color:#111827; }
    .bronze { background:linear-gradient(135deg,#b45309,#f59e0b); }
    .name { color:#111827; font-weight:700; }
    .right { text-align:right; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .pill { font-size:12px; font-weight:700; padding:3px 8px; border-radius:999px; background:#e5f3ff; color:#0b5cab; }
    .pill.sales { background:#fef3c7; color:#92400e; }
    .pill.calls { background:#e0f2fe; color:#075985; }
    .pill.texts { background:#ecfdf5; color:#065f46; }
    .pill.appt { background:#f1f5f9; color:#334155; }
    .muted { color:#6b7280; font-size:13px; }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <!-- üîß Your Apps Script Web App URL -->
  <script>
    window.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRf4KkWsC8EBN6G6ybStLKBNqmnu-Rjow4aZ_NWpSaRY7Q8JlxFaTsTsAW2Ny76dCS/exec";
    window.sessionToken = window.sessionToken || "";
    window.userData = window.userData || {};
  </script>

  <script type="module">
    const SCRIPT_URL = window.SCRIPT_URL || '';
    const state = { mode: 'sales', raw: null };

    function isAdmin(){ return (window.userData?.role==='admin'||window.userData?.role==='superadmin'); }
    function isManager(){ return (window.userData?.role==='manager'); }
    function canViewName(targetName){
      const mine=(window.userData?.linkedName||'').toUpperCase();
      if(isAdmin()||isManager())return true;
      return mine && (String(targetName||'').toUpperCase()===mine);
    }

    async function fetchLeaderboards(){
      if(!SCRIPT_URL) throw new Error('SCRIPT_URL is not defined on window.');
      const url = `${SCRIPT_URL}?route=leaderboards&session=${encodeURIComponent(window.sessionToken||'')}`;
      const resp = await fetch(url, { cache: 'no-store' });
      const text = await resp.text();
      let data; try{ data=JSON.parse(text);}catch(e){ throw new Error(`Non-JSON from GAS\nHTTP ${resp.status}\n\n${text}`); }
      if(!data?.ok) throw new Error(data?.error||'Backend returned ok:false');
      return data;
    }

    function sortSales(arr){
      return [...(arr||[])].sort((a,b)=>(b.sales??0)-(a.sales??0)||String(a.name||'').localeCompare(String(b.name||'')));
    }
    function sortBDC(arr){
      const shown = x => x.shown ?? x.shows ?? x.shows_count ?? 0;
      return [...(arr||[])].sort((a,b)=>shown(b)-shown(a)||String(a.name||'').localeCompare(String(b.name||'')));
    }
    function chip(label, value, cls=''){ return `<span class="pill ${cls}">${label}: <strong>${value}</strong></span>`; }

    function rowHTML(person, i, mode){
      const name = person.name || '';
      const rankClass = i===0 ? 'gold' : i===1 ? 'silver' : i===2 ? 'bronze' : '';
      const allowed = canViewName(name);
      const clickAttr = allowed ? `onclick="showPersonDetails('${name.replace(/'/g,"\\'")}', '${mode.toUpperCase()}')"` : '';
      const style = allowed ? '' : 'opacity:.6; cursor:not-allowed;';

      if(mode==='sales'){
        const sales = person.sales ?? 0;
        const calls = person.calls ?? 0;
        const texts = person.texts ?? 0;
        const created = person.created ?? 0;
        const shown = person.shown ?? person.shown_count ?? 0;
        return `
          <div class="row" ${clickAttr} style="${style}">
            <div class="left">
              <div class="rank ${rankClass}">${i+1}</div>
              <div class="name">${name}</div>
            </div>
            <div class="right">
              <div class="chips">
                ${chip('Sales', sales, 'sales')}
                ${chip('Calls', calls, 'calls')}
                ${chip('Texts', texts, 'texts')}
                ${chip('Appts Made', created, 'appt')}
                ${chip('Appts Shown', shown, 'appt')}
              </div>
            </div>
          </div>`;
      } else {
        const calls = person.calls ?? 0;
        const texts = person.texts ?? 0;
        const created = person.created ?? 0;
        const shown = person.shown ?? person.shows ?? person.shows_count ?? 0;
        return `
          <div class="row" ${clickAttr} style="${style}">
            <div class="left">
              <div class="rank ${rankClass}">${i+1}</div>
              <div class="name">${name}</div>
            </div>
            <div class="right">
              <div class="chips">
                ${chip('Appts Shown', shown, 'appt')}
                ${chip('Appts Made', created, 'appt')}
                ${chip('Calls', calls, 'calls')}
                ${chip('Texts', texts, 'texts')}
              </div>
            </div>
          </div>`;
      }
    }

    function render(data){
      const me = window.userData || {};
      if(!state.raw) state.raw = data;
      const salesLB = sortSales(data.sales || []);
      const bdcLB   = sortBDC(data.bdc   || []);
      const activeList = state.mode==='sales' ? salesLB : bdcLB;

      document.getElementById('app').innerHTML = `
        <div class="header"><h1>Store Performance Dashboard</h1></div>
        <div class="user-info">
          <div>
            Welcome, <strong>${me.email || ''}</strong>
            ${isAdmin() ? '<span style="color:#a7f3d0;"> (Admin)</span>' :
              (isManager() ? '<span style="color:#93c5fd;"> (Manager)</span>' : '')}
            ${me.linkedName ? ' ‚Ä¢ Linked: <strong>'+me.linkedName+'</strong>' : ''}
          </div>
          <div>
            ${isAdmin() ? '<button class="admin-btn" onclick="showUserModal()">User Management</button>' : ''}
            <button class="logout-btn" onclick="logout()" style="margin-left:10px;">Logout</button>
          </div>
        </div>

        <div class="switcher">
          <button class="seg ${state.mode==='sales'?'active':''}" onclick="setMode('sales')">Sales</button>
          <button class="seg ${state.mode==='bdc'?'active':''}" onclick="setMode('bdc')">BDC</button>
          <span class="hint">Tip: Click a name to open their 1:1</span>
        </div>

        <div id="content" class="card">
          <div class="titleRow">
            <h2>${state.mode==='sales' ? 'üèÜ Sales Leaderboard' : 'üìû BDC Leaderboard'}</h2>
            <div class="muted">
              ${state.mode==='sales' ? 'Sorted by Sales (MTD)' : 'Sorted by Appts Shown (MTD)'}
            </div>
          </div>
          <div class="list">
            ${activeList.length
              ? activeList.map((p,i)=>rowHTML(p,i,state.mode)).join('')
              : '<p class="muted" style="text-align:center;">No '+state.mode.toUpperCase()+' data</p>'}
          </div>
        </div>`;
    }

    function setMode(mode){ state.mode = mode; render(state.raw); }

    async function showDashboard(){
      try{
        const data = await fetchLeaderboards();
        render(data);
      }catch(err){
        document.getElementById('app').innerHTML = `
          <div class="container">
            <div class="card" style="padding:50px;text-align:center;color:#dc2626;">
              <h2>Error Loading Dashboard</h2>
              <p style="white-space:pre-wrap;">${err?.message||err}</p>
              <button class="btn" onclick="window.showDashboard()" style="max-width:200px;margin:20px auto;">Retry</button>
            </div>
          </div>`;
      }
    }

    window.setMode = setMode;
    window.showDashboard = showDashboard;

    showDashboard();
  </script>
</body>
</html>
