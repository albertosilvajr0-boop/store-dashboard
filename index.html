<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BDC &amp; Sales Leaderboards</title>

<style>
/* â”€â”€ Reset & Base â”€â”€ */
:root {
  --bg: #fafaf9;
  --card: #ffffff;
  --text: #1a1a1a;
  --muted: #71717a;
  --line: #e4e4e7;
  --green: #16a34a;
  --greenBg: #dcfce7;
  --yellow: #ca8a04;
  --yellowBg: #fef9c3;
  --red: #dc2626;
  --redBg: #fee2e2;
  --gray: #a1a1aa;
  --grayBg: #f4f4f5;
  --chipBg: #f4f4f5;
  --chipOn: #f97316;
  --chipOnText: #fff;
  --header: #1c1917;
  --headerText: #fafaf9;
  --accent: #ea580c;
}

*, *::before, *::after { box-sizing: border-box; }
html, body {
  height: 100%; margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
}

/* â”€â”€ Scrollbar styling â”€â”€ */
.table-card::-webkit-scrollbar { height: 6px; }
.table-card::-webkit-scrollbar-track { background: var(--line); border-radius: 3px; }
.table-card::-webkit-scrollbar-thumb { background: #a1a1aa; border-radius: 3px; }
.table-card::-webkit-scrollbar-thumb:hover { background: #71717a; }
.detail-card::-webkit-scrollbar { height: 6px; }
.detail-card::-webkit-scrollbar-track { background: var(--line); border-radius: 3px; }
.detail-card::-webkit-scrollbar-thumb { background: #a1a1aa; border-radius: 3px; }

/* â”€â”€ Watermark â”€â”€ */
body::before {
  content: "";
  position: fixed; inset: 0;
  pointer-events: none; z-index: 0;
  background-image: url("sa-watermark.png");
  background-repeat: repeat;
  background-size: 300px auto;
  opacity: .07;
  filter: grayscale(100%) contrast(120%);
}

/* â”€â”€ Layout â”€â”€ */
.wrap { position: relative; z-index: 1; max-width: 1440px; margin: 0 auto; padding: 16px 20px 40px; }

/* â”€â”€ Top Header Bar â”€â”€ */
.topbar {
  display: flex; align-items: center; gap: 14px;
  background: var(--header); color: var(--headerText);
  border-radius: 14px; padding: 14px 20px;
  margin-bottom: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,.15);
}
.topbar-logo {
  width: 42px; height: 42px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), #fb923c);
  display: grid; place-items: center;
  font-size: 20px; font-weight: 800; color: #fff;
  flex-shrink: 0;
}
.topbar-info { flex: 1; min-width: 0; }
.topbar-title { font-size: 18px; font-weight: 700; letter-spacing: .2px; }
.topbar-sub { font-size: 12px; color: #a8a29e; margin-top: 2px; }
.topbar-actions { display: flex; gap: 8px; flex-shrink: 0; }
.topbar-btn {
  padding: 9px 16px; border-radius: 8px; border: none;
  font-weight: 600; font-size: 13px; cursor: pointer; white-space: nowrap;
  transition: filter .15s;
}
.topbar-btn:hover { filter: brightness(1.1); }
.topbar-btn.manage { background: #3f3f46; color: #fafaf9; }
.topbar-btn.logout  { background: #ef4444; color: #fff; }

/* â”€â”€ Two-Panel Grid â”€â”€ */
.panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  align-items: start;
}
.panels > div {
  min-width: 0; /* prevent grid blowout from wide tables */
}
@media (max-width: 1024px) {
  .panels { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
  .wrap { padding: 10px 12px 30px; }
  .topbar { flex-wrap: wrap; gap: 10px; padding: 12px 14px; border-radius: 10px; }
  .topbar-info { min-width: 0; flex-basis: calc(100% - 56px); }
  .topbar-actions { width: 100%; justify-content: flex-end; }
  .topbar-title { font-size: 16px; }
  .stat-row { gap: 6px; }
  .stat-card { min-width: 80px; padding: 8px 10px; }
  .stat-value { font-size: 18px; }
  .stat-label { font-size: 10px; }
  .panel-title { font-size: 15px; }
}
@media (max-width: 480px) {
  .topbar-btn { padding: 7px 10px; font-size: 12px; }
  .stat-value { font-size: 16px; }
  .stat-value.top-performer { font-size: 13px; }
  .login-container { margin: 8vh 12px; padding: 20px; }
}

/* â”€â”€ Panel â”€â”€ */
.panel-header { margin-bottom: 6px; }
.panel-title { font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
.panel-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }

/* â”€â”€ Stat Cards â”€â”€ */
.stat-row {
  display: flex; gap: 10px; margin: 10px 0 8px;
  flex-wrap: wrap;
}
.stat-card {
  flex: 1; min-width: 100px;
  border: 1px solid var(--line); border-radius: 10px;
  padding: 10px 12px;
  background: var(--card);
}
.stat-label { font-size: 11px; color: var(--muted); font-weight: 500; display: flex; align-items: center; gap: 4px; }
.stat-value { font-size: 22px; font-weight: 800; margin-top: 2px; color: var(--text); }
.stat-value.top-performer { font-size: 15px; font-weight: 700; line-height: 1.3; }

/* â”€â”€ Time Filter Chips â”€â”€ */
.chip-row { display: flex; gap: 6px; margin: 8px 0 6px; align-items: center; }
.chip {
  padding: 5px 12px; border-radius: 999px; font-size: 12px; font-weight: 600;
  cursor: pointer; user-select: none; border: 1px solid var(--line);
  background: var(--chipBg); color: var(--text);
  transition: all .15s;
}
.chip.active { background: var(--chipOn); color: var(--chipOnText); border-color: transparent; }
.chip:hover:not(.active) { background: #e4e4e7; }

/* â”€â”€ KPI Legend (Sales) â”€â”€ */
.kpi-legend { display: flex; gap: 12px; margin: 4px 0 8px; font-size: 11px; color: var(--muted); flex-wrap: wrap; }
.kpi-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 3px; vertical-align: middle; }
.kpi-dot.green  { background: var(--green); }
.kpi-dot.yellow { background: var(--yellow); }
.kpi-dot.gray   { background: var(--gray); }
.kpi-dot.red    { background: var(--red); }

/* â”€â”€ Table Card â”€â”€ */
.table-card {
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 12px;
  overflow-x: auto;
  overflow-y: visible;
  -webkit-overflow-scrolling: touch;
  box-shadow: 0 2px 8px rgba(0,0,0,.04);
}
.table-card table {
  width: 100%; min-width: 620px; border-collapse: collapse;
}
.table-card th {
  padding: 9px 6px; font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .4px; color: var(--muted); background: #fafaf9;
  border-bottom: 2px solid var(--line);
  cursor: pointer; user-select: none; white-space: nowrap;
  position: relative;
}
.table-card th:hover { color: var(--text); }
.table-card th .sort-arrow { font-size: 10px; margin-left: 2px; opacity: .5; }
.table-card th.sorted .sort-arrow { opacity: 1; color: var(--accent); }

.table-card td {
  padding: 8px 6px; font-size: 13px; text-align: center;
  border-bottom: 1px solid #f4f4f5;
}
.table-card tr:last-child td { border-bottom: none; }
.table-card tr.top3 { background: #fffbeb; }
.table-card .rank-cell { width: 32px; text-align: center; }
.table-card .name-cell { text-align: left; font-weight: 600; white-space: nowrap; }
.table-card .trophy { font-size: 14px; margin-right: 4px; }

/* â”€â”€ KPI Cell Colors â”€â”€ */
.kpi-green  { background: var(--greenBg);  color: var(--green);  font-weight: 700; }
.kpi-yellow { background: var(--yellowBg); color: var(--yellow); font-weight: 700; }
.kpi-red    { background: var(--redBg);    color: var(--red);    font-weight: 700; }
.kpi-gray   { background: var(--grayBg);   color: var(--gray);   font-weight: 600; }
.kpi-none   { color: var(--muted); }

/* â”€â”€ Sales primary column highlight â”€â”€ */
.sales-primary { font-weight: 800; font-size: 14px; }

/* â”€â”€ Login â”€â”€ */
.login-container {
  max-width: 400px; margin: 14vh auto; background: var(--card);
  border-radius: 16px; padding: 28px; box-shadow: 0 12px 36px rgba(0,0,0,.12);
  position: relative; z-index: 1;
}
.login-container h2 { margin: 0 0 10px; text-align: center; }
.form-group { margin-top: 12px; display: flex; flex-direction: column; gap: 6px; }
.form-group input, .form-group select { padding: 12px; border: 1px solid var(--line); border-radius: 10px; font-size: 15px; }
.btn {
  display: inline-block; padding: 12px 18px; border-radius: 10px; border: none;
  background: var(--header); color: #fff; font-weight: 600; cursor: pointer;
  text-align: center; text-decoration: none; font-size: 14px;
  transition: filter .15s;
}
.btn:hover { filter: brightness(1.15); }
.btn:disabled { opacity: .5; cursor: not-allowed; }

/* â”€â”€ Modal â”€â”€ */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.45); place-items: center; z-index: 50; }
.modal-content { width: min(720px, 92vw); max-height: 85vh; overflow-y: auto; background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 12px 32px rgba(0,0,0,.25); }
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.modal-close { background: transparent; border: none; font-size: 26px; cursor: pointer; line-height: 1; }
.user-list .user-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
.delete-btn { background: #ef4444; color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }

/* â”€â”€ Activity Log â”€â”€ */
.activity-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }

/* â”€â”€ Reassignment Page â”€â”€ */
.reassign-stats { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 14px; }
.reassign-stat { background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 12px 18px; min-width: 120px; }
.reassign-stat .stat-label { font-size: 11px; color: var(--muted); font-weight: 500; }
.reassign-stat .stat-value { font-size: 20px; font-weight: 800; margin-top: 2px; }
.days-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; min-width: 28px; text-align: center; }
.days-3  { background: #fef9c3; color: #854d0e; }
.days-4  { background: #fef3c7; color: #92400e; }
.days-5  { background: #fed7aa; color: #9a3412; }
.days-6  { background: #fecaca; color: #991b1b; }
.days-7  { background: #fca5a5; color: #7f1d1d; }
.days-8  { background: #ef4444; color: #fff; }
.days-9p { background: #dc2626; color: #fff; }
.reassign-link { color: var(--accent); text-decoration: none; font-weight: 600; }
.reassign-link:hover { text-decoration: underline; }
.reassign-sheet-badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: #f0f0f0; color: #555; }

/* â”€â”€ News Page â”€â”€ */
.news-card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 16px 18px; margin-bottom: 10px; transition: box-shadow .15s; }

/* â”€â”€ Resources Dropdown â”€â”€ */
.res-link { display:block;padding:9px 16px;color:var(--text);text-decoration:none;font-size:13px;font-weight:500;white-space:nowrap;transition:background .12s; }
.res-link:hover { background:#f4f4f5; }
.custom-link-wrap { display:flex;align-items:center;gap:0; }
.custom-link-wrap .res-link { flex:1;overflow:hidden;text-overflow:ellipsis; }
.custom-link-del { background:none;border:none;color:#dc2626;font-size:14px;cursor:pointer;padding:6px 10px;opacity:0.4;transition:opacity .15s; }
.custom-link-del:hover { opacity:1; }
th[draggable="true"] { cursor:grab; user-select:none; position:relative; }
th[draggable="true"]:active { cursor:grabbing; }
th[draggable="true"]::after { content:'â ¿'; position:absolute; top:2px; right:2px; font-size:8px; color:var(--muted); opacity:0.4; }
th[draggable="true"]:hover { background:rgba(59,130,246,.08); }
.news-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,.08); }
.news-title { font-size: 15px; font-weight: 700; line-height: 1.4; }
.news-title a { color: var(--text); text-decoration: none; }
.news-title a:hover { color: var(--accent); text-decoration: underline; }
.news-meta { display: flex; gap: 12px; margin-top: 6px; font-size: 12px; color: var(--muted); flex-wrap: wrap; }
.news-source { background: #f0f0f0; padding: 2px 8px; border-radius: 6px; font-weight: 600; font-size: 11px; }
.activity-item:last-child { border-bottom: none; }
.activity-name { font-weight: 600; font-size: 14px; }
.activity-email { color: var(--muted); font-size: 12px; }
.activity-time { text-align: right; white-space: nowrap; }
.activity-time .time-main { font-size: 14px; font-weight: 500; }
.activity-time .time-sub { color: var(--muted); font-size: 11px; }
.activity-status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; }
.status-recent { background: #22c55e; }
.status-stale  { background: #f59e0b; }
.status-old    { background: #ef4444; }
.status-never  { background: #d1d5db; }

/* â”€â”€ Person Detail Card â”€â”€ */
.detail-card {
  background: var(--card); border-radius: 14px; padding: 24px;
  border: 1px solid var(--line);
  box-shadow: 0 2px 12px rgba(0,0,0,.06);
  overflow-x: auto;
}

/* â”€â”€ Loading Spinner â”€â”€ */
.loading-wrap {
  display: flex; align-items: center; justify-content: center;
  min-height: 300px;
}
.spinner {
  width: 36px; height: 36px; border: 3px solid var(--line);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ Auto-refresh countdown â”€â”€ */
.refresh-dot {
  width: 6px; height: 6px; border-radius: 50%; background: #22c55e;
  display: inline-block; margin-right: 4px; animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .4; } }
</style>
</head>

<body>
<div class="wrap" id="app"></div>

<!-- User Management Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>User Management</h2>
      <button class="modal-close" onclick="closeUserModal()">&times;</button>
    </div>
    <div class="form-group">
      <h3 style="margin:0 0 6px;">Add New User</h3>
      <input type="email" id="newUserEmail" placeholder="Email address">
      <input type="password" id="newUserPassword" placeholder="Password" style="margin-top:8px;">
      <input type="text" id="newUserLinked" placeholder='Linked Sheet Name (e.g., "JASMINE VASQUEZ")' style="margin-top:8px;">
      <select id="newUserRole" style="width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:8px;">
        <option value="user">User</option>
        <option value="manager">Manager</option>
        <option value="admin">Admin</option>
      </select>
      <button class="btn" style="margin-top:10px;" onclick="addUser()">Add User</button>
    </div>
    <div class="user-list" id="userList">
      <h3>Existing Users</h3>
      <div id="userListContent"></div>
    </div>
  </div>
</div>

<!-- Activity Log Modal -->
<div class="modal" id="activityModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ• User Activity Log</h2>
      <button class="modal-close" onclick="closeActivityModal()">&times;</button>
    </div>
    <div id="activityContent" style="margin-top:8px;">
      <p style="color:var(--muted);">Loading...</p>
    </div>
  </div>
</div>

<script type="module">
/************ Firebase imports ************/
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
import {
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  signOut, onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc, updateDoc, increment,
  addDoc, query, where, orderBy, limit, Timestamp
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

/************ Firebase config ************/
const firebaseConfig = {
  apiKey: "AIzaSyC74YFnCKeO5TjmPa4H4BMm_pFwohOVAX4",
  authDomain: "store-dashboard-2025.firebaseapp.com",
  projectId: "store-dashboard-2025",
  storageBucket: "store-dashboard-2025.firebasestorage.app",
  messagingSenderId: "556566448299",
  appId: "1:556566448299:web:a2cbe4dda5d21fc6c5cfee",
  measurementId: "G-0D5JMNGE4S"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const secondaryApp = initializeApp(firebaseConfig, 'secondary');
const secondaryAuth = getAuth(secondaryApp);

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJ9NuW7fHB8jqJrC8eQl82kj3A_oNJa61ICivs72p7oi06tY8Pj_lfSwn9Ana7qV70/exec';
const SUPERADMIN_EMAIL = 'albertosilvajr0@gmail.com';

/* â”€â”€ Crash reporter â”€â”€ */
window.addEventListener('error', (e) => {
  const appEl = document.getElementById('app');
  if (!appEl) return;
  appEl.innerHTML = `
    <div style="padding:60px 20px;text-align:center;color:#dc2626;">
      <h2>Frontend Error</h2>
      <p>${e?.message || 'Unknown error'}</p>
      <pre style="text-align:left;white-space:pre-wrap;background:#fff;border:1px solid #eee;border-radius:8px;padding:12px;max-width:600px;margin:12px auto;">${(e?.error?.stack) || ''}</pre>
    </div>`;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCESS HELPERS & SESSION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function isAdmin()   { return window.userData?.role === 'admin' || window.userData?.role === 'superadmin'; }
function isManager() { return window.userData?.role === 'manager'; }
function canViewName(targetName) {
  const n = (targetName || '').toUpperCase();
  const mine = (window.userData?.linkedName || '').toUpperCase();
  if (isAdmin() || isManager()) return true;
  return mine && n === mine;
}
function makeSessionToken({ name, role }) {
  return btoa(JSON.stringify({ name, role }));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE VIEW TRACKING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _sessionId = Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
let _lastPageView = null;
let _pageViewQueue = [];
let _pvFlushTimer = null;

function logPageView(pageName) {
  const user = auth.currentUser;
  if (!user?.email) return;
  const now = Date.now();
  // Calculate time on previous page
  const dwellMs = _lastPageView ? now - _lastPageView.ts : 0;
  _lastPageView = { page: pageName, ts: now };

  _pageViewQueue.push({
    email: user.email,
    page: pageName,
    ts: Timestamp.fromMillis(now),
    sessionId: _sessionId,
    dwellMs: dwellMs
  });

  // Update daily login lastSeen
  if (user.uid) {
    const loginDocId = user.uid + '_' + todayDateStr();
    setDoc(doc(db, 'dailyLogins', loginDocId), { lastSeen: new Date() }, { merge: true }).catch(() => {});
  }

  // Batch writes â€” flush every 3 seconds or at 5 queued
  if (_pvFlushTimer) clearTimeout(_pvFlushTimer);
  if (_pageViewQueue.length >= 5) {
    _flushPageViews();
  } else {
    _pvFlushTimer = setTimeout(_flushPageViews, 3000);
  }
}

function _flushPageViews() {
  if (_pageViewQueue.length === 0) return;
  const batch = [..._pageViewQueue];
  _pageViewQueue = [];
  batch.forEach(pv => {
    addDoc(collection(db, 'pageViews'), pv).catch(() => {});
  });
}

// Flush on page unload
window.addEventListener('beforeunload', () => {
  if (_lastPageView) {
    // Log final dwell time
    const now = Date.now();
    _pageViewQueue.push({
      email: auth.currentUser?.email || 'unknown',
      page: _lastPageView.page + ' (exit)',
      ts: Timestamp.fromMillis(now),
      sessionId: _sessionId,
      dwellMs: now - _lastPageView.ts
    });
  }
  _flushPageViews();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function safeNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
function shownVal(x) { return x.shown ?? x.shows ?? x.shown_count ?? x.shows_count ?? 0; }
function fmt(n, d=0) { return Number(n).toFixed(d); }

function timeStr() {
  return new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

/* â”€â”€ Motivational Quotes â”€â”€ */
const TOPBAR_QUOTES = [
  "The leaderboard doesn't lie.",
  "You don't get paid for intention. You get paid for execution.",
  "Volume creates luck.",
  "Every call is an opportunity. Every note is a receipt.",
  "Small daily disciplines become big monthly commissions."
];
function setTopbarQuote() {
  const el = document.getElementById('topbarQuote');
  if (el) el.textContent = TOPBAR_QUOTES[Math.floor(Math.random() * TOPBAR_QUOTES.length)];
}

/* â”€â”€ Click Tracking â”€â”€ */
function todayDateStr() {
  const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' }));
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

let _clickBuffer = 0;
let _clickFlushing = false;

async function _flushClicks() {
  if (!window.userData?.uid || _clickBuffer <= 0 || _clickFlushing) return;
  _clickFlushing = true;
  const count = _clickBuffer;
  _clickBuffer = 0;
  try {
    const userRef = doc(db, 'users', window.userData.uid);
    const today = todayDateStr();
    const snap = await getDoc(userRef);
    const data = snap.data() || {};
    if (data.clickDate === today) {
      await updateDoc(userRef, { clicksToday: increment(count) });
    } else {
      await setDoc(userRef, { clicksToday: count, clickDate: today }, { merge: true });
    }
  } catch (e) { _clickBuffer += count; /* retry next flush */ }
  _clickFlushing = false;
}

// Track ALL clicks on the page
document.addEventListener('click', () => {
  if (!window.userData?.uid) return;
  _clickBuffer++;
});

// Flush every 15 seconds
setInterval(_flushClicks, 15000);

// Flush on page unload (tab close, navigation away, refresh)
window.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') _flushClicks();
});
window.addEventListener('beforeunload', () => { _flushClicks(); });

// Legacy wrapper for explicit trackClick() calls
function trackClick() { /* now handled by global listener */ }

/* â”€â”€ Cache â”€â”€ */
const personCache = new Map();
const callListCache = new Map();
function cacheKey(name) { return (name || '').toUpperCase().trim(); }

async function fetchPerson(name) {
  const key = cacheKey(name);
  if (personCache.has(key)) return personCache.get(key);
  const url = `${SCRIPT_URL}?route=person&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken || '')}`;
  const resp = await fetch(url);
  const data = await resp.json();
  if (data?.ok) personCache.set(key, data);
  return data;
}
async function fetchCalls(name) {
  const key = cacheKey(name);
  if (callListCache.has(key)) return callListCache.get(key);
  const url = `${SCRIPT_URL}?route=calls_for&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken || '')}`;
  const resp = await fetch(url);
  const data = await resp.json();
  if (data?.ok) callListCache.set(key, data);
  return data;
}

/* â”€â”€ Prefetch helpers â”€â”€ */
const _prefetchingPerson = new Set();
const _prefetchingCalls = new Set();

function prefetchPerson(name) {
  if (!name) return;
  const key = cacheKey(name);
  if (personCache.has(key) || _prefetchingPerson.has(key)) return;
  _prefetchingPerson.add(key);
  fetchPerson(name).catch(() => {}).finally(() => _prefetchingPerson.delete(key));
}
function prefetchCalls(name) {
  if (!name) return;
  const key = cacheKey(name);
  if (callListCache.has(key) || _prefetchingCalls.has(key)) return;
  _prefetchingCalls.add(key);
  fetchCalls(name).catch(() => {}).finally(() => _prefetchingCalls.delete(key));
}

// Hover prefetch: triggered on mouseenter of leaderboard rows
function onRowHover(name) {
  prefetchPerson(name);
  prefetchCalls(name);
}

// Staggered prefetch: fetch all names with delays so we don't overwhelm GAS
function prefetchForDashboard(data) {
  const allNames = new Set();
  (data.sales || []).forEach(x => { if (x.name) allNames.add(x.name); });
  (data.bdc || []).forEach(x => { if (x.name) allNames.add(x.name); });
  if (window.userData?.linkedName) allNames.add(window.userData.linkedName);

  // Priority: own name + top 3 immediately
  const topSales = (data.sales || []).slice(0, 3).map(x => x.name);
  const topBDC = (data.bdc || []).slice(0, 3).map(x => x.name);
  const mine = window.userData?.linkedName ? [window.userData.linkedName] : [];
  const priority = [...new Set([...mine, ...topSales, ...topBDC])];
  priority.forEach(n => { prefetchPerson(n); prefetchCalls(n); });

  // Rest: stagger 500ms apart to avoid overwhelming GAS
  const rest = [...allNames].filter(n => !priority.includes(n));
  rest.forEach((n, i) => {
    setTimeout(() => prefetchPerson(n), (i + 1) * 500);
    setTimeout(() => prefetchCalls(n), (i + 1) * 500 + 250);
  });
}

// Quick-lookup: find a person's row data from dashboard cache
function getDashboardRow(name) {
  const key = (name || '').toUpperCase().trim();
  const all = [...(dashboardData.sales || []), ...(dashboardData.bdc || [])];
  return all.find(r => (r.name || '').toUpperCase().trim() === key) || null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLoading(on = true) {
  const appEl = document.getElementById('app');
  if (!appEl || !on) return;
  appEl.innerHTML = `<div class="loading-wrap"><div class="spinner"></div></div>`;
}

function showUserModal() {
  if (!isAdmin()) { alert('Only admins can manage users.'); return; }
  logPageView('Manage Users');
  document.getElementById('userModal').style.display = 'grid';
  loadUsers();
}
function closeUserModal() {
  document.getElementById('userModal').style.display = 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLogin() {
  document.getElementById('app').innerHTML = `
    <div class="login-container">
      <h2>BDC &amp; Sales Leaderboards</h2>
      <div id="error-message" style="color:#dc2626;min-height:20px;margin:10px 0 0;"></div>
      <div class="form-group" style="margin-top:16px;">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="you@company.com" autocomplete="username" />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" placeholder="Your password" autocomplete="current-password" />
      </div>
      <button class="btn" style="width:100%;margin-top:14px;" onclick="login()">Log in</button>
    </div>`;
}

async function login() {
  const email = document.getElementById('email')?.value?.trim();
  const password = document.getElementById('password')?.value?.trim();
  const errEl = document.getElementById('error-message');
  if (!email || !password) { if (errEl) errEl.textContent = 'Enter email and password.'; return; }
  try {
    showLoading(true);
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    if (errEl) errEl.textContent = e.message || 'Login failed';
    showLogin();
  }
}

async function logout() {
  await signOut(auth);
  showLogin();
}

onAuthStateChanged(auth, async (user) => {
  if (!user) { showLogin(); return; }

  const userRef = doc(db, 'users', user.uid);
  let snap = await getDoc(userRef);
  if (!snap.exists()) {
    await setDoc(userRef, {
      email: user.email,
      role: user.email === SUPERADMIN_EMAIL ? 'superadmin' : 'user',
      linkedName: '',
      createdAt: new Date()
    });
    snap = await getDoc(userRef);
  }
  const data = snap.data() || {};
  let role = data.role || 'user';
  if (user.email === SUPERADMIN_EMAIL && role !== 'superadmin') {
    role = 'superadmin';
    await setDoc(userRef, { ...data, role }, { merge: true });
  }

  window.userData = { email: user.email, uid: user.uid, role, linkedName: data.linkedName || '' };
  const sessionName = window.userData.linkedName || window.userData.email;
  window.sessionToken = makeSessionToken({ name: sessionName, role });

  // Record last login timestamp
  setDoc(userRef, { lastLogin: new Date() }, { merge: true }).catch(() => {});

  // Record daily login for historical accuracy
  const loginDate = todayDateStr();
  const loginDocId = user.uid + '_' + loginDate;
  setDoc(doc(db, 'dailyLogins', loginDocId), {
    email: user.email,
    uid: user.uid,
    linkedName: data.linkedName || '',
    role: role,
    date: loginDate,
    lastSeen: new Date()
  }, { merge: true }).catch(() => {});

  trackClick();

  showDashboard();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD (pic2 layout)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let dashboardData = { sales: [], bdc: [] };
let bdcSort = { col: 'shown', dir: 'desc' };
let salesSort = { col: 'sales', dir: 'desc' };

async function showDashboard() {
  if (!window.userData) { showLogin(); return; }
  logPageView('Dashboard');
  try {
    showLoading(true);
    const url = `${SCRIPT_URL}?route=leaderboards&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error(`Non-JSON response.\nHTTP ${resp.status}\n\n${raw}`); }
    if (!result.ok) throw new Error(result.error || 'Backend returned ok:false');

    const payload = (result.data) ? result.data : result;
    dashboardData.sales = Array.isArray(payload?.sales) ? payload.sales : [];
    dashboardData.bdc   = Array.isArray(payload?.bdc)   ? payload.bdc   : [];
    dashboardData.bdc = dashboardData.bdc.map(x => ({ calls: 0, texts: 0, ...x }));
    // Total Units from "User Act" sheet (col M, "Total" row) â€” sent by backend
    dashboardData.salesTotalUnits = payload.salesTotalUnits ?? null;
    console.log('DEBUG salesTotalUnits from backend:', payload.salesTotalUnits, '| stored:', dashboardData.salesTotalUnits);

    renderDashboard();
    setTopbarQuote();
    prefetchForDashboard(dashboardData);
    checkLeadsAtRisk();
    loadCustomLinks();
    loadCallPatterns();
  } catch (err) {
    console.error('Dashboard error:', err);
    document.getElementById('app').innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div class="detail-card" style="max-width:500px;margin:auto;color:#dc2626;">
          <h2>Error Loading Dashboard</h2>
          <p style="white-space:pre-wrap;">${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">Retry</button>
        </div>
      </div>`;
  }
}

/* â”€â”€ Compute Stats â”€â”€ */
function bdcStats(rows) {
  let totalShown = 0, totalCreated = 0, totalDue = 0;
  rows.forEach(r => {
    totalShown   += safeNum(shownVal(r));
    totalCreated += safeNum(r.created ?? r.created_count ?? 0);
    totalDue     += safeNum(r.due ?? r.due_count ?? 0);
  });
  const avgShowRate = totalDue > 0 ? ((totalShown / totalDue) * 100).toFixed(1) : (totalCreated > 0 ? ((totalShown / totalCreated) * 100).toFixed(1) : 'â€“');
  return { totalShown, totalCreated, avgShowRate };
}

function salesStats(rows) {
  let totalUnits = safeNum(dashboardData.salesTotalUnits ?? 0);
  let topName = 'â€“', topVal = 0;
  let repSalesSum = 0;
  rows.forEach(r => {
    const s = safeNum(r.sales);
    repSalesSum += s;
    if (s > topVal) { topVal = s; topName = r.name || 'â€“'; }
  });
  const active = rows.filter(r => safeNum(r.sales) > 0 || safeNum(r.calls) > 0).length || rows.length || 1;
  const avgUnits = active > 0 ? (repSalesSum / active).toFixed(2) : '0';
  return { totalUnits, avgUnits, topName, topVal };
}

/* â”€â”€ Column definitions (draggable order) â”€â”€ */
const BDC_COL_DEFS = {
  shown:    { key: 'shown',    label: 'Appts Shown', primary: true },
  pctShown: { key: 'pctShown', label: '% Shown' },
  due:      { key: 'due',      label: 'Appts Due' },
  created:  { key: 'created',  label: 'Appts Created' },
  calls:    { key: 'calls',    label: 'Calls' },
  texts:    { key: 'texts',    label: 'Texts' },
};
const SALES_COL_DEFS = {
  sales:    { key: 'sales',    label: 'Sales', primary: true },
  pctShown: { key: 'pctShown', label: '% Shown' },
  shown:    { key: 'shown',    label: 'Appts Shown' },
  due:      { key: 'due',      label: 'Appts Due' },
  created:  { key: 'created',  label: 'Appts Created' },
  calls:    { key: 'calls',    label: 'Calls' },
  texts:    { key: 'texts',    label: 'Texts' },
};
// Mutable order arrays (user can rearrange via drag)
let bdcColOrder   = ['shown','pctShown','due','created','calls','texts'];
let salesColOrder = ['sales','pctShown','shown','due','created','calls','texts'];

let _dragPanel = null, _dragColKey = null;

function onColDragStart(e, panel, colKey) {
  _dragPanel = panel; _dragColKey = colKey;
  e.dataTransfer.effectAllowed = 'move';
  e.target.style.opacity = '0.5';
}
function onColDragEnd(e) { e.target.style.opacity = '1'; _dragPanel = null; _dragColKey = null; }
function onColDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function onColDrop(e, panel, targetKey) {
  e.preventDefault();
  if (_dragPanel !== panel || !_dragColKey || _dragColKey === targetKey) return;
  const arr = panel === 'bdc' ? bdcColOrder : salesColOrder;
  const fromIdx = arr.indexOf(_dragColKey);
  const toIdx = arr.indexOf(targetKey);
  if (fromIdx < 0 || toIdx < 0) return;
  arr.splice(fromIdx, 1);
  arr.splice(toIdx, 0, _dragColKey);
  renderDashboard();
}
window.onColDragStart = onColDragStart;
window.onColDragEnd = onColDragEnd;
window.onColDragOver = onColDragOver;
window.onColDrop = onColDrop;

/* â”€â”€ Sort â”€â”€ */
function sortRows(rows, sortState, type) {
  const { col, dir } = sortState;
  const mult = dir === 'desc' ? -1 : 1;
  return [...rows].sort((a, b) => {
    let va, vb;
    if (col === 'name') {
      va = (a.name || '').toLowerCase();
      vb = (b.name || '').toLowerCase();
      return mult * va.localeCompare(vb);
    }
    if (col === 'shown') { va = safeNum(shownVal(a)); vb = safeNum(shownVal(b)); }
    else if (col === 'created') { va = safeNum(a.created ?? a.created_count ?? 0); vb = safeNum(b.created ?? b.created_count ?? 0); }
    else if (col === 'due') { va = safeNum(a.due ?? a.due_count ?? 0); vb = safeNum(b.due ?? b.due_count ?? 0); }
    else if (col === 'pctShown') {
      const dueA = safeNum(a.due ?? a.due_count ?? a.created ?? 0) || 1;
      const dueB = safeNum(b.due ?? b.due_count ?? b.created ?? 0) || 1;
      va = safeNum(shownVal(a)) / dueA;
      vb = safeNum(shownVal(b)) / dueB;
    }
    else { va = safeNum(a[col]); vb = safeNum(b[col]); }
    return mult * (va - vb);
  });
}

function toggleSort(panel, col) {
  const s = panel === 'bdc' ? bdcSort : salesSort;
  if (s.col === col) { s.dir = s.dir === 'desc' ? 'asc' : 'desc'; }
  else { s.col = col; s.dir = 'desc'; }
  renderDashboard();
}

/* â”€â”€ KPI Weekly Targets (Sales) â”€â”€ */
const WEEKLY_TARGETS = { calls: 150, texts: 100, created: 5, due: 5, shown: 3 };

function kpiClass(value, target) {
  if (target <= 0) return '';
  if (value <= 0) return 'kpi-gray';
  const pct = value / target;
  if (pct >= 1) return 'kpi-green';
  if (pct >= 0.5) return 'kpi-yellow';
  return 'kpi-red';
}

/* â”€â”€ BDC Column-Relative Gradient â”€â”€ */
/* Computes min/max per metric across all BDC rows, then colors each cell
   on a red â†’ yellow â†’ green scale based on where it falls in that range. */
function bdcColumnRanges(rows) {
  const metrics = ['calls','texts','created','due'];
  const ranges = {};
  metrics.forEach(m => {
    let min = Infinity, max = -Infinity;
    rows.forEach(r => {
      let v;
      if (m === 'calls') v = safeNum(r.calls);
      else if (m === 'texts') v = safeNum(r.texts);
      else if (m === 'created') v = safeNum(r.created ?? r.created_count ?? 0);
      else if (m === 'due') v = safeNum(r.due ?? r.due_count ?? 0);
      else v = 0;
      if (v < min) min = v;
      if (v > max) max = v;
    });
    ranges[m] = { min, max };
  });
  return ranges;
}

function kpiColumnGradient(value, min, max) {
  if (max === min) {
    // Everyone has the same value
    if (value <= 0) return 'background:#f4f4f5;color:#a1a1aa;font-weight:600;';
    return 'background:#dcfce7;color:#16a34a;font-weight:700;';
  }
  if (value <= 0) return 'background:#f4f4f5;color:#a1a1aa;font-weight:600;';

  const pct = (value - min) / (max - min); // 0 = worst, 1 = best

  let r, g, b, tr, tg, tb;
  if (pct < 0.5) {
    const t = pct / 0.5;
    // red (#fee2e2) â†’ amber (#fef3c7)
    r = 254; g = Math.round(226 + t * (243 - 226)); b = Math.round(226 - t * (226 - 199));
    tr = Math.round(220 + t * (180 - 220)); tg = Math.round(38 + t * (83 - 38)); tb = Math.round(38 + t * (9 - 38));
  } else {
    const t = (pct - 0.5) / 0.5;
    // amber (#fef3c7) â†’ green (#dcfce7)
    r = Math.round(254 - t * (254 - 220)); g = Math.round(243 + t * (252 - 243)); b = Math.round(199 - t * (199 - 231));
    tr = Math.round(180 - t * (180 - 22)); tg = Math.round(83 + t * (163 - 83)); tb = Math.round(9 + t * (74 - 9));
  }
  return `background:rgb(${r},${g},${b});color:rgb(${tr},${tg},${tb});font-weight:700;`;
}

/* â”€â”€ Render â”€â”€ */
/* â”€â”€ Personal Scorecard + Rank + Leads at Risk â”€â”€ */
function buildPersonalSection(sales, bdc) {
  const me = window.userData || {};
  const myName = (me.linkedName || '').trim();
  if (!myName) return ''; // not linked, skip

  // Always rank by primary metric (sales desc, shown desc) regardless of current sort
  const salesByUnits = [...sales].sort((a, b) => safeNum(b.sales) - safeNum(a.sales));
  const bdcByShown   = [...bdc].sort((a, b) => safeNum(shownVal(b)) - safeNum(shownVal(a)));

  const myNameUpper = myName.toUpperCase();
  const salesIdx = salesByUnits.findIndex(r => (r.name || '').toUpperCase() === myNameUpper);
  const bdcIdx   = bdcByShown.findIndex(r => (r.name || '').toUpperCase() === myNameUpper);

  const inSales = salesIdx >= 0;
  const inBDC   = bdcIdx >= 0;
  if (!inSales && !inBDC) return ''; // not on either board

  let cards = '';

  if (inSales) {
    const r = salesByUnits[salesIdx];
    const rank = salesIdx + 1;
    const total = salesByUnits.length;
    const unitsSold = safeNum(r.sales);
    const calls = safeNum(r.calls);
    const texts = safeNum(r.texts);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const shown = safeNum(shownVal(r));
    const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : 'ğŸ“Š';

    cards = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:80px;text-align:center;">
          <div style="font-size:22px;">${rankEmoji}</div>
          <div style="font-size:20px;font-weight:800;color:var(--accent);">#${rank}</div>
          <div style="font-size:10px;color:var(--muted);">of ${total} reps</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${unitsSold}</div>
          <div style="font-size:10px;color:var(--muted);">Units</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${calls}</div>
          <div style="font-size:10px;color:var(--muted);">Calls</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${texts}</div>
          <div style="font-size:10px;color:var(--muted);">Texts</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${created}</div>
          <div style="font-size:10px;color:var(--muted);">Appts Created</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${shown}</div>
          <div style="font-size:10px;color:var(--muted);">Appts Shown</div>
        </div>
      </div>`;
  }

  if (inBDC) {
    const r = bdcByShown[bdcIdx];
    const rank = bdcIdx + 1;
    const total = bdcByShown.length;
    const shown = safeNum(shownVal(r));
    const calls = safeNum(r.calls);
    const texts = safeNum(r.texts);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const due = safeNum(r.due ?? r.due_count ?? 0);
    const pct = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : 'â€“';
    const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : 'ğŸ“Š';

    cards = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:80px;text-align:center;">
          <div style="font-size:22px;">${rankEmoji}</div>
          <div style="font-size:20px;font-weight:800;color:var(--accent);">#${rank}</div>
          <div style="font-size:10px;color:var(--muted);">of ${total} agents</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${shown}</div>
          <div style="font-size:10px;color:var(--muted);">Shown</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${calls}</div>
          <div style="font-size:10px;color:var(--muted);">Calls</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${texts}</div>
          <div style="font-size:10px;color:var(--muted);">Texts</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${created}</div>
          <div style="font-size:10px;color:var(--muted);">Created</div>
        </div>
        <div style="flex:1;min-width:60px;text-align:center;">
          <div style="font-size:20px;font-weight:800;">${pct}</div>
          <div style="font-size:10px;color:var(--muted);">Show Rate</div>
        </div>
      </div>`;
  }

  const teamLabel = inSales ? 'Sales' : 'BDC';
  const firstName = myName.split(' ')[0] || myName;

  return `
    <div style="max-width:1400px;margin:0 auto 12px;padding:0 12px;">
      <div id="personalCard" style="background:linear-gradient(135deg,#1e293b,#334155);border-radius:14px;padding:16px 20px;color:#fff;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
          <div style="font-size:15px;font-weight:700;">ğŸ‘‹ Hey ${firstName} â€” here's your ${teamLabel} snapshot</div>
          <div style="font-size:11px;color:#94a3b8;">MTD Performance</div>
        </div>
        ${cards}
        <div id="leadsAtRiskBanner"></div>
      </div>
    </div>`;
}

/* Fetch reassignment data in background and show leads-at-risk banner */
function checkLeadsAtRisk() {
  const me = window.userData || {};
  const myName = (me.linkedName || '').trim();
  if (!myName) return;

  const url = `${SCRIPT_URL}?route=reassignments&session=${encodeURIComponent(window.sessionToken || '')}`;
  fetch(url).then(r => r.text()).then(raw => {
    let result;
    try { result = JSON.parse(raw); } catch { return; }
    if (!result.ok) return;

    const rows = result.rows || [];
    const myNameUpper = myName.toUpperCase();
    const myLeads = rows.filter(r =>
      (r.salesPerson || '').toUpperCase().includes(myNameUpper) ||
      (r.bdcAgent || '').toUpperCase().includes(myNameUpper)
    );

    const banner = document.getElementById('leadsAtRiskBanner');
    if (!banner) return;

    if (myLeads.length > 0) {
      const reviewCount = myLeads.filter(r => r.status === 'Active - Manager Review').length;
      const reviewNote = reviewCount > 0 ? ` Â· <span style="color:#fca5a5;">${reviewCount} in Manager Review</span>` : '';
      banner.innerHTML = `
        <div onclick="${(isAdmin() || isManager()) ? 'showReassignments()' : ''}" style="margin-top:12px;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);border-radius:10px;padding:10px 14px;${(isAdmin() || isManager()) ? 'cursor:pointer;' : ''}display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;">
          <div>
            <span style="font-size:14px;">ğŸš¨</span>
            <strong style="color:#fca5a5;">You have ${myLeads.length} lead${myLeads.length !== 1 ? 's' : ''} with 3+ days no contact</strong>${reviewNote}
          </div>
          ${(isAdmin() || isManager()) ? '<span style="font-size:12px;color:#94a3b8;">View Reassignments â†’</span>' : '<span style="font-size:12px;color:#94a3b8;">Follow up today!</span>'}
        </div>`;
    }
  }).catch(() => {});
}

/* â”€â”€ Pearson Correlation for KPI Analysis (all users) â”€â”€ */
function pearsonR(xs, ys) {
  const n = xs.length;
  if (n < 3) return null; // need at least 3 data points
  const mx = xs.reduce((s, v) => s + v, 0) / n;
  const my = ys.reduce((s, v) => s + v, 0) / n;
  let num = 0, dx2 = 0, dy2 = 0;
  for (let i = 0; i < n; i++) {
    const dx = xs[i] - mx, dy = ys[i] - my;
    num += dx * dy;
    dx2 += dx * dx;
    dy2 += dy * dy;
  }
  const denom = Math.sqrt(dx2 * dy2);
  return denom === 0 ? 0 : num / denom;
}

function buildCorrelationBox(rows, targetKey, targetLabel, kpiDefs) {
  if (rows.length < 3) return '';

  const targetVals = rows.map(r => {
    if (targetKey === 'shown') return safeNum(shownVal(r));
    return safeNum(r[targetKey]);
  });

  const results = [];
  kpiDefs.forEach(kpi => {
    const vals = rows.map(r => {
      if (kpi.key === 'shown') return safeNum(shownVal(r));
      if (kpi.key === 'pctShown') {
        const shown = safeNum(shownVal(r));
        const due = safeNum(r.due ?? r.due_count ?? 0);
        const created = safeNum(r.created ?? r.created_count ?? 0);
        return due > 0 ? shown / due : (created > 0 ? shown / created : 0);
      }
      return safeNum(r[kpi.key] ?? r[kpi.alt] ?? 0);
    });
    const r = pearsonR(vals, targetVals);
    if (r !== null) results.push({ label: kpi.label, r });
  });

  results.sort((a, b) => Math.abs(b.r) - Math.abs(a.r));

  let rows_html = results.map(item => {
    const absR = Math.abs(item.r);
    const sign = item.r >= 0 ? '+' : 'âˆ’';
    const color = absR >= 0.7 ? '#16a34a' : absR >= 0.4 ? '#ca8a04' : '#94a3b8';
    const strength = absR >= 0.7 ? 'Strong' : absR >= 0.4 ? 'Moderate' : 'Weak';
    const barW = Math.round(absR * 100);
    const barColor = item.r >= 0
      ? (absR >= 0.7 ? '#22c55e' : absR >= 0.4 ? '#eab308' : '#d1d5db')
      : (absR >= 0.7 ? '#ef4444' : absR >= 0.4 ? '#f97316' : '#d1d5db');
    return `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--line);">
      <div style="width:110px;font-size:12px;font-weight:600;">${item.label}</div>
      <div style="flex:1;height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
        <div style="width:${barW}%;height:100%;background:${barColor};border-radius:4px;transition:width .3s;"></div>
      </div>
      <div style="min-width:50px;text-align:right;font-size:12px;font-weight:700;color:${color};">${sign}${absR.toFixed(2)}</div>
      <div style="min-width:60px;text-align:right;font-size:10px;color:${color};">${strength}</div>
    </div>`;
  }).join('');

  return `
    <div style="margin-top:12px;padding:14px 16px;background:var(--card);border:1px solid var(--line);border-radius:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div style="font-weight:700;font-size:13px;">ğŸ“ KPI Correlation to ${targetLabel}</div>
        <div style="font-size:10px;color:var(--muted);">Pearson r Â· ${rows.length} reps</div>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:8px;">Which metrics most predict ${targetLabel.toLowerCase()}?</div>
      ${rows_html}
      <div style="margin-top:8px;font-size:10px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap;">
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#22c55e;"></span> Strong (â‰¥0.70)</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#eab308;"></span> Moderate (0.40â€“0.69)</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#d1d5db;"></span> Weak (&lt;0.40)</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#ef4444;"></span> Negative</span>
      </div>
    </div>`;
}

/* â”€â”€ Day-of-Week & Time-of-Day Performance Patterns (admin only) â”€â”€ */
let _callPatternsData = null;
let _callPatternsFilter = 'total'; // 'total', 'inbound', 'outbound'

function setCallPatternsFilter(f) {
  _callPatternsFilter = f;
  renderCallPatternsFromCache();
}
window.setCallPatternsFilter = setCallPatternsFilter;

function loadCallPatterns() {
  if (!isAdmin() && !isManager()) return;
  const container = document.getElementById('callPatternsBox');
  if (!container) return;

  const url = `${SCRIPT_URL}?route=callpatterns&session=${encodeURIComponent(window.sessionToken || '')}`;
  fetch(url).then(r => r.text()).then(raw => {
    let result;
    try { result = JSON.parse(raw); } catch { return; }
    if (!result.ok) return;
    _callPatternsData = result;
    _callPatternsFilter = 'total';
    renderCallPatternsFromCache();
  }).catch(err => {
    console.error('Call patterns load error:', err);
  });
}

function renderCallPatternsFromCache() {
  const container = document.getElementById('callPatternsBox');
  if (!container || !_callPatternsData) return;

  const result = _callPatternsData;
  // Support both old format (flat) and new format (total/inbound/outbound)
  const hasNewFormat = result.total && result.total.heatmap;
  const slice = hasNewFormat
    ? (result[_callPatternsFilter] || result.total)
    : { heatmap: result.heatmap || [], dayTotals: result.dayTotals || [], hourTotals: result.hourTotals || [] };
  const showToggle = hasNewFormat;
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const heatmap = slice.heatmap || [];

  // Filter label
  const filterLabels = { total: 'All Calls', inbound: 'Inbound', outbound: 'Outbound' };
  const filterColors = { total: '#166534', inbound: '#2563eb', outbound: '#f97316' };
  const heatPalettes = {
    total:    { bg: ['var(--card)','#f0fdf4','#bbf7d0','#86efac','#22c55e','#166534'], fg6: '#fff' },
    inbound:  { bg: ['var(--card)','#eff6ff','#bfdbfe','#93c5fd','#3b82f6','#1d4ed8'], fg6: '#fff' },
    outbound: { bg: ['var(--card)','#fff7ed','#fed7aa','#fdba74','#f97316','#c2410c'], fg6: '#fff' },
  };
  const palette = heatPalettes[_callPatternsFilter];

  // Hour range
  let minHour = 23, maxHour = 0;
  heatmap.forEach(c => {
    if (c.hour < minHour) minHour = c.hour;
    if (c.hour > maxHour) maxHour = c.hour;
  });
  if (minHour > maxHour) { minHour = 7; maxHour = 20; }
  minHour = Math.max(0, minHour - 1);
  maxHour = Math.min(23, maxHour + 1);

  // Build grid
  const grid = {};
  let maxCount = 1;
  heatmap.forEach(c => {
    if (!grid[c.day]) grid[c.day] = {};
    grid[c.day][c.hour] = c;
    if (c.count > maxCount) maxCount = c.count;
  });

  function heatColor(count) {
    if (!count) return palette.bg[0];
    const pct = count / maxCount;
    if (pct >= 0.8) return palette.bg[5];
    if (pct >= 0.6) return palette.bg[4];
    if (pct >= 0.4) return palette.bg[3];
    if (pct >= 0.2) return palette.bg[2];
    return palette.bg[1];
  }
  function textColor(count) {
    if (!count) return 'var(--muted)';
    const pct = count / maxCount;
    return pct >= 0.6 ? palette.fg6 : '#1e293b';
  }
  function fmtHour(h) {
    if (h === 0) return '12a';
    if (h < 12) return h + 'a';
    if (h === 12) return '12p';
    return (h - 12) + 'p';
  }

  // Build table
  let gridHTML = '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:11px;">';
  gridHTML += '<thead><tr><th style="padding:4px 6px;text-align:left;font-size:10px;color:var(--muted);">Day</th>';
  for (let h = minHour; h <= maxHour; h++) {
    gridHTML += `<th style="padding:4px 2px;text-align:center;font-size:9px;color:var(--muted);min-width:32px;">${fmtHour(h)}</th>`;
  }
  gridHTML += '<th style="padding:4px 6px;text-align:right;font-size:10px;color:var(--muted);">Total</th></tr></thead><tbody>';

  const dayOrder = [1,2,3,4,5,6,0];
  const dayTotals = slice.dayTotals || [];
  const hourTotals = slice.hourTotals || [];

  dayOrder.forEach(d => {
    const dayTotal = dayTotals[d] || 0;
    const isWeekend = d === 0 || d === 6;
    gridHTML += `<tr><td style="padding:4px 6px;font-weight:700;font-size:11px;${isWeekend ? 'color:var(--muted);' : ''}">${dayNames[d]}</td>`;
    for (let h = minHour; h <= maxHour; h++) {
      const cell = (grid[d] || {})[h];
      const count = cell ? cell.count : 0;
      const talk = cell ? cell.avgTalk : 0;
      const bg = heatColor(count);
      const fg = textColor(count);
      const title = count > 0 ? `${dayNames[d]} ${fmtHour(h)}: ${count} ${filterLabels[_callPatternsFilter].toLowerCase()}, avg ${talk.toFixed(1)}min` : `${dayNames[d]} ${fmtHour(h)}: no calls`;
      gridHTML += `<td style="padding:3px 1px;text-align:center;background:${bg};color:${fg};border-radius:3px;font-weight:${count > 0 ? '600' : '400'};" title="${title}">${count || 'Â·'}</td>`;
    }
    gridHTML += `<td style="padding:4px 6px;text-align:right;font-weight:700;font-size:11px;">${dayTotal}</td></tr>`;
  });

  gridHTML += '<tr><td style="padding:4px 6px;font-size:10px;color:var(--muted);font-weight:600;">Total</td>';
  for (let h = minHour; h <= maxHour; h++) {
    const ht = hourTotals[h] || 0;
    gridHTML += `<td style="padding:3px 1px;text-align:center;font-size:10px;font-weight:600;color:var(--muted);">${ht || 'Â·'}</td>`;
  }
  const grandTotal = dayTotals.reduce((s, v) => s + v, 0);
  gridHTML += `<td style="padding:4px 6px;text-align:right;font-weight:800;font-size:12px;">${grandTotal}</td></tr>`;
  gridHTML += '</tbody></table></div>';

  // Insights
  let peakDay = 0, peakDayVal = 0;
  dayTotals.forEach((v, i) => { if (v > peakDayVal) { peakDayVal = v; peakDay = i; } });
  let peakHour = 0, peakHourVal = 0;
  hourTotals.forEach((v, i) => { if (v > peakHourVal) { peakHourVal = v; peakHour = i; } });
  let deadHour = -1, deadHourVal = Infinity;
  for (let h = 8; h <= 18; h++) {
    const v = hourTotals[h] || 0;
    if (v < deadHourVal) { deadHourVal = v; deadHour = h; }
  }
  const accentClr = filterColors[_callPatternsFilter];
  const insights = `
    <div style="margin-top:10px;font-size:11px;color:var(--muted);line-height:1.7;">
      â€¢ <strong>${dayNames[peakDay]}</strong> is the busiest day with ${peakDayVal} total calls<br>
      ${deadHour >= 0 ? `â€¢ <strong style="color:#dc2626;">${fmtHour(deadHour)}â€“${fmtHour(deadHour+1)}</strong> is the slowest business hour â€” only ${deadHourVal} calls<br>` : ''}
      â€¢ Peak calling hour overall: <strong>${fmtHour(peakHour)}â€“${fmtHour(peakHour+1)}</strong> with ${peakHourVal} calls
    </div>`;

  // Legend with palette colors
  const legend = `<div style="display:flex;gap:6px;align-items:center;margin-top:8px;font-size:10px;color:var(--muted);">
    <span>Low</span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[1]};border:1px solid var(--line);border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[2]};border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[3]};border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[4]};border-radius:2px;"></span>
    <span style="display:inline-block;width:14px;height:10px;background:${palette.bg[5]};border-radius:2px;"></span>
    <span>High</span>
    <span style="margin-left:8px;">Â· Hover cells for details</span>
  </div>`;

  // Toggle buttons
  function tbtn(key, label) {
    const active = _callPatternsFilter === key;
    const clr = filterColors[key];
    return `<button onclick="setCallPatternsFilter('${key}')" style="padding:3px 10px;font-size:11px;font-weight:${active ? '700' : '500'};border:1px solid ${active ? clr : 'var(--line)'};background:${active ? clr : 'transparent'};color:${active ? '#fff' : 'var(--text)'};border-radius:6px;cursor:pointer;transition:all .15s;">${label}</button>`;
  }

  // Totals for each filter for the header
  const totalAll = (hasNewFormat ? result.total?.dayTotals : slice.dayTotals || []).reduce((s, v) => s + v, 0);
  const totalIB  = hasNewFormat ? (result.inbound?.dayTotals || []).reduce((s, v) => s + v, 0) : 0;
  const totalOB  = hasNewFormat ? (result.outbound?.dayTotals || []).reduce((s, v) => s + v, 0) : 0;

  const dateRangeStr = result.dateRange ? `${result.dateRange.from || '?'} â€“ ${result.dateRange.to || '?'}` : '';

  container.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-weight:700;font-size:13px;">ğŸ• Call Activity Heatmap</div>
        ${showToggle ? `<div style="display:flex;gap:4px;">
          ${tbtn('total', 'Total')}
          ${tbtn('inbound', 'IB')}
          ${tbtn('outbound', 'OB')}
        </div>` : ''}
      </div>
      <div style="font-size:10px;color:var(--muted);">${result.month || 'MTD'}${dateRangeStr ? ` Â· <span style="color:var(--text);">${dateRangeStr}</span>` : ''} Â· ${grandTotal} ${filterLabels[_callPatternsFilter].toLowerCase()}${showToggle ? ` Â· <span style="color:var(--text);">${totalAll} total</span> (<span style="color:#2563eb;">${totalIB} IB</span> / <span style="color:#f97316;">${totalOB} OB</span>)` : ''}</div>
    </div>
    <div style="font-size:10px;color:var(--muted);margin-bottom:8px;">When are ${_callPatternsFilter === 'total' ? 'calls' : _callPatternsFilter + ' calls'} happening? Darker = more calls in that time slot.</div>
    ${gridHTML}
    ${legend}
    ${insights}`;
}

function renderDashboard() {
  const me = window.userData || {};
  const bdc   = sortRows(dashboardData.bdc, bdcSort, 'bdc');
  const sales = sortRows(dashboardData.sales, salesSort, 'sales');
  const bs = bdcStats(bdc);
  const ss = salesStats(sales);
  const now = timeStr();
  const bdcRanges = bdcColumnRanges(bdc);

  function sortArrow(panel, col) {
    const s = panel === 'bdc' ? bdcSort : salesSort;
    const active = s.col === col;
    const arrow = active ? (s.dir === 'desc' ? 'â–¼' : 'â–²') : 'â†•';
    return `<span class="sort-arrow">${arrow}</span>`;
  }
  function thAttr(panel, col) {
    return `class="${(panel === 'bdc' ? bdcSort : salesSort).col === col ? 'sorted' : ''}" onclick="toggleSort('${panel}','${col}')"`;
  }
  function thDrag(panel, col) {
    return `draggable="true" ondragstart="onColDragStart(event,'${panel}','${col}')" ondragend="onColDragEnd(event)" ondragover="onColDragOver(event)" ondrop="onColDrop(event,'${panel}','${col}')" style="cursor:grab;"`;
  }

  function trophy(i) {
    if (i === 0) return '<span class="trophy">ğŸ¥‡</span>';
    if (i === 1) return '<span class="trophy">ğŸ¥ˆ</span>';
    if (i === 2) return '<span class="trophy">ğŸ¥‰</span>';
    return '';
  }

  /* â”€â”€ BDC cell renderer â”€â”€ */
  function bdcCellData(r) {
    const shown   = safeNum(shownVal(r));
    const calls   = safeNum(r.calls);
    const texts   = safeNum(r.texts);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const due     = safeNum(r.due ?? r.due_count ?? 0);
    const pct     = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : (created > 0 ? ((shown / created) * 100).toFixed(1) + '%' : 'â€“');
    const callsS   = kpiColumnGradient(calls, bdcRanges.calls.min, bdcRanges.calls.max);
    const textsS   = kpiColumnGradient(texts, bdcRanges.texts.min, bdcRanges.texts.max);
    const createdS = kpiColumnGradient(created, bdcRanges.created.min, bdcRanges.created.max);
    const dueS     = kpiColumnGradient(due, bdcRanges.due.min, bdcRanges.due.max);
    return {
      shown:    `<td><strong>${shown}</strong></td>`,
      pctShown: `<td>${pct}</td>`,
      due:      `<td style="${dueS}">${due}</td>`,
      created:  `<td style="${createdS}">${created}</td>`,
      calls:    `<td style="${callsS}">${calls}</td>`,
      texts:    `<td style="${textsS}">${texts}</td>`,
    };
  }

  function bdcRow(r, i) {
    const name = r.name || 'â€“';
    const top3    = i < 3 ? ' top3' : '';
    const allowed = canViewName(name);
    const click   = allowed ? `onclick="showPersonDetails('${name.replace(/'/g, "\\'")}', 'BDC')" onmouseenter="onRowHover('${name.replace(/'/g, "\\'")}')"` : '';
    const cursor  = allowed ? 'cursor:pointer;' : 'opacity:0.7;';
    const cells = bdcCellData(r);
    return `<tr class="${top3}" ${click} style="${cursor}">
      <td class="rank-cell">${trophy(i)}${i < 3 ? '' : (i + 1)}</td>
      <td class="name-cell">${name}</td>
      ${bdcColOrder.map(k => cells[k]).join('')}
    </tr>`;
  }

  /* â”€â”€ Sales cell renderer â”€â”€ */
  function salesCellData(r) {
    const salesV  = safeNum(r.sales);
    const calls   = safeNum(r.calls);
    const texts   = safeNum(r.texts);
    const created = safeNum(r.created ?? r.created_count ?? 0);
    const due     = safeNum(r.due ?? r.due_count ?? 0);
    const shown   = safeNum(shownVal(r));
    const pct     = due > 0 ? ((shown / due) * 100).toFixed(1) + '%' : (created > 0 ? ((shown / created) * 100).toFixed(1) + '%' : 'â€“');
    const callsK   = kpiClass(calls, WEEKLY_TARGETS.calls);
    const textsK   = kpiClass(texts, WEEKLY_TARGETS.texts);
    const createdK = kpiClass(created, WEEKLY_TARGETS.created);
    const dueK     = kpiClass(due, WEEKLY_TARGETS.due);
    const shownK   = kpiClass(shown, WEEKLY_TARGETS.shown);
    return {
      sales:    `<td class="sales-primary">${salesV}</td>`,
      pctShown: `<td>${pct}</td>`,
      shown:    `<td class="${shownK}">${shown}</td>`,
      due:      `<td class="${dueK}">${due}</td>`,
      created:  `<td class="${createdK}">${created}</td>`,
      calls:    `<td class="${callsK}">${calls}</td>`,
      texts:    `<td class="${textsK}">${texts}</td>`,
    };
  }

  function salesRow(r, i) {
    const name    = r.name || 'â€“';
    const top3    = i < 3 ? ' top3' : '';
    const allowed = canViewName(name);
    const click   = allowed ? `onclick="showPersonDetails('${name.replace(/'/g, "\\'")}', 'Sales')" onmouseenter="onRowHover('${name.replace(/'/g, "\\'")}')"` : '';
    const cursor  = allowed ? 'cursor:pointer;' : 'opacity:0.7;';
    const cells = salesCellData(r);
    return `<tr class="${top3}" ${click} style="${cursor}">
      <td class="rank-cell">${trophy(i)}${i < 3 ? '' : (i + 1)}</td>
      <td class="name-cell">${name}</td>
      ${salesColOrder.map(k => cells[k]).join('')}
    </tr>`;
  }

  document.getElementById('app').innerHTML = `
    <!-- Top Bar -->
    <div class="topbar">
      <div class="topbar-logo">SA</div>
      <div class="topbar-info">
        <div class="topbar-title">BDC &amp; Sales Leaderboards</div>
        <div class="topbar-sub"><span class="refresh-dot"></span><span id="topbarQuote"></span></div>
      </div>
      <div class="topbar-actions">
        <div style="position:relative;display:inline-block;" id="resourcesWrap">
          <button class="topbar-btn manage" onclick="toggleResourcesMenu()" style="min-width:110px;">ğŸ“‚ Resources â–¾</button>
          <div id="resourcesMenu" style="display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:1000;min-width:220px;padding:6px 0;max-height:70vh;overflow-y:auto;">
            <a href="https://sanantoniododge.com" target="_blank" class="res-link">ğŸŒ Website</a>
            <a href="https://www.eleadcrm.com/evo2/fresh/login.asp?logout=1&CID=0&USERID=0&SESSIONID=" target="_blank" class="res-link">ğŸ–¥ï¸ Old CRM</a>
            <a href="https://retail.cdk.com/login/login.htm?fromURI=%2Fapp%2Fmodern-retailing_eleadcrm_2%2Fexk3ds515b8OezABo697%2Fsso%2Fsaml%3FSAMLRequest%3DfZHNbsIwEITvSLxD5DtxYpofLEBKywWJqhK0PfSCnHgpFrGdep2C%252BvRNQ1HLhevMfjua3SkKXbOGF63fmzV8tIA%252BOOnaID87M9I6w61AhdwIDch9xTfF44qzMOKNs95Wtib%252FmduIQATnlTUkWC5mRMkqjuNdFCdsIuVdPk5LEGlaTuKclWkpdxkJXsFhB8xIx3cUYgtLg14Y30kRS0YxG7HsORrzKOOMvZFg0dVQRvie2nvfIKfUgReqDit5CCurqWgaqq0EZ0ZnR5n3LdQgZOX0llE4HcYSkzgp8yf4Ku5tOskooqU%252FJUlQXHo8WIOtBrcB96kqeFmv%252FiKPx2N4WdmHdjyZDwdBMO1Pxfsybn5rfkqvRoeDX%252BH6afNv%26RelayState%3DdFxaLjd1sdMLESVboy1b35lo" target="_blank" class="res-link">ğŸ’» New CRM</a>
            <a href="https://auth.automotivemastermind.com/u/login/identifier?state=hKFo2SBqMkxFdnZqYUQzSmI5OFIzVFNXNGtLM2IzcDZrZDVXX6Fur3VuaXZlcnNhbC1sb2dpbqN0aWTZIEhzUjFTRVpIZ2RWeG1HNm1CX0xNM0lnQXJqSXNiVFY0o2NpZNkgQ0pHdUlpQThVZmRiVDRxMU54RTF6dU9NV3d0YTNuOWg" target="_blank" class="res-link">ğŸ§  Dealer Mastermind</a>
            <div style="border-top:1px solid var(--line);margin:4px 0;"></div>
            <a href="https://www.ramtrucks.com/vehicle-selector.incentives.html" target="_blank" class="res-link">ğŸ Ram Incentives</a>
            <a href="https://www.jeep.com/vehicle-selector.incentives.html" target="_blank" class="res-link">ğŸ”ï¸ Jeep Incentives</a>
            <a href="https://www.jeep.com/vehicle-selector.incentives.html" target="_blank" class="res-link">ğŸ”µ Chrysler Incentives</a>
            <a href="https://www.dodge.com/vehicle-selector.incentives.html" target="_blank" class="res-link">ğŸ”´ Dodge Incentives</a>
            <div style="border-top:1px solid var(--line);margin:4px 0;"></div>
            <a href="https://dealerconnect.chrysler.com/login/login.html?TYPE=33554433&REALMOID=06-d5cf97a8-bccd-103a-bcc8-83e513310cb3&GUID=&SMAUTHREASON=0&METHOD=GET&SMAGENTNAME=-SM-go2wTta208Z%2fzUCz5DbrvlEeym4%2faGv4KExpKsILVlca0WM5Is5FVfWQwWKj8l6iqbgVd8ZTMNXhZNBworA80NiZt2yCKScu&TARGET=-SM-https%3a%2f%2fdealerconnect%2echrysler%2ecom%2fportal%2fController%2fPortal" target="_blank" class="res-link">ğŸ”— DealerConnect</a>
            <a href="https://gemini.google.com/app" target="_blank" class="res-link">âœ¨ Gemini AI</a>
            <a href="#" onclick="event.preventDefault();closeResourcesMenu();showAutoNews();" class="res-link">ğŸ“° News (Last 48 hrs)</a>
            ${isAdmin() ? '<a href="#" onclick="event.preventDefault();closeResourcesMenu();showCompetitiveAnalysis();" class="res-link">ğŸ† Competitive Analysis</a>' : ''}
            <div id="customLinksSection"></div>
            <div style="border-top:1px solid var(--line);margin:4px 0;"></div>
            <div id="addLinkForm" style="padding:6px 12px;">
              <a href="#" onclick="event.preventDefault();event.stopPropagation();showAddLinkForm();" class="res-link" id="addLinkBtn" style="color:var(--accent);font-weight:600;">â• Add My Link</a>
              <div id="addLinkFields" style="display:none;padding:4px 0;">
                <input id="newLinkLabel" type="text" placeholder="Label (e.g. My Tool)" maxlength="40" style="width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-size:12px;margin-bottom:4px;box-sizing:border-box;" onclick="event.stopPropagation();" onkeydown="if(event.key==='Enter'){event.stopPropagation();document.getElementById('newLinkUrl').focus();}" />
                <input id="newLinkUrl" type="url" placeholder="https://..." maxlength="500" style="width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;font-size:12px;margin-bottom:6px;box-sizing:border-box;" onclick="event.stopPropagation();" onkeydown="if(event.key==='Enter'){event.stopPropagation();saveCustomLink();}" />
                <div style="display:flex;gap:6px;">
                  <button onclick="event.stopPropagation();saveCustomLink();" style="flex:1;padding:5px 0;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">Save</button>
                  <button onclick="event.stopPropagation();hideAddLinkForm();" style="flex:1;padding:5px 0;background:var(--line);color:var(--text);border:none;border-radius:6px;font-size:12px;cursor:pointer;">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        ${(isAdmin() || isManager()) ? `<div style="position:relative;display:inline-block;" id="reportsWrap">
          <button class="topbar-btn manage" onclick="toggleReportsMenu()" style="min-width:110px;">ğŸ“Š Reports â–¾</button>
          <div id="reportsMenu" style="display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:1000;min-width:200px;padding:6px 0;">
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showReassignments();" class="res-link">ğŸ”„ Reassignments</a>
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showActivityModal();" class="res-link">ğŸ• Activity Log</a>
            <a href="#" onclick="event.preventDefault();closeReportsMenu();showVehicleDemand();" class="res-link">ğŸš— Vehicle Demand</a>
            ${isAdmin() ? '<div style="border-top:1px solid var(--line);margin:4px 0;"></div><a href="#" onclick="event.preventDefault();closeReportsMenu();showLeadFunnel();" class="res-link">ğŸ”¬ Lead Funnel</a>' : ''}
            ${isAdmin() ? '<a href="#" onclick="event.preventDefault();closeReportsMenu();showEngagement();" class="res-link">ğŸ“ˆ Engagement</a>' : ''}
          </div>
        </div>` : ''}
        ${isAdmin() ? '<button class="topbar-btn manage" onclick="showUserModal()">ğŸ‘¤ Manage Users</button>' : ''}
        <button class="topbar-btn logout" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Two Panels -->
    ${buildPersonalSection(sales, bdc)}
    <div class="panels">

      <!-- â•â•â• BDC Panel â•â•â• -->
      <div>
        <div class="panel-header">
          <div class="panel-title">ğŸ“ BDC â€“ Appointments Shown</div>
          <div class="panel-subtitle">Top 3 highlighted by appointments shown Â· click headers to sort Â· drag to reorder</div>
        </div>

        <div class="stat-row">
          <div class="stat-card">
            <div class="stat-label">Total Appts Shown ğŸ‘£</div>
            <div class="stat-value">${bs.totalShown}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Appts Created ğŸ“‹</div>
            <div class="stat-value">${bs.totalCreated}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Show Rate ğŸ¯</div>
            <div class="stat-value">${bs.avgShowRate}%</div>
          </div>
        </div>

        <div class="chip-row">
          <div class="chip active">MTD</div>
        </div>

        <div class="kpi-legend" style="align-items:center;">
          <span style="display:inline-flex;align-items:center;gap:6px;">
            <span style="display:inline-block;width:120px;height:10px;border-radius:5px;background:linear-gradient(to right,#fee2e2 0%,#fef3c7 50%,#dcfce7 100%);border:1px solid var(--line);"></span>
            <span>lowest â†’ highest in column</span>
          </span>
          <span><span class="kpi-dot gray"></span> no activity</span>
        </div>

        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th class="rank-cell" ${thAttr('bdc','rank')}>Rank ${sortArrow('bdc','rank')}</th>
                <th style="text-align:left;" ${thAttr('bdc','name')}>Name ${sortArrow('bdc','name')}</th>
                ${bdcColOrder.map(k => `<th ${thAttr('bdc', BDC_COL_DEFS[k].key)} ${thDrag('bdc', k)}>${BDC_COL_DEFS[k].label} ${sortArrow('bdc', BDC_COL_DEFS[k].key)}</th>`).join('\n                ')}
              </tr>
            </thead>
            <tbody>
              ${bdc.length ? bdc.map((r, i) => bdcRow(r, i)).join('') : '<tr><td colspan="' + (2 + bdcColOrder.length) + '" style="padding:30px;color:var(--muted);">No BDC data</td></tr>'}
            </tbody>
          </table>
        </div>
        ${buildCorrelationBox(bdc, 'shown', 'Appts Shown', [
          { key: 'calls', label: 'Calls' },
          { key: 'texts', label: 'Texts' },
          { key: 'created', alt: 'created_count', label: 'Appts Created' },
          { key: 'due', alt: 'due_count', label: 'Appts Due' },
          { key: 'pctShown', label: '% Show Rate' },
        ])}
        ${buildCorrelationBox(sales, 'sales', 'Units Sold', [
          { key: 'calls', label: 'Calls' },
          { key: 'texts', label: 'Texts' },
          { key: 'created', alt: 'created_count', label: 'Appts Created' },
          { key: 'due', alt: 'due_count', label: 'Appts Due' },
          { key: 'shown', label: 'Appts Shown' },
          { key: 'pctShown', label: '% Show Rate' },
        ])}
        ${(isAdmin() || isManager()) ? '<div id="callPatternsBox" style="margin-top:12px;padding:14px 16px;background:var(--card);border:1px solid var(--line);border-radius:10px;"><div style="color:var(--muted);font-size:12px;">Loading call patternsâ€¦</div></div>' : ''}
      </div>

      <!-- â•â•â• Sales Panel â•â•â• -->
      <div>
        <div class="panel-header">
          <div class="panel-title">ğŸš— Sales â€“ Units Sold</div>
          <div class="panel-subtitle">Ranked by units sold Â· weekly KPI flags Â· click headers to sort Â· drag to reorder</div>
        </div>

        <div class="stat-row">
          <div class="stat-card">
            <div class="stat-label">Total Units ğŸš—</div>
            <div class="stat-value">${ss.totalUnits}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Units / Rep ğŸ“Š</div>
            <div class="stat-value">${ss.avgUnits}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Top Performer â­</div>
            <div class="stat-value top-performer">${ss.topName} (${ss.topVal})</div>
          </div>
        </div>

        <div class="chip-row">
          <div class="chip active">MTD</div>
        </div>

        <div class="kpi-legend">
          <span><span class="kpi-dot green"></span> â‰¥ target</span>
          <span><span class="kpi-dot yellow"></span> some but &lt; target</span>
          <span><span class="kpi-dot gray"></span> no activity yet</span>
          <span><span class="kpi-dot red"></span> sales well below target</span>
        </div>

        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th class="rank-cell" ${thAttr('sales','rank')}>Rank ${sortArrow('sales','rank')}</th>
                <th style="text-align:left;" ${thAttr('sales','name')}>Name ${sortArrow('sales','name')}</th>
                ${salesColOrder.map(k => `<th ${thAttr('sales', SALES_COL_DEFS[k].key)} ${thDrag('sales', k)}>${SALES_COL_DEFS[k].label} ${sortArrow('sales', SALES_COL_DEFS[k].key)}</th>`).join('\n                ')}
              </tr>
            </thead>
            <tbody>
              ${sales.length ? sales.map((r, i) => salesRow(r, i)).join('') : '<tr><td colspan="' + (2 + salesColOrder.length) + '" style="padding:30px;color:var(--muted);">No sales data</td></tr>'}
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /panels -->
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO-REFRESH (5 min)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setInterval(() => {
  if (window.userData && document.querySelector('.panels')) {
    showDashboard();
  }
}, 5 * 60 * 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSON DETAILS (1-on-1 view)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showPersonDetails(name, type) {
  trackClick();
  logPageView('Person Detail: ' + name);
  const appEl = document.getElementById('app');

  // Also start fetching calls in background so they're ready when user clicks "View Call Sheets"
  prefetchCalls(name);

  // Instant preview: use dashboard data we already have while full details load
  const preview = getDashboardRow(name);
  const isSalesPreview = type === 'Sales' || (preview && safeNum(preview.sales) > 0);

  if (preview && !personCache.has(cacheKey(name))) {
    // Show instant preview from leaderboard data
    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">${name}</div><div class="topbar-sub">${type || 'â€“'} Â· Loading full detailsâ€¦</div></div>
        <div class="topbar-actions">
          <button class="topbar-btn manage" onclick="showDashboard()">â† Back</button>
          <button class="topbar-btn logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="detail-card" style="margin-top:8px;">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:14px; margin-bottom:18px;">
          <div class="stat-card"><div class="stat-label">Calls (MTD)</div><div class="stat-value">${safeNum(preview.calls)}</div></div>
          ${isSalesPreview
            ? `<div class="stat-card"><div class="stat-label">Sales (MTD)</div><div class="stat-value">${safeNum(preview.sales)}</div></div>
               <div class="stat-card"><div class="stat-label">Texts (MTD)</div><div class="stat-value">${safeNum(preview.texts)}</div></div>`
            : `<div class="stat-card"><div class="stat-label">Appts Shown (MTD)</div><div class="stat-value">${safeNum(shownVal(preview))}</div></div>
               <div class="stat-card"><div class="stat-label">Appts Created (MTD)</div><div class="stat-value">${safeNum(preview.created ?? preview.created_count ?? 0)}</div></div>`
          }
        </div>
        <div style="text-align:center;padding:18px;color:var(--muted);font-size:13px;">
          <div class="spinner" style="margin:0 auto 10px;width:24px;height:24px;"></div>
          Loading full details, coaching notes & last work dayâ€¦
        </div>
      </div>`;
  } else {
    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">Loading ${name}â€¦</div></div>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>`;
  }

  try {
    const result = await fetchPerson(name);
    if (!result?.ok) throw new Error(result?.error || 'Failed to load person details');

    const payload = result.data || {};
    const b = payload.block || {};
    const day = payload.lastDay || {};
    const note = payload.prNotes || {};
    const isSales = (b.type || type) === 'Sales';

    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">${b.name || name}</div><div class="topbar-sub">${b.type || type || 'â€“'} Â· ${b.workingDays || 0} working days (MTD)</div></div>
        <div class="topbar-actions">
          <button class="topbar-btn manage" onclick="showDashboard()">â† Back</button>
          <button class="topbar-btn logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="detail-card" style="margin-top:8px;">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:14px; margin-bottom:18px;">
          <div class="stat-card"><div class="stat-label">Calls (MTD)</div><div class="stat-value">${b.callsMTD || 0}</div></div>
          ${isSales
            ? `<div class="stat-card"><div class="stat-label">Sales (MTD)</div><div class="stat-value">${b.salesMTD || 0}</div></div>
               <div class="stat-card"><div class="stat-label">Texts (MTD)</div><div class="stat-value">${b.textsMTD || 0}</div></div>`
            : `<div class="stat-card"><div class="stat-label">Appts Shown (MTD)</div><div class="stat-value">${b.shownMTD || 0}</div></div>
               <div class="stat-card"><div class="stat-label">Appts Created (MTD)</div><div class="stat-value">${b.createdMTD || 0}</div></div>`
          }
          <div class="stat-card"><div class="stat-label">Leads In Name</div><div class="stat-value">${b.leadsInNameMTD || 0}</div></div>
          <div class="stat-card"><div class="stat-label">Avg Talk</div><div class="stat-value">${b.avgTalk || '0:00'}</div></div>
        </div>

        <div style="background:#fafaf9;border-radius:10px;padding:14px;margin-bottom:14px;">
          <div style="font-weight:700;margin-bottom:6px;">Last Work Day</div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:14px;">
            <div><span style="color:var(--muted);">Date:</span> ${day.dateKey || 'â€“'}</div>
            <div><span style="color:var(--muted);">Calls:</span> ${day.calls || 0}</div>
            <div><span style="color:var(--muted);">Avg Talk:</span> ${day.avgTalkMSS || '0:00'}</div>
            ${isSales ? `<div><span style="color:var(--muted);">Texts:</span> ${day.texts || 0}</div>` : ''}
          </div>
        </div>

        ${note.wins ? `<div style="background:var(--greenBg);padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:14px;"><strong>Wins:</strong> ${note.wins}</div>` : ''}
        ${note.opportunities ? `<div style="background:var(--yellowBg);padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:14px;"><strong>Opportunities:</strong> ${note.opportunities}</div>` : ''}
        ${note.coaching ? `<div style="background:#ede9fe;padding:10px 14px;border-radius:8px;margin-bottom:8px;font-size:14px;"><strong>Coaching:</strong> ${note.coaching}</div>` : ''}

        <button class="btn" style="margin-top:10px;" onclick="viewCallSheets('${name.replace(/'/g, "\\'")}')">View Call Sheets</button>
      </div>`;
  } catch (e) {
    appEl.innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div class="detail-card" style="max-width:500px;margin:auto;color:#dc2626;">
          <h2>Error Loading Details</h2>
          <p>${e.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">â† Back</button>
        </div>
      </div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALL SHEETS VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function viewCallSheets(name) {
  trackClick();
  logPageView('Call Sheets: ' + name);
  const appEl = document.getElementById('app');
  appEl.innerHTML = `
    <div class="topbar">
      <div class="topbar-logo">SA</div>
      <div class="topbar-info"><div class="topbar-title">Call Sheets â€“ ${name}</div></div>
    </div>
    <div class="loading-wrap"><div class="spinner"></div></div>`;

  try {
    const result = await fetchCalls(name);
    if (!result?.ok) throw new Error(result?.error || 'Failed to load call sheets');
    const rows = result.data?.calls || result.calls || [];

    const trs = rows.map(r => {
      const custName = r.name || 'â€“';
      const custCell = r.link
        ? `<a href="${r.link}" target="_blank" rel="noopener" style="color:#2563eb;text-decoration:underline;font-weight:600;">${custName}</a>`
        : custName;
      return `
      <tr>
        <td style="text-align:left;padding:8px;">${custCell}</td>
        <td style="padding:8px;">${r.phone || 'â€“'}</td>
        <td style="padding:8px;">${r.email || 'â€“'}</td>
        <td style="padding:8px;">${r.salesPerson || 'â€“'}</td>
        <td style="padding:8px;">${r.bdcAgent || 'â€“'}</td>
        <td style="padding:8px;">${r.source || 'â€“'}</td>
        <td style="padding:8px;">${r.dateIn || 'â€“'}</td>
        <td style="padding:8px;">${r.leadAge ?? 'â€“'}</td>
        <td style="padding:8px;">${r.daysSince ?? 'â€“'}</td>
        <td style="padding:8px;">${r.bucket || 'â€“'}</td>
        <td style="padding:8px;">${r.status || 'â€“'}</td>
        <td style="padding:8px;">${r.reason || 'â€“'}</td>
      </tr>`;
    }).join('');

    appEl.innerHTML = `
      <div class="topbar">
        <div class="topbar-logo">SA</div>
        <div class="topbar-info"><div class="topbar-title">Call Sheets â€“ ${name}</div><div class="topbar-sub">${rows.length} records</div></div>
        <div class="topbar-actions">
          <button class="topbar-btn manage" onclick="showPersonDetails('${name.replace(/'/g, "\\'")}')">â† Back to ${name}</button>
          <button class="topbar-btn manage" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>

      <div class="table-card" style="margin-top:12px;overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th style="text-align:left;">Customer</th><th>Phone</th><th>Email</th><th>Sales Person</th>
              <th>BDC Agent</th><th>Source</th><th>Date In</th><th>Lead Age</th>
              <th>Days Since</th><th>Bucket</th><th>Status</th><th>Reason</th>
            </tr>
          </thead>
          <tbody>
            ${rows.length ? trs : '<tr><td colspan="12" style="padding:30px;color:var(--muted);">No call data</td></tr>'}
          </tbody>
        </table>
      </div>`;
  } catch (e) {
    appEl.innerHTML = `
      <div style="padding:60px 20px;text-align:center;">
        <div class="detail-card" style="max-width:500px;margin:auto;color:#dc2626;">
          <h2>Error Loading Call Sheets</h2>
          <p>${e.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">â† Back</button>
        </div>
      </div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USER MANAGEMENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadUsers() {
  try {
    const usersSnapshot = await getDocs(collection(db, 'users'));
    let html = '';
    usersSnapshot.forEach((docu) => {
      const u = docu.data();
      const email = u.email || '';
      const role = u.role || 'user';
      const linked = u.linkedName || '';
      const isSelf = email === window.userData.email;
      const canDelete = isAdmin() && !isSelf && role !== 'admin' && role !== 'superadmin' && email !== SUPERADMIN_EMAIL;
      html += `
        <div class="user-item">
          <div>
            <div>${email}</div>
            <small>Role: <strong>${role}</strong>${role === 'superadmin' ? ' ğŸ‘‘' : ''} ${linked ? `â€¢ Linked: ${linked}` : ''}</small>
          </div>
          ${canDelete ? `<button class="delete-btn" onclick="deleteUser('${docu.id}','${email}','${role}')">Delete</button>` : ''}
        </div>`;
    });
    document.getElementById('userListContent').innerHTML = html || '<p style="color:var(--muted);">No users found.</p>';
  } catch (e) {
    document.getElementById('userListContent').innerHTML = `<p style="color:#dc2626;">Error: ${e.message}</p>`;
  }
}

async function addUser() {
  const email = document.getElementById('newUserEmail')?.value?.trim();
  const password = document.getElementById('newUserPassword')?.value?.trim();
  const linked = document.getElementById('newUserLinked')?.value?.trim() || '';
  const role = document.getElementById('newUserRole')?.value || 'user';
  if (!email || !password) { alert('Enter email and password.'); return; }
  if (password.length < 6) { alert('Password must be at least 6 characters.'); return; }

  try {
    const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
    await setDoc(doc(db, 'users', cred.user.uid), {
      email, role, linkedName: linked, createdAt: new Date()
    });
    await secondaryAuth.signOut();
    alert('User created!');
    loadUsers();
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUserLinked').value = '';
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function deleteUser(uid, email, role) {
  if (!isAdmin()) { alert('Only admins.'); return; }
  if (role === 'admin' || role === 'superadmin' || email === SUPERADMIN_EMAIL) { alert('Cannot delete admins.'); return; }
  if (!confirm('Delete this user?')) return;
  try {
    await deleteDoc(doc(db, 'users', uid));
    loadUsers();
    alert('User deleted.');
  } catch (e) { alert('Error: ' + e.message); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POTENTIAL REASSIGNMENTS PAGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let reassignSort = { col: 'daysSince', dir: 'desc' };

async function showReassignments() {
  if (!isAdmin() && !isManager()) { alert('Only admins and managers can view reassignments.'); return; }
  trackClick();
  logPageView('Reassignments');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">ğŸ”„ Potential Reassignments</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Leads with a CRM link and 3+ days since last contact</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">â† Back to Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    const url = `${SCRIPT_URL}?route=reassignments&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error(`Non-JSON response.\nHTTP ${resp.status}\n\n${raw}`); }
    if (!result.ok) throw new Error(result.error || 'Backend error');

    const rows = result.rows || [];
    renderReassignments(rows);
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading Reassignments</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">â† Back</button>
        </div>
      </div>`;
  }
}

function renderReassignments(rows) {
  window._reassignRows = rows;  // cache for re-sorting
  // Sort
  const sorted = sortReassignRows(rows, reassignSort);

  // Stats
  const total = sorted.length;
  const critical = sorted.filter(r => r.daysSince >= 5).length;
  const reviewCount = sorted.filter(r => r.status === 'Active - Manager Review').length;
  const bySheet = {};
  sorted.forEach(r => { bySheet[r.sheet] = (bySheet[r.sheet] || 0) + 1; });
  const sheetCount = Object.keys(bySheet).length;

  // Find who has the most
  let worstSheet = 'â€“', worstCount = 0;
  Object.entries(bySheet).forEach(([k, v]) => { if (v > worstCount) { worstCount = v; worstSheet = k; } });

  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">ğŸ”„ Potential Reassignments</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Leads with a CRM link and 3+ days since last contact</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="showReassignments()">â†» Refresh</button>
          <button class="topbar-btn manage" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>

      <div class="reassign-stats">
        <div class="reassign-stat">
          <div class="stat-label">Total Flagged</div>
          <div class="stat-value">${total}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Manager Review âš ï¸</div>
          <div class="stat-value" style="color:#991b1b;">${reviewCount}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Critical (5+ days) ğŸ”´</div>
          <div class="stat-value" style="color:#dc2626;">${critical}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Reps Affected</div>
          <div class="stat-value">${sheetCount}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Most Flagged</div>
          <div class="stat-value" style="font-size:15px;">${worstSheet} (${worstCount})</div>
        </div>
      </div>

      ${total === 0 ? '<div class="detail-card" style="text-align:center;padding:40px;color:var(--muted);font-size:15px;">No leads flagged â€” everyone is within 5 days ğŸ‰</div>' : ''}
      ${total > 0 ? `<div class="table-card" id="reassignTable">${reassignTableHTML(sorted)}</div>` : ''}
    </div>`;
}

function reassignTableHTML(rows) {
  const sc = (col) => reassignSort.col === col ? 'sorted' : '';
  const ar = (col) => reassignSort.col === col ? (reassignSort.dir === 'desc' ? 'â–¼' : 'â–²') : 'â–½';

  const headerRow = `<tr>
    <th class="${sc('leadAge')}" onclick="toggleReassignSort('leadAge')">Lead Age <span class="sort-arrow">${ar('leadAge')}</span></th>
    <th class="${sc('daysSince')}" onclick="toggleReassignSort('daysSince')">Days Since <span class="sort-arrow">${ar('daysSince')}</span></th>
    <th class="${sc('customer')}" onclick="toggleReassignSort('customer')">Customer <span class="sort-arrow">${ar('customer')}</span></th>
    <th>Phone</th>
    <th class="${sc('salesPerson')}" onclick="toggleReassignSort('salesPerson')">Sales Rep <span class="sort-arrow">${ar('salesPerson')}</span></th>
    <th class="${sc('bdcAgent')}" onclick="toggleReassignSort('bdcAgent')">BDC Agent <span class="sort-arrow">${ar('bdcAgent')}</span></th>
    <th class="${sc('source')}" onclick="toggleReassignSort('source')">Source <span class="sort-arrow">${ar('source')}</span></th>
    <th class="${sc('status')}" onclick="toggleReassignSort('status')">Status <span class="sort-arrow">${ar('status')}</span></th>
    <th class="${sc('sheet')}" onclick="toggleReassignSort('sheet')">Assigned To <span class="sort-arrow">${ar('sheet')}</span></th>
  </tr>`;

  // Split into Manager Review and rest
  const reviewRows = rows.filter(r => r.status === 'Active - Manager Review');
  const otherRows = rows.filter(r => r.status !== 'Active - Manager Review');

  let html = '<table><thead>' + headerRow + '</thead><tbody>';

  if (reviewRows.length > 0) {
    html += `<tr><td colspan="9" style="background:#fef2f2;text-align:left;padding:10px 12px;font-weight:700;font-size:13px;color:#991b1b;border-bottom:2px solid #fecaca;">
      âš ï¸ Manager Review Required (${reviewRows.length})
    </td></tr>`;
    reviewRows.forEach(r => { html += reassignRowHTML(r); });
  }

  if (otherRows.length > 0) {
    if (reviewRows.length > 0) {
      html += `<tr><td colspan="9" style="background:#f9fafb;text-align:left;padding:10px 12px;font-weight:700;font-size:13px;color:var(--muted);border-bottom:2px solid var(--line);">
        Other Flagged Leads (${otherRows.length})
      </td></tr>`;
    }
    otherRows.forEach(r => { html += reassignRowHTML(r); });
  }

  html += '</tbody></table>';
  return html;
}

function reassignRowHTML(r) {
  const dc = r.daysSince >= 9 ? 'days-9p' : r.daysSince >= 8 ? 'days-8' : r.daysSince >= 7 ? 'days-7' : r.daysSince >= 6 ? 'days-6' : r.daysSince >= 5 ? 'days-5' : r.daysSince >= 4 ? 'days-4' : 'days-3';
  const isReview = r.status === 'Active - Manager Review';
  const rowStyle = isReview ? 'background:#fff5f5;' : '';
  const statusStyle = isReview ? 'color:#991b1b;font-weight:700;' : 'font-size:12px;';
  return `<tr style="${rowStyle}">
    <td style="font-size:12px;">${r.leadAge || 'â€”'}</td>
    <td><span class="days-badge ${dc}">${r.daysSince}</span></td>
    <td style="text-align:left;"><a class="reassign-link" href="${r.link}" target="_blank">${r.customer || 'â€”'}</a></td>
    <td style="font-size:12px;">${r.phone || 'â€”'}</td>
    <td style="font-size:12px;">${r.salesPerson || 'â€”'}</td>
    <td style="font-size:12px;">${r.bdcAgent || 'â€”'}</td>
    <td style="font-size:12px;">${r.source || 'â€”'}</td>
    <td style="${statusStyle}">${r.status || 'â€”'}</td>
    <td><span class="reassign-sheet-badge">${r.sheet}</span></td>
  </tr>`;
}

function sortReassignRows(rows, sortState) {
  const { col, dir } = sortState;
  const mult = dir === 'desc' ? -1 : 1;
  return [...rows].sort((a, b) => {
    if (col === 'daysSince') return mult * (a.daysSince - b.daysSince);
    if (col === 'leadAge') return mult * ((a.leadAge || 0) - (b.leadAge || 0));
    if (col === 'customer' || col === 'salesPerson' || col === 'bdcAgent' || col === 'source' || col === 'status' || col === 'sheet') {
      return mult * (a[col] || '').localeCompare(b[col] || '');
    }
    return 0;
  });
}

function toggleReassignSort(col) {
  if (reassignSort.col === col) {
    reassignSort.dir = reassignSort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    reassignSort.col = col;
    reassignSort.dir = 'desc';
  }
  // Re-render with current data â€” refetch not needed
  const table = document.getElementById('reassignTable');
  if (table && window._reassignRows) {
    table.innerHTML = reassignTableHTML(sortReassignRows(window._reassignRows, reassignSort));
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTOMOTIVE NEWS PAGE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showAutoNews() {
  logPageView('Auto News');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:800px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">ğŸ“° Automotive Industry News</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Latest articles from the past week</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">â† Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    const url = `${SCRIPT_URL}?route=autonews&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error(`Non-JSON response.\nHTTP ${resp.status}\n\n${raw}`); }
    if (!result.ok) throw new Error(result.error || 'Backend error');

    const articles = result.articles || [];
    renderAutoNews(articles);
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading News</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">â† Back</button>
        </div>
      </div>`;
  }
}

function renderAutoNews(articles) {
  const app = document.getElementById('app');

  let cardsHTML = '';
  if (articles.length === 0) {
    cardsHTML = '<div class="detail-card" style="text-align:center;padding:40px;color:var(--muted);font-size:15px;">No recent articles found. Check back later.</div>';
  } else {
    // Group by source
    const groups = new Map();
    articles.forEach(a => {
      const src = a.source || 'Other';
      if (!groups.has(src)) groups.set(src, []);
      groups.get(src).push(a);
    });

    // Sort groups: CDG first, then by article count descending
    const sortedGroups = [...groups.entries()].sort((a, b) => {
      if (a[0] === 'Car Dealership Guy') return -1;
      if (b[0] === 'Car Dealership Guy') return 1;
      return b[1].length - a[1].length;
    });

    let groupIdx = 0;
    sortedGroups.forEach(([source, items]) => {
      const isCDG = source === 'Car Dealership Guy';
      const groupId = 'newsGroup' + groupIdx++;
      const bgColor = isCDG ? '#f0fdf4' : '#f9fafb';
      const badgeBg = isCDG ? '#dcfce7' : '#f4f4f5';
      const badgeColor = isCDG ? '#166534' : '#71717a';

      // Source-specific icons
      const srcLower = source.toLowerCase();
      let icon = 'ğŸ“°';
      if (isCDG) icon = 'ğŸš—';
      else if (srcLower.includes('automotive news')) icon = 'ğŸ­';
      else if (srcLower.includes('cbt')) icon = 'ğŸ™ï¸';
      else if (srcLower.includes('reuters')) icon = 'ğŸŒ';
      else if (srcLower.includes('cnbc')) icon = 'ğŸ“ˆ';
      else if (srcLower.includes('bloomberg')) icon = 'ğŸ’¹';
      else if (srcLower.includes('fox')) icon = 'ğŸ“º';
      else if (srcLower.includes('cnn')) icon = 'ğŸ“¡';
      else if (srcLower.includes('yahoo')) icon = 'ğŸŸ£';
      else if (srcLower.includes('ap news') || srcLower.includes('associated press')) icon = 'ğŸ”µ';
      else if (srcLower.includes('usa today')) icon = 'ğŸ‡ºğŸ‡¸';
      else if (srcLower.includes('wall street') || srcLower.includes('wsj')) icon = 'ğŸ“Š';
      else if (srcLower.includes('motor') || srcLower.includes('drive') || srcLower.includes('torque')) icon = 'ğŸï¸';
      else if (srcLower.includes('truck') || srcLower.includes('pickup')) icon = 'ğŸ›»';
      else if (srcLower.includes('ev') || srcLower.includes('electric') || srcLower.includes('electrek')) icon = 'âš¡';
      else if (srcLower.includes('car') || srcLower.includes('auto')) icon = 'ğŸš™';
      else if (srcLower.includes('dealer')) icon = 'ğŸ¤';
      else if (srcLower.includes('forbes')) icon = 'ğŸ’°';
      else if (srcLower.includes('nbc')) icon = 'ğŸ“º';
      else if (srcLower.includes('abc')) icon = 'ğŸ“º';

      cardsHTML += `
        <div style="margin-bottom:8px;border:1px solid var(--line);border-radius:10px;overflow:hidden;">
          <div onclick="toggleNewsGroup('${groupId}')" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:${bgColor};cursor:pointer;user-select:none;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:14px;">${icon}</span>
              <span style="font-weight:700;font-size:14px;color:${isCDG ? '#166534' : 'var(--text)'};">${source}</span>
              <span style="background:${badgeBg};color:${badgeColor};padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">${items.length}</span>
            </div>
            <span id="${groupId}Arrow" style="font-size:12px;color:var(--muted);transition:transform .2s;transform:rotate(-90deg);">â–¼</span>
          </div>
          <div id="${groupId}" style="border-top:1px solid var(--line);display:none;">`;

      items.forEach(a => {
        const timeStr = a.date ? timeAgoNews(new Date(a.date)) : '';
        cardsHTML += `
            <div style="padding:12px 16px;border-bottom:1px solid var(--line);${isCDG ? 'border-left:3px solid #22c55e;' : ''}">
              <div class="news-title"><a href="${a.link}" target="_blank" rel="noopener">${a.title}</a></div>
              <div class="news-meta">
                ${timeStr ? `<span>ğŸ• ${timeStr}</span>` : ''}
              </div>
            </div>`;
      });

      cardsHTML += `
          </div>
        </div>`;
    });
  }

  app.innerHTML = `
    <div style="max-width:800px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">ğŸ“° Automotive Industry News</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Latest articles from the past 48 hours Â· ${articles.length} article${articles.length !== 1 ? 's' : ''}</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="toggleAllNewsGroups()">Expand / Collapse All</button>
          <button class="topbar-btn manage" onclick="showAutoNews()">â†» Refresh</button>
          <button class="topbar-btn manage" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>
      ${cardsHTML}
    </div>`;
}

function toggleNewsGroup(id) {
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + 'Arrow');
  if (!el) return;
  if (el.style.display === 'none') {
    el.style.display = '';
    if (arrow) arrow.style.transform = 'rotate(0deg)';
  } else {
    el.style.display = 'none';
    if (arrow) arrow.style.transform = 'rotate(-90deg)';
  }
}

function toggleAllNewsGroups() {
  const groups = document.querySelectorAll('[id^="newsGroup"]');
  let hiddenCount = 0;
  groups.forEach(g => { if (g.id.indexOf('Arrow') === -1 && g.style.display === 'none') hiddenCount++; });
  const shouldShow = hiddenCount > 0;
  groups.forEach(g => {
    if (g.id.indexOf('Arrow') !== -1) {
      g.style.transform = shouldShow ? 'rotate(0deg)' : 'rotate(-90deg)';
    } else {
      g.style.display = shouldShow ? '' : 'none';
    }
  });
}

function timeAgoNews(date) {
  const diff = Date.now() - date;
  const mins = Math.floor(diff / 60000);
  const hrs  = Math.floor(diff / 3600000);
  if (mins < 60) return `${mins}m ago`;
  if (hrs < 24)  return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOURCE LEADERBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let sourceSort = { col: 'total', dir: 'desc' };

async function showSourceLeaderboard() {
  if (!isAdmin()) { alert('Only admins can view the Source Leaderboard.'); return; }
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">ğŸ“Š Source Leaderboard</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Lead source performance across all distribution tabs</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">â† Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    const url = `${SCRIPT_URL}?route=sourcestats&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error(`Non-JSON response.\nHTTP ${resp.status}\n\n${raw}`); }
    if (!result.ok) throw new Error(result.error || 'Backend error');

    window._sourceRows = result.sources || [];
    renderSourceLeaderboard(window._sourceRows);
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading Sources</h2>
          <p>${err.message}</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">â† Back</button>
        </div>
      </div>`;
  }
}

function renderSourceLeaderboard(rows) {
  const sorted = sortSourceRows(rows, sourceSort);

  // Summary stats
  const totalLeads = sorted.reduce((s, r) => s + r.total, 0);
  const totalAtRisk = sorted.reduce((s, r) => s + r.atRisk, 0);
  const totalReview = sorted.reduce((s, r) => s + r.managerReview, 0);
  const sourceCount = sorted.length;

  // Best & worst follow-up (by atRiskPct, min 5 leads)
  const qualified = sorted.filter(r => r.total >= 5);
  let bestSource = 'â€“', worstSource = 'â€“';
  if (qualified.length) {
    const byRisk = [...qualified].sort((a, b) => a.atRiskPct - b.atRiskPct);
    bestSource = byRisk[0].source + ' (' + byRisk[0].atRiskPct + '%)';
    worstSource = byRisk[byRisk.length - 1].source + ' (' + byRisk[byRisk.length - 1].atRiskPct + '%)';
  }

  const sc = (col) => sourceSort.col === col ? 'sorted' : '';
  const ar = (col) => sourceSort.col === col ? (sourceSort.dir === 'desc' ? 'â–¼' : 'â–²') : 'â–½';

  let tableHTML = `<table><thead><tr>
    <th class="${sc('source')}" onclick="toggleSourceSort('source')">Source <span class="sort-arrow">${ar('source')}</span></th>
    <th class="${sc('total')}" onclick="toggleSourceSort('total')">Total Leads <span class="sort-arrow">${ar('total')}</span></th>
    <th class="${sc('atRisk')}" onclick="toggleSourceSort('atRisk')">At Risk (3+d) <span class="sort-arrow">${ar('atRisk')}</span></th>
    <th class="${sc('atRiskPct')}" onclick="toggleSourceSort('atRiskPct')">% At Risk <span class="sort-arrow">${ar('atRiskPct')}</span></th>
    <th class="${sc('managerReview')}" onclick="toggleSourceSort('managerReview')">Mgr Review <span class="sort-arrow">${ar('managerReview')}</span></th>
    <th class="${sc('avgDaysSince')}" onclick="toggleSourceSort('avgDaysSince')">Avg Days Since <span class="sort-arrow">${ar('avgDaysSince')}</span></th>
    <th class="${sc('avgLeadAge')}" onclick="toggleSourceSort('avgLeadAge')">Avg Lead Age <span class="sort-arrow">${ar('avgLeadAge')}</span></th>
    <th class="${sc('repCount')}" onclick="toggleSourceSort('repCount')">Reps <span class="sort-arrow">${ar('repCount')}</span></th>
  </tr></thead><tbody>`;

  sorted.forEach((r, i) => {
    // Color code % at risk
    const riskColor = r.atRiskPct >= 60 ? '#dc2626' : r.atRiskPct >= 40 ? '#ea580c' : r.atRiskPct >= 20 ? '#ca8a04' : '#16a34a';
    const riskBg = r.atRiskPct >= 60 ? '#fef2f2' : r.atRiskPct >= 40 ? '#fff7ed' : r.atRiskPct >= 20 ? '#fefce8' : '#f0fdf4';
    const topRepsStr = r.topReps.map(t => t.name.split(' ')[0] + ' (' + t.count + ')').join(', ');

    tableHTML += `<tr>
      <td style="text-align:left;font-weight:600;">${r.source}</td>
      <td><strong>${r.total}</strong></td>
      <td>${r.atRisk > 0 ? '<span style="color:#dc2626;font-weight:600;">' + r.atRisk + '</span>' : '0'}</td>
      <td style="background:${riskBg};color:${riskColor};font-weight:700;">${r.atRiskPct}%</td>
      <td>${r.managerReview > 0 ? '<span style="color:#991b1b;font-weight:600;">' + r.managerReview + '</span>' : '0'}</td>
      <td>${r.avgDaysSince}</td>
      <td>${r.avgLeadAge}d</td>
      <td title="${topRepsStr}">${r.repCount}</td>
    </tr>`;
  });

  tableHTML += '</tbody></table>';

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">ğŸ“Š Source Leaderboard</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Lead source performance across all distribution tabs Â· ${sourceCount} sources Â· ${totalLeads} total leads</p>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="topbar-btn manage" onclick="showSourceLeaderboard()">â†» Refresh</button>
          <button class="topbar-btn manage" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>

      <div class="reassign-stats">
        <div class="reassign-stat">
          <div class="stat-label">Total Leads</div>
          <div class="stat-value">${totalLeads}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">At Risk (3+ days) ğŸ”´</div>
          <div class="stat-value" style="color:#dc2626;">${totalAtRisk}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Manager Review âš ï¸</div>
          <div class="stat-value" style="color:#991b1b;">${totalReview}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Best Follow-Up âœ…</div>
          <div class="stat-value" style="font-size:13px;color:#16a34a;">${bestSource}</div>
        </div>
        <div class="reassign-stat">
          <div class="stat-label">Worst Follow-Up ğŸš¨</div>
          <div class="stat-value" style="font-size:13px;color:#dc2626;">${worstSource}</div>
        </div>
      </div>

      <div class="table-card" id="sourceTable">${tableHTML}</div>

      <div style="margin-top:12px;padding:12px 16px;background:var(--card);border:1px solid var(--line);border-radius:10px;">
        <div style="font-weight:700;font-size:13px;margin-bottom:8px;">ğŸ“ˆ Quick Insights</div>
        <div style="font-size:12px;color:var(--muted);line-height:1.6;">
          ${qualified.length >= 2 ? `â€¢ <strong style="color:#16a34a;">${[...qualified].sort((a,b)=>a.atRiskPct-b.atRiskPct)[0].source}</strong> has the best follow-up rate â€” only ${[...qualified].sort((a,b)=>a.atRiskPct-b.atRiskPct)[0].atRiskPct}% at risk<br>` : ''}
          ${qualified.length >= 2 ? `â€¢ <strong style="color:#dc2626;">${[...qualified].sort((a,b)=>b.atRiskPct-a.atRiskPct)[0].source}</strong> needs attention â€” ${[...qualified].sort((a,b)=>b.atRiskPct-a.atRiskPct)[0].atRiskPct}% of leads at risk<br>` : ''}
          ${sorted.length > 0 ? `â€¢ <strong>${sorted[0].source}</strong> produces the most volume with ${sorted[0].total} total leads<br>` : ''}
          ${totalReview > 0 ? `â€¢ <strong style="color:#991b1b;">${totalReview} leads</strong> across all sources are in Manager Review status` : 'â€¢ No leads currently in Manager Review â€” great job!'}
        </div>
      </div>
    </div>`;
}

function sortSourceRows(rows, sortState) {
  const { col, dir } = sortState;
  const mult = dir === 'desc' ? -1 : 1;
  return [...rows].sort((a, b) => {
    if (col === 'source') return mult * (a.source || '').localeCompare(b.source || '');
    return mult * ((a[col] || 0) - (b[col] || 0));
  });
}

function toggleSourceSort(col) {
  if (sourceSort.col === col) {
    sourceSort.dir = sourceSort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    sourceSort.col = col;
    sourceSort.dir = 'desc';
  }
  if (window._sourceRows) {
    renderSourceLeaderboard(window._sourceRows);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVITY LOG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showActivityModal() {
  if (!isAdmin() && !isManager()) { alert('Only admins and managers can view activity.'); return; }
  logPageView('Activity Log');
  document.getElementById('activityModal').style.display = 'grid';
  loadActivity();
}
function closeActivityModal() {
  document.getElementById('activityModal').style.display = 'none';
}

function timeAgo(date) {
  if (!date) return { text: 'Never', status: 'never' };
  const now = new Date();
  const diff = now - date;
  const mins = Math.floor(diff / 60000);
  const hrs  = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  let text;
  if (mins < 1)       text = 'Just now';
  else if (mins < 60) text = `${mins}m ago`;
  else if (hrs < 24)  text = `${hrs}h ago`;
  else if (days < 7)  text = `${days}d ago`;
  else                text = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

  const status = hrs < 24 ? 'recent' : days < 7 ? 'stale' : 'old';
  return { text, status };
}

async function loadActivity() {
  const el = document.getElementById('activityContent');
  el.innerHTML = '<p style="color:var(--muted);">Loading...</p>';
  try {
    // Fetch users for current data + clicks
    const userSnap = await getDocs(collection(db, 'users'));
    const userMap = {}; // uid â†’ user data
    const today = todayDateStr();
    userSnap.forEach(d => {
      const u = d.data();
      const ll = u.lastLogin?.toDate ? u.lastLogin.toDate() : (u.lastLogin ? new Date(u.lastLogin) : null);
      const clicks = (u.clickDate === today) ? (u.clicksToday || 0) : 0;
      userMap[d.id] = {
        uid: d.id,
        email: u.email || '',
        role: u.role || 'user',
        linkedName: u.linkedName || '',
        lastLogin: ll,
        clicks
      };
    });

    // Fetch dailyLogins (last 14 days)
    let loginSnap = null;
    try {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - 14);
      const cutoffStr = cutoff.getFullYear() + '-' + String(cutoff.getMonth() + 1).padStart(2, '0') + '-' + String(cutoff.getDate()).padStart(2, '0');
      loginSnap = await getDocs(query(
        collection(db, 'dailyLogins'),
        where('date', '>=', cutoffStr),
        orderBy('date', 'desc')
      ));
    } catch (e) { console.warn('dailyLogins query failed, falling back:', e); }

    // Build day â†’ users map from dailyLogins
    const dayLogins = new Map(); // date string â†’ [{email, linkedName, role, lastSeen}]
    if (loginSnap) {
      loginSnap.forEach(d => {
        const data = d.data();
        const dateStr = data.date;
        if (!dayLogins.has(dateStr)) dayLogins.set(dateStr, []);
        const lastSeen = data.lastSeen?.toDate ? data.lastSeen.toDate() : (data.lastSeen ? new Date(data.lastSeen) : null);
        dayLogins.get(dateStr).push({
          email: data.email || '',
          linkedName: data.linkedName || '',
          role: data.role || 'user',
          uid: data.uid || '',
          lastSeen: lastSeen,
          clicks: (dateStr === today && userMap[data.uid]) ? userMap[data.uid].clicks : 0
        });
      });
    }

    // Also include users from users collection for today if no dailyLogins yet (backward compat)
    const todayLogins = dayLogins.get(today) || [];
    const todayUidSet = new Set(todayLogins.map(u => u.uid));
    Object.values(userMap).forEach(u => {
      if (u.lastLogin && u.lastLogin.toDateString() === new Date().toDateString() && !todayUidSet.has(u.uid)) {
        if (!dayLogins.has(today)) dayLogins.set(today, []);
        dayLogins.get(today).push({
          email: u.email,
          linkedName: u.linkedName,
          role: u.role,
          uid: u.uid,
          lastSeen: u.lastLogin,
          clicks: u.clicks
        });
      }
    });

    // If dailyLogins was empty (first deploy / query failed), fall back to users collection lastLogin
    if (dayLogins.size === 0 || (dayLogins.size === 1 && dayLogins.has(today))) {
      Object.values(userMap).forEach(u => {
        if (!u.lastLogin) return;
        const d = u.lastLogin;
        const dStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        if (dayLogins.has(dStr)) {
          const existing = dayLogins.get(dStr);
          if (existing.some(e => e.uid === u.uid)) return;
        }
        if (!dayLogins.has(dStr)) dayLogins.set(dStr, []);
        dayLogins.get(dStr).push({
          email: u.email, linkedName: u.linkedName, role: u.role,
          uid: u.uid, lastSeen: u.lastLogin, clicks: u.clicks
        });
      });
    }

    // Also add "never logged in" users
    const allLoggedUids = new Set();
    dayLogins.forEach(users => users.forEach(u => allLoggedUids.add(u.uid)));
    const neverGroup = Object.values(userMap).filter(u => !u.lastLogin && !allLoggedUids.has(u.uid));

    // Format day groups
    const now = new Date();
    const todayDateString = now.toDateString();
    const yesterday = new Date(now); yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayDateString = yesterday.toDateString();

    // Sort dates descending
    const sortedDates = [...dayLogins.keys()].sort((a, b) => b.localeCompare(a));

    function dateLabel(dateStr) {
      // dateStr is "2026-02-17"
      const parts = dateStr.split('-');
      const d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      if (d.toDateString() === todayDateString) return 'Today';
      if (d.toDateString() === yesterdayDateString) return 'Yesterday';
      return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
    }

    // Summary stats
    const todayGroup = dayLogins.get(today) || [];
    const todayUids = new Set(todayGroup.map(u => u.uid));
    const notSignedIn = Object.values(userMap).filter(u => !todayUids.has(u.uid));
    const notSignedInSales = notSignedIn.filter(u => u.role === 'user');
    const notSignedInMgmt = notSignedIn.filter(u => ['admin','superadmin','manager'].includes(u.role));
    notSignedIn.sort((a, b) => (a.linkedName || a.email).localeCompare(b.linkedName || b.email));

    const salesLoggedIn = todayGroup.filter(u => u.role === 'user').length;
    const mgmtLoggedIn = todayGroup.filter(u => ['admin','superadmin','manager'].includes(u.role)).length;
    const totalClicks = todayGroup.reduce((sum, u) => sum + (u.clicks || 0), 0);

    let html = `
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:4px;">
        <div style="flex:1;min-width:120px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#166534;font-weight:500;">Sales Logged In Today</div>
          <div style="font-size:22px;font-weight:800;color:#166534;">${salesLoggedIn}</div>
        </div>
        <div style="flex:1;min-width:120px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#1e40af;font-weight:500;">Mgmt / Admin Today</div>
          <div style="font-size:22px;font-weight:800;color:#1e40af;">${mgmtLoggedIn}</div>
        </div>
        <div style="flex:1;min-width:120px;background:#faf5ff;border:1px solid #e9d5ff;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#7e22ce;font-weight:500;">Total Clicks Today</div>
          <div style="font-size:22px;font-weight:800;color:#7e22ce;">${totalClicks}</div>
        </div>
        <div style="flex:1;min-width:120px;background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px 16px;">
          <div style="font-size:11px;color:#991b1b;font-weight:500;">Not Signed In Today</div>
          <div style="font-size:22px;font-weight:800;color:#991b1b;">${notSignedIn.length}</div>
        </div>
      </div>
      ${notSignedIn.length > 0 ? `
      <details style="margin-top:8px;margin-bottom:4px;">
        <summary style="cursor:pointer;font-weight:700;font-size:12px;color:#991b1b;padding:6px 0;user-select:none;">
          ğŸš« Not Signed In Today <span style="background:#fecaca;color:#991b1b;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:6px;">${notSignedIn.length}</span>
        </summary>
        <div style="display:flex;flex-wrap:wrap;gap:6px;padding:8px 0;">
          ${notSignedIn.map(u => {
            const name = u.linkedName || u.email;
            const roleBadge = u.role === 'superadmin' ? ' ğŸ™' : u.role === 'admin' ? ' â­' : u.role === 'manager' ? ' ğŸ“‹' : '';
            const lastStr = u.lastLogin ? timeAgo(u.lastLogin).text : 'Never';
            return `<div style="background:#fff;border:1px solid #fecaca;border-radius:8px;padding:5px 10px;font-size:11px;" title="Last seen: ${lastStr}">
              <span style="font-weight:600;">${name}</span>${roleBadge} <span style="color:var(--muted);margin-left:4px;">${lastStr}</span>
            </div>`;
          }).join('')}
        </div>
      </details>` : ''}`;

    for (const dateStr of sortedDates) {
      const group = dayLogins.get(dateStr);
      // Sort by lastSeen desc within group
      group.sort((a, b) => (b.lastSeen || 0) - (a.lastSeen || 0));
      const label = dateLabel(dateStr);
      const isToday = label === 'Today';
      const countBadge = `<span style="background:${isToday ? '#dcfce7' : '#f4f4f5'};color:${isToday ? '#166534' : '#71717a'};padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:8px;">${group.length}</span>`;
      html += `<div style="margin-top:16px;margin-bottom:6px;font-weight:700;font-size:13px;color:${isToday ? '#166534' : 'var(--muted)'};text-transform:uppercase;letter-spacing:.3px;">${label}${countBadge}</div>`;

      group.forEach(u => {
        const ago = u.lastSeen ? timeAgo(u.lastSeen) : { text: 'â€”', status: 'never' };
        const displayName = u.linkedName || u.email;
        const loginTime = u.lastSeen
          ? u.lastSeen.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
          : 'â€”';
        const roleBadge = u.role === 'superadmin' ? ' ğŸ™' : u.role === 'admin' ? ' â­' : u.role === 'manager' ? ' ğŸ“‹' : '';
        const clickBadge = u.clicks > 0
          ? `<span style="background:#dbeafe;color:#1d4ed8;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:600;">${u.clicks} click${u.clicks !== 1 ? 's' : ''}</span>`
          : '<span style="color:#d1d5db;font-size:11px;">0 clicks</span>';

        html += `
          <div class="activity-item">
            <div style="min-width:48px;text-align:center;">${isToday ? clickBadge : ''}</div>
            <div style="display:flex;align-items:center;min-width:0;flex:1;">
              <span class="activity-status status-${ago.status}"></span>
              <div style="min-width:0;">
                <div class="activity-name">${displayName}${roleBadge}</div>
                <div class="activity-email">${u.linkedName ? u.email + ' Â· ' : ''}${u.role}</div>
              </div>
            </div>
            <div class="activity-time">
              <div class="time-main">${isToday ? ago.text : loginTime}</div>
              <div class="time-sub">${isToday ? loginTime : ago.text}</div>
            </div>
          </div>`;
      });
    }

    if (neverGroup.length) {
      const countBadge = `<span style="background:#f4f4f5;color:#71717a;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;margin-left:8px;">${neverGroup.length}</span>`;
      html += `<div style="margin-top:16px;margin-bottom:6px;font-weight:700;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;">Never Logged In${countBadge}</div>`;
      neverGroup.forEach(u => {
        const roleBadge = u.role === 'superadmin' ? ' ğŸ™' : u.role === 'admin' ? ' â­' : u.role === 'manager' ? ' ğŸ“‹' : '';
        html += `
          <div class="activity-item">
            <div style="min-width:48px;"></div>
            <div style="display:flex;align-items:center;min-width:0;flex:1;">
              <span class="activity-status status-never"></span>
              <div style="min-width:0;">
                <div class="activity-name">${u.linkedName || u.email}${roleBadge}</div>
                <div class="activity-email">${u.linkedName ? u.email + ' Â· ' : ''}${u.role}</div>
              </div>
            </div>
            <div class="activity-time"><div class="time-main">Never</div></div>
          </div>`;
      });
    }

    el.innerHTML = html;
  } catch (err) {
    console.error('Activity error:', err);
    el.innerHTML = '<p style="color:#dc2626;">Error loading activity data. Check Firestore rules.</p>';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL BINDINGS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.login = login;
window.logout = logout;
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEAD FUNNEL (Admin + Manager)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _funnelSort = { col: 'total', dir: 'desc' };
let _funnelData = null;
let _funnelExpanded = new Set(); // which source types are open

async function showLeadFunnel() {
  if (!isAdmin()) return;
  logPageView('Lead Funnel');
  showLoading();
  try {
    const url = `${SCRIPT_URL}?route=sourcefunnel&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.ok) { alert('Error loading funnel data'); showDashboard(); return; }
    _funnelData = data;
    _funnelSort = { col: 'total', dir: 'desc' };
    // Start with all expanded
    const sourceTypes = [...new Set((data.byProvider || []).map(p => p.sourceType || '(Unknown)'))];
    _funnelExpanded = new Set(sourceTypes);
    renderLeadFunnel();
  } catch (err) {
    console.error('Lead funnel error:', err);
    showDashboard();
  }
}

function toggleFunnelGroup(st) {
  if (_funnelExpanded.has(st)) _funnelExpanded.delete(st);
  else _funnelExpanded.add(st);
  renderLeadFunnel();
}
window.toggleFunnelGroup = toggleFunnelGroup;

function toggleFunnelSort(col) {
  if (_funnelSort.col === col) {
    _funnelSort.dir = _funnelSort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    _funnelSort = { col, dir: 'desc' };
  }
  renderLeadFunnel();
}

function funnelExpandAll() { 
  const types = [...new Set((_funnelData?.byProvider || []).map(p => p.sourceType || '(Unknown)'))];
  _funnelExpanded = new Set(types);
  renderLeadFunnel();
}
function funnelCollapseAll() { _funnelExpanded = new Set(); renderLeadFunnel(); }
window.funnelExpandAll = funnelExpandAll;
window.funnelCollapseAll = funnelCollapseAll;

function renderLeadFunnel() {
  if (!_funnelData) return;
  const providers = _funnelData.byProvider || [];
  const sourceTypes = _funnelData.bySourceType || [];

  // Group providers by sourceType
  const groups = {};
  providers.forEach(p => {
    const st = p.sourceType || '(Unknown)';
    if (!groups[st]) groups[st] = [];
    groups[st].push(p);
  });

  // Sort providers within each group
  function sortRows(arr) {
    return [...arr].sort((a, b) => {
      let av = a[_funnelSort.col], bv = b[_funnelSort.col];
      if (typeof av === 'string') return _funnelSort.dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
      av = av ?? -1; bv = bv ?? -1;
      return _funnelSort.dir === 'asc' ? av - bv : bv - av;
    });
  }

  // Overall stats
  const allProviders = providers;
  const totLeads = allProviders.reduce((s, r) => s + r.total, 0);
  const totSold = allProviders.reduce((s, r) => s + r.sold, 0);
  const totAppt = allProviders.reduce((s, r) => s + r.apptSet, 0);
  const overallClose = totLeads > 0 ? (totSold / totLeads * 100).toFixed(1) : '0';
  const overallAppt = totLeads > 0 ? (totAppt / totLeads * 100).toFixed(1) : '0';

  // Best/worst (min 5 leads) across all providers
  const qualified = allProviders.filter(r => r.total >= 5);
  const bestClose = qualified.length ? qualified.reduce((a, b) => a.closeRate > b.closeRate ? a : b) : null;
  const worstClose = qualified.length ? qualified.reduce((a, b) => a.closeRate < b.closeRate ? a : b) : null;
  const bestAppt = qualified.length ? qualified.reduce((a, b) => a.apptRate > b.apptRate ? a : b) : null;
  const fastestClose = qualified.filter(r => r.avgDaysToClose !== null).length
    ? qualified.filter(r => r.avgDaysToClose !== null).reduce((a, b) => (a.avgDaysToClose ?? 999) < (b.avgDaysToClose ?? 999) ? a : b) : null;

  function sa(col) {
    const active = _funnelSort.col === col;
    return active ? (_funnelSort.dir === 'desc' ? 'â–¼' : 'â–²') : 'â†•';
  }
  function thC(col) { return _funnelSort.col === col ? 'sorted' : ''; }
  function closeColor(rate) {
    if (rate >= 15) return '#16a34a';
    if (rate >= 8) return '#ca8a04';
    if (rate >= 3) return '#f97316';
    return '#dc2626';
  }
  function apptColor(rate) {
    if (rate >= 30) return '#16a34a';
    if (rate >= 15) return '#ca8a04';
    return '#94a3b8';
  }

  const sourceIcons = {
    'Internet Up': 'ğŸŒ',
    'Phone Up': 'ğŸ“',
    'Showroom Up': 'ğŸª',
    'Campaign': 'ğŸ“£',
  };
  const sourceColors = {
    'Internet Up': '#2563eb',
    'Phone Up': '#16a34a',
    'Showroom Up': '#9333ea',
    'Campaign': '#f97316',
  };

  // Sort source types by total leads desc
  const sortedSourceTypes = [...sourceTypes].sort((a, b) => b.total - a.total);

  // Build accordion HTML
  let accordionHTML = '';
  sortedSourceTypes.forEach(st => {
    const stName = st.name;
    const icon = sourceIcons[stName] || 'ğŸ“‹';
    const clr = sourceColors[stName] || '#64748b';
    const expanded = _funnelExpanded.has(stName);
    const chevron = expanded ? 'â–¾' : 'â–¸';
    const provs = sortRows(groups[stName] || []);

    // Source type header row
    accordionHTML += `
      <div style="margin-bottom:${expanded ? '0' : '8'}px;">
        <div onclick="toggleFunnelGroup('${stName.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border:1px solid var(--line);border-radius:${expanded ? '10px 10px 0 0' : '10px'};cursor:pointer;user-select:none;transition:all .15s;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:16px;">${icon}</span>
            <span style="font-size:11px;color:var(--muted);">${chevron}</span>
            <span style="font-weight:800;font-size:14px;">${stName}</span>
            <span style="font-size:11px;color:var(--muted);font-weight:500;">${provs.length} provider${provs.length !== 1 ? 's' : ''}</span>
          </div>
          <div style="display:flex;gap:16px;align-items:center;font-size:12px;flex-wrap:wrap;">
            <span><strong>${st.total}</strong> leads</span>
            <span style="color:${apptColor(st.apptRate)};font-weight:700;">${st.apptRate}% appt</span>
            <span style="color:${closeColor(st.closeRate)};font-weight:700;">${st.closeRate}% close</span>
            <span style="font-weight:700;color:#16a34a;">${st.sold} sold</span>
            <span style="color:${st.stalePct > 40 ? '#dc2626' : st.stalePct > 20 ? '#ca8a04' : '#16a34a'};">${st.stalePct}% stale</span>
          </div>
        </div>`;

    if (expanded) {
      accordionHTML += `
        <div style="border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px;overflow:hidden;margin-bottom:8px;">
          <div style="overflow-x:auto;">
          <table style="width:100%;font-size:12px;">
            <thead>
              <tr style="background:rgba(0,0,0,.02);">
                <th style="text-align:left;padding:8px 12px;cursor:pointer;font-size:11px;" class="${thC('name')}" onclick="toggleFunnelSort('name')">Lead Provider <span class="sort-arrow">${sa('name')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('total')}" onclick="toggleFunnelSort('total')">Leads <span class="sort-arrow">${sa('total')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('apptSet')}" onclick="toggleFunnelSort('apptSet')">Appt Set <span class="sort-arrow">${sa('apptSet')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('apptRate')}" onclick="toggleFunnelSort('apptRate')">Appt % <span class="sort-arrow">${sa('apptRate')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('sold')}" onclick="toggleFunnelSort('sold')">Sold <span class="sort-arrow">${sa('sold')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('closeRate')}" onclick="toggleFunnelSort('closeRate')">Close % <span class="sort-arrow">${sa('closeRate')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('avgDaysToClose')}" onclick="toggleFunnelSort('avgDaysToClose')">Days to Close <span class="sort-arrow">${sa('avgDaysToClose')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('active')}" onclick="toggleFunnelSort('active')">Active <span class="sort-arrow">${sa('active')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('stalePct')}" onclick="toggleFunnelSort('stalePct')">Stale 3d+ <span class="sort-arrow">${sa('stalePct')}</span></th>
                <th style="cursor:pointer;font-size:11px;" class="${thC('badLead')}" onclick="toggleFunnelSort('badLead')">Bad <span class="sort-arrow">${sa('badLead')}</span></th>
                <th style="text-align:left;font-size:11px;">Top Reps</th>
              </tr>
            </thead>
            <tbody>`;

      provs.forEach(r => {
        const daysClose = r.avgDaysToClose !== null ? r.avgDaysToClose + 'd' : 'â€“';
        const repsStr = (r.topReps || []).join(', ');
        // Bar width proportional to group max
        const groupMax = Math.max(...provs.map(p => p.total), 1);
        const barPct = Math.round((r.total / groupMax) * 100);
        accordionHTML += `<tr>
          <td style="padding:6px 12px;font-weight:600;white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis;" title="${r.name}">
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;">${r.name}</div>
              <div style="width:40px;height:4px;background:#f1f5f9;border-radius:2px;flex-shrink:0;">
                <div style="width:${barPct}%;height:100%;background:${clr};border-radius:2px;opacity:.5;"></div>
              </div>
            </div>
          </td>
          <td style="text-align:center;font-weight:700;">${r.total}</td>
          <td style="text-align:center;">${r.apptSet}</td>
          <td style="text-align:center;font-weight:700;color:${apptColor(r.apptRate)};">${r.apptRate}%</td>
          <td style="text-align:center;font-weight:700;">${r.sold}</td>
          <td style="text-align:center;font-weight:700;color:${closeColor(r.closeRate)};">${r.closeRate}%</td>
          <td style="text-align:center;">${daysClose}</td>
          <td style="text-align:center;">${r.active}</td>
          <td style="text-align:center;color:${r.stalePct > 40 ? '#dc2626' : r.stalePct > 20 ? '#ca8a04' : '#16a34a'};">${r.stalePct}%</td>
          <td style="text-align:center;">${r.badLead}</td>
          <td style="font-size:10px;color:var(--muted);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${repsStr}">${repsStr || 'â€“'}</td>
        </tr>`;
      });

      accordionHTML += `</tbody></table></div></div>`;
    }
    accordionHTML += `</div>`;
  });

  // Insights
  let insights = '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;">';
  if (bestClose) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0;font-size:12px;"><div style="font-weight:700;color:#16a34a;">ğŸ† Best Close Rate</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${bestClose.name}</div><div>${bestClose.closeRate}% (${bestClose.sold}/${bestClose.total})</div></div>`;
  if (worstClose) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;font-size:12px;"><div style="font-weight:700;color:#dc2626;">ğŸš¨ Worst Close Rate</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${worstClose.name}</div><div>${worstClose.closeRate}% (${worstClose.sold}/${worstClose.total})</div></div>`;
  if (fastestClose) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#eff6ff;border-radius:8px;border:1px solid #bfdbfe;font-size:12px;"><div style="font-weight:700;color:#2563eb;">âš¡ Fastest to Close</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${fastestClose.name}</div><div>Avg ${fastestClose.avgDaysToClose} days</div></div>`;
  if (bestAppt) insights += `<div style="flex:1;min-width:160px;padding:10px;background:#fefce8;border-radius:8px;border:1px solid #fde68a;font-size:12px;"><div style="font-weight:700;color:#ca8a04;">ğŸ“… Best Appt Rate</div><div style="font-weight:800;font-size:15px;margin:4px 0;">${bestAppt.name}</div><div>${bestAppt.apptRate}% (${bestAppt.apptSet}/${bestAppt.total})</div></div>`;
  insights += '</div>';

  const funnelDateRange = _funnelData.dateRange ? `${_funnelData.dateRange.from || '?'} â€“ ${_funnelData.dateRange.to || '?'}` : '';

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">ğŸ”¬ Lead Source Funnel</div>
          <div style="font-size:12px;color:var(--muted);">Lead In â†’ Appointment Set â†’ Sold Â· grouped by Source Type${funnelDateRange ? ` Â· <strong style="color:var(--text);">${funnelDateRange}</strong>` : ''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="topbar-btn" onclick="funnelExpandAll()" style="font-size:11px;padding:5px 10px;">Expand All</button>
          <button class="topbar-btn" onclick="funnelCollapseAll()" style="font-size:11px;padding:5px 10px;">Collapse All</button>
          <button class="topbar-btn manage" onclick="showLeadFunnel()">â†» Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Total Leads</div>
          <div style="font-size:22px;font-weight:800;">${totLeads}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Appts Set ğŸ“…</div>
          <div style="font-size:22px;font-weight:800;">${totAppt}</div>
          <div style="font-size:11px;color:var(--muted);">${overallAppt}% of leads</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Sold âœ…</div>
          <div style="font-size:22px;font-weight:800;color:#16a34a;">${totSold}</div>
          <div style="font-size:11px;color:var(--muted);">${overallClose}% close rate</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Source Types</div>
          <div style="font-size:22px;font-weight:800;">${sortedSourceTypes.length}</div>
          <div style="font-size:11px;color:var(--muted);">${allProviders.length} providers</div>
        </div>
      </div>

      ${insights}

      <!-- Accordion -->
      <div style="margin-top:16px;">
        ${accordionHTML}
      </div>

      <div style="margin-top:12px;font-size:10px;color:var(--muted);line-height:1.6;">
        <strong>How to read:</strong> Appt % = what % of leads get an appointment. Close % = what % convert to a sale. Stale 3d+ = leads not contacted in 3+ days. Sources with &lt;5 leads excluded from insight cards. Colors: <span style="color:#16a34a;">â– </span> strong <span style="color:#ca8a04;">â– </span> moderate <span style="color:#dc2626;">â– </span> weak
      </div>
    </div>`;
}

window.showDashboard = showDashboard;
window.showPersonDetails = showPersonDetails;
window.onRowHover = onRowHover;
window.viewCallSheets = viewCallSheets;
window.showUserModal = showUserModal;
window.closeUserModal = closeUserModal;
window.showActivityModal = showActivityModal;
window.closeActivityModal = closeActivityModal;
window.showReassignments = showReassignments;
window.toggleReassignSort = toggleReassignSort;
window.showSourceLeaderboard = showSourceLeaderboard;
window.toggleSourceSort = toggleSourceSort;
window.showLeadFunnel = showLeadFunnel;
window.toggleFunnelSort = toggleFunnelSort;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VEHICLE DEMAND DASHBOARD (Admin)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _vehData = null;
let _vehExpanded = new Set();
let _vehSort = { col: 'total', dir: 'desc' };

async function showVehicleDemand() {
  if (!isAdmin() && !isManager()) return;
  logPageView('Vehicle Demand');
  showLoading();
  try {
    const url = `${SCRIPT_URL}?route=vehicledemand&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!data.ok) { alert('Error loading vehicle data'); showDashboard(); return; }
    _vehData = data;
    _vehSort = { col: 'total', dir: 'desc' };
    _vehExpanded = new Set(data.byMake.slice(0, 5).map(m => m.name));
    renderVehicleDemand();
  } catch (err) {
    console.error('Vehicle demand error:', err);
    showDashboard();
  }
}

function toggleVehGroup(make) {
  if (_vehExpanded.has(make)) _vehExpanded.delete(make);
  else _vehExpanded.add(make);
  renderVehicleDemand();
}

function toggleVehSort(col) {
  if (_vehSort.col === col) _vehSort.dir = _vehSort.dir === 'desc' ? 'asc' : 'desc';
  else _vehSort = { col, dir: 'desc' };
  renderVehicleDemand();
}

function vehExpandAll() {
  _vehExpanded = new Set((_vehData?.byMake || []).map(m => m.name));
  renderVehicleDemand();
}
function vehCollapseAll() { _vehExpanded = new Set(); renderVehicleDemand(); }

function renderVehicleDemand() {
  if (!_vehData) return;
  const { byMake, summary, dateRange } = _vehData;
  const s = summary;
  const dateStr = dateRange ? `${dateRange.from || '?'} â€“ ${dateRange.to || '?'}` : '';

  // Sort makes
  const sorted = [...byMake].sort((a, b) => {
    let av = a[_vehSort.col], bv = b[_vehSort.col];
    if (typeof av === 'string') return _vehSort.dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    return _vehSort.dir === 'asc' ? (av||0) - (bv||0) : (bv||0) - (av||0);
  });

  function closeClr(r) { return r >= 20 ? '#16a34a' : r >= 10 ? '#ca8a04' : r >= 3 ? '#f97316' : '#dc2626'; }
  function nuBar(nw, used, total) {
    if (!total) return '';
    const pN = Math.round(nw / total * 100);
    const pU = Math.round(used / total * 100);
    return `<div style="display:flex;height:6px;border-radius:3px;overflow:hidden;width:80px;" title="New ${pN}% / Used ${pU}%">
      <div style="width:${pN}%;background:#3b82f6;"></div>
      <div style="width:${pU}%;background:#f97316;"></div>
      <div style="flex:1;background:#e2e8f0;"></div>
    </div>`;
  }
  function statusDots(active, sold, inactive, total) {
    if (!total) return '';
    const pA = Math.round(active / total * 100);
    const pS = Math.round(sold / total * 100);
    return `<div style="display:flex;height:6px;border-radius:3px;overflow:hidden;width:80px;" title="Active ${pA}% / Sold ${pS}%">
      <div style="width:${pA}%;background:#3b82f6;"></div>
      <div style="width:${pS}%;background:#16a34a;"></div>
      <div style="flex:1;background:#fca5a5;"></div>
    </div>`;
  }

  function sa(col) {
    return _vehSort.col === col ? (_vehSort.dir === 'desc' ? 'â–¼' : 'â–²') : 'â†•';
  }

  // Make brand colors
  const brandColors = {
    'JEEP': '#4d6b3a', 'RAM': '#1a1a1a', 'DODGE': '#d32f2f', 'TOYOTA': '#eb0a1e',
    'FORD': '#003478', 'BMW': '#0066b1', 'CHEVROLET': '#d4a843', 'KIA': '#05141f',
    'NISSAN': '#c3002f', 'HONDA': '#cc0000', 'CHRYSLER': '#004b87',
  };

  // Accordion
  let accHTML = '';
  sorted.forEach(mk => {
    const expanded = _vehExpanded.has(mk.name);
    const chevron = expanded ? 'â–¾' : 'â–¸';
    const clr = brandColors[mk.name] || '#64748b';
    const pctNew = mk.total > 0 ? Math.round(mk.new / mk.total * 100) : 0;
    const pctUsed = mk.total > 0 ? Math.round(mk.used / mk.total * 100) : 0;

    accHTML += `<div style="margin-bottom:${expanded ? '0' : '6'}px;">
      <div onclick="toggleVehGroup('${mk.name.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border:1px solid var(--line);border-radius:${expanded ? '10px 10px 0 0' : '10px'};cursor:pointer;user-select:none;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:11px;color:var(--muted);">${chevron}</span>
          <span style="display:inline-block;width:4px;height:20px;background:${clr};border-radius:2px;"></span>
          <span style="font-weight:800;font-size:14px;">${mk.name}</span>
          <span style="font-size:11px;color:var(--muted);">${mk.models.length} model${mk.models.length !== 1 ? 's' : ''}</span>
        </div>
        <div style="display:flex;gap:14px;align-items:center;font-size:12px;flex-wrap:wrap;">
          <span><strong>${mk.total}</strong> leads</span>
          ${nuBar(mk.new, mk.used, mk.total)}
          <span style="color:#3b82f6;font-size:10px;">${pctNew}% new</span>
          <span style="color:#f97316;font-size:10px;">${pctUsed}% used</span>
          <span style="color:${closeClr(mk.closeRate)};font-weight:700;">${mk.closeRate}% sold</span>
          <span style="font-size:10px;color:var(--muted);">${mk.withTrade} trades</span>
        </div>
      </div>`;

    if (expanded) {
      accHTML += `<div style="border:1px solid var(--line);border-top:none;border-radius:0 0 10px 10px;overflow:hidden;margin-bottom:6px;">
        <div style="overflow-x:auto;">
        <table style="width:100%;font-size:12px;">
          <thead><tr style="background:rgba(0,0,0,.02);">
            <th style="text-align:left;padding:8px 12px;font-size:11px;cursor:pointer;" onclick="toggleVehSort('name')">Model <span class="sort-arrow">${sa('name')}</span></th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('total')">Leads <span class="sort-arrow">${sa('total')}</span></th>
            <th style="font-size:11px;">New/Used</th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('active')">Active <span class="sort-arrow">${sa('active')}</span></th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('sold')">Sold <span class="sort-arrow">${sa('sold')}</span></th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('closeRate')">Close % <span class="sort-arrow">${sa('closeRate')}</span></th>
            <th style="font-size:11px;">Pipeline</th>
            <th style="font-size:11px;cursor:pointer;" onclick="toggleVehSort('withTrade')">Trades <span class="sort-arrow">${sa('withTrade')}</span></th>
            <th style="text-align:left;font-size:11px;">Top Trims</th>
          </tr></thead><tbody>`;

      const sortedModels = [...mk.models].sort((a, b) => {
        let av = a[_vehSort.col], bv = b[_vehSort.col];
        if (typeof av === 'string') return _vehSort.dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
        return _vehSort.dir === 'asc' ? (av||0) - (bv||0) : (bv||0) - (av||0);
      });

      const groupMax = Math.max(...mk.models.map(m => m.total), 1);
      sortedModels.forEach(md => {
        const barPct = Math.round((md.total / groupMax) * 100);
        const trimStr = (md.topTrims || []).join(', ');
        const eMake = mk.name.replace(/'/g, "\\'");
        const eModel = md.name.replace(/'/g, "\\'");
        const lnk = (val, filter, color) => val > 0
          ? `<a href="#" onclick="event.preventDefault();showVehLeads('${eMake}','${eModel}','${filter}')" style="color:${color || 'var(--text)'};text-decoration:underline;text-underline-offset:2px;cursor:pointer;font-weight:700;">${val}</a>`
          : `<span style="color:var(--muted);">${val}</span>`;
        accHTML += `<tr>
          <td style="padding:6px 12px;font-weight:600;">
            <div style="display:flex;align-items:center;gap:8px;">
              <div style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${md.name}">${md.name}</div>
              <div style="width:40px;height:4px;background:#f1f5f9;border-radius:2px;flex-shrink:0;">
                <div style="width:${barPct}%;height:100%;background:${clr};border-radius:2px;opacity:.4;"></div>
              </div>
            </div>
          </td>
          <td style="text-align:center;">${lnk(md.total, 'all', 'var(--text)')}</td>
          <td style="text-align:center;">${nuBar(md.new, md.used, md.total)}</td>
          <td style="text-align:center;">${lnk(md.active, 'active', '#3b82f6')}</td>
          <td style="text-align:center;">${lnk(md.sold, 'sold', '#16a34a')}</td>
          <td style="text-align:center;font-weight:700;color:${closeClr(md.closeRate)};">${md.closeRate}%</td>
          <td style="text-align:center;">${statusDots(md.active, md.sold, md.inactive, md.total)}</td>
          <td style="text-align:center;">${lnk(md.withTrade, 'trade', '#f97316')}</td>
          <td style="font-size:10px;color:var(--muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${trimStr}">${trimStr || 'â€“'}</td>
        </tr>`;
      });

      accHTML += '</tbody></table></div></div>';
    }
    accHTML += '</div>';
  });

  // Top trades sidebar
  const tradesHTML = (s.topTrades || []).map((t, i) =>
    `<div style="display:flex;justify-content:space-between;padding:4px 0;${i > 0 ? 'border-top:1px solid var(--line);' : ''}">
      <span style="font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px;" title="${t.name}">${t.name}</span>
      <span style="font-size:11px;font-weight:700;flex-shrink:0;margin-left:8px;">${t.count}</span>
    </div>`
  ).join('');

  // New vs Used donut (CSS-based)
  const totalNU = s.new + s.used;
  const pctNew = totalNU > 0 ? Math.round(s.new / totalNU * 100) : 50;

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">ğŸš— Vehicle Demand Dashboard</div>
          <div style="font-size:12px;color:var(--muted);">What customers are shopping for Â· grouped by Make${dateStr ? ` Â· <strong style="color:var(--text);">${dateStr}</strong>` : ''}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="topbar-btn" onclick="vehExpandAll()" style="font-size:11px;padding:5px 10px;">Expand All</button>
          <button class="topbar-btn" onclick="vehCollapseAll()" style="font-size:11px;padding:5px 10px;">Collapse All</button>
          <button class="topbar-btn manage" onclick="showVehicleDemand()">â†» Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Leads w/ Vehicle</div>
          <div style="font-size:22px;font-weight:800;">${s.withVehicle}</div>
          <div style="font-size:10px;color:var(--muted);">of ${s.totalLeads} total</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">New / Used</div>
          <div style="font-size:18px;font-weight:800;"><span style="color:#3b82f6;">${s.new}</span> <span style="color:var(--muted);font-size:12px;">/</span> <span style="color:#f97316;">${s.used}</span></div>
          <div style="display:flex;height:6px;border-radius:3px;overflow:hidden;margin-top:4px;">
            <div style="width:${pctNew}%;background:#3b82f6;"></div>
            <div style="flex:1;background:#f97316;"></div>
          </div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Active ğŸŸ¢</div>
          <div style="font-size:22px;font-weight:800;">${s.active}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Sold âœ…</div>
          <div style="font-size:22px;font-weight:800;color:#16a34a;">${s.sold}</div>
          <div style="font-size:10px;color:var(--muted);">${s.closeRate}% close</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Makes</div>
          <div style="font-size:22px;font-weight:800;">${byMake.length}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">With Trade-In</div>
          <div style="font-size:22px;font-weight:800;">${s.withTrade}</div>
          <div style="font-size:10px;color:var(--muted);">${s.withVehicle > 0 ? Math.round(s.withTrade / s.withVehicle * 100) : 0}% of leads</div>
        </div>
      </div>

      <!-- Insights row -->
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
        <!-- Top 5 Models -->
        <div style="flex:1;min-width:250px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:12px;margin-bottom:8px;">ğŸ”¥ Top 5 Most Demanded</div>
          ${(() => {
            const allModels = [];
            byMake.forEach(mk => mk.models.forEach(md => allModels.push({ make: mk.name, ...md })));
            allModels.sort((a, b) => b.total - a.total);
            return allModels.slice(0, 5).map((m, i) =>
              '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;' + (i > 0 ? 'border-top:1px solid var(--line);' : '') + '">' +
                '<span style="font-size:12px;font-weight:600;">' + (i+1) + '. ' + m.make + ' ' + m.name + '</span>' +
                '<span style="font-size:11px;color:var(--muted);"><strong style="color:var(--text);">' + m.total + '</strong> leads Â· <span style="color:' + closeClr(m.closeRate) + ';">' + m.closeRate + '% sold</span></span>' +
              '</div>'
            ).join('');
          })()}
        </div>

        <!-- Top Trades -->
        <div style="flex:1;min-width:250px;background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:12px;margin-bottom:8px;">ğŸ”„ Top Trade-Ins</div>
          ${tradesHTML || '<div style="color:var(--muted);font-size:12px;">No trade data</div>'}
        </div>
      </div>

      <!-- Accordion -->
      <div>${accHTML}</div>

      <div style="margin-top:12px;font-size:10px;color:var(--muted);line-height:1.6;">
        <strong>How to read:</strong> New/Used bar = <span style="color:#3b82f6;">â– </span> new <span style="color:#f97316;">â– </span> used. Pipeline = <span style="color:#3b82f6;">â– </span> active <span style="color:#16a34a;">â– </span> sold <span style="color:#fca5a5;">â– </span> inactive. Close % = sold Ã· total leads for that vehicle.
      </div>
    </div>`;
}

window.showVehicleDemand = showVehicleDemand;
window.toggleVehGroup = toggleVehGroup;
window.toggleVehSort = toggleVehSort;
window.vehExpandAll = vehExpandAll;
window.vehCollapseAll = vehCollapseAll;

function showVehLeads(makeName, modelName, filter) {
  if (!_vehData) return;
  logPageView('Vehicle Leads: ' + makeName + ' ' + modelName);
  const mk = _vehData.byMake.find(m => m.name === makeName);
  if (!mk) return;
  const md = mk.models.find(m => m.name === modelName);
  if (!md || !md.leads) return;

  let leads = md.leads;
  let filterLabel = 'All';
  const filterColors = { all: 'var(--text)', active: '#3b82f6', sold: '#16a34a', inactive: '#dc2626', trade: '#f97316' };
  if (filter === 'active') { leads = leads.filter(l => l.cat === 'active'); filterLabel = 'Active'; }
  else if (filter === 'sold') { leads = leads.filter(l => l.cat === 'sold'); filterLabel = 'Sold'; }
  else if (filter === 'inactive') { leads = leads.filter(l => l.cat === 'inactive'); filterLabel = 'Inactive'; }
  else if (filter === 'trade') { leads = leads.filter(l => l.tv); filterLabel = 'With Trade-In'; }

  const filterBtns = ['all','active','sold','trade'].map(f => {
    const labels = { all: `All (${md.total})`, active: `Active (${md.active})`, sold: `Sold (${md.sold})`, trade: `Trades (${md.withTrade})` };
    const isActive = f === filter;
    return `<button onclick="showVehLeads('${makeName.replace(/'/g, "\\'")}','${modelName.replace(/'/g, "\\'")}','${f}')" style="padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid ${filterColors[f]};background:${isActive ? filterColors[f] : 'transparent'};color:${isActive ? '#fff' : filterColors[f]};cursor:pointer;">${labels[f]}</button>`;
  }).join('');

  const statusClr = (cat) => cat === 'sold' ? '#16a34a' : cat === 'active' ? '#3b82f6' : '#dc2626';

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">${makeName} ${modelName}</div>
          <div style="font-size:12px;color:var(--muted);">
            <span style="color:${filterColors[filter]};font-weight:700;">${filterLabel}</span> Â· ${leads.length} lead${leads.length !== 1 ? 's' : ''}
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          ${filterBtns}
          <button class="topbar-btn manage" onclick="renderVehicleDemand()" style="margin-left:8px;">â† Vehicle Demand</button>
        </div>
      </div>

      <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;overflow:hidden;">
        <div style="overflow-x:auto;">
        <table style="width:100%;font-size:12px;border-collapse:collapse;">
          <thead><tr style="background:rgba(0,0,0,.03);">
            <th style="text-align:left;padding:10px 12px;font-size:11px;">Customer</th>
            <th style="text-align:left;font-size:11px;">Phone</th>
            <th style="text-align:left;font-size:11px;">Email</th>
            <th style="text-align:left;font-size:11px;">Status</th>
            <th style="text-align:left;font-size:11px;">Sales Rep</th>
            <th style="text-align:left;font-size:11px;">Date In</th>
            <th style="text-align:center;font-size:11px;">New/Used</th>
            <th style="text-align:left;font-size:11px;">Trim</th>
            <th style="text-align:left;font-size:11px;">Trade-In</th>
          </tr></thead>
          <tbody>
            ${leads.length === 0 ? '<tr><td colspan="9" style="padding:20px;text-align:center;color:var(--muted);">No leads match this filter.</td></tr>' : ''}
            ${leads.map(l => `<tr style="border-top:1px solid var(--line);">
              <td style="padding:8px 12px;font-weight:600;white-space:nowrap;">${l.n || 'â€“'}</td>
              <td style="white-space:nowrap;">${l.p ? `<a href="tel:${l.p}" style="color:var(--accent);text-decoration:none;">${l.p}</a>` : 'â€“'}</td>
              <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.e}">${l.e ? `<a href="mailto:${l.e}" style="color:var(--accent);text-decoration:none;">${l.e}</a>` : 'â€“'}</td>
              <td style="white-space:nowrap;"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${statusClr(l.cat)};margin-right:4px;"></span>${l.s || 'â€“'}</td>
              <td style="white-space:nowrap;">${l.r || 'â€“'}</td>
              <td style="white-space:nowrap;">${l.d || 'â€“'}</td>
              <td style="text-align:center;"><span style="background:${l.nu === 'New' ? '#dbeafe' : l.nu === 'Used' ? '#ffedd5' : '#f4f4f5'};color:${l.nu === 'New' ? '#1d4ed8' : l.nu === 'Used' ? '#c2410c' : '#71717a'};padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;">${l.nu || 'â€“'}</span></td>
              <td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.t}">${l.t || 'â€“'}</td>
              <td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.tv}">${l.tv || 'â€“'}</td>
            </tr>`).join('')}
          </tbody>
        </table>
        </div>
      </div>
    </div>`;
}

window.showVehLeads = showVehLeads;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENGAGEMENT REPORT (Admin)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _engagementData = null;
let _engDays = 7;

async function showEngagement() {
  if (!isAdmin()) return;
  logPageView('Engagement Report');
  showLoading();
  try {
    await loadEngagementData(_engDays);
    renderEngagement();
  } catch (err) {
    console.error('Engagement error:', err);
    showDashboard();
  }
}

async function loadEngagementData(days) {
  _engDays = days;
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);
  const cutoffTs = Timestamp.fromDate(cutoff);

  const q = query(
    collection(db, 'pageViews'),
    where('ts', '>=', cutoffTs),
    orderBy('ts', 'desc'),
    limit(10000)
  );

  const snap = await getDocs(q);
  const rows = [];
  snap.forEach(d => {
    const data = d.data();
    rows.push({
      email: data.email || 'unknown',
      page: data.page || '',
      ts: data.ts?.toDate ? data.ts.toDate() : new Date(data.ts),
      sessionId: data.sessionId || '',
      dwellMs: data.dwellMs || 0
    });
  });
  _engagementData = rows;
}

function setEngDays(d) {
  showLoading();
  loadEngagementData(d).then(() => renderEngagement()).catch(() => showDashboard());
}

function renderEngagement() {
  if (!_engagementData) return;
  const rows = _engagementData.filter(r => !r.page.endsWith('(exit)'));
  const exitRows = _engagementData.filter(r => r.page.endsWith('(exit)'));

  if (rows.length === 0) {
    document.getElementById('app').innerHTML = `
      <div style="max-width:1000px;margin:0 auto;padding:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div>
            <div style="font-size:20px;font-weight:800;">ğŸ“ˆ Engagement Report</div>
            <div style="font-size:12px;color:var(--muted);">No data yet â€” tracking just started. Check back after users navigate the dashboard.</div>
          </div>
          <button class="topbar-btn logout" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>`;
    return;
  }

  // â”€â”€ 1. Page Popularity â”€â”€
  const pageCounts = {};
  const pageDwell = {};
  rows.forEach(r => {
    const p = r.page.startsWith('Person Detail:') ? 'Person Detail' : r.page.startsWith('Call Sheets:') ? 'Call Sheets' : r.page;
    pageCounts[p] = (pageCounts[p] || 0) + 1;
    if (!pageDwell[p]) pageDwell[p] = [];
    if (r.dwellMs > 0 && r.dwellMs < 3600000) pageDwell[p].push(r.dwellMs);
  });
  const pagePopularity = Object.entries(pageCounts)
    .map(([page, count]) => ({
      page,
      count,
      avgDwell: pageDwell[page]?.length ? Math.round(pageDwell[page].reduce((a, b) => a + b, 0) / pageDwell[page].length / 1000) : null
    }))
    .sort((a, b) => b.count - a.count);
  const maxPageCount = pagePopularity.length ? pagePopularity[0].count : 1;

  // â”€â”€ 2. Drop-off (last page per session) â”€â”€
  const sessionPages = {};
  rows.forEach(r => {
    if (!sessionPages[r.sessionId]) sessionPages[r.sessionId] = [];
    sessionPages[r.sessionId].push(r);
  });
  const dropOffs = {};
  Object.values(sessionPages).forEach(pages => {
    pages.sort((a, b) => b.ts - a.ts);
    let last = pages[0].page;
    last = last.startsWith('Person Detail:') ? 'Person Detail' : last.startsWith('Call Sheets:') ? 'Call Sheets' : last;
    dropOffs[last] = (dropOffs[last] || 0) + 1;
  });
  const dropOffArr = Object.entries(dropOffs).sort((a, b) => b[1] - a[1]);
  const totalSessions = Object.keys(sessionPages).length;

  // â”€â”€ 3. Session Depth â”€â”€
  const sessionDepths = Object.values(sessionPages).map(p => p.length);
  const avgDepth = sessionDepths.length ? (sessionDepths.reduce((a, b) => a + b, 0) / sessionDepths.length).toFixed(1) : 0;
  const maxDepth = Math.max(...sessionDepths, 0);

  // â”€â”€ 4. Per-User Engagement â”€â”€
  const userStats = {};
  rows.forEach(r => {
    if (!userStats[r.email]) userStats[r.email] = { views: 0, sessions: new Set(), pages: new Set() };
    userStats[r.email].views++;
    userStats[r.email].sessions.add(r.sessionId);
    const p = r.page.startsWith('Person Detail:') ? 'Person Detail' : r.page.startsWith('Call Sheets:') ? 'Call Sheets' : r.page;
    userStats[r.email].pages.add(p);
  });
  const userArr = Object.entries(userStats).map(([email, s]) => ({
    email,
    views: s.views,
    sessions: s.sessions.size,
    uniquePages: s.pages.size
  })).sort((a, b) => b.views - a.views);

  // â”€â”€ 5. Time Patterns (hour of day) â”€â”€
  const hourCounts = new Array(24).fill(0);
  const dayCounts = new Array(7).fill(0);
  rows.forEach(r => {
    hourCounts[r.ts.getHours()]++;
    dayCounts[r.ts.getDay()]++;
  });
  const maxHour = Math.max(...hourCounts, 1);
  const maxDay = Math.max(...dayCounts, 1);
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  function fmtDwell(sec) {
    if (sec === null) return 'â€“';
    if (sec < 60) return sec + 's';
    return Math.floor(sec / 60) + 'm ' + (sec % 60) + 's';
  }

  // â”€â”€ Render â”€â”€
  document.getElementById('app').innerHTML = `
    <div style="max-width:1100px;margin:0 auto;padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">ğŸ“ˆ Engagement Report</div>
          <div style="font-size:12px;color:var(--muted);">Page views, drop-offs & user activity Â· last ${_engDays} days Â· ${rows.length} views tracked</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          ${[7, 14, 30].map(d =>
            `<button class="topbar-btn${_engDays === d ? ' active' : ''}" onclick="setEngDays(${d})" style="font-size:11px;padding:5px 10px;${_engDays === d ? 'background:var(--accent);color:#fff;' : ''}">${d}d</button>`
          ).join('')}
          <button class="topbar-btn manage" onclick="showEngagement()">â†» Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Page Views</div>
          <div style="font-size:22px;font-weight:800;">${rows.length}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Sessions</div>
          <div style="font-size:22px;font-weight:800;">${totalSessions}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Unique Users</div>
          <div style="font-size:22px;font-weight:800;">${userArr.length}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Avg Depth</div>
          <div style="font-size:22px;font-weight:800;">${avgDepth}</div>
          <div style="font-size:10px;color:var(--muted);">pages/session</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Deepest Session</div>
          <div style="font-size:22px;font-weight:800;">${maxDepth}</div>
          <div style="font-size:10px;color:var(--muted);">pages</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
        <!-- Page Popularity -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;grid-column:${pagePopularity.length > 6 ? '1 / -1' : '1'};">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">ğŸ”¥ Page Popularity</div>
          ${pagePopularity.map(p => `
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
              <div style="width:130px;font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0;" title="${p.page}">${p.page}</div>
              <div style="flex:1;height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
                <div style="width:${Math.round(p.count / maxPageCount * 100)}%;height:100%;background:linear-gradient(90deg,#3b82f6,#8b5cf6);border-radius:4px;"></div>
              </div>
              <div style="font-size:11px;font-weight:700;min-width:32px;text-align:right;">${p.count}</div>
              <div style="font-size:10px;color:var(--muted);min-width:40px;text-align:right;">${fmtDwell(p.avgDwell)}</div>
            </div>
          `).join('')}
          <div style="font-size:9px;color:var(--muted);margin-top:6px;text-align:right;">Right column = avg time on page</div>
        </div>

        <!-- Drop-off Points -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">ğŸšª Session Exit Points</div>
          <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">Where users leave the dashboard</div>
          ${dropOffArr.slice(0, 8).map(([page, count]) => {
            const pct = Math.round(count / totalSessions * 100);
            return `
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
              <div style="width:120px;font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0;">${page}</div>
              <div style="flex:1;height:8px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
                <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#f97316,#dc2626);border-radius:4px;"></div>
              </div>
              <div style="font-size:11px;font-weight:700;min-width:32px;text-align:right;">${count}</div>
              <div style="font-size:10px;color:var(--muted);min-width:32px;text-align:right;">${pct}%</div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
        <!-- Hourly Pattern -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">ğŸ• Activity by Hour</div>
          <div style="display:flex;align-items:flex-end;gap:2px;height:80px;">
            ${hourCounts.map((c, h) => {
              const pct = Math.round(c / maxHour * 100);
              const isWork = h >= 8 && h <= 18;
              return `<div title="${h > 12 ? (h-12) : h}${h >= 12 ? 'pm' : 'am'}: ${c} views" style="flex:1;height:${Math.max(pct, 2)}%;background:${isWork ? '#3b82f6' : '#cbd5e1'};border-radius:2px 2px 0 0;transition:all .15s;"></div>`;
            }).join('')}
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:9px;color:var(--muted);">
            <span>12a</span><span>6a</span><span>12p</span><span>6p</span><span>11p</span>
          </div>
        </div>

        <!-- Daily Pattern -->
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px;">ğŸ“… Activity by Day</div>
          ${dayNames.map((name, i) => {
            const pct = Math.round(dayCounts[i] / maxDay * 100);
            return `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <div style="width:32px;font-size:11px;font-weight:600;">${name}</div>
              <div style="flex:1;height:10px;background:#f1f5f9;border-radius:4px;overflow:hidden;">
                <div style="width:${pct}%;height:100%;background:${i === 0 || i === 6 ? '#f97316' : '#3b82f6'};border-radius:4px;"></div>
              </div>
              <div style="font-size:11px;font-weight:700;min-width:32px;text-align:right;">${dayCounts[i]}</div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- User Engagement Table -->
      <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:14px;">
        <div style="font-weight:700;font-size:13px;margin-bottom:10px;">ğŸ‘¤ Per-User Engagement</div>
        <div style="overflow-x:auto;">
        <table style="width:100%;font-size:12px;">
          <thead><tr style="background:rgba(0,0,0,.02);">
            <th style="text-align:left;padding:8px 12px;">User</th>
            <th>Page Views</th>
            <th>Sessions</th>
            <th>Unique Pages</th>
            <th>Views/Session</th>
          </tr></thead>
          <tbody>
            ${userArr.map(u => {
              const vps = u.sessions > 0 ? (u.views / u.sessions).toFixed(1) : '0';
              const maxViews = userArr[0]?.views || 1;
              const barPct = Math.round(u.views / maxViews * 100);
              return `<tr>
                <td style="padding:6px 12px;font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="${u.email}">${u.email}</td>
                <td style="text-align:center;">
                  <div style="display:flex;align-items:center;gap:6px;justify-content:center;">
                    <div style="width:50px;height:5px;background:#f1f5f9;border-radius:3px;overflow:hidden;">
                      <div style="width:${barPct}%;height:100%;background:#3b82f6;border-radius:3px;"></div>
                    </div>
                    <span style="font-weight:700;">${u.views}</span>
                  </div>
                </td>
                <td style="text-align:center;">${u.sessions}</td>
                <td style="text-align:center;">${u.uniquePages}</td>
                <td style="text-align:center;font-weight:700;">${vps}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
        </div>
      </div>

      <div style="margin-top:12px;font-size:10px;color:var(--muted);line-height:1.6;">
        <strong>How to read:</strong> Page Views = total navigations. Sessions = distinct login sessions. Depth = pages visited per session. Exit Points = last page viewed before leaving. Avg time = average seconds spent on that page before navigating away. Tracking began when this feature was deployed.
      </div>
    </div>`;
}

window.showEngagement = showEngagement;
window.setEngDays = setEngDays;
window.showAutoNews = showAutoNews;
window.toggleNewsGroup = toggleNewsGroup;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPETITIVE ANALYSIS (Admin)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _compData = null;
let _compFilter = 'all';
let _compExpanded = new Set();

async function showCompetitiveAnalysis() {
  if (!isAdmin()) return;
  logPageView('Competitive Analysis');
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="max-width:1300px;margin:0 auto;padding:18px 12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <h2 style="margin:0;font-size:20px;">ğŸ† Competitive Analysis</h2>
          <p style="margin:4px 0 0;color:var(--muted);font-size:13px;">Live pricing from CarGurus â€” Ancira CJD vs. SA CDJR new inventory</p>
        </div>
        <button class="topbar-btn manage" onclick="showDashboard()">â† Dashboard</button>
      </div>
      <div class="loading-wrap"><div class="spinner"></div></div>
    </div>`;

  try {
    const url = `${SCRIPT_URL}?route=comp_analysis&session=${encodeURIComponent(window.sessionToken || '')}`;
    const resp = await fetch(url);
    const raw = await resp.text();
    let result;
    try { result = JSON.parse(raw); } catch { throw new Error('Non-JSON response from backend'); }
    if (!result.ok) throw new Error(result.error || 'Backend error');
    _compData = result;
    _compFilter = 'all';
    _compExpanded = new Set();
    renderCompAnalysis();
  } catch (err) {
    app.innerHTML = `
      <div style="max-width:800px;margin:40px auto;padding:20px;">
        <div class="detail-card" style="color:#dc2626;text-align:center;">
          <h2>Error Loading Competitive Analysis</h2>
          <p>${err.message}</p>
          <p style="color:var(--muted);font-size:13px;margin-top:8px;">Make sure the <code>comp_analysis</code> route is added to your Apps Script backend and the <strong>CompAnalysis</strong> sheet tab exists.</p>
          <button class="btn" onclick="showDashboard()" style="margin-top:14px;">â† Back</button>
        </div>
      </div>`;
  }
}

function setCompFilter(make) { _compFilter = make; _compModelFilter = 'all'; renderCompAnalysis(); }
function setCompModelFilter(model) { _compModelFilter = model; renderCompAnalysis(); }
function toggleCompGroup(key) {
  if (_compExpanded.has(key)) _compExpanded.delete(key); else _compExpanded.add(key);
  renderCompAnalysis();
}
function compExpandAll() { _compExpanded = new Set(_compGroupKeys || []); renderCompAnalysis(); }
function compCollapseAll() { _compExpanded = new Set(); renderCompAnalysis(); }

let _compGroupKeys = [];
let _compModelFilter = 'all';
let _compSortCol = 'salePrice'; // default sort
let _compSortDir = 'asc';
function compSort(col) {
  if (_compSortCol === col) _compSortDir = _compSortDir === 'asc' ? 'desc' : 'asc';
  else { _compSortCol = col; _compSortDir = 'asc'; }
  renderCompAnalysis();
}

function renderCompAnalysis() {
  if (!_compData) return;
  const { competitors, ourPricing, lastUpdated, anciraCount, ourCount } = _compData;

  // â”€â”€ Merge ALL vehicles into one unified list with a store label â”€â”€
  const allVehicles = [];
  competitors.forEach(v => allVehicles.push({ ...v, store: v.dealer || 'Ancira CJD', storeColor: '#dc2626' }));
  ourPricing.forEach(v => allVehicles.push({ ...v, store: 'SA CDJR', storeColor: '#2563eb' }));

  // â”€â”€ Collect all makes and models for filtering â”€â”€
  const makeModelMap = {};
  allVehicles.forEach(v => {
    if (!makeModelMap[v.make]) makeModelMap[v.make] = new Set();
    makeModelMap[v.make].add(v.model);
  });
  const allMakes = Object.keys(makeModelMap).sort();

  // â”€â”€ Apply make + model filters â”€â”€
  const filtered = allVehicles.filter(v => {
    if (_compFilter !== 'all' && v.make.toLowerCase() !== _compFilter.toLowerCase()) return false;
    if (_compModelFilter !== 'all' && v.model.toLowerCase() !== _compModelFilter.toLowerCase()) return false;
    return true;
  });

  // â”€â”€ Group by Make > Model > Trim â”€â”€
  const trimGroups = {};
  filtered.forEach(v => {
    const gKey = `${v.make} ${v.model} â€“ ${v.trim || 'Base'}`;
    if (!trimGroups[gKey]) trimGroups[gKey] = { make: v.make, model: v.model, trim: v.trim || 'Base', items: [] };
    trimGroups[gKey].items.push(v);
  });

  // Sort each group's items by selected column
  const getSortVal = (v) => {
    if (_compSortCol === 'msrp') return v.msrp || 0;
    if (_compSortCol === 'salePrice') return v.salePrice || 0;
    if (_compSortCol === 'discount') return (v.msrp && v.salePrice) ? v.msrp - v.salePrice : 0;
    if (_compSortCol === 'pctMsrp') return (v.msrp && v.salePrice) ? v.salePrice / v.msrp : 2;
    return v.salePrice || 0;
  };
  Object.values(trimGroups).forEach(g => {
    g.items.sort((a, b) => {
      const va = getSortVal(a), vb = getSortVal(b);
      return _compSortDir === 'asc' ? va - vb : vb - va;
    });
  });

  // Sort group keys alphabetically
  const sortedKeys = Object.keys(trimGroups).sort();
  _compGroupKeys = sortedKeys;

  // Auto-expand first 5 if nothing expanded
  if (_compExpanded.size === 0) sortedKeys.slice(0, 5).forEach(k => _compExpanded.add(k));

  // â”€â”€ Summary stats â”€â”€
  let totalComp = competitors.filter(v => {
    if (_compFilter !== 'all' && v.make.toLowerCase() !== _compFilter.toLowerCase()) return false;
    if (_compModelFilter !== 'all' && v.model.toLowerCase() !== _compModelFilter.toLowerCase()) return false;
    return true;
  }).length;
  let totalOurs = ourPricing.filter(v => {
    if (_compFilter !== 'all' && v.make.toLowerCase() !== _compFilter.toLowerCase()) return false;
    if (_compModelFilter !== 'all' && v.model.toLowerCase() !== _compModelFilter.toLowerCase()) return false;
    return true;
  }).length;

  // Compare: for each trim group that has both stores, count wins
  let totalWeBeat = 0, totalTheyBeat = 0, totalNoCompare = 0;
  Object.values(trimGroups).forEach(g => {
    const anciraItems = g.items.filter(v => v.store !== 'SA CDJR');
    const ourItems = g.items.filter(v => v.store === 'SA CDJR');
    if (anciraItems.length > 0 && ourItems.length > 0) {
      const bestAncira = Math.min(...anciraItems.filter(v => v.salePrice > 0).map(v => v.salePrice));
      const bestOurs = Math.min(...ourItems.filter(v => v.salePrice > 0).map(v => v.salePrice));
      if (bestOurs < Infinity && bestAncira < Infinity) {
        if (bestOurs <= bestAncira) totalWeBeat++;
        else totalTheyBeat++;
      } else { totalNoCompare++; }
    } else { totalNoCompare++; }
  });

  // Format helpers
  const fmt = (n) => n ? '$' + n.toLocaleString('en-US') : 'â€“';
  const fmtDelta = (d) => {
    if (!d) return 'â€“';
    const abs = Math.abs(d);
    const str = '$' + abs.toLocaleString('en-US');
    return d > 0 ? '+' + str : '-' + str;
  };

  // â”€â”€ Build accordion HTML â”€â”€
  let accHTML = '';
  sortedKeys.forEach(gKey => {
    const g = trimGroups[gKey];
    const open = _compExpanded.has(gKey);
    const count = g.items.length;

    // Best prices per store for the header
    const ancPrices = g.items.filter(v => v.store !== 'SA CDJR' && v.salePrice > 0).map(v => v.salePrice);
    const ourPrices = g.items.filter(v => v.store === 'SA CDJR' && v.salePrice > 0).map(v => v.salePrice);
    const bestAnc = ancPrices.length > 0 ? Math.min(...ancPrices) : null;
    const bestOur = ourPrices.length > 0 ? Math.min(...ourPrices) : null;

    // Winner badge
    let winBadge = '';
    if (bestAnc && bestOur) {
      if (bestOur < bestAnc) winBadge = '<span style="color:#16a34a;font-weight:700;font-size:11px;">âœ“ Us</span>';
      else if (bestAnc < bestOur) winBadge = '<span style="color:#dc2626;font-weight:700;font-size:11px;">âœ— Ancira</span>';
      else winBadge = '<span style="color:#ca8a04;font-weight:700;font-size:11px;">= Even</span>';
    }

    accHTML += `
      <div style="margin-bottom:6px;border:1px solid var(--line);border-radius:10px;overflow:hidden;">
        <div onclick="toggleCompGroup('${gKey.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);cursor:pointer;user-select:none;">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:13px;">${open ? 'â–¼' : 'â–¶'}</span>
            <div>
              <span style="font-weight:700;font-size:13px;">${g.make} ${g.model}</span>
              <span style="margin-left:6px;font-weight:400;font-size:12px;color:var(--muted);">â€” ${g.trim}</span>
              <span style="margin-left:8px;font-size:10px;color:var(--muted);">(${count})</span>
            </div>
          </div>
          <div style="display:flex;gap:14px;font-size:12px;align-items:center;">
            ${bestAnc ? `<span style="color:#dc2626;">Ancira: <strong>${fmt(bestAnc)}</strong></span>` : ''}
            ${bestOur ? `<span style="color:#2563eb;">Us: <strong>${fmt(bestOur)}</strong></span>` : ''}
            ${winBadge}
          </div>
        </div>`;

    if (open) {
      accHTML += `<div style="padding:0;overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Store</th>
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Year</th>
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Details</th>
              <th onclick="compSort('msrp')" style="padding:8px 12px;text-align:right;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">MSRP ${_compSortCol === 'msrp' ? (_compSortDir === 'asc' ? 'â–²' : 'â–¼') : '<span style="color:#ccc;">â‡…</span>'}</th>
              <th onclick="compSort('salePrice')" style="padding:8px 12px;text-align:right;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">Sale Price ${_compSortCol === 'salePrice' ? (_compSortDir === 'asc' ? 'â–²' : 'â–¼') : '<span style="color:#ccc;">â‡…</span>'}</th>
              <th onclick="compSort('discount')" style="padding:8px 12px;text-align:right;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">Discount ${_compSortCol === 'discount' ? (_compSortDir === 'asc' ? 'â–²' : 'â–¼') : '<span style="color:#ccc;">â‡…</span>'}</th>
              <th onclick="compSort('pctMsrp')" style="padding:8px 12px;text-align:center;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;cursor:pointer;user-select:none;">% MSRP ${_compSortCol === 'pctMsrp' ? (_compSortDir === 'asc' ? 'â–²' : 'â–¼') : '<span style="color:#ccc;">â‡…</span>'}</th>
              <th style="padding:8px 12px;text-align:left;font-weight:700;border-bottom:1px solid var(--line);white-space:nowrap;">Stock / VIN</th>
            </tr>
          </thead>
          <tbody>`;

      g.items.forEach((v, idx) => {
        const discount = (v.msrp && v.salePrice) ? v.msrp - v.salePrice : 0;
        const details = [v.color, v.drivetrain].filter(Boolean).join(' Â· ') || 'â€“';

        // Store badge
        const isUs = v.store === 'SA CDJR';
        const storeBadge = `<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;color:#fff;background:${isUs ? '#2563eb' : '#dc2626'};white-space:nowrap;">${isUs ? 'SA CDJR' : 'Ancira'}</span>`;

        // % of MSRP
        const pctMsrp = (v.msrp > 0 && v.salePrice > 0) ? ((v.salePrice / v.msrp) * 100) : 0;
        let pctColor = 'var(--muted)';
        let pctLabel = 'â€“';
        if (pctMsrp > 0) {
          pctLabel = pctMsrp.toFixed(1) + '%';
          if (pctMsrp <= 80) pctColor = '#16a34a';
          else if (pctMsrp <= 87) pctColor = '#059669';
          else if (pctMsrp <= 92) pctColor = '#ca8a04';
          else pctColor = '#dc2626';
        }

        // Hyperlinked price
        const priceHTML = v.salePrice > 0
          ? (v.url ? `<a href="${v.url}" target="_blank" rel="noopener" style="color:${v.storeColor};font-weight:700;text-decoration:underline;text-underline-offset:2px;" title="Search VIN on Google">${fmt(v.salePrice)}</a>` : `<span style="font-weight:700;color:${v.storeColor};">${fmt(v.salePrice)}</span>`)
          : 'â€“';

        // Stock/VIN
        const stockVin = [];
        if (v.stock) stockVin.push('#' + v.stock);
        const vinShort = v.vin ? v.vin.slice(-6) : '';
        if (vinShort) stockVin.push(vinShort);

        // Lowest price highlight
        const isLowest = idx === 0 && v.salePrice > 0;
        const rowBg = isLowest ? (isUs ? 'background:#eff6ff;' : 'background:#fef2f2;') : '';

        accHTML += `
            <tr style="border-bottom:1px solid var(--line);${rowBg}">
              <td style="padding:8px 12px;">${storeBadge}</td>
              <td style="padding:8px 12px;">${v.year}</td>
              <td style="padding:8px 12px;color:var(--muted);font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${details}">${details}</td>
              <td style="padding:8px 12px;text-align:right;">${v.msrp > 0 ? fmt(v.msrp) : 'â€“'}</td>
              <td style="padding:8px 12px;text-align:right;">${priceHTML}</td>
              <td style="padding:8px 12px;text-align:right;color:#16a34a;font-weight:600;">${discount > 0 ? fmt(discount) : 'â€“'}</td>
              <td style="padding:8px 12px;text-align:center;font-weight:600;color:${pctColor};">${pctLabel}</td>
              <td style="padding:8px 12px;font-size:11px;color:var(--muted);white-space:nowrap;" title="${v.vin || ''}">${stockVin.join(' Â· ') || 'â€“'}</td>
            </tr>`;
      });

      accHTML += `</tbody></table></div>`;
    }
    accHTML += `</div>`;
  });

  if (sortedKeys.length === 0) {
    accHTML = `<div class="detail-card" style="text-align:center;padding:40px;color:var(--muted);">
      No data found${_compFilter !== 'all' ? ' for ' + _compFilter : ''}${_compModelFilter !== 'all' ? ' ' + _compModelFilter : ''}. Make sure <code>refreshCompetitorPricing_()</code> has been run.
    </div>`;
  }

  // â”€â”€ Styles â”€â”€
  const tabStyle = (f, active) => `padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid ${active ? 'var(--accent)' : 'var(--line)'};background:${active ? 'var(--accent)' : 'var(--card)'};color:${active ? '#fff' : 'var(--text)'};`;
  const modelTabStyle = (f, active) => `padding:4px 12px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid ${active ? '#7c3aed' : 'var(--line)'};background:${active ? '#7c3aed' : 'var(--card)'};color:${active ? '#fff' : 'var(--text)'};`;

  // Models for the selected make
  const modelsForMake = _compFilter !== 'all' && makeModelMap[_compFilter]
    ? [...makeModelMap[_compFilter]].sort()
    : [];

  document.getElementById('app').innerHTML = `
    <div style="max-width:1200px;margin:0 auto;padding:16px 12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
        <div>
          <div style="font-size:20px;font-weight:800;">ğŸ† Competitive Analysis</div>
          <div style="font-size:12px;color:var(--muted);">
            Competitor: <strong>Ancira CJD</strong> Â· Us: <strong>SA CDJR</strong>
            ${lastUpdated ? ` Â· Updated <strong>${lastUpdated}</strong>` : ''}
            Â· <span style="font-size:11px;">Click any <u>underlined price</u> to search VIN on Google</span>
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <button class="topbar-btn" onclick="compExpandAll()" style="font-size:11px;padding:5px 10px;">Expand All</button>
          <button class="topbar-btn" onclick="compCollapseAll()" style="font-size:11px;padding:5px 10px;">Collapse All</button>
          <button class="topbar-btn manage" onclick="showCompetitiveAnalysis()">â†» Refresh</button>
          <button class="topbar-btn logout" onclick="showDashboard()">â† Dashboard</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:14px;">
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#dc2626;font-weight:600;">Ancira Listings</div>
          <div style="font-size:22px;font-weight:800;">${totalComp}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#2563eb;font-weight:600;">Our Listings</div>
          <div style="font-size:22px;font-weight:800;">${totalOurs}</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:var(--muted);font-weight:600;">Trim Matchups</div>
          <div style="font-size:22px;font-weight:800;">${sortedKeys.length}</div>
        </div>
        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#16a34a;font-weight:600;">We Beat Ancira</div>
          <div style="font-size:22px;font-weight:800;color:#16a34a;">${totalWeBeat}</div>
        </div>
        <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px;text-align:center;">
          <div style="font-size:10px;color:#dc2626;font-weight:600;">Ancira Beats Us</div>
          <div style="font-size:22px;font-weight:800;color:#dc2626;">${totalTheyBeat}</div>
        </div>
      </div>

      <!-- Make filter tabs -->
      <div style="display:flex;gap:6px;margin-bottom:${modelsForMake.length > 0 ? '8' : '14'}px;flex-wrap:wrap;">
        <button onclick="setCompFilter('all')" style="${tabStyle('all', _compFilter === 'all')}">All Makes</button>
        ${allMakes.map(m => `<button onclick="setCompFilter('${m}')" style="${tabStyle(m, _compFilter === m)}">${m}</button>`).join('')}
      </div>

      <!-- Model sub-filter tabs (only shown when a make is selected) -->
      ${modelsForMake.length > 0 ? `
      <div style="display:flex;gap:5px;margin-bottom:14px;flex-wrap:wrap;padding-left:4px;">
        <span style="font-size:11px;color:var(--muted);align-self:center;margin-right:4px;">Model:</span>
        <button onclick="setCompModelFilter('all')" style="${modelTabStyle('all', _compModelFilter === 'all')}">All ${_compFilter}</button>
        ${modelsForMake.map(m => `<button onclick="setCompModelFilter('${m}')" style="${modelTabStyle(m, _compModelFilter === m)}">${m}</button>`).join('')}
      </div>` : ''}

      <!-- Trim-level Accordions -->
      ${accHTML}

      <div style="margin-top:14px;padding:14px;background:var(--card);border:1px solid var(--line);border-radius:10px;font-size:11px;color:var(--muted);line-height:1.7;">
        <strong>ğŸ“¡ Live data from CarGurus</strong> â€” Both dealerships' pricing scraped automatically.<br>
        â€¢ Each dropdown = one <strong>trim level</strong>. Rows are sorted by price <strong>lowest â†’ highest</strong> across both stores.<br>
        â€¢ <span style="background:#2563eb;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">SA CDJR</span> = Us Â· <span style="background:#dc2626;color:#fff;padding:1px 6px;border-radius:3px;font-size:10px;">Ancira</span> = Competitor Â· The lowest-priced row is highlighted.<br>
        â€¢ <u style="color:#dc2626;">Underlined prices</u> are clickable â€” searches the VIN on Google to find the vehicle across dealer sites &amp; marketplaces<br>
        â€¢ <strong>% MSRP</strong> = Sale Price Ã· MSRP. Lower is better: <span style="color:#16a34a;font-weight:700;">â‰¤80%</span> great Â· <span style="color:#059669;font-weight:700;">â‰¤87%</span> good Â· <span style="color:#ca8a04;font-weight:700;">â‰¤92%</span> fair Â· <span style="color:#dc2626;font-weight:700;">&gt;92%</span> low discount<br>
        â€¢ Click <strong>MSRP</strong>, <strong>Sale Price</strong>, <strong>Discount</strong>, or <strong>% MSRP</strong> column headers to sort â–²â–¼<br>
        â€¢ Data source: <a href="https://www.cargurus.com/Cars/m-Ancira-Chrysler-Dodge-Jeep-RAM-sp243011" target="_blank" style="color:var(--accent);">Ancira on CarGurus</a> Â· <a href="https://www.cargurus.com/Cars/m-San-Antonio-Dodge-Chrysler-Jeep-Ram-sp302392" target="_blank" style="color:var(--accent);">SA CDJR on CarGurus</a><br>
        â€¢ Filtered to: New CDJR vehicles only (2025+ model year, under 1,000 miles)<br>
        â€¢ To auto-refresh: Set a daily trigger on <code>refreshCompetitorPricing_()</code> in Apps Script
      </div>
    </div>`;
}

window.showCompetitiveAnalysis = showCompetitiveAnalysis;
window.setCompFilter = setCompFilter;
window.setCompModelFilter = setCompModelFilter;
window.toggleCompGroup = toggleCompGroup;
window.compSort = compSort;
window.compExpandAll = compExpandAll;
window.compCollapseAll = compCollapseAll;
window.toggleAllNewsGroups = toggleAllNewsGroups;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUSTOM USER LINKS (Resources)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window._customLinks = [];

async function loadCustomLinks() {
  if (!window.userData?.uid) return;
  try {
    const snap = await getDoc(doc(db, 'users', window.userData.uid));
    window._customLinks = snap.exists() ? (snap.data().customLinks || []) : [];
  } catch { window._customLinks = []; }
  renderCustomLinks();
}

function renderCustomLinks() {
  const container = document.getElementById('customLinksSection');
  if (!container) return;
  if (!window._customLinks.length) { container.innerHTML = ''; return; }

  let html = '<div style="border-top:1px solid var(--line);margin:4px 0;"></div>';
  html += '<div style="padding:2px 14px 0;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;">My Links</div>';
  window._customLinks.forEach((lnk, i) => {
    const safeLabel = (lnk.label || 'Link').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const safeUrl = (lnk.url || '#').replace(/"/g, '&quot;');
    html += `<div class="custom-link-wrap">
      <a href="${safeUrl}" target="_blank" class="res-link" style="flex:1;">ğŸ”– ${safeLabel}</a>
      <button class="custom-link-del" onclick="event.stopPropagation();removeCustomLink(${i});" title="Remove">âœ•</button>
    </div>`;
  });
  container.innerHTML = html;
}

function showAddLinkForm() {
  document.getElementById('addLinkBtn').style.display = 'none';
  document.getElementById('addLinkFields').style.display = 'block';
  document.getElementById('newLinkLabel').focus();
}
function hideAddLinkForm() {
  document.getElementById('addLinkBtn').style.display = 'block';
  document.getElementById('addLinkFields').style.display = 'none';
  document.getElementById('newLinkLabel').value = '';
  document.getElementById('newLinkUrl').value = '';
}

async function saveCustomLink() {
  const label = (document.getElementById('newLinkLabel').value || '').trim();
  let url = (document.getElementById('newLinkUrl').value || '').trim();
  if (!label || !url) { alert('Please enter both a label and URL.'); return; }
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

  window._customLinks.push({ label, url });
  try {
    await setDoc(doc(db, 'users', window.userData.uid), { customLinks: window._customLinks }, { merge: true });
  } catch (err) {
    console.error('Save custom link error:', err);
    window._customLinks.pop();
    alert('Failed to save link.');
    return;
  }
  hideAddLinkForm();
  renderCustomLinks();
}

async function removeCustomLink(idx) {
  if (idx < 0 || idx >= window._customLinks.length) return;
  const removed = window._customLinks.splice(idx, 1);
  try {
    await setDoc(doc(db, 'users', window.userData.uid), { customLinks: window._customLinks }, { merge: true });
  } catch (err) {
    console.error('Remove custom link error:', err);
    window._customLinks.splice(idx, 0, ...removed);
    alert('Failed to remove link.');
    return;
  }
  renderCustomLinks();
}

function toggleResourcesMenu() {
  const menu = document.getElementById('resourcesMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  const rMenu = document.getElementById('reportsMenu');
  if (rMenu) rMenu.style.display = 'none';
}
function closeResourcesMenu() {
  document.getElementById('resourcesMenu').style.display = 'none';
}
function toggleReportsMenu() {
  const menu = document.getElementById('reportsMenu');
  if (menu) menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  document.getElementById('resourcesMenu').style.display = 'none';
}
function closeReportsMenu() {
  const menu = document.getElementById('reportsMenu');
  if (menu) menu.style.display = 'none';
}
// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('resourcesWrap');
  if (wrap && !wrap.contains(e.target)) closeResourcesMenu();
  const rWrap = document.getElementById('reportsWrap');
  if (rWrap && !rWrap.contains(e.target)) closeReportsMenu();
});
window.toggleResourcesMenu = toggleResourcesMenu;
window.closeResourcesMenu = closeResourcesMenu;
window.toggleReportsMenu = toggleReportsMenu;
window.closeReportsMenu = closeReportsMenu;
window.showAddLinkForm = showAddLinkForm;
window.hideAddLinkForm = hideAddLinkForm;
window.saveCustomLink = saveCustomLink;
window.removeCustomLink = removeCustomLink;
window.addUser = addUser;
window.deleteUser = deleteUser;
window.toggleSort = toggleSort;

/* Boot */
if (auth.currentUser) { showDashboard(); } else { showLogin(); }
</script>
</body>
</html>
