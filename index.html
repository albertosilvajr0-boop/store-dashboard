<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Store Performance Dashboard</title>
  <link rel="icon" href="data:;base64,=">
  <style>
    :root{
      --ink:#111827; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb;
      --brand1:#6a11cb; --brand2:#2575fc; --btn:#2563eb; --btnH:#1d4ed8;
      --danger:#ef4444; --dangerH:#dc2626; --ok:#10b981; --okH:#059669;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:var(--ink);}
    .container{max-width:1100px;margin:28px auto 80px;padding:0 20px;}
    .topbar{
      background:linear-gradient(135deg,var(--brand1),var(--brand2));
      border-radius:18px; padding:18px 20px; color:#fff; display:flex; align-items:center; gap:14px; justify-content:space-between;
      box-shadow:0 10px 24px rgba(0,0,0,.10);
    }
    .title{font-size:28px; font-weight:900; margin:0;}
    .btn{background:var(--btn); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700;}
    .btn:hover{background:var(--btnH);}
    .logout-btn{background:var(--danger);} .logout-btn:hover{background:var(--dangerH);}
    .admin-btn{background:var(--ok);} .admin-btn:hover{background:var(--okH);}
    .switcher{display:flex;gap:8px;margin:14px 0 10px;}
    .seg{border:1px solid rgba(0,0,0,.08); color:#111; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:800; background:#fff;}
    .seg.active{background:#111827; color:#fff; border-color:#111827;}
    .hint{color:#6b7280; font-size:12px; margin-left:8px; display:flex; align-items:center;}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:16px;border:1px solid var(--line);}
    .titleRow{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .titleRow h2{margin:0;font-size:18px;display:flex;align-items:center;gap:10px;}
    .muted{color:var(--muted);font-size:13px;}
    .list{display:flex;flex-direction:column;gap:4px;}
    .row{display:flex;align-items:center;justify-content:space-between;padding:12px 10px;border-radius:10px;cursor:pointer;transition:transform .06s ease, background .2s;}
    .row:hover{background:#f8fafc; transform:translateY(-1px);}
    .left{display:flex;align-items:center;gap:10px;}
    .rank{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;font-weight:800;color:#fff;background:#9ca3af;}
    .gold{background:linear-gradient(135deg,#f59e0b,#fbbf24);} .silver{background:linear-gradient(135deg,#9ca3af,#e5e7eb);color:#111827;} .bronze{background:linear-gradient(135deg,#b45309,#f59e0b);}
    .name{color:#111827;font-weight:900; letter-spacing:.4px;}
    .right{text-align:right;}
    .chips{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
    .pill{font-size:12px;font-weight:800;padding:3px 8px;border-radius:999px;background:#eef6ff;color:#0b5cab;border:1px solid #dbeafe;}
    .pill.sales{background:#fef3c7;color:#92400e;border-color:#fde68a;}
    .pill.calls{background:#e0f2fe;color:#075985;border-color:#bae6fd;}
    .pill.texts{background:#ecfdf5;color:#065f46;border-color:#bbf7d0;}
    .pill.appt{background:#f1f5f9;color:#334155;border-color:#e2e8f0;}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px;z-index:999;}
    .modal{background:#fff;border-radius:14px;max-width:760px;width:100%;padding:16px;border:1px solid var(--line);box-shadow:0 20px 40px rgba(0,0,0,.2);}
    .modal h3{margin:0 0 8px;}
    .closeX{background:transparent;border:none;font-size:22px;cursor:pointer;}

    a.inline{color:#2563eb;text-decoration:none;} a.inline:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div class="container" id="root">
    <div class="topbar">
      <h1 class="title">Store Performance Dashboard</h1>
      <div style="display:flex; gap:10px; align-items:center;">
        <span id="whoami" class="muted">Welcome, <strong id="whoamiEmail"></strong></span>
        <button id="adminBtn" class="admin-btn" style="display:none;">User Management</button>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="switcher">
      <button class="seg active" id="segSales">Sales</button>
      <button class="seg" id="segBDC">BDC</button>
      <span class="hint">Tip: Click a name to open their 1:1</span>
    </div>

    <div id="content" class="card"></div>
  </div>

  <!-- User Management Modal -->
  <div class="modal-backdrop" id="umBackdrop" aria-hidden="true">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3>User Management</h3>
        <button class="closeX" onclick="closeUserModal()">×</button>
      </div>
      <div id="umBody" class="muted">Loading users…</div>
      <div style="text-align:right;margin-top:12px;">
        <button class="btn" onclick="closeUserModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- 🔧 Backend URL & safe defaults -->
  <script>
    window.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRf4KkWsC8EBN6G6ybStLKBNqmnu-Rjow4aZ_NWpSaRY7Q8JlxFaTsTsAW2Ny76dCS/exec";
    window.sessionToken = window.sessionToken || (localStorage.getItem('sessionToken') || "");
    try{ window.userData = window.userData || JSON.parse(localStorage.getItem('userData')||"{}"); }catch{ window.userData = window.userData || {}; }
  </script>

  <script type="module">
    const SCRIPT_URL = window.SCRIPT_URL || '';
    const state = { mode: 'sales', raw: null };

    // ====== Auth / Role helpers ======
    function isAdmin(){ return (window.userData?.role==='admin'||window.userData?.role==='superadmin'); }
    function isManager(){ return (window.userData?.role==='manager'); }
    function canViewName(targetName){
      const mine=(window.userData?.linkedName||'').toUpperCase();
      if(isAdmin()||isManager())return true;
      return mine && (String(targetName||'').toUpperCase()===mine);
    }

    // ====== UI boot ======
    const segSales = document.getElementById('segSales');
    const segBDC   = document.getElementById('segBDC');
    segSales.addEventListener('click', ()=>setMode('sales'));
    segBDC.addEventListener('click', ()=>setMode('bdc'));
    const whoamiEmailEl = document.getElementById('whoamiEmail');
    whoamiEmailEl.textContent = window.userData?.email || '';
    if (isAdmin()) document.getElementById('adminBtn').style.display = 'inline-block';
    document.getElementById('adminBtn').addEventListener('click', showUserModal);

    // ====== Data fetchers ======
    async function fetchLeaderboards(){
      if(!SCRIPT_URL) throw new Error('SCRIPT_URL is not defined on window.');
      const url = `${SCRIPT_URL}?route=leaderboards&session=${encodeURIComponent(window.sessionToken||'')}`;
      const resp = await fetch(url, { cache: 'no-store' });
      const text = await resp.text();
      let data; try{ data=JSON.parse(text);}catch(e){ throw new Error(`Non-JSON from GAS\nHTTP ${resp.status}\n\n${text}`); }
      if(!data?.ok) throw new Error(data?.error||'Backend returned ok:false');
      return data;
    }

    async function fetchUsers(){
      const url = `${SCRIPT_URL}?route=users&session=${encodeURIComponent(window.sessionToken||'')}`;
      const resp = await fetch(url, { cache:'no-store' });
      return resp.json();
    }

    async function fetchPerson(name){
      const url = `${SCRIPT_URL}?route=person&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken||'')}`;
      const resp = await fetch(url, { cache:'no-store' });
      return resp.json();
    }

    async function fetchCallsFor(name){
      const url = `${SCRIPT_URL}?route=calls_for&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken||'')}`;
      const resp = await fetch(url, { cache:'no-store' });
      return resp.json();
    }

    // ====== Sorting & row builder ======
    const shownVal = x => x.shown ?? x.shows ?? x.shows_count ?? 0;
    function sortSales(arr){return [...(arr||[])].sort((a,b)=>(b.sales??0)-(a.sales??0)||String(a.name||'').localeCompare(String(b.name||'')));}
    function sortBDC(arr){return [...(arr||[])].sort((a,b)=>shownVal(b)-shownVal(a)||String(a.name||'').localeCompare(String(b.name||'')));}

    const chip = (label, value, cls='') => `<span class="pill ${cls}">${label}: <strong>${value}</strong></span>`;

    function rowHTML(person, i, mode){
      const name = person.name || '';
      const rk = i===0?'gold':i===1?'silver':i===2?'bronze':'';
      const allowed = canViewName(name);
      const clickAttr = allowed ? `onclick="showPersonDetails('${name.replace(/'/g,"\\'")}', '${mode.toUpperCase()}')"` : '';
      const style = allowed ? '' : 'opacity:.6; cursor:not-allowed;';
      if(mode==='sales'){
        const sales = person.sales ?? 0, calls = person.calls ?? 0, texts = person.texts ?? 0, created = person.created ?? 0, shown = person.shown ?? person.shown_count ?? 0;
        return `<div class="row" ${clickAttr} style="${style}">
          <div class="left"><div class="rank ${rk}">${i+1}</div><div class="name">${name}</div></div>
          <div class="right">
            <div class="chips">
              ${chip('Sales', sales,'sales')}
              ${chip('Calls', calls,'calls')}
              ${chip('Texts', texts,'texts')}
              ${chip('Appts Made', created,'appt')}
              ${chip('Appts Shown', shown,'appt')}
            </div>
          </div>
        </div>`;
      } else {
        const calls = person.calls ?? 0, texts = person.texts ?? 0, created = person.created ?? 0, shown = shownVal(person);
        return `<div class="row" ${clickAttr} style="${style}">
          <div class="left"><div class="rank ${rk}">${i+1}</div><div class="name">${name}</div></div>
          <div class="right">
            <div class="chips">
              ${chip('Appts Shown', shown,'appt')}
              ${chip('Appts Made', created,'appt')}
              ${chip('Calls', calls,'calls')}
              ${chip('Texts', texts,'texts')}
            </div>
          </div>
        </div>`;
      }
    }

    // ====== Renderers ======
    function render(data){
      if(!state.raw) state.raw = data;
      const salesLB = sortSales(data.sales || []);
      const bdcLB   = sortBDC(data.bdc   || []);
      const active  = state.mode==='sales' ? salesLB : bdcLB;

      // segment UI state
      document.getElementById('segSales').classList.toggle('active', state.mode==='sales');
      document.getElementById('segBDC').classList.toggle('active', state.mode==='bdc');

      document.getElementById('content').innerHTML = `
        <div class="titleRow">
          <h2>${state.mode==='sales' ? '🏆 Sales Leaderboard' : '📞 BDC Leaderboard'}</h2>
          <div class="muted">${state.mode==='sales'?'Sorted by Sales (MTD)':'Sorted by Appts Shown (MTD)'}</div>
        </div>
        <div class="list">
          ${active.length ? active.map((p,i)=>rowHTML(p,i,state.mode)).join('') : `<p class="muted" style="text-align:center;">No ${state.mode.toUpperCase()} data</p>`}
        </div>`;
    }

    function setMode(mode){ state.mode=mode; render(state.raw); }

    // ====== 1:1 and Call Sheets ======
    async function showPersonDetails(name, type){
      const el = document.getElementById('content');
      el.innerHTML = `<div class="card" style="padding:24px; text-align:center;">Loading ${name}…</div>`;
      try{
        const result = await fetchPerson(name);
        if(!result?.ok) throw new Error(result?.error||'Failed to load person details');
        const payload = result.data || {};
        const b = payload.block || {};
        const day = payload.lastDay || {};
        const isSales = (b.type || type) === 'Sales';
        const html = `
          <button class="btn" style="background:#6B7280;margin-bottom:16px;" onclick="window.showDashboard()">← Back to Leaderboard</button>
          <div class="card" style="padding:24px;">
            <h2 style="margin:0 0 6px;">${b.name || name}</h2>
            <div class="muted" style="margin-bottom:14px;">${b.type || type || '-'} • ${b.workingDays || 0} working days (MTD)</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;">
              <div><div class="muted">Total Calls (MTD)</div><div style="font-weight:700">${b.callsMTD || 0}</div></div>
              ${isSales ? `
                <div><div class="muted">Sales (MTD)</div><div style="font-weight:700">${b.salesMTD || 0}</div></div>
                <div><div class="muted">Texts (MTD)</div><div style="font-weight:700">${b.textsMTD || 0}</div></div>
                <div><div class="muted">Appts Created (MTD)</div><div style="font-weight:700">${b.createdMTD || 0}</div></div>
                <div><div class="muted">Appts Shown (MTD)</div><div style="font-weight:700">${b.shownMTD || 0}</div></div>
              ` : `
                <div><div class="muted">Appts Shown (MTD)</div><div style="font-weight:700">${b.shownMTD || 0}</div></div>
                <div><div class="muted">Appts Created (MTD)</div><div style="font-weight:700">${b.createdMTD || 0}</div></div>
                <div><div class="muted">Texts (MTD)</div><div style="font-weight:700">${b.textsMTD || 0}</div></div>
              `}
              <div><div class="muted">Leads In Name (MTD)</div><div style="font-weight:700">${b.leadsInNameMTD || 0}</div></div>
              <div><div class="muted">Avg Talk</div><div style="font-weight:700">${b.avgTalk || '0:00'}</div></div>
            </div>
            <div style="margin-top:18px;background:#f8fafc;border-radius:10px;padding:14px;">
              <div style="font-weight:600;margin-bottom:6px;">Last Work Day</div>
              <div style="display:flex;gap:18px;flex-wrap:wrap;">
                <div><span class="muted">Date:</span> ${day.dateKey || '-'}</div>
                <div><span class="muted">Calls:</span> ${day.calls || 0}</div>
                <div><span class="muted">Avg Talk:</span> ${day.avgTalkMSS || '0:00'}</div>
                ${isSales ? `<div><span class="muted">Sales:</span> ${day.sales ?? 0}</div>` : ''}
              </div>
            </div>
            <div style="display:flex; gap:12px; margin-top:20px;">
              <button class="btn" onclick="viewCallSheets('${(b.name || name).replace(/'/g, "\\'")}')">📊 View Call Sheets</button>
            </div>
          </div>`;
        el.innerHTML = html;
      }catch(e){
        el.innerHTML = `<div class="card" style="padding:40px;color:#dc2626;text-align:center;"><h2>Error Loading Details</h2><p>${e?.message||e}</p><button class="btn" onclick="window.showDashboard()" style="margin-top:12px;background:#6B7280;">← Back to Leaderboard</button></div>`;
      }
    }
    async function viewCallSheets(name){
      const el = document.getElementById('content');
      el.innerHTML = `<div class="card" style="padding:24px; text-align:center;">Loading call sheets for ${name}…</div>`;
      try{
        const result = await fetchCallsFor(name);
        if(!result?.ok) throw new Error(result?.error||'Failed to load call sheets');
        const rows = result.data?.calls || [];
        const tzDateOnly = v => { if(!v) return '-'; try{ const d=(v instanceof Date)?v:new Date(v); return isNaN(d)?String(v):(d.toLocaleDateString()); }catch{ return String(v); }};
        const trs = rows.map(r=>`
          <tr style="border-top:1px solid #e5e7eb;">
            <td style="padding:10px;">${r.link ? `<a class="inline" href="${r.link}" target="_blank" rel="noopener">${r.name||'-'}</a>` : (r.name||'-')}</td>
            <td style="padding:10px;">${r.phone||'-'}</td>
            <td style="padding:10px;">${r.email||'-'}</td>
            <td style="padding:10px;">${r.salesPerson||'-'}</td>
            <td style="padding:10px;">${r.bdcAgent||'-'}</td>
            <td style="padding:10px;">${r.source||'-'}</td>
            <td style="padding:10px;">${tzDateOnly(r.dateIn||r.date)}</td>
            <td style="padding:10px;">${r.leadAge??'-'}</td>
            <td style="padding:10px;">${r.daysSince??'-'}</td>
            <td style="padding:10px;">${r.bucket||'-'}</td>
            <td style="padding:10px;">${r.status||'-'}</td>
            <td style="padding:10px;">${r.reason||'-'}</td>
          </tr>`).join('');
        el.innerHTML = `
          <div class="card" style="padding:24px;">
            <button class="btn" onclick="window.showPersonDetails('${name.replace(/'/g,"\\'")}')" style="background:#6B7280;margin-bottom:12px;">← Back to ${name}</button>
            <h2 style="margin:0 0 10px;">Call Sheets - ${name}</h2>
            <div style="overflow:auto;">
              <table style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#f3f4f6;">
                    <th style="text-align:left; padding:10px;">Customer</th>
                    <th style="text-align:left; padding:10px;">Phone</th>
                    <th style="text-align:left; padding:10px;">Email</th>
                    <th style="text-align:left; padding:10px;">Sales Person</th>
                    <th style="text-align:left; padding:10px;">BDC Agent</th>
                    <th style="text-align:left; padding:10px;">Source</th>
                    <th style="text-align:left; padding:10px;">Date In</th>
                    <th style="text-align:left; padding:10px;">Lead Age</th>
                    <th style="text-align:left; padding:10px;">Days Since</th>
                    <th style="text-align:left; padding:10px;">Priority Bucket</th>
                    <th style="text-align:left; padding:10px;">Status</th>
                    <th style="text-align:left; padding:10px;">Priority Reason</th>
                  </tr>
                </thead>
                <tbody>${rows.length ? trs : `<tr><td colspan="12" style="padding:20px;text-align:center;color:#6b7280;">No call data</td></tr>`}</tbody>
              </table>
            </div>
          </div>`;
      }catch(e){
        el.innerHTML = `<div class="card" style="padding:40px;color:#dc2626;text-align:center;"><h2>Error Loading Call Sheets</h2><p>${e?.message||e}</p></div>`;
      }
    }

    // ====== User Management modal ======
    async function showUserModal(){
      const bd = document.getElementById('umBackdrop');
      const body = document.getElementById('umBody');
      bd.style.display='flex';
      body.textContent='Loading users…';
      try{
        const res = await fetchUsers();
        if(!res?.ok) throw new Error(res?.error||'Failed to load users');
        const list = res.data?.users || [];
        body.innerHTML = `
          <div class="muted" style="margin-bottom:6px;">Total: ${list.length}</div>
          <div style="max-height:380px; overflow:auto; border:1px solid #eef2f7; border-radius:10px;">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr style="background:#f8fafc;">
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;">Email</th>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;">Linked Name</th>
                  <th style="text-align:left; padding:10px; border-bottom:1px solid #eee;">Role</th>
                </tr>
              </thead>
              <tbody>
                ${list.map(u=>`
                  <tr>
                    <td style="padding:10px;border-top:1px solid #f1f5f9;">${u.email||'-'}</td>
                    <td style="padding:10px;border-top:1px solid #f1f5f9;">${u.linkedName||'-'}</td>
                    <td style="padding:10px;border-top:1px solid #f1f5f9;">${u.role||'-'}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
          </div>`;
      }catch(e){
        body.innerHTML = `<div style="color:#dc2626;">${e?.message||e}</div>`;
      }
    }
    function closeUserModal(){ document.getElementById('umBackdrop').style.display='none'; }

    // ====== Public exports for onclicks ======
    window.setMode = setMode;
    window.showDashboard = showDashboard;
    window.showPersonDetails = showPersonDetails;
    window.viewCallSheets = viewCallSheets;
    window.showUserModal = showUserModal;
    window.closeUserModal = closeUserModal;

    // ====== Boot ======
    async function showDashboard(){
      try{
        const data = await fetchLeaderboards();
        render(data);
      }catch(err){
        document.getElementById('content').innerHTML = `
          <div class="card" style="padding:50px;text-align:center;color:#dc2626;">
            <h2>Error Loading Dashboard</h2>
            <p style="white-space:pre-wrap;">${err?.message||err}</p>
            <button class="btn" onclick="window.showDashboard()" style="max-width:200px;margin:20px auto;">Retry</button>
          </div>`;
      }
    }
    showDashboard();
  </script>

  <script>
    // Logout that works with both memory & localStorage
    function logout(){
      try{ localStorage.removeItem('sessionToken'); localStorage.removeItem('userData'); }catch(e){}
      window.sessionToken=''; window.userData={};
      location.reload();
    }
  </script>
</body>
</html>
