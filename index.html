<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Store Performance Dashboard</title>
  <link rel="icon" href="data:;base64,=">
  <style>
    :root {
      --bg1:#6a11cb; --bg2:#2575fc;
      --card:#ffffff; --text:#1f2937; --muted:#6b7280;
    }
    html, body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); }
    .container { max-width:1100px; margin:40px auto; padding:0 20px; }
    .header { color:#fff; text-align:center; margin:20px 0 10px; }
    .header h1 { margin:0; font-size:36px; }
    .user-info { display:flex; align-items:center; justify-content:space-between; background:rgba(0,0,0,.65); color:#fff; border-radius:12px; padding:10px 16px; }
    .btn { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn:hover { background:#1d4ed8; }
    .logout-btn { background:#ef4444; }
    .logout-btn:hover { background:#dc2626; }
    .admin-btn { background:#10b981; }
    .admin-btn:hover { background:#059669; }

    /* NEW: switcher + chips */
    .switcher { display:flex; align-items:center; gap:8px; margin:16px 0 10px; }
    .seg { border:1px solid rgba(255,255,255,.25); color:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:800; background:rgba(0,0,0,.25); }
    .seg.active { background:#fff; color:#111827; border-color:#fff; }
    .hint { color:#e5e7eb; font-size:12px; }

    .leaderboard-card { background:var(--card); border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.12); padding:16px; }
    .leaderboard-card h2 { margin:4px 0 12px; color:var(--text); display:flex; align-items:center; gap:8px; }
    .leaderboard-list { display:flex; flex-direction:column; gap:2px; }
    .leaderboard-item { display:flex; align-items:center; justify-content:space-between; padding:12px 10px; border-radius:10px; cursor:pointer; transition:transform .05s ease, background .2s; }
    .leaderboard-item:hover { background:#f3f4f6; transform:translateY(-1px); }
    .rank { width:28px; height:28px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#fff; background:#9ca3af; margin-right:10px; }
    .gold { background:linear-gradient(135deg,#f59e0b,#fbbf24); }
    .silver { background:linear-gradient(135deg,#9ca3af,#e5e7eb); color:#111827; }
    .bronze { background:linear-gradient(135deg,#b45309,#f59e0b); }
    .name { color:#111827; font-weight:700; letter-spacing:.3px; }
    .muted { color:#6b7280; font-size:14px; }

    /* NEW: stat chips */
    .chips { display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .pill { font-size:12px; font-weight:800; padding:3px 8px; border-radius:999px; background:#eef6ff; color:#0b5cab; border:1px solid #dbeafe; }
    .pill.sales { background:#fef3c7; color:#92400e; border-color:#fde68a; }
    .pill.calls { background:#e0f2fe; color:#075985; border-color:#bae6fd; }
    .pill.texts { background:#ecfdf5; color:#065f46; border-color:#bbf7d0; }
    .pill.appt { background:#f1f5f9; color:#334155; border-color:#e2e8f0; }

    #app { margin:0 auto; }
  </style>
</head>
<body>
  <div id="app" class="container"></div>

  <!-- ADD THIS: your Apps Script URL -->
  <script>
    window.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRf4KkWsC8EBN6G6ybStLKBNqmnu-Rjow4aZ_NWpSaRY7Q8JlxFaTsTsAW2Ny76dCS/exec";
  </script>

  <script type="module">
    // ─────────────────────────────────────────────────────────────
    // Minimal helpers – keep your existing ones if you have them
    // ─────────────────────────────────────────────────────────────
    const SCRIPT_URL = window.SCRIPT_URL || ''; // your Apps Script web app URL should already be on window.SCRIPT_URL
    function isAdmin()   { return (window.userData?.role === 'admin' || window.userData?.role === 'superadmin'); }
    function isManager() { return (window.userData?.role === 'manager'); }
    function canViewName(targetName){ const mine=(window.userData?.linkedName||'').toUpperCase(); if(isAdmin()||isManager())return true; return mine && (String(targetName||'').toUpperCase()===mine); }

    // NEW: local UI state for toggle (default to 'sales')
    const state = { mode: 'sales', raw: null };

    // ─────────────────────────────────────────────────────────────
    // Core: Dashboard fetch + render
    // ─────────────────────────────────────────────────────────────
    async function showDashboard() {
      try { if (typeof showLoading === 'function') showLoading(true); } catch(_) {}

      try {
        if (!SCRIPT_URL) throw new Error('SCRIPT_URL is not defined on window.');
        const url  = `${SCRIPT_URL}?route=leaderboards&session=${encodeURIComponent(window.sessionToken || '')}`;
        const resp = await fetch(url, { cache: 'no-store' });
        const raw  = await resp.text();

        let result;
        try { result = JSON.parse(raw); }
        catch (e) { throw new Error(`Non-JSON response from GAS.\nHTTP ${resp.status}\n\n${raw}`); }

        if (!result?.ok) throw new Error(result?.error || 'Backend returned ok:false');

        state.raw = result; // save once
        renderDashboard(result);

        try { prefetchForDashboard(result); } catch(_) {}
      } catch (err) {
        console.error('Dashboard error:', err);
        document.getElementById('app').innerHTML = `
          <div class="container">
            <div style="padding:50px;text-align:center;color:red;background:#fff;border-radius:16px;">
              <h2>Error Loading Dashboard</h2>
              <p style="white-space:pre-wrap;">${err?.message || err}</p>
              <button class="btn" onclick="window.showDashboard()" style="max-width:200px;margin:20px auto;">Retry</button>
            </div>
          </div>
        `;
      } finally {
        try { if (typeof showLoading === 'function') showLoading(false); } catch(_) {}
      }
    }

    // Helpers for sorting
    const shownVal = x => x.shown_count ?? x.shown ?? x.shows ?? x.shows_count ?? 0;
    const sortSales = arr => [...(arr||[])].sort((a,b)=>(b.sales??0)-(a.sales??0) || String(a.name||'').localeCompare(String(b.name||'')));
    const sortBDC   = arr => [...(arr||[])].sort((a,b)=> shownVal(b) - shownVal(a) || String(a.name||'').localeCompare(String(b.name||'')));

    // Small chip helper
    const chip = (label, value, cls='') => `<span class="pill ${cls}">${label}: <strong>${value}</strong></span>`;

    // Row builder for each mode
    function rowHTML(person, idx, mode){
      const name = person.name || '';
      const rankClass = idx===0?'gold':idx===1?'silver':idx===2?'bronze':'';
      const allowed = canViewName(name);
      const clickAttr = allowed ? `onclick="showPersonDetails('${name.replace(/'/g,"\\'")}', '${mode.toUpperCase()}')"` : '';
      const style = allowed ? '' : 'opacity:.6; cursor:not-allowed;';

      if(mode==='sales'){
        const sales  = person.sales ?? 0;
        const calls  = person.calls ?? 0;
        const texts  = person.texts ?? 0;
        const made   = person.created ?? 0;
        const shown  = shownVal(person);
        return `
          <div class="leaderboard-item" ${clickAttr} style="${style}">
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="rank ${rankClass}">${idx + 1}</div>
              <div class="name">${name}</div>
            </div>
            <div class="chips">
              ${chip('Sales', sales, 'sales')}
              ${chip('Calls', calls, 'calls')}
              ${chip('Texts', texts, 'texts')}
              ${chip('Appts Made', made, 'appt')}
              ${chip('Appts Shown', shown, 'appt')}
            </div>
          </div>`;
      } else {
        const calls  = person.calls ?? 0;
        const texts  = person.texts ?? 0;
        const made   = person.created ?? 0;
        const shown  = shownVal(person);
        return `
          <div class="leaderboard-item" ${clickAttr} style="${style}">
            <div style="display:flex; align-items:center; gap:10px;">
              <div class="rank ${rankClass}">${idx + 1}</div>
              <div class="name">${name}</div>
            </div>
            <div class="chips">
              ${chip('Appts Shown', shown, 'appt')}
              ${chip('Appts Made', made, 'appt')}
              ${chip('Calls', calls, 'calls')}
              ${chip('Texts', texts, 'texts')}
            </div>
          </div>`;
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Render: SINGLE leaderboard with toggle
    // ─────────────────────────────────────────────────────────────
    function renderDashboard(data) {
      const me = window.userData || {};
      const salesLB = sortSales(data.sales || []);
      const bdcLB   = sortBDC(data.bdc   || []);

      const activeMode = state.mode; // 'sales' | 'bdc'
      const activeList = activeMode==='sales' ? salesLB : bdcLB;

      document.getElementById('app').innerHTML = `
        <div class="header"><h1>Store Performance Dashboard</h1></div>

        <div class="user-info">
          <div>
            Welcome, <strong>${me.email || ''}</strong>
            ${isAdmin() ? '<span style="color:#a7f3d0;"> (Admin)</span>' :
              (isManager() ? '<span style="color:#93c5fd;"> (Manager)</span>' : '')}
            ${me.linkedName ? ` • Linked: <strong>${me.linkedName}</strong>` : ''}
          </div>
          <div>
            ${isAdmin() ? '<button class="admin-btn" onclick="showUserModal()">User Management</button>' : ''}
            <a href="/leaderboard" class="btn" style="margin-left:10px;">Open Full Leaderboard</a>
            <button class="logout-btn" onclick="logout()" style="margin-left:10px;">Logout</button>
          </div>
        </div>

        <div class="switcher">
          <button class="seg ${activeMode==='sales'?'active':''}" onclick="window.setMode('sales')">Sales</button>
          <button class="seg ${activeMode==='bdc'  ?'active':''}" onclick="window.setMode('bdc')">BDC</button>
          <span class="hint">Tip: Click a name to open their 1:1</span>
        </div>

        <div class="leaderboard-card" id="content">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <h2>${activeMode==='sales'?'🏆 Sales Leaderboard':'📞 BDC Leaderboard'}</h2>
            <div class="muted">${activeMode==='sales'?'Sorted by Sales (MTD)':'Sorted by Appts Shown (MTD)'}</div>
          </div>
          <div class="leaderboard-list">
            ${activeList.length ? activeList.map((p,i)=>rowHTML(p,i,activeMode)).join('') :
              '<p style="text-align:center;color:#999;">No data</p>'}
          </div>
        </div>
      `;
    }

    // Allow toggle without re-fetch
    function setMode(mode){
      state.mode = mode;
      if(state.raw) renderDashboard(state.raw);
    }

    // ─────────────────────────────────────────────────────────────
    // Person 1:1 (unchanged from your version)
    // ─────────────────────────────────────────────────────────────
    async function showPersonDetails(name, type) {
      const contentEl = document.getElementById('content');
      if (contentEl) {
        contentEl.innerHTML = `
          <div class="leaderboard-card" style="padding:24px; text-align:center;">
            Loading ${name}…
          </div>`;
      }

      try {
        const result = await fetchPerson(name);
        if (!result?.ok) throw new Error(result?.error || 'Failed to load person details');

        const payload = result.data || {};
        const b   = payload.block || {};
        const day = payload.lastDay || {};
        const note = payload.prNotes || {};
        const isSales = (b.type || type) === 'Sales';

        const html = `
          <button onclick="window.showDashboard()" class="btn" style="background:#6B7280;margin-bottom:16px;">
            ← Back to Leaderboard
          </button>

          <div class="leaderboard-card" style="padding:24px;">
            <h2 style="margin-top:0;">${b.name || name}</h2>
            <div style="color:#6b7280;margin-bottom:12px;">
              ${b.type || type || '-'} • ${b.workingDays || 0} working days (MTD)
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:16px;">
              <div><div class="muted">Total Calls (MTD)</div><div style="font-weight:700">${b.callsMTD || 0}</div></div>

              ${isSales ? `
                <div><div class="muted">Sales (MTD)</div><div style="font-weight:700">${b.salesMTD || 0}</div></div>
                <div><div class="muted">Texts (MTD)</div><div style="font-weight:700">${b.textsMTD || 0}</div></div>
                <div><div class="muted">Appts Created (MTD)</div><div style="font-weight:700">${b.createdMTD || 0}</div></div>
                <div><div class="muted">Appts Shown (MTD)</div><div style="font-weight:700">${b.shownMTD || 0}</div></div>
              ` : `
                <div><div class="muted">Appts Shown (MTD)</div><div style="font-weight:700">${b.shownMTD || 0}</div></div>
                <div><div class="muted">Appts Created (MTD)</div><div style="font-weight:700">${b.createdMTD || 0}</div></div>
              `}

              <div><div class="muted">Leads In Name (MTD)</div><div style="font-weight:700">${b.leadsInNameMTD || 0}</div></div>
              <div><div class="muted">Avg Talk</div><div style="font-weight:700">${b.avgTalk || '0:00'}</div></div>
            </div>

            <div style="margin-top:18px; background:#f8fafc; border-radius:10px; padding:14px;">
              <div style="font-weight:600; margin-bottom:6px;">Last Work Day</div>
              <div style="display:flex; gap:18px; flex-wrap:wrap;">
                <div><span class="muted">Date:</span> ${day.dateKey || '-'}</div>
                <div><span class="muted">Calls:</span> ${day.calls || 0}</div>
                <div><span class="muted">Avg Talk:</span> ${day.avgTalkMSS || '0:00'}</div>
                ${isSales ? `<div><span class="muted">Sales:</span> ${day.sales ?? 0}</div>` : ''}
              </div>
            </div>

            ${note.wins ? `<div style="margin-top:12px; background:#d9ead3; border-radius:10px; padding:12px;">${note.wins}</div>` : ''}
            ${note.opportunities ? `<div style="margin-top:12px; background:#ffe599; border-radius:10px; padding:12px;">${note.opportunities}</div>` : ''}

            <div style="display:flex; gap:12px; margin-top:20px;">
              <button class="btn" onclick="viewCallSheets('${(b.name || name).replace(/'/g, "\\'")}')">📊 View Call Sheets</button>
            </div>
          </div>
        `;
        if (contentEl) contentEl.innerHTML = html;

      } catch (e) {
        if (contentEl) {
          contentEl.innerHTML = `
            <div style="background:#fff;border-radius:16px;padding:40px;color:#dc2626; text-align:center;">
              <h2>Error Loading Details</h2>
              <p>${e?.message || e}</p>
              <button class="btn" onclick="window.showDashboard()" style="margin-top:12px;background:#6B7280;">← Back to Leaderboard</button>
            </div>
          `;
        }
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Calls list (unchanged)
    // ─────────────────────────────────────────────────────────────
    async function viewCallSheets(name) {
      const contentEl = document.getElementById('content');
      if (contentEl) {
        contentEl.innerHTML = `
          <div class="leaderboard-card" style="padding:24px; text-align:center;">
            Loading call sheets for ${name}…
          </div>`;
      }
      try {
        const url = `${SCRIPT_URL}?route=calls_for&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken || '')}`;
        const resp = await fetch(url, { cache: 'no-store' });
        const result = await resp.json();
        if (!result?.ok) throw new Error(result?.error || 'Failed to load call sheets');
        const rows = result.data?.calls || [];

        const tzDateOnly = (v) => {
          if (!v) return '-';
          try { const d=(v instanceof Date)?v:new Date(v); return isNaN(d)?String(v):(d.toLocaleDateString()); }
          catch { return String(v); }
        };

        const trs = rows.map(r => {
          const customer = r.link ? `<a href="${r.link}" target="_blank" rel="noopener">${r.name || '-'}</a>` : (r.name || '-');
          return `
            <tr style="border-top:1px solid #e5e7eb;">
              <td style="padding:10px;">${customer}</td>
              <td style="padding:10px;">${r.phone || '-'}</td>
              <td style="padding:10px;">${r.email || '-'}</td>
              <td style="padding:10px;">${r.salesPerson || '-'}</td>
              <td style="padding:10px;">${r.bdcAgent || '-'}</td>
              <td style="padding:10px;">${r.source || '-'}</td>
              <td style="padding:10px;">${tzDateOnly(r.dateIn || r.date)}</td>
              <td style="padding:10px;">${r.leadAge ?? '-'}</td>
              <td style="padding:10px;">${r.daysSince ?? '-'}</td>
              <td style="padding:10px;">${r.bucket || '-'}</td>
              <td style="padding:10px;">${r.status || '-'}</td>
              <td style="padding:10px;">${r.reason || '-'}</td>
            </tr>`;
        }).join('');

        const html = `
          <div class="leaderboard-card" style="padding:24px;">
            <button onclick="window.showPersonDetails('${name.replace(/'/g, "\\'")}')" class="btn" style="background:#6B7280;margin-bottom:12px;">← Back to ${name}</button>
            <h2 style="margin-top:0;">Call Sheets - ${name}</h2>
            <div style="overflow:auto;">
              <table style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="background:#f3f4f6;">
                    <th style="text-align:left; padding:10px;">Customer</th>
                    <th style="text-align:left; padding:10px;">Phone</th>
                    <th style="text-align:left; padding:10px;">Email</th>
                    <th style="text-align:left; padding:10px;">Sales Person</th>
                    <th style="text-align:left; padding:10px;">BDC Agent</th>
                    <th style="text-align:left; padding:10px;">Source</th>
                    <th style="text-align:left; padding:10px;">Date In</th>
                    <th style="text-align:left; padding:10px;">Lead Age</th>
                    <th style="text-align:left; padding:10px;">Days Since</th>
                    <th style="text-align:left; padding:10px;">Priority Bucket</th>
                    <th style="text-align:left; padding:10px;">Status</th>
                    <th style="text-align:left; padding:10px;">Priority Reason</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows.length ? trs : `<tr><td colspan="12" style="padding:20px;text-align:center;color:#6b7280;">No call data</td></tr>`}
                </tbody>
              </table>
            </div>
          </div>`;
        if (contentEl) contentEl.innerHTML = html;
      } catch (e) {
        if (contentEl) {
          contentEl.innerHTML = `
            <div style="background:#fff;border-radius:16px;padding:40px;color:#dc2626; text-align:center;">
              <h2>Error Loading Call Sheets</h2>
              <p>${e?.message || e}</p>
            </div>`;
        }
      }
    }

    // ─────────────────────────────────────────────────────────────
    // Prefetch helper (unchanged), and a tiny fetch stub
    // ─────────────────────────────────────────────────────────────
    function prefetchForDashboard(data) {
      try {
        const names = [
          ...(data.sales || []).slice(0,3).map(p=>p.name),
          ...(data.bdc   || []).slice(0,3).map(p=>p.name),
          ...(window.userData?.linkedName ? [window.userData.linkedName] : [])
        ].filter(Boolean);
        names.forEach(n => fetchPerson(n).catch(()=>{}));
      } catch{}
    }

    async function fetchPerson(name) {
      const url = `${SCRIPT_URL}?route=person&name=${encodeURIComponent(name)}&session=${encodeURIComponent(window.sessionToken || '')}`;
      const resp = await fetch(url, { cache: 'no-store' });
      return resp.json();
    }

    // ─────────────────────────────────────────────────────────────
    // Expose handlers used by inline onclick (important for modules)
    // ─────────────────────────────────────────────────────────────
    window.showDashboard        = showDashboard;
    window.showPersonDetails    = showPersonDetails;
    window.viewCallSheets       = viewCallSheets;
    window.prefetchForDashboard = prefetchForDashboard;
    window.setMode              = setMode;

    // Kick off the dashboard
    showDashboard();
  </script>
</body>
</html>
